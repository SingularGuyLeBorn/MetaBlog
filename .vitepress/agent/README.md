# Agent Chat çŠ¶æ€ç®¡ç†

åŸºäº Pinia çš„ç°ä»£çŠ¶æ€ç®¡ç†æ¶æ„ï¼Œä¸º MetaBlog çš„ AI åŠ©æ‰‹æä¾›å¯é ã€å¯ç»´æŠ¤çš„çŠ¶æ€ç®¡ç†ã€‚

## âœ¨ ç‰¹æ€§

- ğŸ¯ **çŠ¶æ€æœºé©±åŠ¨** - ä¸¥æ ¼çš„çŠ¶æ€æµè½¬ï¼Œæ¶ˆé™¤çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜
- ğŸ”„ **ä¹è§‚æ›´æ–°** - å³æ—¶åé¦ˆï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
- ğŸ’¾ **è‡ªåŠ¨æŒä¹…åŒ–** - ä¼šè¯è‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°ä¸ä¸¢å¤±
- ğŸš€ **æµå¼æ”¯æŒ** - å®Œæ•´çš„ SSE æµå¼æ¶ˆæ¯å¤„ç†
- ğŸ§ª **å®Œå…¨ç±»å‹åŒ–** - TypeScript å…¨æ”¯æŒï¼ŒIDE å‹å¥½
- ğŸ“¦ **æ¨¡å—åŒ–è®¾è®¡** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œæ˜“äºæµ‹è¯•

## ğŸ“ ç›®å½•ç»“æ„

```
agent/
â”œâ”€â”€ stores/                          # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ index.ts                     # Store å…¥å£
â”‚   â”œâ”€â”€ types.ts                     # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ chatStore.ts                 # ä¸» Chat Store
â”‚   â”œâ”€â”€ sessionStore.ts              # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ messageStore.ts              # æ¶ˆæ¯ç®¡ç†
â”‚   â”œâ”€â”€ streamStore.ts               # æµå¼å¤„ç†
â”‚   â”œâ”€â”€ machines/                    # çŠ¶æ€æœº
â”‚   â”‚   â””â”€â”€ ChatStateMachine.ts      # Chat çŠ¶æ€æœº
â”‚   â””â”€â”€ plugins/                     # æ’ä»¶
â”‚       â”œâ”€â”€ persistPlugin.ts         # æŒä¹…åŒ–
â”‚       â””â”€â”€ loggerPlugin.ts          # å¼€å‘æ—¥å¿—
â”œâ”€â”€ composables/                     # ç»„åˆå¼å‡½æ•°
â”‚   â”œâ”€â”€ useChat.ts                   # Chat åŠŸèƒ½
â”‚   â””â”€â”€ useVirtualScroll.ts          # è™šæ‹Ÿæ»šåŠ¨
â””â”€â”€ components/                      # UI ç»„ä»¶
    â”œâ”€â”€ AIChatOrbNew.vue             # å®Œæ•´èŠå¤©ç»„ä»¶
    â””â”€â”€ examples/                    # ç¤ºä¾‹ç»„ä»¶
        â”œâ”€â”€ BasicChatExample.vue     # åŸºç¡€ç¤ºä¾‹
        â””â”€â”€ ChatMessage.vue          # æ¶ˆæ¯ç»„ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install pinia
```

### 2. æ³¨å†Œ Pinia

```typescript
// .vitepress/theme/index.ts
import { createPinia } from 'pinia'
import persistPlugin from '../agent/stores/plugins/persistPlugin'

export default {
  enhanceApp({ app }) {
    const pinia = createPinia()
    pinia.use(persistPlugin)
    app.use(pinia)
  }
}
```

### 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<script setup>
import { useChat } from '../composables/useChat'

const { messages, sendMessage, isLoading } = useChat()

async function handleSend(content) {
  await sendMessage(content, { stream: true })
}
</script>
```

## ğŸ“– æ–‡æ¡£

- [å¿«é€Ÿä¸Šæ‰‹æŒ‡å—](./QUICK_START.md) - 5 åˆ†é’Ÿå…¥é—¨
- [æ¶æ„è®¾è®¡æ–‡æ¡£](./ARCHITECTURE.md) - è¯¦ç»†æ¶æ„è¯´æ˜
- [è¿ç§»æŒ‡å—](./MIGRATION.md) - ä»æ—§æ¶æ„è¿ç§»
- [API å‚è€ƒ](#api-å‚è€ƒ) - å®Œæ•´çš„ API æ–‡æ¡£

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI Layer                               â”‚
â”‚         AIChatOrbNew.vue, BasicChatExample.vue              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Composables Layer                          â”‚
â”‚              useChat(), useChatInput()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Store Layer (Pinia)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚chatStore  â”‚ â”‚sessionStoreâ”‚ â”‚messageStoreâ”‚ â”‚streamStoreâ”‚   â”‚
â”‚  â”‚  (ç¼–æ’)    â”‚ â”‚  (ä¼šè¯)   â”‚ â”‚  (æ¶ˆæ¯)   â”‚ â”‚  (æµå¼)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 State Machine Layer                         â”‚
â”‚              ChatStateMachine                               â”‚
â”‚     IDLE â†’ SENDING â†’ STREAMING â†’ IDLE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“š API å‚è€ƒ

### useChat()

ä¸»è¦ Chat åŠŸèƒ½ç»„åˆå¼å‡½æ•°ã€‚

```typescript
const {
  // çŠ¶æ€
  messages,           // å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨
  isLoading,          // æ˜¯å¦æ­£åœ¨åŠ è½½
  isStreaming,        // æ˜¯å¦æ­£åœ¨æµå¼ç”Ÿæˆ
  canSend,            // æ˜¯å¦å¯ä»¥å‘é€
  canInterrupt,       // æ˜¯å¦å¯ä»¥ä¸­æ–­
  currentState,       // å½“å‰çŠ¶æ€æœºçŠ¶æ€
  
  // è¾“å…¥
  inputContent,       // å½“å‰è¾“å…¥å†…å®¹
  updateInput,        // æ›´æ–°è¾“å…¥
  
  // æ“ä½œ
  sendMessage,        // å‘é€æ¶ˆæ¯
  interrupt,          // ä¸­æ–­ç”Ÿæˆ
  regenerate,         // é‡æ–°ç”Ÿæˆ
  clearChat,          // æ¸…ç©ºä¼šè¯
  exportChat,         // å¯¼å‡ºèŠå¤©è®°å½•
  newChat,            // åˆ›å»ºæ–°ä¼šè¯
  switchChat          // åˆ‡æ¢ä¼šè¯
} = useChat(options)
```

### useChatStores()

è®¿é—®æ‰€æœ‰ Storeã€‚

```typescript
const { chat, session, message, stream } = useChatStores()
```

### Store æ–¹æ³•

#### chatStore

| æ–¹æ³• | æè¿° | å‚æ•° |
|------|------|------|
| `sendMessage` | å‘é€æ¶ˆæ¯ | `options?: SendMessageOptions` |
| `interrupt` | ä¸­æ–­ç”Ÿæˆ | - |
| `retry` | é‡è¯•å¤±è´¥çš„æ¶ˆæ¯ | - |
| `reset` | é‡ç½®çŠ¶æ€ | - |

#### sessionStore

| æ–¹æ³• | æè¿° | å‚æ•° |
|------|------|------|
| `createSession` | åˆ›å»ºä¼šè¯ | `title?: string` |
| `switchSession` | åˆ‡æ¢ä¼šè¯ | `sessionId: string` |
| `deleteSession` | åˆ é™¤ä¼šè¯ | `sessionId: string` |
| `searchSessions` | æœç´¢ä¼šè¯ | `query: string` |

#### messageStore

| æ–¹æ³• | æè¿° | å‚æ•° |
|------|------|------|
| `addMessage` | æ·»åŠ æ¶ˆæ¯ | `message: Partial<Message>` |
| `updateMessage` | æ›´æ–°æ¶ˆæ¯ | `id: string, updates: Partial<Message>` |
| `deleteMessage` | åˆ é™¤æ¶ˆæ¯ | `id: string` |
| `clearSessionMessages` | æ¸…ç©ºä¼šè¯æ¶ˆæ¯ | `sessionId: string` |
| `exportMessages` | å¯¼å‡ºæ¶ˆæ¯ | `sessionId: string, format: 'json' \| 'markdown'` |

## ğŸ”„ çŠ¶æ€æµè½¬

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  IDLE   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
        â”‚                â”‚                â”‚
   INTERRUPT        START_COMPOSING  STREAM_END
        â”‚                â”‚                â”‚
        â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”‚
        â”‚           â”‚COMPOSINGâ”‚           â”‚
        â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
        â”‚                â”‚ SEND_MESSAGE   â”‚
        â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ SENDING â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ START_STREAM
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                    â”‚STREAMINGâ”‚â—€â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚
                         â”‚          â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”‚
                    â”‚  ERROR  â”œâ”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   RETRY
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test -- chatStore.test.ts
```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0.0

- âœ¨ å…¨æ–°çš„ Pinia çŠ¶æ€ç®¡ç†æ¶æ„
- âœ¨ å¼•å…¥çŠ¶æ€æœºç®¡ç† Chat ç”Ÿå‘½å‘¨æœŸ
- âœ¨ ä¹è§‚æ›´æ–°ä¸è‡ªåŠ¨å›æ»š
- âœ¨ å®Œæ•´çš„æµå¼æ¶ˆæ¯å¤„ç†
- âœ¨ ä¼šè¯è‡ªåŠ¨æŒä¹…åŒ–
- âœ¨ è™šæ‹Ÿæ»šåŠ¨æ”¯æŒ
- â™»ï¸ å®Œå…¨é‡æ„çš„æ—§æ¶æ„

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ PRï¼

## ğŸ“„ è®¸å¯è¯

MIT
