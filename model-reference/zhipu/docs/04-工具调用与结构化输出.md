# 04-工具调用与结构化输出

## GLM-4-Flash-250414 模型

### 模型概述

GLM-4-Flash-250414 是 GLM-4-Flash 的迭代版本，采用 MoE 架构，性能大幅升级：支持 **128K 上下文窗口**、**16K 输出长度**，具备图片理解能力，并通过内置工具调用、深度推理等能力，进一步适配 **智能体开发** 与 **内容创作** 场景。

### 模型规格

| 规格项 | 数值 |
|:---|:---|
| 输入模态 | 图片、文本 |
| 输出模态 | 文本 |
| 上下文窗口 | 128K tokens |
| 最大输出 Tokens | 16K |
| 思考模式 | ❌ 不支持 |
| 思维链 | ❌ 不支持 |

### 能力支持

- ❌ **深度思考** - 不支持思考模式
- ✅ **视觉理解** - 支持图片输入理解
- ✅ **流式输出** - 支持实时流式响应
- ✅ **Function Call** - 强大的工具调用能力
- ✅ **上下文缓存** - 智能缓存机制
- ✅ **结构化输出** - 支持 JSON Schema 约束
- ✅ **MCP** - 可灵活调用外部 MCP 工具

### 适用场景

#### 智能体开发

| 场景 | 描述 |
|:---|:---|
| Agent 调用工具 | 自动识别用户意图并调用相应工具函数 |
| 任务编排 | 多步骤任务自动分解与执行 |
| 数据处理 | 调用外部 API 获取和处理数据 |

#### 内容创作

| 场景 | 描述 |
|:---|:---|
| 智能写作 | 新闻、文章、营销文案自动生成 |
| 润色改写 | 文本风格转换、语法纠错 |
| 翻译优化 | 多语言翻译与本地化 |

### API 调用方式

**端点**：`https://open.bigmodel.cn/api/paas/v4/chat/completions`

### 工具调用（Function Call）示例

#### 1. 基础工具定义

```python
from openai import OpenAI
import json

client = OpenAI(
    api_key="your-api-key",
    base_url="https://open.bigmodel.cn/api/paas/v4"
)

# 定义工具 - 天气查询
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "查询指定城市的当前天气信息",
            "parameters": {
                "type": "object",
                "properties": {
                    "city": {
                        "type": "string",
                        "description": "城市名称，如北京、上海"
                    }
                },
                "required": ["city"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "calculate",
            "description": "执行数学计算",
            "parameters": {
                "type": "object",
                "properties": {
                    "expression": {
                        "type": "string",
                        "description": "数学表达式，如 '2 + 3 * 4'"
                    }
                },
                "required": ["expression"]
            }
        }
    }
]

# 用户询问天气
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {"role": "user", "content": "北京今天天气怎么样？"}
    ],
    tools=tools,
    tool_choice="auto"  # 自动选择工具
)

# 检查是否需要调用工具
if response.choices[0].message.tool_calls:
    tool_call = response.choices[0].message.tool_calls[0]
    function_name = tool_call.function.name
    arguments = json.loads(tool_call.function.arguments)
    
    print(f"需要调用函数: {function_name}")
    print(f"参数: {arguments}")
    
    # 实际执行工具（这里模拟）
    if function_name == "get_weather":
        city = arguments["city"]
        # 调用天气 API...
        weather_result = f"{city}今天晴，25°C"
        
        # 将工具结果返回给模型
        messages = [
            {"role": "user", "content": "北京今天天气怎么样？"},
            {"role": "assistant", "content": None, "tool_calls": [tool_call]},
            {
                "role": "tool",
                "tool_call_id": tool_call.id,
                "content": weather_result
            }
        ]
        
        final_response = client.chat.completions.create(
            model="glm-4-flash-250414",
            messages=messages,
            tools=tools
        )
        print(final_response.choices[0].message.content)
```

#### 2. 多工具并行调用

```python
# 支持同时调用多个工具
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {"role": "user", "content": "计算 2+3 和 4*5 的结果"}
    ],
    tools=[{
        "type": "function",
        "function": {
            "name": "calculate",
            "description": "执行数学计算",
            "parameters": {
                "type": "object",
                "properties": {
                    "expression": {"type": "string"}
                },
                "required": ["expression"]
            }
        }
    }],
    tool_choice="auto"
)

# 可能返回多个 tool_calls
for tool_call in response.choices[0].message.tool_calls:
    print(f"调用: {tool_call.function.name}({tool_call.function.arguments})")
```

### 结构化输出（JSON Mode）

#### 1. 基础 JSON 输出

```python
# 强制输出 JSON 格式
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {"role": "user", "content": """
请从以下文本中提取信息并返回JSON格式：
张三，28岁，软件工程师，居住在北京

要求输出格式：
{
    "name": "姓名",
    "age": 年龄,
    "job": "职业",
    "city": "城市"
}
"""}
    ],
    response_format={"type": "json_object"}
)

import json
data = json.loads(response.choices[0].message.content)
print(data)
```

#### 2. 实体抽取示例

```python
# 实体抽取 - 返回结构化数据
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {"role": "system", "content": "你是一个实体抽取助手。从文本中提取人名、地名、时间，并返回JSON数组格式。"},
        {"role": "user", "content": "李明在2024年5月从北京搬到了上海工作。"}
    ],
    response_format={"type": "json_object"}
)

result = json.loads(response.choices[0].message.content)
print(json.dumps(result, ensure_ascii=False, indent=2))
# 输出示例：
# {
#   "entities": [
#     {"type": "person", "value": "李明"},
#     {"type": "location", "value": "北京"},
#     {"type": "location", "value": "上海"},
#     {"type": "date", "value": "2024年5月"}
#   ]
# }
```

#### 3. 智能写作 - 结构化输出

```python
# 生成结构化文章
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {"role": "system", "content": "你是一位专业的科技文章写手。输出必须是JSON格式，包含title、summary、keywords、content字段。"},
        {"role": "user", "content": "请写一篇关于人工智能的文章"}
    ],
    response_format={"type": "json_object"}
)

article = json.loads(response.choices[0].message.content)
print(f"标题: {article['title']}")
print(f"摘要: {article['summary']}")
print(f"关键词: {', '.join(article['keywords'])}")
print(f"内容: {article['content']}")
```

### 图片理解 + 工具调用

```python
# 结合图片理解和工具调用
response = client.chat.completions.create(
    model="glm-4-flash-250414",
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "image_url",
                    "image_url": {"url": "https://example.com/product.png"}
                },
                {
                    "type": "text",
                    "text": "识别图片中的商品名称，并查询该商品的价格"
                }
            ]
        }
    ],
    tools=[{
        "type": "function",
        "function": {
            "name": "query_price",
            "description": "查询商品价格",
            "parameters": {
                "type": "object",
                "properties": {
                    "product_name": {"type": "string"}
                },
                "required": ["product_name"]
            }
        }
    }],
    tool_choice="auto"
)
```

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|:---|:---|:---:|:---|
| model | string | 是 | `glm-4-flash-250414` |
| messages | array | 是 | 对话消息列表（支持图片/文本） |
| tools | array | 否 | 工具定义列表 |
| tool_choice | string/object | 否 | 工具选择策略：`auto`、`none` 或指定工具 |
| response_format | object | 否 | 响应格式：`{"type": "json_object"}` |
| max_tokens | integer | 否 | 最大输出 tokens |
| temperature | float | 否 | 采样温度 |
| stream | boolean | 否 | 是否流式输出 |

### 注意事项

1. **不支持思考模式**：该模型不支持 `thinking` 参数
2. **工具调用流程**：检测到 tool_calls → 执行工具 → 将结果作为 tool 消息返回 → 获取最终回答
3. **JSON 模式**：需要明确提示输出格式，并设置 `response_format={"type": "json_object"}`
4. **图片限制**：支持图片输入理解，但主要用于辅助文本理解，不像 4.6V 那样专注于视觉
5. **流式输出**：工具调用结果在流式输出中也能正确处理

### 工具选择策略

| tool_choice 值 | 说明 |
|:---|:---|
| `auto` | 模型自动决定是否调用工具 |
| `none` | 禁止调用工具 |
| `{"type": "function", "function": {"name": "xxx"}}` | 强制调用指定工具 |

### 与其他模型的对比

| 能力 | GLM-4-Flash-250414 | GLM-4.7-Flash |
|:---|:---:|:---:|
| 思考模式 | ❌ | ✅ |
| Function Call | ✅ | ✅ |
| 上下文 | 128K | 200K |
| 最大输出 | 16K | 128K |
| 图片理解 | ✅ 支持 | ❌ 不支持 |
| 结构化输出 | ✅ | ✅ |
