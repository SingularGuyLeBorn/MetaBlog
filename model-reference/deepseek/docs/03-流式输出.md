# 03-流式输出

## 基础流式输出

```python
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com",
)

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[{"role": "user", "content": "讲一个故事"}],
    stream=True
)

for chunk in response:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="", flush=True)

print()
```

## 思考模型流式输出

```python
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[{"role": "user", "content": "解释量子力学"}],
    stream=True
)

reasoning_buffer = []
content_buffer = []
in_content = False

for chunk in response:
    delta = chunk.choices[0].delta
    
    # 收集思考过程
    reasoning = getattr(delta, "reasoning_content", None)
    if reasoning:
        if not reasoning_buffer:
            print("思考过程：")
            print("-" * 60)
        reasoning_buffer.append(reasoning)
        print(reasoning, end="", flush=True)
    
    # 收集正式回答
    if delta.content:
        if not in_content:
            in_content = True
            print("\n\n正式回答：")
            print("-" * 60)
        content_buffer.append(delta.content)
        print(delta.content, end="", flush=True)

print("\n")
print(f"\n思考部分: {len(''.join(reasoning_buffer))} 字符")
print(f"回答部分: {len(''.join(content_buffer))} 字符")
```

## 带工具调用的流式输出

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "获取天气",
            "parameters": {
                "type": "object",
                "properties": {"city": {"type": "string"}},
                "required": ["city"]
            }
        }
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[{"role": "user", "content": "北京天气如何？"}],
    tools=tools,
    stream=True
)

for chunk in response:
    delta = chunk.choices[0].delta
    
    if delta.content:
        print(delta.content, end="", flush=True)
    
    if hasattr(delta, "tool_calls") and delta.tool_calls:
        for tc in delta.tool_calls:
            if tc.function:
                print(f"\n[调用工具] {tc.function.name}")
                print(f"[参数] {tc.function.arguments}")

print()
```

## 完整流式处理类

```python
class StreamingChat:
    def __init__(self, client):
        self.client = client
    
    def chat(self, message, model="deepseek-chat", **kwargs):
        response = self.client.chat.completions.create(
            model=model,
            messages=[{"role": "user", "content": message}],
            stream=True,
            **kwargs
        )
        
        full_content = []
        reasoning_content = []
        
        for chunk in response:
            delta = chunk.choices[0].delta
            
            # 获取思考内容（reasoner 模型）
            reasoning = getattr(delta, "reasoning_content", None)
            if reasoning:
                reasoning_content.append(reasoning)
                print(f"\033[90m{reasoning}\033[0m", end="", flush=True)
            
            # 获取正式内容
            if delta.content:
                full_content.append(delta.content)
                print(delta.content, end="", flush=True)
        
        print()
        
        return {
            "content": "".join(full_content),
            "reasoning": "".join(reasoning_content) if reasoning_content else None
        }

# 使用
chat = StreamingChat(client)
result = chat.chat("解释机器学习", model="deepseek-reasoner")
print(f"\n思考长度: {len(result['reasoning'] or '')} 字符")
```
