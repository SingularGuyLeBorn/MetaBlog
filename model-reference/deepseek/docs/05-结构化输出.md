# 05-结构化输出（JSON Output）

## 基础 JSON 输出

```python
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com",
)

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[
        {
            "role": "system",
            "content": "You are a helpful assistant. Always respond in valid JSON format."
        },
        {
            "role": "user",
            "content": "Extract name and age from: John is 25 years old."
        }
    ],
    response_format={"type": "json_object"}
)

import json
data = json.loads(response.choices[0].message.content)
print(json.dumps(data, indent=2))
```

## 指定 JSON Schema

```python
response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[
        {
            "role": "system",
            "content": """Extract person information and return in this JSON format:
{
    "name": "string",
    "age": "number",
    "hobbies": ["string"]
}"""
        },
        {
            "role": "user",
            "content": "Tom is 30 years old. He likes reading and swimming."
        }
    ],
    response_format={"type": "json_object"}
)

result = json.loads(response.choices[0].message.content)
print(result)
```

## 实体抽取

```python
def extract_entities(text):
    """从文本中提取实体"""
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {
                "role": "system",
                "content": """Extract entities from the text and return JSON:
{
    "people": ["name1", "name2"],
    "organizations": ["org1", "org2"],
    "locations": ["loc1", "loc2"],
    "dates": ["date1", "date2"]
}"""
            },
            {
                "role": "user",
                "content": text
            }
        ],
        response_format={"type": "json_object"},
        temperature=0.1  # 低温度确保格式稳定
    )
    
    return json.loads(response.choices[0].message.content)

# 使用
text = "Apple Inc. announced on January 10, 2024 that Tim Cook will visit Beijing."
entities = extract_entities(text)
print(json.dumps(entities, indent=2, ensure_ascii=False))
```

## 思考模型 JSON 输出

```python
# deepseek-reasoner 也支持 JSON 输出
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[
        {
            "role": "user",
            "content": """分析以下数学问题，给出解题步骤和答案：
问题：一个水箱有两个进水管 A 和 B...
请以 JSON 格式返回：
{
    "analysis": "问题分析",
    "steps": ["步骤1", "步骤2", ...],
    "answer": "最终答案"
}"""
        }
    ],
    response_format={"type": "json_object"},
    max_tokens=4096
)

# 解析结果
result = json.loads(response.choices[0].message.content)
print(f"分析: {result['analysis']}")
print(f"步骤: {result['steps']}")
print(f"答案: {result['answer']}")

# 查看思考过程
reasoning = getattr(response.choices[0].message, "reasoning_content", None)
if reasoning:
    print(f"\n思考过程: {reasoning[:300]}...")
```

## 批量数据处理

```python
def analyze_reviews(reviews):
    """批量分析用户评论"""
    results = []
    
    for review in reviews:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {
                    "role": "system",
                    "content": """Analyze the sentiment and extract key points from the review.
Return JSON format:
{
    "sentiment": "positive/negative/neutral",
    "score": 1-10,
    "key_points": ["point1", "point2"],
    "suggestions": ["suggestion1"]
}"""
                },
                {
                    "role": "user",
                    "content": review
                }
            ],
            response_format={"type": "json_object"},
            temperature=0.2
        )
        
        result = json.loads(response.choices[0].message.content)
        results.append(result)
    
    return results

# 使用
reviews = [
    "Great product! Fast delivery.",
    "Not good, broke after one day.",
    "Average quality, acceptable price."
]

analysis = analyze_reviews(reviews)
for i, result in enumerate(analysis):
    print(f"\nReview {i+1}: {result['sentiment']} (score: {result['score']})")
```
