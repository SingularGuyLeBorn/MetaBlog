# 02-思考模式

来源：https://api-docs.deepseek.com/zh-cn/guides/thinking_mode

## 概述

DeepSeek 支持思考模式：模型会先输出思维链（`reasoning_content`），再输出最终答案（`content`），以提升准确性。

## 开启方式

有两种方式开启思考模式：

### 方式 1: 使用 `deepseek-reasoner` 模型（推荐）

```python
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[{"role": "user", "content": "9.11 and 9.8, which is greater?"}]
)
```

### 方式 2: 使用 `deepseek-chat` + `thinking` 参数

```python
response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[{"role": "user", "content": "解方程"}],
    extra_body={"thinking": {"type": "enabled"}}  # 必须通过 extra_body
)
```

## 重要限制 ⚠️

`deepseek-reasoner` **不支持以下参数**：

| 参数 | 行为 |
|:---|:---|
| `temperature` | 设置不会报错，但不会生效 |
| `top_p` | 设置不会报错，但不会生效 |
| `presence_penalty` | 设置不会报错，但不会生效 |
| `frequency_penalty` | 设置不会报错，但不会生效 |
| `logprobs` | **会报错** |
| `top_logprobs` | **会报错** |

```python
# ❌ 错误：会报错
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[...],
    logprobs=True  # 报错！
)

# ⚠️ 无效：不会报错但也不生效
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[...],
    temperature=0.5  # 无效！
)
```

## 输出字段

| 字段 | 说明 |
|:---|:---|
| `reasoning_content` | 思维链内容（与 `content` 同级） |
| `content` | 最终回答内容 |
| `tool_calls` | 工具调用（思考模式支持） |

## 基础使用

```python
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com",
)

# 使用 deepseek-reasoner
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[
        {"role": "user", "content": "解方程：3x² - 6x + 2 = 0"}
    ],
    max_tokens=4096  # 默认 32K，最大 64K（含思维链）
)

message = response.choices[0].message

# 访问思维链 - 直接通过属性访问
reasoning_content = message.reasoning_content
content = message.content

print("思考过程：")
print("=" * 60)
print(reasoning_content)
print("=" * 60)
print("\n最终答案：")
print(content)
```

## 多轮对话处理 ⚠️ 重要

**关键点**：
1. 多轮对话中，**`reasoning_content` 不会被拼接到上下文中**
2. 新一轮对话只传入上一轮的 `content`，忽略 `reasoning_content`
3. 只有在**同一轮的工具调用**中，才需要回传 `reasoning_content`

```python
# Turn 1
messages = [{"role": "user", "content": "9.11 and 9.8, which is greater?"}]
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=messages
)

reasoning_content = response.choices[0].message.reasoning_content
content = response.choices[0].message.content

# Turn 2 - 只传入 content，不传入 reasoning_content
messages.append({'role': 'assistant', 'content': content})  # 注意：不是整个 message
messages.append({'role': 'user', 'content': "How many Rs are in 'strawberry'?"})

response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=messages
)
```

## 流式输出

```python
response = client.chat.completions.create(
    model="deepseek-reasoner",
    messages=[{"role": "user", "content": "证明勾股定理"}],
    stream=True,
    max_tokens=4096
)

for chunk in response:
    delta = chunk.choices[0].delta
    
    # 思维链
    if delta.reasoning_content:
        print(delta.reasoning_content, end="", flush=True)
    
    # 最终答案
    if delta.content:
        print(delta.content, end="", flush=True)
```

## 支持的功能

- ✅ JSON Output
- ✅ Tool Calls（见下方）
- ✅ 对话补全
- ✅ 对话前缀续写 (Beta)
- ❌ FIM 补全 (Beta) - **不支持**

## 思考模式 + 工具调用

```python
import json

# 工具定义
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_date",
            "description": "Get the current date",
            "parameters": {"type": "object", "properties": {}}
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "Get weather of a location",
            "parameters": {
                "type": "object",
                "properties": {
                    "location": {"type": "string"},
                    "date": {"type": "string"}
                },
                "required": ["location", "date"]
            }
        }
    }
]

# 模拟工具
TOOL_CALL_MAP = {
    "get_date": lambda: "2025-12-01",
    "get_weather": lambda location, date: "Cloudy 7~13°C"
}

def clear_reasoning_content(messages):
    """清除历史消息中的 reasoning_content（节省带宽）"""
    for message in messages:
        if hasattr(message, 'reasoning_content'):
            message.reasoning_content = None

def run_turn(turn, messages):
    """执行一轮对话（可能包含多步工具调用）"""
    sub_turn = 1
    while True:
        response = client.chat.completions.create(
            model="deepseek-chat",  # 或 deepseek-reasoner
            messages=messages,
            tools=tools,
            extra_body={"thinking": {"type": "enabled"}}
        )
        
        # 必须将完整的 message 添加到历史（包含 reasoning_content）
        messages.append(response.choices[0].message)
        
        reasoning_content = response.choices[0].message.reasoning_content
        content = response.choices[0].message.content
        tool_calls = response.choices[0].message.tool_calls
        
        print(f"Turn {turn}.{sub_turn}")
        print(f"reasoning: {reasoning_content[:100]}...")
        print(f"content: {content}")
        print(f"tool_calls: {tool_calls}")
        
        # 如果没有工具调用，回答完成
        if not tool_calls:
            break
        
        # 执行工具
        for tool in tool_calls:
            result = TOOL_CALL_MAP[tool.function.name](**json.loads(tool.function.arguments))
            print(f"Tool result: {result}")
            
            # 添加工具结果到历史
            messages.append({
                "role": "tool",
                "tool_call_id": tool.id,
                "content": result
            })
        
        sub_turn += 1

# Turn 1: 用户提问
messages = [{"role": "user", "content": "How's the weather in Hangzhou tomorrow?"}]
run_turn(1, messages)

# Turn 2: 新问题时，清除之前的 reasoning_content
messages.append({"role": "user", "content": "What should I wear?"})
clear_reasoning_content(messages)  # 清除 reasoning_content 节省带宽
run_turn(2, messages)
```

## 关键要点

1. **参数限制**: `deepseek-reasoner` 不支持 temperature、top_p 等参数
2. **Max tokens**: 默认 32K，最大 64K（含思维链输出）
3. **多轮对话**: 只传 `content`，不传 `reasoning_content`
4. **工具调用**: 同一轮内需要回传 `reasoning_content`，新问题时清除
5. **不支持 FIM**: `deepseek-reasoner` 不支持 FIM 补全
