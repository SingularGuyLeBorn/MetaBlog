# 04-工具调用

来源：https://api-docs.deepseek.com/zh-cn/guides/tool_calls

## 基础工具调用

```python
from openai import OpenAI
import json

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com",
)

# 定义工具
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "Get weather of a location, the user should supply a location first.",
            "parameters": {
                "type": "object",
                "properties": {
                    "location": {
                        "type": "string",
                        "description": "The city and state, e.g. San Francisco, CA"
                    }
                },
                "required": ["location"]
            }
        }
    }
]

# 调用
messages = [{"role": "user", "content": "How's the weather in Hangzhou?"}]
response = client.chat.completions.create(
    model="deepseek-chat",
    messages=messages,
    tools=tools
)

message = response.choices[0].message
messages.append(message)

# 检查是否需要调用工具
if message.tool_calls:
    tool = message.tool_calls[0]
    print(f"调用工具: {tool.function.name}")
    print(f"参数: {tool.function.arguments}")
    
    # 模拟执行工具
    result = "24°C, sunny"
    messages.append({
        "role": "tool",
        "tool_call_id": tool.id,
        "content": result
    })
    
    # 获取最终回答
    final_response = client.chat.completions.create(
        model="deepseek-chat",
        messages=messages,
        tools=tools
    )
    print(final_response.choices[0].message.content)
```

## Strict 模式（Beta）

> ⚠️ **Beta 功能**：需要使用 `https://api.deepseek.com/beta`

在 `strict` 模式下，模型输出的 Function 调用会严格遵循 JSON Schema 格式。

### 使用条件

1. 使用 beta 端点：`base_url="https://api.deepseek.com/beta"`
2. 所有 function 设置 `strict: true`
3. 所有 object 的 `additionalProperties` 必须为 `false`
4. 所有 object 的属性必须全部设置为 `required`

```python
client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com/beta",  # beta 端点
)

tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "strict": True,  # 启用 strict 模式
            "description": "Get weather of a location",
            "parameters": {
                "type": "object",
                "properties": {
                    "location": {
                        "type": "string",
                        "description": "The city name"
                    },
                    "date": {
                        "type": "string",
                        "description": "Date in YYYY-MM-DD"
                    }
                },
                "required": ["location", "date"],  # 所有属性必须 required
                "additionalProperties": False       # 必须为 false
            }
        }
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[{"role": "user", "content": "杭州明天天气"}],
    tools=tools
)
```

### Strict 模式支持的 JSON Schema 类型

#### object 类型

```python
{
    "type": "object",
    "properties": {
        "name": {"type": "string"},
        "age": {"type": "integer"}
    },
    "required": ["name", "age"],      # 所有属性必须 required
    "additionalProperties": False      # 必须为 false
}
```

#### string 类型

```python
{
    "type": "string",
    "description": "Email address",
    "format": "email",           # 支持: email, hostname, ipv4, ipv6, uuid
    "pattern": "^\\d{6}$"         # 正则表达式
}
```

> 不支持: `minLength`, `maxLength`

#### number/integer 类型

```python
{
    "type": "integer",
    "description": "Rating score",
    "minimum": 1,                # 最小值
    "maximum": 5,                # 最大值
    "exclusiveMinimum": 0,       # 不小于
    "exclusiveMaximum": 6,       # 不大于
    "multipleOf": 1,             # 倍数
    "const": 5,                  # 固定值
    "default": 3                 # 默认值
}
```

#### array 类型

```python
{
    "type": "array",
    "description": "Keywords",
    "items": {
        "type": "string",
        "description": "A keyword"
    }
    # 不支持: minItems, maxItems
}
```

#### enum 类型

```python
{
    "type": "string",
    "description": "Order status",
    "enum": ["pending", "processing", "shipped", "cancelled"]
}
```

#### anyOf 类型

```python
{
    "type": "object",
    "properties": {
        "account": {
            "anyOf": [
                {"type": "string", "format": "email"},
                {"type": "string", "pattern": "^\\d{11}$"}
            ]
        }
    }
}
```

#### $ref 和 $def（递归结构）

```python
{
    "type": "object",
    "properties": {
        "report_date": {"type": "string"},
        "authors": {
            "type": "array",
            "items": {"$ref": "#/$def/author"}  # 引用定义
        }
    },
    "required": ["report_date", "authors"],
    "additionalProperties": False,
    "$def": {
        "author": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "email": {"type": "string", "format": "email"}
            },
            "additionalProperties": False,
            "required": ["name", "email"]
        }
    }
}
```

## 完整示例：订单处理

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "create_order",
            "strict": True,
            "description": "Create a new order",
            "parameters": {
                "type": "object",
                "properties": {
                    "customer": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "email": {"type": "string", "format": "email"}
                        },
                        "required": ["name", "email"],
                        "additionalProperties": False
                    },
                    "items": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "product_id": {"type": "string"},
                                "quantity": {"type": "integer", "minimum": 1}
                            },
                            "required": ["product_id", "quantity"],
                            "additionalProperties": False
                        }
                    },
                    "status": {
                        "type": "string",
                        "enum": ["pending", "confirmed"]
                    }
                },
                "required": ["customer", "items", "status"],
                "additionalProperties": False
            }
        }
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=[{"role": "user", "content": "创建订单：张三，zhangsan@email.com，购买商品 A001 2件"}],
    tools=tools
)

# 输出会严格遵循 schema
```
