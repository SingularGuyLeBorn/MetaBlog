# 06-对话前缀续写（Beta）

来源：https://api-docs.deepseek.com/zh-cn/guides/chat_prefix_completion

> ⚠️ **Beta 功能**：需要使用 `https://api.deepseek.com/beta`

## 概述

通过预填（Prefill）部分助手回复来引导模型输出，可以：
- 控制输出格式
- 引导输出内容
- 保持角色一致性

## 使用方法

在最后一个 `role` 为 `assistant` 的消息中，设置 `prefix: True`。

```python
from openai import OpenAI

# ⚠️ 注意：使用 beta 端点
client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com/beta",  # beta 端点
)
```

## 示例 1: 强制输出 Python 代码

```python
messages = [
    {"role": "user", "content": "Please write quick sort code"},
    {
        "role": "assistant",
        "content": "```python\n",  # 预填代码块开头
        "prefix": True             # 标记为前缀
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=messages,
    stop=["```"],  # 在代码块结束符处停止
)

print(response.choices[0].message.content)
# 输出会以 "```python\n" 开头，生成代码，不会有多余解释
```

## 示例 2: JSON 格式引导

```python
messages = [
    {"role": "user", "content": "提取人名和年龄：张三，25岁"},
    {
        "role": "assistant",
        "content": '{"name": "',  # 预填 JSON 开头
        "prefix": True
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=messages,
    temperature=0.1  # 低温度确保格式稳定
)

result = response.choices[0].message.content
print(result)  # 会以 JSON 格式继续
```

## 示例 3: 角色扮演引导

```python
messages = [
    {
        "role": "system",
        "content": "你是一位古代诗人，说话文雅。"
    },
    {"role": "user", "content": "描写月亮"},
    {
        "role": "assistant",
        "content": "皓月当空，",  # 预填开头
        "prefix": True
    }
]

response = client.chat.completions.create(
    model="deepseek-chat",
    messages=messages
)

print(response.choices[0].message.content)
```

## 示例 4: 思考模式 + 前缀续写

```python
messages = [
    {"role": "user", "content": "证明勾股定理"},
    {
        "role": "assistant",
        "content": "证明：",
        "prefix": True
    }
]

response = client.chat.completions.create(
    model="deepseek-reasoner",  # 思考模式也支持
    messages=messages,
    max_tokens=4096
)

message = response.choices[0].message

# 查看思考过程
if hasattr(message, 'reasoning_content'):
    print(f"思考: {message.reasoning_content[:200]}...")

print(f"回答: {message.content}")
```

## 注意事项

1. **Beta 端点**: 必须使用 `https://api.deepseek.com/beta`
2. **prefix 字段**: 放在最后一个 assistant message 中
3. **stop 参数**: 可用于控制生成停止点
4. **兼容性**: `deepseek-chat` 和 `deepseek-reasoner` 都支持
