# 09-文件接口

来源：https://platform.moonshot.cn/docs/api/files

## 限制

| 项目 | 限制 |
|:---|:---|
| 单个用户文件数 | 最多 1000 个 |
| 单文件大小 | 不超过 100MB |
| 总容量 | 不超过 10GB |
| 文件解析 | 限时免费，高峰期可能限流 |

## 支持的文件格式

- **文档**: `.pdf` `.txt` `.csv` `.doc` `.docx` `.xls` `.xlsx` `.ppt` `.pptx` `.md` `.epub` `.html` `.json` `.mobi` `.log`
- **图片**: `.jpeg` `.png` `.bmp` `.gif` `.svg` `.svgz` `.webp` `.ico` `.xbm` `.dib` `.pjp` `.tif` `.pjpeg` `.avif` `.apng` `.tiff` `.jfif`
- **代码文件**: `.go` `.h` `.c` `.cpp` `.cxx` `.cc` `.cs` `.java` `.js` `.css` `.jsp` `.php` `.py` `.py3` `.asp` `.yaml` `.yml` `.ini` `.conf` `.ts` `.tsx`

## Purpose 类型

| Purpose | 说明 |
|:---|:---|
| `file-extract` | 文件内容抽取，用于获取文件中的文本信息 |
| `image` | 上传图片，用于视觉理解 |
| `video` | 上传视频，用于视觉理解 |

## 上传文件

```python
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.moonshot.cn/v1",
)

# 上传文件用于内容抽取
with open("document.pdf", "rb") as f:
    file = client.files.create(
        file=f,
        purpose="file-extract"
    )

print(f"文件ID: {file.id}")
print(f"文件名: {file.filename}")
print(f"大小: {file.bytes} bytes")
```

## 上传图片/视频

```python
# 上传图片
with open("image.png", "rb") as f:
    image_file = client.files.create(
        file=f,
        purpose="image"
    )

# 上传视频
with open("video.mp4", "rb") as f:
    video_file = client.files.create(
        file=f,
        purpose="video"
    )
```

## 使用文件内容

### 1. 视觉理解（图片/视频）

```python
response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[{
        "role": "user",
        "content": [
            {"type": "image_url", "image_url": {"url": f"ms://{image_file.id}"}},
            {"type": "text", "text": "描述这张图片"}
        ]
    }]
)
```

### 2. 文件内容抽取

```python
# 获取文件内容抽取结果
file_content = client.files.content(file_id="file-xxxxx")

# 将内容作为上下文使用
response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[
        {
            "role": "system",
            "content": f"基于以下文档内容回答问题：\n{file_content.text}"
        },
        {
            "role": "user",
            "content": "文档的主要内容是什么？"
        }
    ]
)
```

### 3. 多文件上下文

```python
# 抽取多个文件内容
file_ids = ["file-1", "file-2", "file-3"]
contents = []

for fid in file_ids:
    content = client.files.content(file_id=fid)
    contents.append(content.text)

# 用换行符拼接，作为 system message
combined_content = "\n".join(contents)

response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[
        {
            "role": "system",
            "content": f"参考以下文档：\n{combined_content}"
        },
        {
            "role": "user",
            "content": "综合这些文档，总结关键点"
        }
    ]
)
```

## 文件管理

### 列出文件

```python
files = client.files.list()
for file in files.data:
    print(f"{file.id}: {file.filename} ({file.bytes} bytes, {file.purpose})")
```

### 获取文件信息

```python
file_info = client.files.retrieve(file_id="file-xxxxx")
print(f"ID: {file_info.id}")
print(f"文件名: {file_info.filename}")
print(f"大小: {file_info.bytes}")
print(f"用途: {file_info.purpose}")
print(f"创建时间: {file_info.created_at}")
```

### 删除文件

```python
client.files.delete(file_id="file-xxxxx")
print("文件已删除")
```

### 获取文件内容

```python
# 仅适用于 purpose="file-extract" 的文件
content = client.files.content(file_id="file-xxxxx")
print(content.text)
```

## 完整示例：文档问答系统

```python
class DocumentQA:
    def __init__(self, client):
        self.client = client
        self.file_cache = {}
    
    def upload_document(self, filepath):
        """上传文档"""
        with open(filepath, "rb") as f:
            file = self.client.files.create(
                file=f,
                purpose="file-extract"
            )
        
        self.file_cache[file.id] = file.filename
        return file.id
    
    def ask(self, file_id, question):
        """基于文档问答"""
        # 获取文件内容
        content = self.client.files.content(file_id=file_id)
        
        # 调用模型
        response = self.client.chat.completions.create(
            model="kimi-k2.5",
            messages=[
                {
                    "role": "system",
                    "content": f"基于以下文档回答问题。如果文档中没有相关信息，请明确说明。\n\n文档内容：\n{content.text[:50000]}"
                },
                {
                    "role": "user",
                    "content": question
                }
            ]
        )
        
        return response.choices[0].message.content
    
    def cleanup(self):
        """清理所有上传的文件"""
        for file_id in self.file_cache:
            self.client.files.delete(file_id=file_id)
        self.file_cache.clear()

# 使用
qa = DocumentQA(client)
file_id = qa.upload_document("report.pdf")
answer = qa.ask(file_id, "这份报告的核心观点是什么？")
print(answer)

# 清理
qa.cleanup()
```
