# 07-文件上传

来源：https://platform.moonshot.cn/docs/api/chat

## 概述

对于大文件或需要多次引用的文件，建议先上传到 Kimi 平台，获取 `file_id`，然后在请求中使用 `ms://<file_id>` 格式引用。

## 支持的文件类型

| 类型 | 格式 |
|:---|:---|
| 图片 | png, jpeg, webp, gif |
| 视频 | mp4, mpeg, mov, avi, x-flv, mpg, webm, wmv, 3gpp |
| 文档 | pdf, txt, doc, docx 等 |

## 上传文件

```python
from openai import OpenAI
import os

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.moonshot.cn/v1",
)

# 上传文件
with open("document.pdf", "rb") as f:
    file = client.files.create(
        file=f,
        purpose="vision"  # 或 "file-extract" 等
    )

print(f"文件ID: {file.id}")
print(f"文件名: {file.filename}")
print(f"文件大小: {file.bytes}")
```

## 使用文件ID

### 在视觉理解中使用

```python
# 使用上传的图片
response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[{
        "role": "user",
        "content": [
            {
                "type": "image_url",
                "image_url": {"url": f"ms://{file.id}"}  # 使用文件ID
            },
            {
                "type": "text",
                "text": "分析这个文档"
            }
        ]
    }]
)

print(response.choices[0].message.content)
```

### 在视频理解中使用

```python
# 上传视频
with open("video.mp4", "rb") as f:
    video_file = client.files.create(file=f, purpose="vision")

# 使用视频
response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[{
        "role": "user",
        "content": [
            {
                "type": "video_url",
                "video_url": {"url": f"ms://{video_file.id}"}
            },
            {
                "type": "text",
                "text": "描述这个视频的内容"
            }
        ]
    }]
)
```

## 文件管理

### 列出文件

```python
files = client.files.list()
for file in files.data:
    print(f"{file.id}: {file.filename} ({file.bytes} bytes)")
```

### 获取文件信息

```python
file_info = client.files.retrieve(file_id="file-xxxxx")
print(f"文件名: {file_info.filename}")
print(f"大小: {file_info.bytes}")
print(f"创建时间: {file_info.created_at}")
```

### 删除文件

```python
client.files.delete(file_id="file-xxxxx")
print("文件已删除")
```

## 完整示例：大视频文件处理

```python
def process_large_video(video_path, prompt="描述这个视频"):
    """处理大视频文件"""
    
    # 1. 上传视频
    print(f"上传视频: {video_path}")
    with open(video_path, "rb") as f:
        video_file = client.files.create(file=f, purpose="vision")
    
    print(f"上传完成，文件ID: {video_file.id}")
    
    # 2. 使用文件ID进行理解
    print("分析视频内容...")
    response = client.chat.completions.create(
        model="kimi-k2.5",
        messages=[{
            "role": "user",
            "content": [
                {
                    "type": "video_url",
                    "video_url": {"url": f"ms://{video_file.id}"}
                },
                {"type": "text", "text": prompt}
            ]
        }]
    )
    
    result = response.choices[0].message.content
    
    # 3. 可选：删除文件
    # client.files.delete(file_id=video_file.id)
    
    return result

# 使用
result = process_large_video("large_video.mp4", "总结视频的主要内容")
print(result)
```

## 注意事项

1. **文件大小限制**: 单个文件最大 100MB
2. **文件有效期**: 上传的文件有有效期，过期后需重新上传
3. **purpose 参数**: 
   - `vision`: 用于视觉理解
   - `file-extract`: 用于文本提取
4. **推荐使用场景**: 大文件、需要多次引用的文件、视频文件

## Base64 vs 文件ID 对比

| 方式 | 适用场景 | 优点 | 缺点 |
|:---|:---|:---|:---|
| **Base64** | 小文件、一次性使用 | 简单直接 | 请求体大、编码开销 |
| **文件ID** | 大文件、多次引用 | 请求体小、可复用 | 需要上传步骤 |
