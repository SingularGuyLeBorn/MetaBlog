# 11-æŸ¥è¯¢ä½™é¢

æ¥æºï¼šhttps://platform.moonshot.cn/docs/api/balance

## æ¥å£ä¿¡æ¯

```
GET https://api.moonshot.cn/v1/users/me/balance
```

## å“åº”å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å•ä½ |
|:---|:---|:---|:---|
| `available_balance` | float | å¯ç”¨ä½™é¢ï¼ˆç°é‡‘+ä»£é‡‘åˆ¸ï¼‰ | äººæ°‘å¸å…ƒï¼ˆCNYï¼‰ |
| `voucher_balance` | float | ä»£é‡‘åˆ¸ä½™é¢ | äººæ°‘å¸å…ƒï¼ˆCNYï¼‰ |
| `cash_balance` | float | ç°é‡‘ä½™é¢ | äººæ°‘å¸å…ƒï¼ˆCNYï¼‰ |

> **æ³¨æ„**: 
> - `available_balance <= 0` æ—¶ï¼Œç”¨æˆ·ä¸å¯è°ƒç”¨æ¨ç† API
> - `cash_balance` å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œä»£è¡¨ç”¨æˆ·æ¬ è´¹
> - å½“ `cash_balance` ä¸ºè´Ÿæ•°æ—¶ï¼Œ`available_balance` = `voucher_balance`

## æŸ¥è¯¢ä½™é¢

### ä½¿ç”¨ curl

```bash
curl https://api.moonshot.cn/v1/users/me/balance \
  -H "Authorization: Bearer $MOONSHOT_API_KEY"
```

### ä½¿ç”¨ Python

```python
import requests
import os

api_key = os.environ.get("MOONSHOT_API_KEY")

response = requests.get(
    "https://api.moonshot.cn/v1/users/me/balance",
    headers={"Authorization": f"Bearer {api_key}"}
)

result = response.json()

if result.get("status"):
    data = result["data"]
    print(f"å¯ç”¨ä½™é¢: Â¥{data['available_balance']:.2f}")
    print(f"ä»£é‡‘åˆ¸ä½™é¢: Â¥{data['voucher_balance']:.2f}")
    print(f"ç°é‡‘ä½™é¢: Â¥{data['cash_balance']:.2f}")
else:
    print(f"æŸ¥è¯¢å¤±è´¥: {result}")
```

## å“åº”ç¤ºä¾‹

```json
{
  "code": 0,
  "data": {
    "available_balance": 49.58894,
    "voucher_balance": 46.58893,
    "cash_balance": 3.00001
  },
  "scode": "0x0",
  "status": true
}
```

## å®Œæ•´å°è£…

```python
import requests
from datetime import datetime

class BalanceChecker:
    def __init__(self, api_key):
        self.api_key = api_key
        self.endpoint = "https://api.moonshot.cn/v1/users/me/balance"
    
    def check(self):
        """æŸ¥è¯¢ä½™é¢"""
        response = requests.get(
            self.endpoint,
            headers={"Authorization": f"Bearer {self.api_key}"}
        )
        
        result = response.json()
        
        if not result.get("status"):
            raise Exception(f"æŸ¥è¯¢å¤±è´¥: {result}")
        
        return result["data"]
    
    def check_with_alert(self, threshold=10.0):
        """
        æŸ¥è¯¢ä½™é¢å¹¶æ£€æŸ¥æ˜¯å¦ä½äºé˜ˆå€¼
        
        Args:
            threshold: å‘Šè­¦é˜ˆå€¼ï¼ˆå…ƒï¼‰
        
        Returns:
            dict: ä½™é¢ä¿¡æ¯å’Œå‘Šè­¦çŠ¶æ€
        """
        data = self.check()
        
        available = data["available_balance"]
        voucher = data["voucher_balance"]
        cash = data["cash_balance"]
        
        alert = available <= threshold
        can_call_api = available > 0
        
        return {
            "available_balance": available,
            "voucher_balance": voucher,
            "cash_balance": cash,
            "below_threshold": alert,
            "can_call_api": can_call_api,
            "timestamp": datetime.now().isoformat()
        }
    
    def print_balance(self):
        """æ‰“å°ä½™é¢ä¿¡æ¯"""
        data = self.check()
        
        print("=" * 50)
        print("Kimi API è´¦æˆ·ä½™é¢")
        print("=" * 50)
        print(f"ğŸ’° å¯ç”¨ä½™é¢: Â¥{data['available_balance']:.2f}")
        print(f"ğŸ« ä»£é‡‘åˆ¸ä½™é¢: Â¥{data['voucher_balance']:.2f}")
        print(f"ğŸ’µ ç°é‡‘ä½™é¢: Â¥{data['cash_balance']:.2f}")
        
        if data['available_balance'] <= 0:
            print("\nâš ï¸ è­¦å‘Š: ä½™é¢ä¸è¶³ï¼Œæ— æ³•è°ƒç”¨ API")
        elif data['available_balance'] < 10:
            print("\nâš ï¸ æé†’: ä½™é¢è¾ƒä½ï¼Œå»ºè®®å……å€¼")
        else:
            print("\nâœ… ä½™é¢å……è¶³")
        
        print("=" * 50)

# ä½¿ç”¨
checker = BalanceChecker(api_key="your-api-key")

# ç®€å•æŸ¥è¯¢
data = checker.check()
print(f"å¯ç”¨ä½™é¢: Â¥{data['available_balance']:.2f}")

# å¸¦å‘Šè­¦æ£€æŸ¥
result = checker.check_with_alert(threshold=20.0)
if result["below_threshold"]:
    print(f"âš ï¸ ä½™é¢ä½äº Â¥20ï¼Œå½“å‰: Â¥{result['available_balance']:.2f}")

# æ‰“å°å®Œæ•´ä¿¡æ¯
checker.print_balance()
```

## ä¸ Token è®¡ç®—ç»“åˆ

```python
class CostManager:
    def __init__(self, api_key):
        self.api_key = api_key
        self.balance_checker = BalanceChecker(api_key)
        self.token_estimator = TokenEstimator(api_key)
    
    def can_afford(self, model, messages, max_output_tokens=2000):
        """
        æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿæ‰§è¡Œè¯·æ±‚
        
        Returns:
            dict: åŒ…å«æ˜¯å¦å¯ä»¥æ‰§è¡Œã€é¢„ä¼°æˆæœ¬ç­‰ä¿¡æ¯
        """
        # æŸ¥è¯¢ä½™é¢
        balance = self.balance_checker.check()
        available = balance["available_balance"]
        
        if available <= 0:
            return {
                "can_afford": False,
                "reason": "ä½™é¢ä¸è¶³",
                "available": available
            }
        
        # ä¼°ç®— Token
        try:
            input_tokens = self.token_estimator.estimate(model, messages)
        except Exception as e:
            return {
                "can_afford": False,
                "reason": f"Token ä¼°ç®—å¤±è´¥: {e}",
                "available": available
            }
        
        # ä¼°ç®—æˆæœ¬
        cost = estimate_cost(model, input_tokens, max_output_tokens)
        
        can_afford = available > cost["total_cost"]
        
        return {
            "can_afford": can_afford,
            "available": available,
            "estimated_cost": cost["total_cost"],
            "input_tokens": input_tokens,
            "reason": None if can_afford else "é¢„ä¼°æˆæœ¬è¶…è¿‡ä½™é¢"
        }

# ä½¿ç”¨
manager = CostManager(api_key="your-api-key")

messages = [{"role": "user", "content": "ä½ å¥½"}]
result = manager.can_afford("kimi-k2.5", messages, max_output_tokens=1000)

if result["can_afford"]:
    print(f"âœ… å¯ä»¥æ‰§è¡Œï¼Œé¢„ä¼°æˆæœ¬: Â¥{result['estimated_cost']:.6f}")
else:
    print(f"âŒ æ— æ³•æ‰§è¡Œ: {result['reason']}")
    print(f"   å¯ç”¨ä½™é¢: Â¥{result['available']:.2f}")
```
