# 04-工具调用

来源：https://platform.moonshot.cn/docs/api/tool-use

## 工具定义规范

| 字段 | 要求 | 说明 |
|:---|:---|:---|
| `type` | 必需 | 必须为 `"function"` |
| `name` | 必需 | 符合正则 `^[a-zA-Z_][a-zA-Z0-9-_]{0,63}$` |
| `description` | 推荐 | 清晰描述功能，帮助模型选择 |
| `parameters` | 必需 | JSON Schema 子集，root 必须是 `object` |
| **工具数量** | - | 最多 128 个 |

## 基础工具调用

```python
from openai import OpenAI
import json

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.moonshot.cn/v1",
)

# 定义工具
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "获取指定城市的天气信息",
            "parameters": {
                "type": "object",
                "properties": {
                    "city": {"type": "string", "description": "城市名称"}
                },
                "required": ["city"]
            }
        }
    }
]

# 调用
response = client.chat.completions.create(
    model="kimi-k2-turbo-preview",
    messages=[{"role": "user", "content": "北京天气如何？"}],
    tools=tools,
    tool_choice="auto"  # auto / none / 指定工具
)

# 检查是否需要调用工具
message = response.choices[0].message

if message.tool_calls:
    print(f"需要调用工具: {message.tool_calls[0].function.name}")
    print(f"参数: {message.tool_calls[0].function.arguments}")
else:
    print(f"直接回答: {message.content}")
```

## 完整工具调用流程

```python
# 步骤 1: 第一次调用
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "获取天气",
            "parameters": {
                "type": "object",
                "properties": {"city": {"type": "string"}},
                "required": ["city"]
            }
        }
    }
]

messages = [{"role": "user", "content": "北京天气如何？"}]

response = client.chat.completions.create(
    model="kimi-k2-turbo-preview",
    messages=messages,
    tools=tools
)

assistant_message = response.choices[0].message
messages.append(assistant_message)

# 步骤 2: 执行工具
if assistant_message.tool_calls:
    tool_call = assistant_message.tool_calls[0]
    
    # 实际执行工具（这里模拟）
    city = json.loads(tool_call.function.arguments)["city"]
    weather_result = f"{city}今天晴，25°C"
    
    # 步骤 3: 将工具结果返回给模型
    messages.append({
        "role": "tool",
        "tool_call_id": tool_call.id,
        "content": weather_result
    })
    
    # 步骤 4: 获取最终回答
    final_response = client.chat.completions.create(
        model="kimi-k2-turbo-preview",
        messages=messages,
        tools=tools
    )
    
    print(final_response.choices[0].message.content)
```

## 使用思考模型进行多步工具调用

```python
# 多步工具调用场景
tools = [
    {
        "type": "function",
        "function": {"name": "date", "description": "获取当前日期"}
    },
    {
        "type": "function",
        "function": {
            "name": "web_search",
            "description": "搜索网页",
            "parameters": {
                "type": "object",
                "properties": {"query": {"type": "string"}},
                "required": ["query"]
            }
        }
    }
]

messages = [
    {"role": "system", "content": "你是一个助手，负责生成今日新闻报告。"},
    {"role": "user", "content": "请生成今日的新闻报告。"}
]

# 使用 kimi-k2-thinking 进行多步推理
response = client.chat.completions.create(
    model="kimi-k2-thinking",
    messages=messages,
    tools=tools,
    max_tokens=16000,
    temperature=1.0,
    stream=True
)

# 处理流式响应
for chunk in response:
    delta = chunk.choices[0].delta
    
    # 获取思考过程
    reasoning = getattr(delta, "reasoning_content", None)
    if reasoning:
        print(f"[思考] {reasoning}", end="")
    
    # 获取内容
    if delta.content:
        print(delta.content, end="")
    
    # 获取工具调用（流式中也会有 tool_calls）
    if hasattr(delta, "tool_calls") and delta.tool_calls:
        print(f"\n[工具调用] {delta.tool_calls}")
```

## 官方内置工具 - 联网搜索

```python
# 使用官方 $web_search 工具
# 注意：kimi-k2.5 思考模式与 $web_search 不兼容，需先关闭思考
tools = [
    {
        "type": "builtin_function",
        "function": {"name": "$web_search"}
    }
]

response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[{"role": "user", "content": "今天有什么新闻？"}],
    tools=tools,
    extra_body={"thinking": {"type": "disabled"}}  # 关闭思考模式
)

print(response.choices[0].message.content)
```

## 思考模型工具调用注意事项

1. **tool_choice 限制**: thinking 启用时，tool_choice 只能使用 `"auto"` 或 `"none"`
2. **保留 reasoning_content**: 多步调用时必须在上下文中保留 reasoning_content
3. **$web_search 不兼容**: 思考模式与官方联网搜索工具不兼容

```python
# 错误示例：thinking 启用时不能使用指定工具
tool_choice={"type": "function", "function": {"name": "xxx"}}  # ❌ 会报错

# 正确示例
tool_choice="auto"  # ✅
```
