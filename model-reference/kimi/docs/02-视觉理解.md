# 02-视觉理解

## 支持的格式

- **图片**: png、jpeg、webp、gif
- **视频**: mp4、mpeg、mov、avi、x-flv、mpg、webm、wmv、3gpp

## 重要限制

- ⚠️ **仅支持 Base64 编码**，不支持 URL
- 图片分辨率推荐不超过 4K (4096×2160)
- 视频分辨率推荐不超过 2K (2048×1080)
- 请求 Body 大小不超过 100M
- 图片数量无限制（受 Body 大小限制）

## 图片理解示例

```python
from openai import OpenAI
import base64

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.moonshot.cn/v1",
)

# 读取图片并 Base64 编码
image_path = "kimi.png"
with open(image_path, "rb") as f:
    image_data = f.read()

image_url = f"data:image/{image_path.split('.')[-1]};base64,{base64.b64encode(image_data).decode('utf-8')}"

# 调用视觉模型
completion = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[
        {"role": "system", "content": "你是 Kimi。"},
        {
            "role": "user",
            "content": [
                {
                    "type": "image_url",
                    "image_url": {"url": image_url}
                },
                {
                    "type": "text",
                    "text": "请描述图片的内容。"
                }
            ]
        }
    ]
)

print(completion.choices[0].message.content)
```

## 多张图片

```python
# 编码多张图片
image_paths = ["image1.png", "image2.png"]
image_contents = []

for path in image_paths:
    with open(path, "rb") as f:
        data = base64.b64encode(f.read()).decode('utf-8')
        ext = path.split('.')[-1]
        image_contents.append({
            "type": "image_url",
            "image_url": {"url": f"data:image/{ext};base64,{data}"}
        })

# 构建消息
content = image_contents + [{"type": "text", "text": "对比这两张图片"}]

response = client.chat.completions.create(
    model="kimi-k2.5",
    messages=[{"role": "user", "content": content}]
)

print(response.choices[0].message.content)
```

## Token 计算

图片和视频会动态计算 Token，可通过计算 Token 接口预先获取：

```python
# 使用 /v1/tokenize 接口计算
response = client.post(
    "/v1/tokenize",
    json={
        "model": "kimi-k2.5",
        "messages": messages
    }
)
```

> 图片分辨率越高，消耗 Token 越多；视频关键帧越多、分辨率越高，Token 消耗越多。
