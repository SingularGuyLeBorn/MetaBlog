# 05-流式输出

## 基础流式输出

```python
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.moonshot.cn/v1",
)

response = client.chat.completions.create(
    model="kimi-k2-turbo-preview",
    messages=[{"role": "user", "content": "你好"}],
    stream=True
)

for chunk in response:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="", flush=True)
```

## 思考模型流式输出

```python
response = client.chat.completions.create(
    model="kimi-k2-thinking",
    messages=[{"role": "user", "content": "解释量子计算"}],
    stream=True
)

print("思考过程：")
print("-" * 60)

in_content = False

for chunk in response:
    delta = chunk.choices[0].delta
    
    # 获取 reasoning_content
    reasoning = getattr(delta, "reasoning_content", None)
    if reasoning:
        print(reasoning, end="", flush=True)
    
    # content 在 reasoning_content 之后
    if delta.content:
        if not in_content:
            in_content = True
            print("\n\n最终答案：")
            print("-" * 60)
        print(delta.content, end="", flush=True)
```

## 带工具调用的流式输出

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "获取天气",
            "parameters": {
                "type": "object",
                "properties": {"city": {"type": "string"}},
                "required": ["city"]
            }
        }
    }
]

response = client.chat.completions.create(
    model="kimi-k2-thinking",
    messages=[{"role": "user", "content": "北京天气如何？"}],
    tools=tools,
    max_tokens=16000,
    temperature=1.0,
    stream=True
)

for chunk in response:
    delta = chunk.choices[0].delta
    
    # 思考内容
    reasoning = getattr(delta, "reasoning_content", None)
    if reasoning:
        print(f"[思考] {reasoning}", end="")
    
    # 文本内容
    if delta.content:
        print(delta.content, end="")
    
    # 工具调用
    if hasattr(delta, "tool_calls") and delta.tool_calls:
        for tc in delta.tool_calls:
            if tc.function:
                print(f"\n[工具] {tc.function.name}: {tc.function.arguments}")
```

## 流式响应结构说明

```python
# chunk 结构示例
{
    "choices": [{
        "delta": {
            "content": "文本内容",           # 可能为 null
            "reasoning_content": "思考内容",  # 仅思考模型，可能为 null
            "tool_calls": [...]              # 工具调用，可能为 null
        },
        "finish_reason": null  # 或 "stop" / "tool_calls"
    }]
}

# 注意：
# 1. reasoning_content 一定先于 content 出现
# 2. 通过 hasattr/getattr 访问 reasoning_content
# 3. 流式结束时 finish_reason 会被设置
```

## 完整示例：思考+工具+流式

```python
class StreamingChat:
    def __init__(self, client):
        self.client = client
    
    def chat(self, message, model="kimi-k2-thinking", tools=None):
        response = self.client.chat.completions.create(
            model=model,
            messages=[{"role": "user", "content": message}],
            tools=tools,
            max_tokens=16000,
            temperature=1.0,
            stream=True
        )
        
        reasoning_parts = []
        content_parts = []
        tool_calls = []
        
        for chunk in response:
            delta = chunk.choices[0].delta
            
            # 收集思考内容
            reasoning = getattr(delta, "reasoning_content", None)
            if reasoning:
                reasoning_parts.append(reasoning)
                print(f"\033[90m{reasoning}\033[0m", end="", flush=True)  # 灰色
            
            # 收集文本内容
            if delta.content:
                content_parts.append(delta.content)
                print(delta.content, end="", flush=True)
            
            # 收集工具调用
            if hasattr(delta, "tool_calls") and delta.tool_calls:
                tool_calls.extend(delta.tool_calls)
        
        print()  # 换行
        
        return {
            "reasoning": "".join(reasoning_parts),
            "content": "".join(content_parts),
            "tool_calls": tool_calls
        }

# 使用
chat = StreamingChat(client)
result = chat.chat("今天有什么新闻？", tools=[...])
print(f"\n思考长度: {len(result['reasoning'])} 字符")
print(f"回答长度: {len(result['content'])} 字符")
```
