# MetaUniverse 架构修复计划

> **基于架构解剖报告的问题修复**  
> **创建时间**: 2026-02-20  
> **修复范围**: P0 必改项 + P1 重要修复

---

## 📊 修复优先级

```
P0: 必改（影响系统稳定性或数据安全）
P1: 建议改（影响用户体验或系统健壮性）
P2: 可选（增强功能）
```

---

## 🚨 P0 必改项（进行中）

### ✅ P0-1: 实现文件软删除机制 (Trash)
**状态**: ✅ 已完成  
**位置**: `server/routes/files.ts:148`  
**问题**: 删除操作永久删除文件，无恢复机制  
**修复方案**: 
- 创建 `docs/.trash/` 目录
- 删除时移动到 trash，保留原始路径信息
- 添加 30 天自动清理
- 保留删除日志

**预计工时**: 2h

---

### ✅ P0-2: 文件写入后校验 hash
**状态**: ✅ 已完成（与 P0-1 一同实现）  
**位置**: `server/routes/files.ts:126`  
**问题**: 写入成功后未验证文件真实落盘  
**修复方案**:
- 写入后读取文件计算 hash
- 对比写入内容的 hash
- 不一致时抛出错误并清理

**预计工时**: 1h

---

### ✅ P0-3: 技能参数添加严格类型定义
**状态**: ✅ 已完成  
**位置**: `articleSkills.ts:120`  
**问题**: `params: any` 完全无类型，参数缺失时运行时报错  
**修复方案**:
- 为每个技能定义 Params 接口
- 添加参数校验逻辑
- 缺失必需参数时提前返回错误

**预计工时**: 2h

---

### ✅ P0-4: 实体提取移至保存成功后
**状态**: ✅ 已完成  
**位置**: `articleSkills.ts:197`  
**问题**: 实体提取在文件保存前，保存失败造成数据不一致  
**修复方案**:
- 调整执行顺序：保存成功后再提取实体
- 添加事务回滚逻辑

**预计工时**: 0.5h

---

### ✅ P0-5: 实现文件锁机制
**状态**: ✅ 已完成  
**位置**: 全局  
**问题**: 多场景并发编辑同一文件无锁保护  
**修复方案**:
- 实现内存级文件锁管理器
- 文件操作前获取锁
- 操作完成后释放锁
- 添加锁超时机制

**预计工时**: 4h

---

## 🔧 P1 重要修复（待开始）

### ⏳ P1-1: 意图匹配添加否定词检测
**状态**: 待修复  
**位置**: `IntentRouter.ts:116`  
**问题**: "不要写文章" 会误匹配 `WRITE_ARTICLE`  
**修复方案**:
- 添加否定词列表（不、别、不要、不能等）
- 匹配前检测否定词
- 否定意图置信度降低或返回询问

**预计工时**: 1h

---

### ⏳ P1-2: Memory 文件化持久化
**状态**: 待修复  
**位置**: `memory/index.ts`  
**问题**: Memory 使用内存存储，页面刷新后丢失  
**修复方案**:
- 实现 FileSystemMemoryAdapter
- 实体、任务、会话持久化到 JSON 文件
- 启动时自动加载

**预计工时**: 6h

---

### ⏳ P1-3: 编辑器添加 localStorage 备份
**状态**: 待修复  
**位置**: `VditorEditor.vue:78`  
**问题**: 页面刷新后未保存内容丢失  
**修复方案**:
- 添加防抖自动备份（5秒间隔）
- 使用 `localStorage.setItem('vditor-backup:${path}', content)`
- 编辑器初始化时恢复备份
- 保存成功后清理备份

**预计工时**: 2h

---

### ⏳ P1-4: 统一日志格式
**状态**: 待修复  
**位置**: 全局  
**问题**: 服务端和前端日志格式不统一  
**修复方案**:
- 前端使用 Winston Browser 格式
- 统一包含 traceId/sessionId
- 文件操作日志关联到 Agent 任务

**预计工时**: 4h

---

## 📈 修复进度追踪

```
P0 进度: [██████████] 100% (5/5) ✅
P1 进度: [██████████] 100% (4/4) ✅
总体进度: [██████████] 100% (9/9) ✅
```

---

## 📝 修复日志

### 2026-02-20 - 修复进行中
- ✅ 创建架构修复计划文档
- ✅ P0-1: 文件软删除机制实现
  - 创建 `docs/.trash/` 目录存储被删除文件
  - 实现软删除逻辑：文件移至 trash，保留 30 天
  - 添加回收站索引管理 (`index.json`)
  - 实现恢复功能（支持重命名冲突处理）
  - 添加永久删除选项
  - 前端 API 客户端更新，支持所有 trash 操作
- ✅ P0-2: 文件写入后校验 hash（与 P0-1 一同实现）
  - 写入后计算文件 hash 并对比
  - hash 不匹配时自动清理并返回错误
  - 批量保存同样支持 hash 校验
- ✅ P0-3: 技能参数添加严格类型定义
  - 为所有技能定义严格的 TypeScript 接口
  - 添加参数校验辅助函数 `validateRequiredParams`
  - 添加类型安全辅助函数 `safeString`, `safeStringArray`
  - 缺失必需参数时提前返回错误
- ✅ P0-4: 实体提取移至保存成功后
  - 调整 `CreateArticleSkill` 执行顺序
  - 文件保存成功后才提取实体
  - 实体提取失败不影响主流程（仅记录警告）
- ✅ P0-5: 实现文件锁机制
  - 创建前端 `FileLockManager` 类
  - 服务端 `FileLockManager` 类（集成在 files.ts）
  - 锁超时自动释放（5分钟）
  - 任务结束时自动释放所有关联锁
  - SkillContext 添加 fileLock 接口
- ✅ P1-1: 意图匹配添加否定词检测
  - 添加否定词列表（中英文）
  - 检测否定词是否在关键动词附近
  - 检测到否定时降级为问答意图
- ✅ P1-3: 编辑器添加 localStorage 备份
  - 5秒间隔自动备份
  - 启动时检测并提示恢复
  - 保存成功后清理备份
  - 用户拒绝恢复时清理备份
- ✅ P1-2: Memory 文件化持久化
  - 创建 FileStorage 通用文件存储类
  - EntityManager 文件化
  - TaskManager 文件化
  - SessionManager 文件化
  - 数据存储位置：`.vitepress/agent/memory/data/`
  - 自动限制数据数量（实体无限制，任务1000，会话50）
  - 会话自动清理（7天未活跃）
- ✅ P1-4: 统一日志格式
  - 创建 UnifiedLogger 统一日志类
  - 结构化 JSON 格式
  - 支持 traceId / sessionId / taskId 追踪
  - 文件操作特殊标记
  - 分级日志输出
  - 性能指标记录

---

## 🎉 所有修复完成

所有 P0 级别（必改）问题已修复完成！

**已修复问题**: 5/5
- ✅ 文件软删除机制
- ✅ 文件写入 hash 校验
- ✅ 技能参数严格类型
- ✅ 实体提取顺序调整
- ✅ 文件锁机制

**建议继续修复**: P1 级别问题（可选）

---

## 🔗 相关文档

- [架构解剖报告](../architecture/overview.md)
- [开发进度追踪](./development-progress.md)
