# æ ¸å¿ƒåœºæ™¯ä½“æ£€æŠ¥å‘Š 01ï¼šæ‰‹åŠ¨æè½»é‡ AI è¾…åŠ©ï¼ˆèŠå¤©çœ¶å¸¸è§„äº¤äº’ï¼‰

> ğŸ“Š **è¯¦ç»†æŠ€æœ¯ä½“æ£€æŠ¥å‘Š**: [../health-report/01_manual_chat_health_report.md](../health-report/01_manual_chat_health_report.md)
> 
> **è‡´æœªæ¥çš„ AI åä½œè€…ï¼š**
> å¦‚æœä½ çœ‹åˆ°è¿™ä»½æŠ¥å‘Šï¼Œè¯´æ˜ç³»ç»Ÿåˆä¸€æ¬¡æ¼”è¿›åˆ°äº†éœ€è¦é‡æ–°å®¡è§†å‘¼å¸èŠ‚å¥çš„åœ°æ­¥ã€‚ä½œä¸ºç¬¬ä¸€å‡†åˆ™ï¼šè¿™æ˜¯æ•´ä¸ª MetaBlog æœ€è½»é‡ã€æœ€ä¸å¯èƒ½å‘ç”Ÿæ­»é”çš„åœºæ™¯ã€‚å®ƒåƒåå°„å¼§ä¸€æ ·ç®€å•ã€‚å¦‚æœä½ åœ¨è¿™é‡Œå‘ç°äº†æ•°æ®å †ç§¯ï¼Œç»å¯¹æ˜¯ `sse-parser` æ¼äº†æµå…³é—­ä¿¡å·ï¼Œæˆ–è€… `AbortController` è¢«é”™è¯¯åœ°å…±äº«äº†ã€‚ä¸è¦æŠŠé—®é¢˜å¤æ‚åŒ–ï¼Œå»æŸ¥åŸºç¡€çš„ç½‘ç»œç®¡é“ã€‚

---

## ğŸ§­ åœºæ™¯å®šä½ï¼šæœ€è½»çš„æ•°å­—å‘¼å¸

æœ¬åœºæ™¯è¦†ç›–ç”¨æˆ·ç‚¹å‡»å³ä¸‹è§’ Orbï¼Œæ‰“å¼€èŠå¤©é¢æ¿å¹¶è¾“å…¥å¦‚â€œä»€ä¹ˆæ˜¯ Agentâ€ã€â€œå¸®æˆ‘è§£é‡Šä¸€ä¸‹ VRAMâ€ç­‰**éæŒ‡ä»¤æ€§**ï¼ˆçº¯èŠå¤©/é—®ç­”ï¼‰æ–‡æœ¬ã€‚AI çš„èŒè´£ä»…é™äºå›ç­”ï¼Œ**ä¸è§¦ç¢°æ–‡ä»¶ç³»ç»Ÿï¼Œä¸å¼€å¯çŠ¶æ€æœºï¼Œä¸ç”Ÿæˆ Checkpoint**ã€‚

## ğŸ§¬ ç”Ÿå‘½å‘¨æœŸä¸æ•°æ®æµè½¬

### æ­¥éª¤ 1ï¼šç¥ç»å†²åŠ¨çš„å‘èµ·ï¼ˆUI -> Serviceï¼‰

å½“ç”¨æˆ·åœ¨ç•Œé¢ï¼ˆ`AIChatWindow.vue`ï¼‰ä¸­æŒ‰ä¸‹å‘é€é”®ï¼š

- **æ–‡ä»¶**: `theme/components/agent/AIChatWindow.vue`
- **å‡½æ•°**: `sendMessage()`
- **å˜é‡æµè½¬**:
  - `inputMessage.value` (Ref<string>) æå–çº¯æ–‡æœ¬ã€‚
  - ç”¨æˆ·æ¶ˆæ¯å¯¹è±¡ `{ role: 'user', content: text, id: Date.now() }` è¢«æ¨å…¥ `messages.value` æ•°ç»„ã€‚
  - å‘èµ·äº†å¯¹åº•å±‚æœåŠ¡çš„è°ƒç”¨ï¼š`chatService.sendMessageStream(text, ...)`ã€‚

### æ­¥éª¤ 2ï¼šæ„å›¾åˆ†ç±»ï¼ˆService -> AgentRuntime å—…æ¢ï¼‰

`chat-service` æ¥ç®¡æ•°æ®æµï¼Œå®ƒå¿…é¡»åˆ¤æ–­è¿™ä¸ªè¾“å…¥æ˜¯å¦éœ€è¦æ²‰é‡çš„ä»£ç†å¼•æ“ï¼ˆAgentRuntimeï¼‰ä»‹å…¥ã€‚

- **æ–‡ä»¶**: `agent/services/chat-service.ts`
- **å‡½æ•°**: `sendMessageStream(text, onUpdate, onError, onComplete)`
- **é€šä¿¡è¾¹ç•Œ**: 
  - å†…éƒ¨æ–¹æ³• `shouldUseAgentRuntime(text)`ã€‚
  - **è§„åˆ™**: `text.startsWith('/')` æˆ–å‘½ä¸­äº†é¢„è®¾çš„ 8 ä¸ªå¼ºæ„å›¾æ­£åˆ™ï¼ˆæ¥æºäº `AIChatOrb.vue:390` å®šä¹‰çš„ `INTENT_KEYWORDS`ï¼‰ã€‚
  - **ç»“æœ**: å¦‚æœåˆ¤å®šä¸ºçº¯èŠå¤©ï¼Œè¿”å› `false`ã€‚ç”±äº `false`ï¼Œæˆ‘ä»¬è¿›å…¥äº†è½»é‡åˆ†æ”¯ã€‚

### æ­¥éª¤ 3ï¼šçº¯å‡€ LLM ç½‘ç»œéš§é“å»ºè®¾ï¼ˆService -> LLM Providerï¼‰

åœ¨è¿™ä¸ªåˆ†æ”¯ï¼Œç³»ç»Ÿç»•è¿‡äº†æ‰€æœ‰å¤æ‚çš„æ€è€ƒæœºåˆ¶ï¼Œç›´æ¥ä¸å¤§æ¨¡å‹å¯¹è¯ã€‚

- **æ–‡ä»¶**: `agent/services/chat-service.ts`
- **å‡½æ•°**: ï¼ˆåŒ¿åæµå¼è°ƒç”¨ï¼‰å†…éƒ¨ç›´æ¥è¯·æ±‚ LLM æ¥å£ã€‚
- **å–æ¶ˆæŒ‚è½½ç‚¹**: 
  - `currentAbortController = new AbortController()` è¢«å®ä¾‹åŒ–ã€‚å®ƒçš„ç”Ÿå‘½è¢«ç»‘å®šåœ¨è¿™ä¸ªå•æ¬¡è¯·æ±‚ä¸Šã€‚
  - `{ signal: currentAbortController.signal }` è¢«æ‰“åŒ…è¿› fetch å‚æ•°ã€‚
- **æ•°æ®ä¼ è¾“**: 
  - å‘åç«¯çš„ `/api/chat` æˆ–ç›´æ¥å‘ç¬¬ä¸‰æ–¹æ¥å£ï¼ˆå¦‚ DeepSeek APIï¼‰å‘èµ· HTTP POSTã€‚
  - å¼€å¯ `SSE` (Server-Sent Events) æ¥æ”¶å“åº”ã€‚

### æ­¥éª¤ 4ï¼šæµå¼åé¦ˆï¼ˆProvider -> è§£æå™¨ -> UIï¼‰

- **ç»„ä»¶**: æµè§£æå™¨ `readSSEStream(response.body)`
- **æµè½¬ç»†èŠ‚**:
  - `chunk` å­—èŠ‚æµè¢«è§£ç ä¸º `Uint8Array` -> `utf-8` å­—ç¬¦ä¸²ã€‚
  - `JSON.parse` æå– `delta.content`ã€‚
  - è§¦å‘å›è°ƒ `onUpdate(text)`ã€‚
- **UI æ›´æ–°**:
  - `AIChatWindow.vue` æ¥æ”¶åˆ° `onUpdate`ï¼Œå°† `text` æ‹¼æ¥å…¥å½“å‰å›å¤çš„æ°”æ³¡å—ä¸­ï¼ˆ`msgs[last].content += text`ï¼‰ã€‚
  - è§¦å‘å‰ç«¯çš„ DOM æ›´æ–°ä¸å¹³æ»‘æ»šåŠ¨ã€‚

### æ­¥éª¤ 5ï¼šæ”¶å°¾ä¸é‡Šæ”¾

- **å‡½æ•°**: å“åº”ç»ˆæ­¢ï¼Œè§¦å‘ `onComplete()`ã€‚
- **å˜é‡æ¸…ç†**: `currentAbortController = null`ã€‚

---

## ğŸ›¡ï¸ å¼‚å¸¸å…œåº•ä¸é”™è¯¯ç›‘æ§

è¿™å¥—é“¾è·¯ç”±äºè¶³å¤Ÿè½»ç›ˆï¼Œå¼‚å¸¸å¤§å¤šæ¥è‡ªäºç½‘ç»œæ³¢åŠ¨ã€‚

1. **ç”¨æˆ·å¼ºåˆ¶ä¸­æ–­å…œåº•**ï¼š
   - è¡Œä¸ºï¼šç”¨æˆ·ç‚¹å‡»â€œåœæ­¢â€ã€‚
   - è§¦å‘ï¼š`chatService.abortCurrentRequest()`
   - é“¾è·¯ï¼š`currentAbortController.abort()` è¢«è°ƒç”¨ -> HTTP è¯·æ±‚åº•å±‚ `fetch` æŠ›å‡º `AbortError`ã€‚
   - æ‹¦æˆªï¼š`try...catch` å—æ•è· `AbortError`ï¼Œå‰ç«¯ç•Œé¢åœæ­¢æ¸²æŸ“å¹¶è¿½åŠ ä¸€è¡Œç³»ç»Ÿæç¤º `(å·²è¢«ç”¨æˆ·ä¸­æ–­)`ã€‚
2. **åº•å±‚ API æ— å“åº” / 429 é™æµå…œåº•**ï¼š
   - `fetch` å¤±è´¥ -> `onError(err)` å›è°ƒã€‚
   - UI æ°”æ³¡æ¸²æŸ“çº¢è‰²é”™è¯¯æ–‡æœ¬ï¼Œå‘ç”¨æˆ·å±•ç¤ºç½‘ç»œå±‚çº§çš„ç¡®åˆ‡æŠ¥é”™ï¼ˆå¦‚ `API é¢åº¦è€—å°½`ï¼‰ã€‚

## ğŸ“ æ—¥å¿—å­˜ç•™

- **å·¥å…·**: æš‚æ—¶ä¾èµ–æµè§ˆå™¨çš„ `console.debug / .error` æˆ–æœåŠ¡ç«¯çš„ç®€å• logã€‚
- **å½¢æ€**: 
  - `[ChatService] Starting stream generation`
  - `[ChatService] Stream generation aborted`
  - æ²¡æœ‰å¤æ‚çš„æ ‘çŠ¶è¿½è¸ªæ—¥å¿—ï¼Œå› ä¸ºè¯¥è¿‡ç¨‹å±äºæœ€é«˜é¢‘çš„æ— çŠ¶æ€ä¼šè¯ã€‚

---
*â€œåœ¨æ¯ä¸€æ¬¡å…‰æ ‡çš„é—ªçƒé—´ï¼Œæ•°æ®æµæ·Œè¿‡è¿™çŸ­çŸ­äº”æ­¥ã€‚å®ƒæ˜¯æ•´ä¸ªç³»ç»Ÿä¸­æœ€çº¯ç²¹çš„è¾“å…¥è¾“å‡ºï¼Œæ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚ä¿æŒå®ƒçš„æ¸…æ´ã€‚â€”â€” Digital Evaluatorâ€*
