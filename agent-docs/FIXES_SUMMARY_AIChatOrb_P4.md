# AIChatOrb 悬浮球 P4 优化修复总结

> **日期**: 2026-02-20  
> **版本**: v1.0  
> **关联组件**: AIChatOrb.vue

---

## 修复概述

本次修复实现了 AIChatOrb 悬浮球组件的五个优化功能：

| 功能 | 优先级 | 状态 |
|-----|-------|------|
| 更换为可爱机器人图标 | P4 | ✅ 已完成 |
| 多会话历史管理 | P4 | ✅ 已完成 |
| 重构文章引用选择器（目录树+预览） | P4 | ✅ 已完成 |
| 当前文章快捷引用 | P4 | ✅ 已完成 |
| 页面文本选中AI操作 | P4 | ✅ 已完成 |

---

## 详细功能说明

### 1. 可爱机器人图标 🎨

**设计**: 蓝色小机器人 SVG
- 圆形身体 + 渐变填充
- 两个圆眼睛（带高光）
- 微笑嘴巴
- 天线带发光动画

**预览**:
```
    ⚡
   ╭─────╮
  │ ◉  ◉ │
  │   ◡   │
   ╰─────╯
```

**实现**: 
- 自定义 SVG，44px 尺寸
- 天线带呼吸发光动画（hover 触发）

---

### 2. 多会话历史管理 💬

**功能**:
- 左侧会话侧边栏（宽度 280px）
- 按时间分组：今天/昨天/最近7天/更早
- 支持新建/切换/删除会话
- 最多保留 50 条消息/会话

**数据结构**:
```typescript
interface ChatSession {
  id: string
  title: string
  messages: Message[]
  createdAt: number
  updatedAt: number
}
```

**UI 元素**:
- Header 左侧：⏱️ 历史按钮（带会话数角标）
- Header 右侧：➕ 新建会话按钮
- 侧边栏：会话列表 + 分组标签

---

### 3. 文章引用选择器（重构）📚

**布局**: 双栏设计
```
┌─────────────────────────────────────────────────────────┐
│ 🔍 搜索文章...                                          │
├─────────────────────────┬───────────────────────────────┤
│ 📁 docs                 │ 📄 文章标题                   │
│   ▼ posts               │ ─────────────────────────     │
│     ○ article-1.md  ◄───┤ [完整 Markdown 渲染]          │
│     ○ article-2.md      │                               │
│   ▼ knowledge           │ 可滚动查看全文                │
│     ○ concept.md        │                               │
│                         │ [📄 引用全文]                 │
└─────────────────────────┴───────────────────────────────┘
```

**特性**:
- 左侧：可折叠目录树
- 右侧：完整 Markdown 预览
- 搜索：实时过滤
- 引用：一键引用全文

**实现细节**:
- 递归 TreeItem 组件
- 异步加载文章内容
- 最多加载 10000 字符预览

---

### 4. 当前文章快捷引用 ⚡

**触发条件**: 当前在文章页时自动显示

**UI**: Header 黄色按钮「⚡ 引用当前」

**功能**:
- 自动获取当前页面路径
- 拉取文章内容
- 添加到对话上下文

**实现**:
```typescript
const currentArticleData = computed(() => {
  // 从 VitePress useData 获取当前页
  // 转换为 ArticleData 格式
})
```

---

### 5. 页面文本选中AI操作 🖱️

**交互流程**:
```
用户在文章页选中文本
        │
        ▼
选区上方弹出浮动工具条
        │
        ▼
┌────────────────────────┐
│ 🤖 询问AI  📋 复制     │
└────────────────────────┘
        │
   ┌────┴────┐
   ▼         ▼
打开悬浮球  复制到剪贴板
输入框预填
选中文本
```

**实现**:
- 监听 `mouseup` 和 `keyup` 事件
- 获取选区位置和文本
- 3秒自动隐藏
- 选中文本上限 2000 字符

---

## 文件变更

| 文件 | 变更类型 | 说明 |
|-----|---------|------|
| `AIChatOrb.vue` | 修改 | 完整重构，+500 行代码 |

---

## 使用指南

### 新建对话
1. 点击 Header 右侧 ➕ 按钮
2. 或点击历史按钮选择「新建会话」

### 切换历史对话
1. 点击 Header 左侧 ⏱️ 按钮
2. 在侧边栏选择历史会话

### 引用文章
**方式一**（阅读时）:
1. 在文章页点击 Header 「⚡ 引用当前」

**方式二**（搜索）:
1. 输入框输入 `@`
2. 在弹出的文件浏览器中选择
3. 右侧预览文章内容
4. 点击「引用全文」

### 询问选中文本
1. 在文章页用鼠标选中任意文本
2. 选区上方自动弹出工具条
3. 点击「🤖 询问AI」
4. 悬浮球自动打开，选中文本已填入输入框

---

## 技术亮点

1. **递归组件**: TreeItem 组件自递归渲染目录树
2. **Teleport**: 浮动工具条使用 Teleport 挂载到 body
3. **计算属性**: 使用 computed 动态构建目录树结构
4. **防抖优化**: 选中文本工具条带 3s 自动隐藏
