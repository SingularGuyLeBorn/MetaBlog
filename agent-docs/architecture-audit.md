# MetaBlog AI-Native ç³»ç»Ÿæ¶æ„è§£å‰–æŠ¥å‘Š

> **è¯„ä¼°å¯¹è±¡**: MetaUniverse äº”å±‚ Agent åšå®¢ç³»ç»Ÿ  
> **æ–‡æ¡£ç‰ˆæœ¬**: 2026-02-20  
> **è¯„ä¼°ç­–ç•¥**: æç«¯é˜²å¾¡æ€§è§†è§’ï¼ˆProduction-Grade, Zero-Toleranceï¼‰

---

## ç¬¬ä¸€é˜¶æ®µï¼šæ¶æ„æ˜ å°„ï¼ˆArchitecture Mappingï¼‰

### åœºæ™¯ 1ï¼šæ‰‹åŠ¨å†™ä½œæ¨¡å¼

**ç»„ä»¶æ¸…å•**:

| å±‚çº§ | ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ |
|------|------|----------|
| L5 Frontend | `GlobalPageEditorAGI.vue` | `.vitepress/theme/components/agent/GlobalPageEditorAGI.vue` |
| L5 Frontend | `AIChatOrb.vue` | `.vitepress/theme/components/agent/AIChatOrb.vue`ï¼ˆMANUAL ä¸‹éšè—ï¼‰|
| L5 Frontend | Vditor ç¼–è¾‘å™¨å®ä¾‹ | å†…åµŒåœ¨ `GlobalPageEditorAGI.vue` |
| L3 å·¥å…· | `GitOperator` | `.vitepress/agent/tools/GitOperator.ts`ï¼ˆâŒ æœªå®ç°ï¼‰|
| BFF API | `POST /api/files/save` | `server/routes/`ï¼ˆâŒ å¾…å®ç°ï¼‰|
| BFF API | `POST /api/git/commit` | `server/routes/git.ts`ï¼ˆâŒ å¾…å®ç°ï¼‰|
| L1 å­˜å‚¨ | æ–‡ä»¶ç³»ç»Ÿ `/docs/` | ç‰©ç†ç›®å½• |
| L1 å­˜å‚¨ | Git ä»“åº“ `.git/` | ç‰©ç† Git ä»“åº“ |
| L2 è¿è¡Œæ—¶ | `Logger` | `.vitepress/agent/runtime/Logger.ts` |
| æµè§ˆå™¨ç¼“å­˜ | `localStorage` | æµè§ˆå™¨æœ¬åœ°ï¼Œè‡ªåŠ¨ä¿å­˜è‰ç¨¿ |

**API è°ƒç”¨é“¾**:

```
ç”¨æˆ·è§¦å‘ Ctrl+S
  â†’ Vditor.onChange() å†™å…¥ localStorageï¼ˆå®æ—¶è‰ç¨¿ï¼‰
  â†’ å‰ç«¯: POST /api/files/save
      Body: { path: 'posts/tech/ai/llm-basics.md', content: string }
    â†’ server: å†™å…¥æ–‡ä»¶ç³»ç»Ÿ fs.writeFile(path, content)
    â†’ server: simpleGit().add(path).commit(message)
  â† Response: { success: true }
  â†’ å‰ç«¯: çŠ¶æ€æ æ˜¾ç¤ºã€Œä¿å­˜æˆåŠŸã€
```

**è·¨ç»„ä»¶æ•°æ®ç»“æ„**:

```typescript
// å‰ç«¯ â†’ åç«¯ /api/files/save
interface SaveFileRequest {
  path: string      // ç›¸å¯¹äº docs/ çš„è·¯å¾„
  content: string   // Markdown åŸæ–‡
}

// åç«¯ â†’ Git
interface GitCommitOptions {
  path: string
  message: string   // "content: æ›´æ–°LLMåŸºç¡€æ¦‚å¿µ"
  author?: { name: string; email: string }
}
```

**é€šä¿¡æœºåˆ¶**: HTTP RESTï¼ˆåŒæ­¥ï¼‰+ localStorageï¼ˆæµè§ˆå™¨ç«¯å¼‚æ­¥è‰ç¨¿ï¼‰

---

### åœºæ™¯ 2ï¼šAI è¢«åŠ¨åˆ›ä½œï¼ˆHuman-Triggered AIï¼‰

**ç»„ä»¶æ¸…å•**:

| å±‚çº§ | ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ |
|------|------|----------|
| L5 Frontend | `AIChatOrb.vue` | `.vitepress/theme/components/agent/AIChatOrb.vue` |
| L4 ç¼–æ’ | `AgentRuntime.processInput()` | `.vitepress/agent/core/AgentRuntime.ts` |
| L4 ç¼–æ’ | `IntentRouter.parse()` | `.vitepress/agent/core/IntentRouter.ts` |
| L4 ç¼–æ’ | `StateMachine` | `.vitepress/agent/core/StateMachine.ts` |
| L4 ç¼–æ’ | `SkillEngine.execute()` | `.vitepress/agent/skills/SkillEngine.ts` |
| L4 æŠ€èƒ½ | `WriteArticleSkill` | `.vitepress/agent/skills/WriteArticleSkill.ts` |
| L4 ç¼–æ’ | `MemoryManager.buildContext()` | `.vitepress/agent/memory/MemoryManager.ts` |
| L3 å·¥å…· | `WebSearch` | âŒ æœªå®ç° |
| L3 å·¥å…· | `GitOperator.commitAsAgent()` | âŒ æœªå®ç° |
| L2 è¿è¡Œæ—¶ | `LLMManager.chatStream()` | `.vitepress/agent/llm/LLMManager.ts` |
| L2 è¿è¡Œæ—¶ | `CostTracker` | `.vitepress/agent/runtime/CostTracker.ts` |
| L1 å­˜å‚¨ | æ–‡ä»¶ç³»ç»Ÿ `/docs/` | ç‰©ç†ç›®å½• |
| L1 å­˜å‚¨ | Agent è®°å¿†åº“ `.vitepress/memory/` | JSON æ–‡ä»¶ï¼ˆâš ï¸ éƒ¨åˆ†ä»åœ¨ localStorageï¼‰|

**API è°ƒç”¨é“¾**:

```
ç”¨æˆ·ç‚¹å‡» AIChatOrbï¼Œè¾“å…¥æŒ‡ä»¤ "å†™ä¸€ç¯‡å…³äºå‘é‡æ•°æ®åº“çš„æ–‡ç« "
  â†’ AIChatOrb.sendMessage(input)
  â†’ AgentRuntime.processInput(input, { currentFile })
    â†’ IntentRouter.parse(input) 
        â†’ { type: 'WRITE_ARTICLE', confidence: 0.95, params: { topic, targetPath? } }
    â†’ StateMachine.transition('UNDERSTANDING' â†’ 'PLANNING' â†’ 'EXECUTING')
    â†’ SkillEngine.execute('WriteArticle', ctx, params)
      â†’ WriteArticleSkill.handler(ctx, params)
          1. MemoryManager.buildContext(topic)       # RAG å…³é”®è¯æ£€ç´¢
          2. WebSearch.search(topic)                 # âŒ æœªå®ç°ï¼ˆåº”æœ‰é™çº§é€»è¾‘ï¼‰
          3. LLMManager.chatStream(outlinePrompt)    # ç”Ÿæˆå¤§çº²
          4. LLMManager.chatStream(contentPrompt)   # ç”Ÿæˆæ­£æ–‡ï¼ˆæµå¼æ¨é€åˆ° UIï¼‰
          5. decideTargetPath(topic, memory)        # è·¯å¾„å†³ç­–
          6. FileSystem.saveFile(finalPath, content) # å†™å…¥æ–‡ä»¶
          7. GitOperator.commitAsAgent(params)       # âŒ æœªå®ç°
          8. MemoryManager.extractEntitiesFromContent(content) # å®ä½“æå–å…¥åº“
  â† æµå¼ç»“æœæ¨é€è‡³ AIChatOrb
  â†’ UI æ˜¾ç¤ºã€Œæ–‡ç« åˆ›ä½œå®Œæˆã€ä»¥åŠ [æŸ¥çœ‹æ–‡ç« ] æŒ‰é’®
```

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```typescript
// IntentRouter è¾“å‡º
interface ParsedIntent {
  type: 'WRITE_ARTICLE' | 'EDIT_CONTENT' | 'SEARCH' | ...
  confidence: number         // 0-1 ç½®ä¿¡åº¦
  parameters: {
    topic?: string
    targetPath?: string
    sources?: ('internal' | 'web')[]
    style?: string
  }
  raw: string
}

// WriteArticleSkill è¿”å›
interface SkillResult {
  success: boolean
  data?: { path: string; wordCount: number }
  tokensUsed: number
  cost: number
}
```

**é€šä¿¡æœºåˆ¶**: ç›´æ¥å‡½æ•°è°ƒç”¨ï¼ˆL5 â†’ L4 â†’ L2ï¼‰+ å†…å­˜äº‹ä»¶æ€»çº¿ï¼ˆæµå¼è¾“å‡ºå›è°ƒï¼‰+ HTTP RESTï¼ˆå†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼‰

---

### åœºæ™¯ 3ï¼šAI ä¸»åŠ¨åˆ›ä½œï¼ˆAgent-Autonomousï¼‰

**ç»„ä»¶æ¸…å•**:

| å±‚çº§ | ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ |
|------|------|----------|
| è§¦å‘å±‚ | GitHub Actions Cron | `.github/workflows/agent-cron.yml` |
| è§¦å‘å±‚ | `scripts/agent-cron.ts` | `scripts/agent-cron.ts` |
| L4 ç¼–æ’ | `AgentRuntime`ï¼ˆheadless æ¨¡å¼ï¼‰| `.vitepress/agent/core/AgentRuntime.ts` |
| L4 ç¼–æ’ | `Scheduler`ï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰| âŒ æœªå®ç° |
| L4 æŠ€èƒ½ | `FeedMonitor`ï¼ˆä¿¡æºç›‘å¬ï¼‰| âŒ æœªå®ç° |
| L4 è¯„ä¼° | `ContentEvaluator` | âŒ æœªå®ç° |
| L4 æŠ€èƒ½ | `WriteArticleSkill`ï¼ˆå¤ç”¨åœºæ™¯2ï¼‰| `.vitepress/agent/skills/WriteArticleSkill.ts` |
| L4 å‘å¸ƒ | `AutoPublisher` | âŒ æœªå®ç° |
| L3 å·¥å…· | `WebSearch`ï¼ˆArxiv/RSSï¼‰| âŒ æœªå®ç° |
| L3 å·¥å…· | `GitOperator.push()` | âŒ æœªå®ç° |
| L2 è¿è¡Œæ—¶ | `CostTracker`ï¼ˆæ¯æ—¥ç†”æ–­ï¼‰| `.vitepress/agent/runtime/CostTracker.ts` |
| L1 å­˜å‚¨ | æ–‡ä»¶ç³»ç»Ÿ `/docs/` | ç‰©ç†ç›®å½• |
| L1 å­˜å‚¨ | ä»»åŠ¡çŠ¶æ€è®°å½• | `.vitepress/memory/tasks/` |

**API è°ƒç”¨é“¾**:

```
GitHub Actions Cron è§¦å‘ (0 9 * * 1)
  â†’ scripts/agent-cron.ts main()
      â†’ loadCronConfig('.agent/config/cron-tasks.yaml')
      â†’ AgentRuntime.getInstance({ mode: 'AGENT', headless: true })
      â†’ agent.initialize()
      â†’ for each task in config.tasks:
          if shouldRun(task):
            â†’ FeedMonitor.collect(task.source)    # âŒ æœªå®ç°
              â†’ fetchArxiv(query) / fetchRSS(feeds)
            â†’ ContentEvaluator.evaluate(item)     # âŒ æœªå®ç°
              â†’ findSimilar(item)                 # å»é‡æ£€æŸ¥
              â†’ assessQuality(item)               # LLM è´¨é‡è¯„ä¼°
              â†’ assessRelevance(item)             # LLM ç›¸å…³æ€§è¯„ä¼°
              â†’ decideLocation(category)          # è·¯å¾„å†³ç­–
            â†’ generateFromFeed(agent, item, evaluation)
              â†’ WriteArticleSkill.handler(ctx, params)
            â†’ AutoPublisher.publish(path, config) # âŒ æœªå®ç°
              â†’ commitAndPush(path) / saveAsDraft(path)
              â†’ notifyComplete()
  â†’ GitHub Actions: git push (è„šæœ¬å†…å« git add/commit/push)
```

**é€šä¿¡æœºåˆ¶**: æ—  UIï¼Œçº¯ Node.js è¿›ç¨‹ï¼›å¤–éƒ¨ HTTPï¼ˆArxiv/RSSï¼‰ï¼›æœ¬åœ° Git æ“ä½œï¼›å¯é€‰ Webhook é€šçŸ¥

---

## ç¬¬äºŒé˜¶æ®µï¼šæ­¥è¿›å¼è¯„ä¼°ï¼ˆStep-by-Step Evaluationï¼‰

### åœºæ™¯ 1 è¯„ä¼°ï¼šæ‰‹åŠ¨å†™ä½œæ¨¡å¼

---

#### Step 1 â€” è‡ªåŠ¨ä¿å­˜åˆ° localStorage

âœ… **Good**:  
`Vditor.onChange()` è§¦å‘çš„ localStorage è‰ç¨¿ä¿å­˜é¢‘ç‡é«˜ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±ï¼Œç¬¦åˆé˜²å´©æºƒé“å¾‹ã€‚è¿™æ˜¯æ‰€æœ‰ Web ç¼–è¾‘å™¨æœ€åŸºç¡€çš„ç¦»çº¿å®¹ç¾æ‰‹æ®µã€‚

âš ï¸ **Bad**:  
`localStorage` çš„ Key å‘½åè§„èŒƒä¸æ˜ç¡®ï¼ˆæ–‡æ¡£æœªè¯´æ˜ï¼‰ã€‚è‹¥ä¸€ç¯‡æ–‡ç« æ”¹å˜äº†è·¯å¾„ï¼ˆé‡å‘½åï¼‰ï¼Œæ—§è·¯å¾„çš„è‰ç¨¿å°†æ°¸ä¹…æ®‹ç•™ï¼Œä¸”æ–°è·¯å¾„ä¸‹ä¸ä¼šåŠ è½½æ­£ç¡®è‰ç¨¿ï¼Œé€ æˆæ•°æ®å¹½çµã€‚**æ›´å±é™©çš„æ˜¯**ï¼šå¤šç«¯ Git åŒæ­¥åœºæ™¯ä¸‹ï¼ŒA ç”µè„‘ `git pull` æ‹¿åˆ°æœ€æ–°æ–‡ä»¶åæ‰“å¼€ç¼–è¾‘å™¨ï¼ŒlocalStorage çš„æ—§è‰ç¨¿ä¼šç«‹åˆ»è¦†ç›–åˆšæ‹‰å–çš„æœ€æ–°å†…å®¹ï¼Œé€ æˆã€Œé™é»˜æ•°æ®å›æ»šã€ã€‚

ğŸ”§ **Fix**:  
localStorage Key å¿…é¡»ç»‘å®š`æ–‡ä»¶è·¯å¾„ + æœ€åä¿®æ”¹æ—¶é—´æˆ³`ï¼ˆ`key = \`draft:${path}:${mtime}\``ï¼‰ã€‚åŠ è½½æ—¶å…ˆè¯»å–æ–‡ä»¶çš„ `mtime`ï¼Œè‹¥ localStorage æ—¶é—´æˆ³ < æ–‡ä»¶ mtimeï¼Œ**å¼ºåˆ¶æç¤ºå†²çª** è€Œéé™é»˜è¦†ç›–ï¼šã€Œæ£€æµ‹åˆ°æ­¤æ–‡ä»¶å·²åœ¨å¤–éƒ¨æ›´æ–°ï¼Œæ˜¯å¦åŠ è½½äº‘ç«¯ç‰ˆæœ¬ï¼ˆæ”¾å¼ƒæœ¬åœ°è‰ç¨¿ï¼‰ï¼Ÿã€

---

#### Step 2 â€” `POST /api/files/save` æ–‡ä»¶å†™å…¥

âœ… **Good**:  
API è¯­ä¹‰æ¸…æ™°ï¼Œ`{ path, content }` çš„è¯·æ±‚ä½“ç»“æ„ç®€å•ã€‚è·¯å¾„ä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¿æŒä¸€è‡´ï¼Œé™ä½äº†é˜»æŠ—å¤±é…ã€‚

âš ï¸ **Bad**:  
1. **è·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆPath Traversalï¼‰**ï¼š`path` å‚æ•°æ²¡æœ‰ä»»ä½•æ²™ç®±æ ¡éªŒã€‚æ¶æ„è¯·æ±‚ `{ path: '../../etc/passwd', content: '...' }` å¯è¦†å†™æœåŠ¡å™¨ä»»æ„æ–‡ä»¶ã€‚  
2. **åŸå­æ€§ç¼ºå¤±**ï¼š`fs.writeFile()` ä¸æ˜¯åŸå­æ“ä½œã€‚å¦‚æœå†™å…¥è¿‡ç¨‹ä¸­è¿›ç¨‹å´©æºƒï¼ˆæ–­ç”µã€OOMï¼‰ï¼Œæ–‡ä»¶å°†å¤„äºåŠå†™çŠ¶æ€ï¼ˆæŸåï¼‰ï¼Œè€Œè°ƒç”¨æ–¹ä¸çŸ¥é“ã€‚  
3. **å†™å…¥æˆåŠŸä½†ç£ç›˜æ»¡**ï¼š`fs.writeFile()` æˆåŠŸ resolved å¹¶ä¸èƒ½ 100% ä¿è¯æ•°æ®è½ç›˜ï¼ˆå†…æ ¸ç¼“å†²åŒºæœª flush æ—¶è¿›ç¨‹æŒ‚æ‰æ•°æ®ä¾ç„¶ä¸¢å¤±ï¼‰ã€‚

ğŸ”§ **Fix**:  
â‘  è·¯å¾„ç™½åå•ï¼š`if (!path.startsWith('docs/') || path.includes('..')) throw new ForbiddenError()`ï¼›  
â‘¡ åŸå­å†™å…¥ï¼šå…ˆå†™ä¸´æ—¶æ–‡ä»¶ `path + '.tmp'`ï¼ŒæˆåŠŸå `fs.rename()` æ›¿æ¢ï¼ˆ`rename` åœ¨åŒåˆ†åŒºæ˜¯åŸå­æ“ä½œï¼‰ï¼›  
â‘¢ å†™å…¥å `fd.sync()` å¼ºåˆ¶ flushã€‚

---

#### Step 3 â€” `simple-git commit` è‡ªåŠ¨æäº¤

âœ… **Good**:  
å°† Git æäº¤ä¸æ–‡ä»¶ä¿å­˜è€¦åˆï¼Œè®©æ¯æ¬¡ Ctrl+S äº§ç”Ÿä¸€ä¸ªç‰ˆæœ¬å¿«ç…§ï¼Œè¿™æ˜¯å†…å®¹é˜²ä¸¢çš„ç»ˆæä¿éšœâ€”â€”å›æ»šç²’åº¦ç»†åˆ°æ¯æ¬¡ä¿å­˜ã€‚

âš ï¸ **Bad**:  
1. **`.git/index.lock` å¹¶å‘å´©æºƒ**ï¼šVditor çš„è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯ N ç§’ï¼‰å’Œç”¨æˆ·æ‰‹åŠ¨ Ctrl+S å¯èƒ½åœ¨ 300ms å†…è¿ç»­è§¦å‘ä¸¤æ¬¡ git commitã€‚Node.js ä¸­ä¸¤æ¬¡å¹¶å‘è°ƒç”¨ `simple-git` å°†äº‰æŠ¢ `.git/index` é”ï¼Œå‡ ä¹å¿…ç„¶è§¦å‘ `Another git process seems to be running in this repository` è€Œ `throw`ï¼Œè½»åˆ™æäº¤å¤±è´¥ï¼Œé‡åˆ™ Git ä»“åº“æŸåã€‚  
2. **æäº¤ä¿¡æ¯è¯­ä¹‰ä¸è¶³**ï¼šè‡ªåŠ¨æäº¤çš„ message æ˜¯å›ºå®šå­—ç¬¦ä¸²ï¼Œæ— æ³•åŒºåˆ†ã€Œæ”¹äº†ä»€ä¹ˆã€ã€‚

ğŸ”§ **Fix**:  
â‘  **å…¨å±€ Mutex é˜Ÿåˆ—**ï¼šç”¨ `async-mutex` æˆ– `p-queue`ï¼ˆconcurrency: 1ï¼‰å¯¹æ‰€æœ‰ git æ“ä½œä¸²è¡Œæ’é˜Ÿï¼›  
â‘¡ **é˜²æŠ– debounce(2000ms)**ï¼šè¿ç»­ä¿å­˜åˆå¹¶ä¸ºå•æ¬¡æäº¤ï¼›  
â‘¢ æ¶ˆæ¯æ¨¡æ¿åŠ å…¥ `diff --stat` æ‘˜è¦ï¼ˆæ”¹äº†å“ªäº›è¡Œï¼‰ã€‚

---

#### Step 4 â€” ä¾§è¾¹æ è‡ªåŠ¨æ‰«æä¸è·¯ç”±

âœ… **Good**:  
VitePress çš„ `sidebar` è‡ªåŠ¨ç”Ÿæˆæœºåˆ¶åŸºäºæ–‡ä»¶ç³»ç»Ÿï¼Œæ–°å»ºæ–‡ä»¶å³åˆ»åæ˜ åˆ°å¯¼èˆªï¼Œé›¶é…ç½®æˆæœ¬ã€‚ç¬¦åˆã€Œçº¦å®šä¼˜äºé…ç½®ã€å“²å­¦ã€‚

âš ï¸ **Bad**:  
1. **Vite HMR + Agent æ•°æ®æ–‡ä»¶çš„ OOM ç‚¸å¼¹**ï¼šè‹¥ Agent çš„ä»»åŠ¡çŠ¶æ€æ–‡ä»¶ï¼ˆ`memory/tasks/*.json`ï¼‰å­˜æ”¾åœ¨ `docs/.vitepress/` ä¸‹ï¼ŒVite dev server çš„æ–‡ä»¶ç›‘å¬ï¼ˆFS Watcherï¼‰ä¼šåœ¨ Agent æ¯æ¬¡å†™å…¥è®°å¿†æ–‡ä»¶æ—¶è§¦å‘å…¨é‡é‡æ‰«ï¼Œå‡ ååˆ†é’Ÿå†…å°±ä¼šè€—å°½ Node.js å †å†…å­˜ï¼ˆFatal: Out Of Memoryï¼‰ã€‚  
2. **æ–‡ä»¶å¤¹é‡å‘½åä¸æ›´æ–°å¼•ç”¨**ï¼šæ–‡æ¡£ä¸­æåˆ°çº§è”è·¯å¾„æ›´æ–°ï¼Œä½†æœªçœ‹åˆ°å…·ä½“å®ç°ã€‚æ‰‹åŠ¨æ”¹æ–‡ä»¶å¤¹ååï¼Œæ‰€æœ‰å¼•ç”¨è¯¥ç›®å½•ä¸‹æ–‡ç« çš„ WikiLinksï¼ˆ`[[xxx]]`ã€`wikiLinks` frontmatterï¼‰å‡ä¼šå¤±æ•ˆï¼ŒçŸ¥è¯†å›¾è°±å…³ç³»æ–­è£‚ã€‚

ğŸ”§ **Fix**:  
â‘  `vite.config.ts` é‡Œ `server.watch.ignored` é…ç½®æ’é™¤ `.vitepress/memory/**` å’Œ `logs/**`ï¼›æ„è§æœ€ä¼˜è§£æ˜¯å°† Agent æ•°æ®ç›®å½•æŒªå‡ºé¡¹ç›®æ ¹ç›®å½•ï¼ˆå¦‚ `%APPDATA%/metablog/agent/`ï¼‰ï¼›  
â‘¡ é‡å‘½åæ“ä½œèµ°ä¸“ç”¨ API `PUT /api/files/rename`ï¼Œåç«¯æ‰«æå…¨åº“ `.md` æ–‡ä»¶åšæ­£åˆ™æ›¿æ¢ WikiLinks å¼•ç”¨ã€‚

---

#### Step 5 â€” æ—¥å¿—è®°å½•

âœ… **Good**:  
`StructuredLogger` çš„è®¾è®¡åŒ…å« `sessionId` å’Œ `traceId` å­—æ®µï¼Œå…·å¤‡å…¨é“¾è·¯è¿½è¸ªçš„åŸºç¡€ç»“æ„ï¼Œæ¯”è£¸ `console.log` å¥½å¤ªå¤šã€‚

âš ï¸ **Bad**:  
åœºæ™¯1ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰çš„æ—¥å¿—ç›®å‰å±äºã€Œåˆæ³•ç¼ºå¸­ã€â€”â€”MANUAL æ¨¡å¼ä¸‹æ²¡æœ‰ Agent ä»‹å…¥ï¼ŒLogger è°ƒç”¨æå°‘ã€‚ä½† `POST /api/files/save` å’Œ git æ“ä½œçš„æˆåŠŸ/å¤±è´¥æ—¥å¿—è·¯å¾„ä¸æ¸…æ™°ã€‚è‹¥ git æäº¤å¤±è´¥ï¼ˆlock æŠ¥é”™ï¼‰ï¼ŒæŠ¥é”™å¯èƒ½åªæ‰“å°åˆ° node æ§åˆ¶å°ï¼Œç”¨æˆ·ç•Œé¢æ˜¾ç¤ºã€Œä¿å­˜æˆåŠŸã€ï¼Œå®é™… git çŠ¶æ€ä¸ä¸€è‡´ï¼ˆå·²çŸ¥æ¶æ„è®¾è®¡æ¼æ´ï¼‰ã€‚

ğŸ”§ **Fix**:  
API å±‚å¿…é¡» catch git å¼‚å¸¸ï¼Œå‘å‰ç«¯è¿”å›åŒºåˆ†åçš„çŠ¶æ€ç ï¼š`200 { fileSaved: true, gitCommit: false, error: 'git lock timeout' }`ã€‚å‰ç«¯åŒºåˆ†ã€Œæ–‡ä»¶ä¿å­˜æˆåŠŸä½†ç‰ˆæœ¬æœªæäº¤ã€ä¸¤ç§çŠ¶æ€çš„ UI æ˜¾ç¤ºã€‚

---

### åœºæ™¯ 2 è¯„ä¼°ï¼šAI è¢«åŠ¨åˆ›ä½œ

---

#### Step 1 â€” `IntentRouter.parse()` æ„å›¾è§£æ

âœ… **Good**:  
`ParsedIntent.confidence` å­—æ®µçš„è®¾è®¡ä½“ç°äº†ä¸ç¡®å®šæ€§é‡åŒ–æ„è¯†ï¼Œè€ŒéäºŒå€¼åˆ¤æ–­ã€‚æŠ€èƒ½æ³¨å†Œè¡¨ï¼ˆ`skills: Map<string, Skill>`ï¼‰é€šè¿‡ `intentPattern: RegExp` åŒ¹é…ï¼Œå®ç°äº†è§£è€¦â€”â€”æ–°å¢æŠ€èƒ½æ— éœ€ä¿®æ”¹è·¯ç”±å™¨æ ¸å¿ƒé€»è¾‘ã€‚

âš ï¸ **Bad**:  
1. **ç½®ä¿¡åº¦é˜ˆå€¼æ²¡æœ‰ HITL è§¦å‘æœºåˆ¶**ï¼šæ–‡æ¡£æè¿°ã€Œç½®ä¿¡åº¦ä½äº0.8æ—¶é™çº§ä¸¢å…¥ `posts/`ã€ï¼Œä½†æ²¡æœ‰ Human-in-the-loop æŒ‚èµ·é€»è¾‘ã€‚Agent åœ¨æ— æ³•ç¡®å®šåˆ†ç±»æ—¶**é™é»˜å†³ç­–**ï¼Œéšç€æ—¶é—´æ¨ç§»å¿…ç„¶äº§ç”Ÿæ–‡ä»¶æ ‘æ··ä¹±å’Œéšæ€§æ–‡ä»¶è¦†ç›–ã€‚  
2. **è·¯å¾„å†³ç­–å‡½æ•° `decideTargetPath` çš„æ­£åˆ™æšä¸¾æ˜¯ç¡¬ç¼–ç **ï¼š`/transformer|bert|llm|ai/i` è¿™æ ·çš„è§„åˆ™æ— æ³•è¦†ç›–æ‰€æœ‰æƒ…å†µï¼Œä¸”éšç€å†…å®¹ä½“ç³»å¢é•¿å¿…é¡»æ‰‹åŠ¨ç»´æŠ¤ã€‚æ›´å±é™©çš„æ˜¯ï¼šæ­¤å‡½æ•°ä¼˜å…ˆå– `similarArticles[0].sources[0]`ï¼ˆå†…å­˜ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…å®ä½“çš„ç¬¬ä¸€ä¸ªæ¥æºï¼‰ï¼Œè‹¥å†…å­˜æ•°æ®å­˜åœ¨æ±¡æŸ“ï¼Œè·¯å¾„ç»“æœå°†é”™è¯¯ã€‚

ğŸ”§ **Fix**:  
â‘  æ„å›¾ç½®ä¿¡åº¦ < 0.8 æ—¶ï¼ŒAgent æŒ‚èµ·åˆ° `PAUSED` çŠ¶æ€ï¼Œå‘ AIChatOrb åé—®ï¼š`"æˆ‘å»ºè®®å°†æ–‡ç« å­˜æ”¾åœ¨ posts/tech/ai/ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿè¿˜æ˜¯æ‚¨æœ‰å…¶ä»–åå¥½ï¼Ÿ"` ç­‰ç”¨æˆ·ç¡®è®¤åå†ç»§ç»­ï¼›  
â‘¡ `decideTargetPath` æ”¹ä¸º LLM è¾…åŠ©åˆ†ç±»ï¼ˆç»™æ¨¡å‹æä¾›ç°æœ‰ç›®å½•æ ‘ + æ–‡ç« ä¸»é¢˜ï¼Œè®©æ¨¡å‹è¾“å‡º JSON `{path: string, reason: string}`ï¼‰ï¼Œæ¯”æ­£åˆ™æšä¸¾å‡†ç¡®ã€‚

---

#### Step 2 â€” RAG èµ„æ–™æ£€ç´¢ï¼ˆå†…éƒ¨çŸ¥è¯†åº“ï¼‰

âœ… **Good**:  
`MemoryManager.buildContext()` çš„è®¾è®¡æ”¯æŒæ··åˆæ£€ç´¢ï¼ˆå½“å‰å·²å®ç°å…³é”®è¯ï¼Œè§„åˆ’å‘é‡ï¼‰ï¼Œå¹¶è¿”å› `{ content, source, score }` ç»“æ„ï¼Œä¾¿äºåç»­ç”Ÿæˆæ—¶å¼•ç”¨æ¥æºã€‚

âš ï¸ **Bad**:  
1. **å½“å‰ä»…æœ‰å…³é”®è¯åŒ¹é…**ï¼Œæ— è¯­ä¹‰ç†è§£ã€‚`"å‘é‡æ•°æ®åº“"` å’Œ `"VectorDB"` ã€`"Embedding Store"` å¯èƒ½å‘½ä¸­å®Œå…¨ä¸åŒçš„ç»“æœé›†ï¼Œå¯¼è‡´ RAG ã€ŒèƒŒæ™¯ç›¸å…³æ€§ã€ä¸‹é™ã€‚  
2. **`buildContext` æ— ç»“æœä¸Šé™ä¿æŠ¤**ï¼šå¦‚æœçŸ¥è¯†åº“ä¸­æœ‰æ•°ç™¾ç¯‡æ–‡ç« ä¸æŸå…³é”®è¯åŒ¹é…ï¼Œå…¨éƒ¨å¡å…¥ Prompt ä¼šå¯¼è‡´ Context Window è¶…é™å’Œé«˜é¢è®¡è´¹ã€‚

ğŸ”§ **Fix**:  
â‘  çŸ­æœŸï¼šåŠ  `topK` ç¡¬é™åˆ¶ï¼ˆå¦‚ `maxChunks: 5`ï¼‰ï¼Œæˆªæ–­å‰åªå–è¯„åˆ†æœ€é«˜çš„ N ä¸ªï¼›  
â‘¡ é•¿æœŸï¼šPhase 1 å‘é‡åŒ–ï¼Œç”¨ Embedding ç›¸ä¼¼åº¦æ›¿ä»£å…³é”®è¯åŒ¹é…ã€‚

---

#### Step 3 â€” WebSearch ç½‘ç»œæœç´¢

âœ… **Good**:  
è®¾è®¡äº†æ¨¡æ‹Ÿå›é€€ï¼ˆ`simulateSearch`ï¼‰ï¼Œåœ¨æ—  SerpAPI Key æ—¶é™çº§ä¸º LLM ç”Ÿæˆæ¨¡æ‹Ÿç»“æœï¼Œä¿è¯äº†åŠŸèƒ½å¯ç”¨æ€§ï¼Œæ˜¯å¥½çš„æ¸è¿›é™çº§è®¾è®¡ã€‚

âš ï¸ **Bad**:  
1. **`simulateSearch` æ˜¯ã€Œå¹»è§‰å·¥å‚ã€**ï¼šç”¨ LLMã€Œå‡è£…æœç´¢ã€ä¼šäº§ç”Ÿè™šæ„çš„æ–‡ç« æ ‡é¢˜å’Œ URLï¼Œè¿™äº›å†…å®¹å¯èƒ½ä»¥å¼•ç”¨å½¢å¼å†™å…¥æ–‡ç« ï¼Œæˆä¸ºè™šå‡ä¿¡æ¯çš„æ¥æºã€‚  
2. **æœç´¢è¶…æ—¶æ— ç¡¬ä¸Šé™**ï¼šæ–‡æ¡£æåˆ°ç½‘ç»œè¶…æ—¶10ç§’é™çº§ï¼Œä½†ä»£ç å±‚æœªè§ `AbortSignal` æˆ– `setTimeout` å®ç°ã€‚Arxiv API å¶å°”å“åº”è¶…30ç§’ï¼Œä¼šé˜»å¡æ•´ä¸ª Skill æ‰§è¡Œé“¾ã€‚

ğŸ”§ **Fix**:  
â‘  åºŸå¼ƒ `simulateSearch`ï¼Œæ”¹ä¸ºã€Œæœç´¢å¤±è´¥æ—¶æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ã€ï¼š`"ç½‘ç»œæœç´¢ä¸å¯ç”¨ï¼Œå°†ä»…ä½¿ç”¨æœ¬åœ°çŸ¥è¯†åº“ç”Ÿæˆæ–‡ç« ï¼Œè¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ"`ï¼ˆå›æ»šåˆ° Human-in-the-loopï¼‰ï¼›  
â‘¡ æ‰€æœ‰å¤–éƒ¨ HTTP è°ƒç”¨å¿…é¡»å¥— `AbortSignal`ï¼Œ10ç§’è¶…æ—¶åæŠ›å‡º `SearchTimeoutError`ï¼ŒSkill æ•è·åé™çº§ä¸ºã€Œä»…å†…éƒ¨ RAG æ¨¡å¼ã€ï¼Œå¹¶åœ¨è¾“å‡ºä¸­æ³¨æ˜ã€Œâš ï¸ æœ¬æ–‡æœªä½¿ç”¨å¤–éƒ¨èµ„æ–™ã€ã€‚

---

#### Step 4 â€” `generateArticle` ç”Ÿæˆæµç¨‹ï¼ˆLLM è°ƒç”¨é“¾ï¼‰

âœ… **Good**:  
åˆ†è§£ä¸ºã€Œå¤§çº² â†’ æ­£æ–‡ã€ä¸¤æ­¥ LLM è°ƒç”¨ï¼Œå¤§çº²ä½œä¸ºç»“æ„åŒ–çº¦æŸï¼Œé™ä½å¤§æ¨¡å‹å‘æ•£é£é™©ã€‚æµå¼è¾“å‡ºï¼ˆ`onChunk` å›è°ƒï¼‰è®©ç”¨æˆ·å®æ—¶çœ‹åˆ°ç”Ÿæˆè¿›åº¦ï¼ŒUX ä½“éªŒè‰¯å¥½ã€‚

âš ï¸ **Bad**:  
1. **æ—  AbortControllerï¼šå®¢æˆ·ç«¯æ–­å¼€æ—¶åç«¯ç»§ç»­çƒ§ Token**ï¼šç”¨æˆ·å…³é—­æµè§ˆå™¨æ ‡ç­¾ â†’ å‰ç«¯ WebSocket æˆ– SSE è¿æ¥æ–­å¼€ â†’ åç«¯ `LLMManager.chatStream()` ä»åœ¨è¿è¡Œ â†’ API ç»§ç»­è®¡è´¹ â†’ æ–‡ä»¶åŠå†™å…¥ç£ç›˜æˆä¸ºåƒåœ¾æ–‡ä»¶ã€‚  
2. **`extractEntitiesFromContent()` åœ¨å†™å…¥åç«‹åˆ»æ‰§è¡Œ**ï¼šAI äº§ç”Ÿçš„å¹»è§‰å†…å®¹ï¼ˆé”™è¯¯äº‹å®ã€è™šæ„å¼•ç”¨ï¼‰ä¼šåœ¨æœªç»ç”¨æˆ·ç¡®è®¤å‰ç«‹åˆ»æ±¡æŸ“ MemoryManager çš„å®ä½“åº“ï¼Œå½±å“åç»­æ‰€æœ‰ RAG æ£€ç´¢ï¼Œå½¢æˆã€Œå¹»è§‰åé¦ˆå›è·¯ã€ã€‚  
3. **`saveFile` å’Œ `commitAsAgent` ä¹‹é—´æ²¡æœ‰äº‹åŠ¡**ï¼šæ–‡ä»¶ä¿å­˜æˆåŠŸä½† git commit å¤±è´¥æ—¶ï¼Œæ–‡ä»¶å­˜åœ¨ä½†æœªè®°å½•ã€‚è‹¥ä¹‹å Agent é‡æ–°è§¦å‘ï¼Œå¯èƒ½é‡å¤ç”Ÿæˆå†…å®¹ã€‚

ğŸ”§ **Fix**:  
â‘  Server-Sent Events å¢åŠ  `req.on('close', () => abortController.abort())` çº§è”ç»ˆæ­¢ LLM æµå’Œæ–‡ä»¶å†™å…¥ï¼›  
â‘¡ `extractEntitiesFromContent()` **å¿…é¡»æ”¹ä¸ºå¼‚æ­¥å¯æ’¤é”€æµç¨‹**ï¼šå…ˆå†™å…¥éš”ç¦»çš„ `memory/pending/` ç›®å½•ï¼Œç”¨æˆ·åœ¨ AIChatOrb ç‚¹å‡»ã€Œâœ… æ¥å—ã€åå†è¿ç§»åˆ°æ­£å¼åº“ï¼›  
â‘¢ ç”¨ `try/catch` åŒ…è£¹ `saveFile + commitAsAgent`ï¼Œå¤±è´¥æ—¶æ‰§è¡Œ `fs.unlink(finalPath)`ï¼ˆå›æ»šæ–‡ä»¶å†™å…¥ï¼‰ã€‚

---

#### Step 5 â€” æ–‡ä»¶è·¯å¾„ç¡®å®šä¸é‡åæ£€æŸ¥

âœ… **Good**:  
`slugify(topic) + '.md'` çš„æ–‡ä»¶åç”Ÿæˆæ–¹å¼ç®€æ´ï¼Œè‡ªåŠ¨å¤„ç†ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦ï¼Œæ˜¯æ ‡å‡† Web å‹å¥½å‘½åæ–¹å¼ã€‚

âš ï¸ **Bad**:  
**æ— é‡åæ£€æŸ¥**ï¼šè‹¥ `posts/tech/ai/vector-database.md` å·²å­˜åœ¨ï¼ˆç”¨æˆ·è‡ªå·±å†™çš„æ–‡ç« ï¼‰ï¼Œ`saveFile()` ä¼šç›´æ¥è¦†ç›–ã€‚æ–‡æ¡£è¦æ±‚ã€Œè¦†ç›–å·²æœ‰æ–‡ä»¶å‰å¿…é¡»äºŒæ¬¡ç¡®è®¤ã€ï¼Œä½†ä»£ç é€»è¾‘ä¸­æœªå®ç°ã€‚`generateArticle` å‡½æ•°åœ¨ `saveFile` ä¹‹å‰æ²¡æœ‰ `fs.access(finalPath)` æ£€æŸ¥ã€‚

ğŸ”§ **Fix**:  
```typescript
// å†™å…¥å‰æ£€æŸ¥
if (await fileExists(finalPath)) {
  // æŒ‚èµ·çŠ¶æ€æœºåˆ° PAUSED
  await ctx.notify('file_exists', { path: finalPath })
  const confirm = await waitForUserConfirm(ctx)  // é˜»å¡ç­‰å¾…ç”¨æˆ·å“åº”
  if (!confirm) throw new AbortError('ç”¨æˆ·æ‹’ç»è¦†ç›–')
  // ä¿ç•™å¤‡ä»½
  await backupFile(finalPath, `${finalPath}.backup-${Date.now()}`)
}
```

---

### åœºæ™¯ 3 è¯„ä¼°ï¼šAI ä¸»åŠ¨åˆ›ä½œ

---

#### Step 1 â€” GitHub Actions Cron è§¦å‘

âœ… **Good**:  
åˆ©ç”¨ GitHub Actions åŸç”Ÿè°ƒåº¦ï¼Œé›¶è¿ç»´æˆæœ¬â€”â€”ä¸éœ€è¦è‡ªå»º Cron æœåŠ¡å™¨ã€‚`workflow_dispatch` æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œä¾¿äºè°ƒè¯•ã€‚API Keys é€šè¿‡ Secrets æ³¨å…¥ï¼Œä¸å­˜åœ¨æ˜æ–‡æ³„éœ²é£é™©ï¼ˆSecrets åŠ å¯†å­˜å‚¨ï¼‰ã€‚

âš ï¸ **Bad**:  
1. **Non-fast-forward Push å†²çª**ï¼šå¦‚æœä½œè€…åœ¨æœ¬åœ°å·²æäº¤å¹¶æ¨é€ï¼ŒGitHub Actions çš„ `git push` å¿…ç„¶å›  `non-fast-forward` å¤±è´¥ï¼Œå¯¼è‡´æ•´ä¸ª Cron ä»»åŠ¡å¤±è´¥ã€‚åç»­æ¯æ¬¡è°ƒåº¦ä¹Ÿä¼šæŒç»­å¤±è´¥ï¼Œå½¢æˆã€Œè‡ªåŠ¨åŒ–æ°¸ä¹…ç˜«ç—ªã€ã€‚  
2. **Actions YAML ä¸­æ— é”™è¯¯é€€å‡ºç å¤„ç†**ï¼š`npx tsx scripts/agent-cron.ts` è‹¥å†…éƒ¨ throwï¼Œè„šæœ¬ä»¥éé›¶é€€å‡ºç é€€å‡ºï¼Œåé¢çš„ `git push` æ­¥éª¤ä»ä¼šæ‰§è¡Œï¼Œä½†æ­¤æ—¶ working directory å¯èƒ½æ˜¯æ··ä¹±çŠ¶æ€ã€‚

ğŸ”§ **Fix**:  
â‘  Replace `git push` with `git pull --rebase && git push`ï¼›è‹¥ rebase æ£€æµ‹åˆ° conflict åˆ™ `git checkout --theirs && git push --force-with-lease origin HEAD:agent-conflict-dump`ï¼ˆæ¨é€åˆ°éš”ç¦»åˆ†æ”¯ï¼‰å¹¶å‘é€å‘Šè­¦ï¼›  
â‘¡ Actions YAML å„ step åŠ  `|| echo "::error::Step failed"` å¹¶æ§åˆ¶ `continue-on-error`ã€‚

---

#### Step 2 â€” `FeedMonitor` ä¿¡æºæ”¶é›†

âœ… **Good**:  
`switch(source.type)` çš„ç­–ç•¥æ¨¡å¼è®¾è®¡ä½¿å¾—æ–°å¢ä¿¡æºç±»å‹æ— éœ€æ”¹æ ¸å¿ƒä»£ç ï¼Œæ‰©å±•æ€§å¥½ã€‚Arxiv URL æ‹¼æ¥ä½¿ç”¨äº† `encodeURIComponent`ï¼Œé¿å…æŸ¥è¯¢å­—ç¬¦ä¸²æ³¨å…¥ã€‚

âš ï¸ **Bad**:  
1. **æ— é€Ÿç‡é™åˆ¶ï¼ˆRate Limitï¼‰é˜²æŠ¤**ï¼šArxiv APIã€HackerNews RSS å‡æœ‰é¢‘ç‡é™åˆ¶ã€‚è‹¥ Cron å¯†é›†æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œé«˜é¢‘è¯·æ±‚å¯èƒ½è¢« 429 é™æµã€‚å½“å‰å®ç°æ— é€€é¿ç­–ç•¥ï¼ˆExponential Backoffï¼‰ã€‚  
2. **XML è§£ææ— é”™è¯¯å¤„ç†**ï¼š`parseArxivXML(xml)` è‹¥ Arxiv è¿”å›é”™è¯¯ HTMLï¼ˆ503/ç»´æŠ¤é¡µé¢ï¼‰ï¼ŒXML è§£æå™¨ä¼š throwï¼Œæ•´ä¸ªä»»åŠ¡é“¾å´©æºƒæ— å›æ»šã€‚  
3. **`fetch(url)` æ— è¶…æ—¶æ§åˆ¶**ï¼šRSS æºå¯èƒ½é•¿æ—¶é—´æ— å“åº”ï¼Œé˜»å¡æ•´ä¸ªé‡‡é›†å¾ªç¯ã€‚

ğŸ”§ **Fix**:  
â‘  æ¯æ¬¡ fetch å¥— `AbortSignal.timeout(10_000)`ï¼›  
â‘¡ `parseArxivXML` ç”¨ `try/catch` åŒ…è£¹ï¼Œè§£æå¤±è´¥è¿”å› `[]` å¹¶è®°å½• `logger.warn('feed.parse.failed', { url, error })`ï¼›  
â‘¢ æ·»åŠ ä»»åŠ¡é—´ `sleep(1000)` åŠé€€é¿é‡è¯•é˜Ÿåˆ—ã€‚

---

#### Step 3 â€” `ContentEvaluator` å†…å®¹è¯„ä¼°ï¼ˆLLM è´¨é‡è¯„åˆ†ï¼‰

âœ… **Good**:  
ä¸‰ç»´åº¦è¯„ä¼°ï¼ˆåŸåˆ›æ€§ã€æŠ€æœ¯æ·±åº¦ã€å®ç”¨æ€§ï¼‰æœ‰å…·ä½“é‡åŒ–æ–¹å‘ï¼Œ`minRelevanceScore` é…ç½®åŒ–ï¼Œé¿å…ç¡¬ç¼–ç é˜ˆå€¼ï¼Œç³»ç»Ÿè¡Œä¸ºå¯è°ƒã€‚

âš ï¸ **Bad**:  
1. **æ¯ç¯‡æ–‡ç« éƒ½è°ƒç”¨ LLM åšè´¨é‡è¯„ä¼°**ï¼šè‹¥ Arxiv è¿”å› 10 ç¯‡è®ºæ–‡ï¼Œ`assessQuality` å’Œ `assessRelevance` å„è°ƒä¸€æ¬¡ LLMï¼Œå…‰è¯„ä¼°é˜¶æ®µå°±æ¶ˆè€— 20 æ¬¡ API è°ƒç”¨ï¼Œè¿™åœ¨æ‰¹é‡è¿è¡Œæ—¶æˆæœ¬çˆ†ç‚¸ã€‚  
2. **`JSON.parse(response.content)` æ— æŠ—å´©æ€§**ï¼šLLM è¾“å‡ºä¸æ€»æ˜¯åˆæ³• JSONï¼ˆå¯èƒ½å¸¦ markdown ä»£ç å—ã€ä¸­æ–‡æ³¨é‡Šç­‰ï¼‰ã€‚æœªåŠ  try/catch ä¸”æœªä½œ schema æ ¡éªŒï¼Œä¼šå› æ ¼å¼é—®é¢˜é™é»˜å´©æºƒã€‚  
3. **`findSimilar(item)` çš„å»é‡æœºåˆ¶æœªè§å®ç°**ï¼šè‹¥åŸºäº MemoryManager çš„å…³é”®è¯æ£€ç´¢åšå»é‡ï¼ŒåŒä¸€ç¯‡æ–‡ç« æ¢äº†æ ‡é¢˜ï¼ˆç¿»è¯‘ç‰ˆ/è½¬å‘ï¼‰å°±å»é‡å¤±è´¥ï¼Œå¯¼è‡´é‡å¤ç”Ÿæˆã€‚

ğŸ”§ **Fix**:  
â‘  è¯„ä¼°é˜¶æ®µå…ˆç”¨è½»é‡å…³é”®è¯è¿‡æ»¤ï¼ˆTF-IDF or BM25ï¼‰åš `preFilter`ï¼Œä»…å¯¹é€šè¿‡åˆç­›çš„æ–‡ç« è°ƒç”¨ LLMï¼›  
â‘¡ LLM è¾“å‡ºç”¨ `zod` schema æ ¡éªŒï¼š`z.object({ score: z.number().min(1).max(10), reasons: z.array(z.string()) })`ï¼Œæ ¡éªŒå¤±è´¥æ—¶é»˜è®¤ç»™æ»¡åˆ†ï¼ˆä¿å®ˆç­–ç•¥ï¼šå®å¯è¯¯æ”¶å‹¿æ¼ï¼‰ï¼›  
â‘¢ å»é‡æ”¹ç”¨å†…å®¹æ‘˜è¦çš„è¯­ä¹‰å‘é‡ç›¸ä¼¼åº¦ï¼ˆcosine > 0.85 = é‡å¤ï¼‰ã€‚

---

#### Step 4 â€” `WriteArticleSkill` ç”Ÿæˆ + `AutoPublisher` å‘å¸ƒ

âœ… **Good**:  
`autoPublish: false` è·¯å¾„ä¼šé€šè¿‡ `saveAsDraft`ï¼ˆæ³¨å…¥ `draft: true` frontmatterï¼‰å’Œå‘é€å®¡æ ¸é€šçŸ¥ï¼Œä¿ç•™äººå·¥å®¡æ ¸å¡ç‚¹ï¼Œé¿å…åƒåœ¾å†…å®¹ç›´æ¥å…¬å¼€ã€‚

âš ï¸ **Bad**:  
1. **`saveAsDraft` çš„å­—ç¬¦ä¸²æ›¿æ¢æœ‰ç¼ºé™·**ï¼š`content.replace('---\n', '---\ndraft: true\n')` æ— è®º `draft` å­—æ®µæ˜¯å¦å·²å­˜åœ¨éƒ½æ‰§è¡Œæ›¿æ¢ï¼Œè‹¥æ–‡ä»¶å·²æœ‰ `draft: false`ï¼Œç»“æœå°†å˜æˆ `---\ndraft: true\ndraft: false`ï¼ŒFrontMatter è§£æå™¨è¡Œä¸ºæœªå®šä¹‰ï¼ˆå–ç¬¬ä¸€ä¸ªï¼ŸæŠ¥é”™ï¼Ÿï¼‰ã€‚  
2. **`commitAndPush` åœ¨ `AutoPublisher` å’Œ GitHub Actions æœ«å°¾çš„ Commit æ­¥éª¤ä¹‹é—´é‡å¤**ï¼šci/cd ä¸­å·²æœ‰é€šç”¨çš„ `git add . && git commit && git push`ï¼Œ`AutoPublisher.commitAndPush` åˆåšäº†ä¸€æ¬¡ï¼Œäº§ç”ŸåŒé‡æäº¤æˆ–é”ç«äº‰ï¼ˆåœ¨åŒä¸€ Actions Runner è¿›ç¨‹å†…ï¼‰ã€‚  
3. **Token æˆæœ¬ç†”æ–­æ˜¯ã€Œäº‹åé¢„æµ‹ã€è€Œéã€Œäº‹å‰ç¡¬æˆª**ã€ï¼š`estimateCost` åªåšäº‹å‰ä¼°ç®—ï¼Œè‹¥ Arxiv å®é™…è¿”å›çš„æ‘˜è¦æ–‡æœ¬å¼‚å¸¸åºå¤§ï¼ŒçœŸå®æ¶ˆè€—ä¼šè¿œè¶…ä¼°ç®—ï¼Œç›®å‰ä»£ç æ²¡æœ‰åœ¨ `chatStream` è¿‡ç¨‹ä¸­çš„å®æ—¶ Token è®¡æ•°å¹¶ä¸­æ–­çš„é€»è¾‘ã€‚

ğŸ”§ **Fix**:  
â‘  `saveAsDraft` æ”¹ç”¨ gray-matter ç­‰ YAML frontmatter åº“åšç»“æ„åŒ–è¯»å†™ï¼Œè€Œéå­—ç¬¦ä¸²æ›¿æ¢ï¼›  
â‘¡ ç»Ÿä¸€ç”± GitHub Actions æœ«å°¾çš„ Commit æ­¥éª¤è´Ÿè´£ pushï¼Œ`AutoPublisher` åªè´Ÿè´£æ–‡ä»¶å†™å…¥ï¼Œæ¶ˆé™¤åŒé‡ commitï¼›  
â‘¢ `LLMManager` çš„ `chatStream` å›è°ƒä¸­ç´¯è®¡ Token è®¡æ•°ï¼Œè¶…è¿‡ `SAFETY_LIMITS.maxTokensPerTask` æ—¶è°ƒç”¨ `abortController.abort()` å¼ºåˆ¶ä¸­æ–­ï¼Œå¹¶å°†å·²ç”Ÿæˆéƒ¨åˆ†æ ‡è®°ä¸º `draft: true` ä¿å­˜ã€‚

---

#### Step 5 â€” çŠ¶æ€æœº & å¹¶å‘æ§åˆ¶

âœ… **Good**:  
7 çŠ¶æ€æœºè®¾è®¡ï¼ˆIDLE/UNDERSTANDING/PLANNING/EXECUTING/PAUSED/COMPLETED/ERRORï¼‰è¦†ç›–äº†å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒPAUSED çŠ¶æ€æ”¯æŒå¼‚æ­¥æ–­ç‚¹ç»­ä½œï¼ˆcheckpointsï¼‰ï¼Œæ˜¯å°‘è§çš„æ·±åº¦è®¾è®¡ã€‚

âš ï¸ **Bad**:  
1. **æ²¡æœ‰ TTL çœ‹é—¨ç‹—**ï¼šçŠ¶æ€æœºè¿›å…¥ `EXECUTING` åï¼Œè‹¥ LLM API æ— é™ pendingï¼ˆæœªè¿”å› 200 ä¹Ÿæ²¡è¿”å› 5xxï¼Œæ¯”å¦‚å»‰ä»· API çš„æ²‰é»˜è¶…æ—¶ï¼‰ï¼ŒçŠ¶æ€æœºæ°¸ä¹…é”æ­»åœ¨ `EXECUTING`ã€‚æ­¤åæ‰€æœ‰æ–°æŒ‡ä»¤éƒ½è¢« `State Not Allow` æ‹’ç»ï¼Œç³»ç»Ÿäº‹å®ä¸Šåœæ‘†ã€‚  
2. **æ— å¹¶å‘æ•°é™åˆ¶ï¼ˆç¼ºå°‘ `maxConcurrentTasks`ï¼‰**ï¼š`agent-cron.ts` çš„ `forâ€¦of` æ˜¯ä¸²è¡Œçš„ï¼Œä½†è‹¥è§¦å‘ç‚¹æ˜¯ Webhookï¼ˆå¤šäº‹ä»¶åŒæ—¶åˆ°è¾¾ï¼‰ï¼Œå¤šä¸ª `AgentRuntime` å®ä¾‹å¯èƒ½å¹¶å‘è¿è¡Œï¼Œäº‰æŠ¢æ–‡ä»¶å†™å…¥æƒå’Œ git é”ã€‚  
3. **AgentDashboard åœ¨ç”Ÿäº§ç¯å¢ƒæš´éœ²**ï¼š`AgentDashboard.vue` æŒ‚è½½åœ¨ VitePressï¼ˆé™æ€æ‰˜ç®¡ï¼‰ï¼Œ`npm run build` åå‘å¸ƒåˆ° GitHub Pagesï¼Œä»»ä½•å…¬ç½‘è®¿é—®è€…éƒ½å¯ä»¥è®¿é—® `/agent-dashboard`ï¼Œçœ‹åˆ°å®Œæ•´çš„ API æˆæœ¬ã€é”™è¯¯å †æ ˆã€Prompt æ˜æ–‡ã€‚

ğŸ”§ **Fix**:  
â‘  `StateMachine` æ·»åŠ  Watchdogï¼šè¿›å…¥ `EXECUTING` æ—¶å¯åŠ¨ `setTimeout(5*60*1000, () => forciblyReset())`ï¼Œè¶…æ—¶åå¼ºåˆ¶è½¬æ¢åˆ° `ERROR` å¹¶å‘Šè­¦ï¼›  
â‘¡ `SkillEngine` æ·»åŠ å¹¶å‘é™åˆ¶ï¼ˆ`p-limit(3)`ï¼‰æ§åˆ¶åŒæ—¶è¿è¡ŒæŠ€èƒ½æ•°ï¼›  
â‘¢ Dashboard é¡µé¢æ·»åŠ  `if (process.env.NODE_ENV !== 'development') throw redirect(403)` æˆ–é€šè¿‡ Vite `define` åœ¨ç”Ÿäº§æ„å»ºæ—¶ tree-shake æ‰ã€‚

---

## ç¬¬ä¸‰é˜¶æ®µï¼šè·¨åœºæ™¯ä¸€è‡´æ€§æ£€æŸ¥

### 3.1 çŠ¶æ€ä¸€è‡´æ€§ï¼šåœºæ™¯2ç”Ÿæˆæ–‡ä»¶ â†’ åœºæ™¯1è¯»å–

| é—®é¢˜ | å½“å‰çŠ¶æ€ | é£é™© |
|------|---------|------|
| **åœºæ™¯2å†™å…¥ååœºæ™¯1çš„ç›®å½•æ ‘æ„ŸçŸ¥** | VitePress åœ¨ dev æ¨¡å¼ä¸‹é€šè¿‡ Vite HMR ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œæ–°æ–‡ä»¶å‡ ç§’å†…åæ˜ åˆ°ä¾§è¾¹æ  | ä½é£é™© â€” é€‚ç”¨äºå¼€å‘ç¯å¢ƒ |
| **ç”Ÿäº§éƒ¨ç½²çš„å»¶è¿Ÿ** | `npm run build` éœ€é‡æ–°æ„å»ºï¼Œåœºæ™¯2ç”Ÿæˆçš„æ–‡ç« åœ¨ä¸‹æ¬¡æ„å»ºå‰ä¸å¯è®¿é—® | ä¸­é£é™© â€” è‡ªåŠ¨è§¦å‘å¢é‡æ„å»ºæœªå®ç° |
| **MemoryManager ç¼“å­˜ä¸€è‡´æ€§** | åœºæ™¯1è¯»å–çš„æ–‡ç« æœªç» `extractEntitiesFromContent`ï¼Œä¸ä¼šè‡ªåŠ¨è¿›å…¥å®ä½“åº“ï¼›åœºæ™¯2ç”Ÿæˆåç«‹åˆ»å…¥åº“ï¼ˆ **é—®é¢˜åœ¨åœºæ™¯2 Step 4 å·²è¿°** ï¼‰ | é«˜é£é™© â€” å®ä½“åº“çŠ¶æ€å–å†³äºæ–‡ç« æ¥æºï¼Œå­˜åœ¨ä¸ä¸€è‡´ |

**å»¶è¿Ÿè¯„ä¼°**: åœºæ™¯2å†™å…¥æ–‡ä»¶åˆ°åœºæ™¯1çš„ä¾§è¾¹æ æ„ŸçŸ¥ï¼Œå¼€å‘ç¯å¢ƒçº¦ 1-3 ç§’ï¼›ç”Ÿäº§ç¯å¢ƒå–å†³äºé‡æ–°æ„å»ºå’Œ CDN æ¨é€ï¼Œåˆ†é’Ÿçº§å»¶è¿Ÿã€‚

---

### 3.2 èµ„æºç«äº‰ï¼šåœºæ™¯1ç¼–è¾‘ä¸­ + åœºæ™¯3 Agent åŒæ—¶ä¿®æ”¹

**å½“å‰é”æœºåˆ¶**: **æ— **ã€‚

åœºæ™¯1ç”¨æˆ·æ­£åœ¨ç¼–è¾‘ `posts/tech/ai/transformer.md`ï¼Œåœºæ™¯3 Agentï¼ˆè´¨é‡å·¡æ£€æŠ€èƒ½ï¼‰åŒæ—¶æ‰«æå¹¶è‡ªåŠ¨ä¿®å¤è¯¥æ–‡ç« çš„æ­»é“¾ï¼ŒäºŒè€…åŒæ—¶è§¦å‘å†™å…¥ APIï¼š

```
ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜:    POST /api/files/save  â†’ fs.writeFile('transformer.md', userContent)
Agent è‡ªåŠ¨ä¿®å¤:  AgentRuntime.execute() â†’ fs.writeFile('transformer.md', agentContent)
```

Node.js ä¸­ `fs.writeFile` çš„å¹¶å‘ä¸ä¿è¯åŸå­æ€§ï¼Œæœ€ç»ˆæ–‡ä»¶å†…å®¹å–å†³äºä¸¤æ¬¡å†™å…¥çš„å®Œæˆé¡ºåºï¼ˆæœ€åå†™å…¥è€…èƒœå‡ºï¼‰ï¼Œç”¨æˆ·çš„ç¼–è¾‘**å¯èƒ½è¢« Agent çš„ä¿®å¤å†…å®¹é™é»˜è¦†ç›–**ã€‚

ğŸ”§ **Fix**: 
å®ç°åŸºäºæ–‡ä»¶è·¯å¾„çš„**æ‚²è§‚é”ï¼ˆFile Lockï¼‰**ã€‚å†™å…¥å‰é€šè¿‡ `proper-lockfile` æˆ– Redis åˆ†å¸ƒå¼é”è·å–æ–‡ä»¶é”ï¼Œè·å–å¤±è´¥æ—¶æ’é˜Ÿç­‰å¾…ï¼ˆè¶…æ—¶åæŠ›å‡º `FileLockTimeoutError`ï¼‰ã€‚Agent æ£€æµ‹åˆ°æ–‡ä»¶è¢«ç”¨æˆ·é”å®šæ—¶ï¼Œæ¨è¿Ÿæ‰§è¡Œæˆ–è·³è¿‡è¯¥æ–‡ä»¶ã€‚

---

### 3.3 æ—¥å¿—è¿è´¯æ€§

**å½“å‰çŠ¶å†µ**:

```typescript
// æ—¥å¿—ç¤ºä¾‹ï¼ˆæ¥è‡ª agent-five-layer.mdï¼‰
{
  "timestamp": "2026-02-18T01:12:09.644Z",
  "level": "info",
  "event": "skill.executed",
  "data": { "skill": "WriteArticle", "taskId": "task_123" },
  "sessionId": "sess_abc123",
  "traceId": "trace_xyz789"   // âœ… å­˜åœ¨ traceId å­—æ®µ
}
```

âœ… **Good**: `traceId` å’Œ `sessionId` å­—æ®µçš„è®¾è®¡å…è®¸è¿½è¸ªåŒä¸€æ¬¡è¯·æ±‚é“¾è·¯ã€‚

âš ï¸ **Bad**:  
1. **ä¸‰ä¸ªåœºæ™¯çš„ traceId ç”Ÿæˆæœºåˆ¶ä¸ç»Ÿä¸€**ï¼šåœºæ™¯1ï¼ˆæ‰‹åŠ¨ä¿å­˜ï¼‰çš„ BFF API å±‚æ˜¯å¦ç”Ÿæˆ traceIdï¼Ÿåœºæ™¯3ï¼ˆCronï¼‰çš„ traceId æ˜¯ä½•æ—¶ç”Ÿæˆçš„ï¼Ÿæ–‡æ¡£æœªè§ç»Ÿä¸€çš„ `RequestContext` ä¸­é—´ä»¶ã€‚  
2. **æ—¥å¿—æ–‡ä»¶æ˜¯å•ä¸€çº¿æ€§æ–‡ä»¶**ï¼šå¤šä»»åŠ¡å¹¶å‘æ—¶æ—¥å¿—è¡Œäº¤å‰ä¹±åºï¼Œæ— æ³•é€šè¿‡ `grep traceId` æå–å®Œæ•´é“¾è·¯ï¼ˆ`Logger.info()` å½“å‰æ˜¯åŒæ­¥å†™æ–‡ä»¶ï¼Œé«˜é¢‘å†™å…¥æœ¬èº«ä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆï¼‰ã€‚  
3. **Cron ä»»åŠ¡çš„æ—¥å¿—å’Œç”¨æˆ·è§¦å‘ä»»åŠ¡çš„æ—¥å¿—æ··åœ¨åŒä¸€æ–‡ä»¶**ï¼š24å°æ—¶åæ— æ³•åŒºåˆ†ã€Œå“ˆï¼Œä»Šå¤©æ—©ä¸Š9ç‚¹å‘ç”Ÿäº†ä»€ä¹ˆã€ã€‚

ğŸ”§ **Fix**:  
â‘  å…¥å£å±‚ï¼ˆHTTP Middleware + Cron Entryï¼‰ç»Ÿä¸€ç”Ÿæˆ `traceId = nanoid()`ï¼Œé€šè¿‡ Node.js `AsyncLocalStorage` é€ä¼ åˆ°æ‰€æœ‰ä¸‹å±‚è°ƒç”¨ï¼ŒLogger è‡ªåŠ¨é™„åŠ ï¼›  
â‘¡ æ—¥å¿—æ–‡ä»¶æŒ‰æ—¥æœŸ + åœºæ™¯åˆ†ç‰‡ï¼š`logs/2026-02-20.manual.log`ã€`logs/2026-02-20.agent.log`ã€`logs/2026-02-20.cron.log`ï¼›  
â‘¢ é•¿æœŸå¼•å…¥ OpenTelemetry æ ‡å‡†ï¼Œæ¥å…¥ä»»æ„å…¼å®¹çš„å¯è§‚æµ‹æ€§å¹³å°ï¼ˆGrafana/Jaegerï¼‰ã€‚

---

## ç¬¬å››é˜¶æ®µï¼šä¼˜å…ˆçº§ä¿®å¤æ¸…å•

### ğŸ”´ P0 â€” å¿…æ”¹ï¼ˆæ•°æ®å®‰å…¨ä¸ç³»ç»Ÿå¯ç”¨æ€§ç›¸å…³ï¼‰

| ID | é—®é¢˜ | æ¶‰åŠåœºæ™¯ | ä¿®å¤æ–¹å‘ |
|----|------|---------|---------|
| **P0-1** | Path Traversal è·¯å¾„ç©¿è¶Šæ¼æ´ï¼ˆ`/api/files/save` æ— è·¯å¾„ç™½åå•ï¼‰ | åœºæ™¯1, 2, 3 | è·¯å¾„æ²™ç®±æ ¡éªŒï¼šå¿…é¡»ä»¥ `docs/` å¼€å¤´ä¸”ä¸å« `..` |
| **P0-2** | `simple-git` å¹¶å‘å†™å…¥å¯¼è‡´ `.git/index.lock` å´©æºƒ | åœºæ™¯1 | å…¨å±€ Mutex ä¸²è¡Œé˜Ÿåˆ— + debounce é˜²æŠ– |
| **P0-3** | å®¢æˆ·ç«¯æ–­å¼€æ—¶åç«¯ LLM æµç»§ç»­æ¶ˆè€— Tokenï¼Œæ–‡ä»¶åŠå†™ç•™å­˜ | åœºæ™¯2, 3 | `req.on('close', abort)` çº§è”ç»ˆæ­¢ + å›æ»šæ–‡ä»¶ |
| **P0-4** | åœºæ™¯1/3 å¹¶å‘å†™å…¥åŒä¸€æ–‡ä»¶æ— é”æœºåˆ¶ï¼ˆé™é»˜æ•°æ®ä¸¢å¤±ï¼‰ | åœºæ™¯1 âˆ© åœºæ™¯3 | `proper-lockfile` æ–‡ä»¶çº§æ‚²è§‚é” |
| **P0-5** | AgentDashboard ç”Ÿäº§ç¯å¢ƒå…¬å¼€æš´éœ² API æˆæœ¬å’Œæ•æ„Ÿ Prompt | åœºæ™¯3 | ç¯å¢ƒå˜é‡ä¿æŠ¤ + ç”Ÿäº§æ„å»º Tree-shake |
| **P0-6** | çŠ¶æ€æœºæ—  Watchdog TTLï¼Œ`EXECUTING` æ°¸ä¹…é”æ­» | åœºæ™¯2, 3 | è¿›å…¥é•¿è€—æ—¶çŠ¶æ€æ—¶å¯åŠ¨ 5åˆ†é’Ÿçœ‹é—¨ç‹—å®šæ—¶å™¨ |

### ğŸŸ¡ P1 â€” å»ºè®®æ”¹ï¼ˆåŠŸèƒ½å®Œæ•´æ€§å’Œé˜²å¾¡æ€§ï¼‰

| ID | é—®é¢˜ | æ¶‰åŠåœºæ™¯ | ä¿®å¤æ–¹å‘ |
|----|------|---------|---------|
| **P1-1** | localStorage è‰ç¨¿æ— æ—¶é—´æˆ³æ ¡éªŒï¼Œå¤šç«¯ Git åŒæ­¥åé™é»˜è¦†ç›–æœ€æ–°ç‰ˆæœ¬ | åœºæ™¯1 | Key ç»‘å®š `mtime`ï¼ŒåŠ è½½æ—¶å†²çªå¼¹çª— |
| **P1-2** | `saveFile` å‰æ—  `fs.access` é‡åæ£€æŸ¥ï¼Œè¦†ç›–ç”¨æˆ·æ–‡ç« æ— è­¦å‘Š | åœºæ™¯2 | å†™å…¥å‰æ£€æŸ¥æ–‡ä»¶å­˜åœ¨ï¼Œå‘é€ `PAUSED` ç¡®è®¤ä¿¡å· |
| **P1-3** | `extractEntitiesFromContent` ç«‹åˆ»æ±¡æŸ“æ­£å¼è®°å¿†åº“ï¼Œå¹»è§‰è¢«æ”¾å¤§ | åœºæ™¯2 | å†™å…¥éš”ç¦» `memory/pending/`ï¼Œç”¨æˆ·ç¡®è®¤åè¿ç§» |
| **P1-4** | `simulateSearch` ç”¨ LLM åˆ¶é€ è™šå‡å¼•ç”¨ | åœºæ™¯2 | åºŸå¼ƒæ¨¡æ‹Ÿæœç´¢ï¼Œæ”¹ä¸ºæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·æœç´¢ä¸å¯ç”¨ |
| **P1-5** | Intent ç½®ä¿¡åº¦ < 0.8 æ—¶é™é»˜é™çº§åˆ° `posts/`ï¼Œæ–‡ä»¶æ ‘æ··ä¹± | åœºæ™¯2 | HITL åé—®æœºåˆ¶ï¼šæŒ‚èµ·çŠ¶æ€æœºï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤è·¯å¾„ |
| **P1-6** | GitHub Actions `git push` æ—  rebaseï¼ŒNon-fast-forward å¯¼è‡´ Cron æŒç»­å¤±è´¥ | åœºæ™¯3 | `git pull --rebase` + å†²çªæ—¶æ¨é€åˆ°ç‹¬ç«‹åˆ†æ”¯ |
| **P1-7** | `ContentEvaluator.JSON.parse()` æ—  schema æ ¡éªŒï¼ŒLLM æ ¼å¼é”™è¯¯å´©æºƒ | åœºæ™¯3 | `zod` ç»“æ„æ ¡éªŒ + è§£æå¤±è´¥ä¿å®ˆé»˜è®¤å€¼ |
| **P1-8** | Agent æ•°æ®æ–‡ä»¶å­˜æ”¾åœ¨é¡¹ç›®ç›®å½•ï¼ŒVite HMR OOM | åœºæ™¯1, 3 | `vite.watch.ignored` æ’é™¤ + å»ºè®®è¿å‡ºé¡¹ç›®ç›®å½• |

### ğŸŸ¢ P2 â€” å¯é€‰ï¼ˆå·¥ç¨‹è´¨é‡æå‡ï¼‰

| ID | é—®é¢˜ | æ¶‰åŠåœºæ™¯ | ä¿®å¤æ–¹å‘ |
|----|------|---------|---------|
| **P2-1** | `fs.writeFile` éåŸå­æ€§ï¼Œè¿›ç¨‹å´©æºƒæ—¶æ–‡ä»¶æŸå | åœºæ™¯1, 2, 3 | åŸå­å†™å…¥ï¼šå…ˆå†™ `.tmp` å† `rename` |
| **P2-2** | æ—¥å¿— traceId æ—  `AsyncLocalStorage` é€ä¼ ï¼Œå¤šä»»åŠ¡æ—¥å¿—äº¤å‰æ··ä¹± | åœºæ™¯1, 2, 3 | å¼•å…¥ `AsyncLocalStorage` å…¨é“¾è·¯ traceId |
| **P2-3** | `decideTargetPath` ç¡¬ç¼–ç æ­£åˆ™æšä¸¾ï¼Œç»´æŠ¤æˆæœ¬é«˜ | åœºæ™¯2, 3 | æ”¹ä¸º LLM è¾…åŠ©åˆ†ç±»ï¼ˆè¾“å…¥ç°æœ‰ç›®å½•æ ‘ + ä¸»é¢˜ï¼‰|
| **P2-4** | `saveAsDraft` ç”¨å­—ç¬¦ä¸²æ›¿æ¢ä¿®æ”¹ FrontMatterï¼Œæ ¼å¼å´©å | åœºæ™¯3 | æ”¹ç”¨ `gray-matter` ç»“æ„åŒ–è¯»å†™ YAML |
| **P2-5** | RAG æ— å‘é‡æ£€ç´¢ï¼Œå…³é”®è¯åŒ¹é…è¯­ä¹‰ç›²åŒºå¤§ | åœºæ™¯2, 3 | Phase 1 æ¥å…¥æ–‡æœ¬ embedding + cosine ç›¸ä¼¼åº¦ |
| **P2-6** | `buildContext` æ—  chunk æ•°é‡ä¸Šé™ï¼Œè¶…é•¿ prompt é«˜é¢è®¡è´¹ | åœºæ™¯2, 3 | æ·»åŠ  `topK: 5` ç¡¬é™åˆ¶ |
| **P2-7** | æ–‡ä»¶é‡å‘½åæ— çº§è”æ›´æ–° WikiLinksï¼ŒçŸ¥è¯†å›¾è°±æ–­é“¾ | åœºæ™¯1 | `PUT /api/files/rename` åç«¯æ­£åˆ™å…¨åº“æ›¿æ¢å¼•ç”¨ |

---

## æ€»ç»“

å½“å‰æ¶æ„çš„**è®¾è®¡æ°´å‡†é¢†å…ˆäºå®ç°çŠ¶æ€**â€”â€”äº”å±‚åˆ†ç¦»ã€æ„å›¾è·¯ç”±ã€çŠ¶æ€æœºã€æˆæœ¬è¿½è¸ªç­‰æ¦‚å¿µè®¾è®¡æ‰å®ï¼Œä½†çº¦ **65%** çš„å®ç°å°šåœ¨è·¯ä¸Šï¼ˆL3 å·¥å…·å±‚ä»… 10% å®Œæˆï¼‰ã€‚

æœ€éœ€è¦è­¦æƒ•çš„ä¸‰ä¸ªã€Œæ­»äº¡é™·é˜±ã€ï¼š

1. **P0-2 Git Lock å´©æºƒ** â€” å·²å®ç°éƒ¨åˆ†ï¼ˆåœºæ™¯1ä¿å­˜æµç¨‹ï¼‰ä¸­éšè—çš„ Production Bugï¼Œä¸Šçº¿å³å¯å¤ç°ï¼›
2. **P0-4 æ— æ–‡ä»¶é”** â€” ä¸‰ä¸ªåœºæ™¯åŒæ—¶è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»å…¸ç¾éš¾ï¼›
3. **P1-3 å®ä½“åº“æ±¡æŸ“** â€” å¹»è§‰å†…å®¹ä¸€æ—¦è¿›å…¥çŸ¥è¯†å›¾è°±ï¼Œä¼šé€šè¿‡ RAG è¢«æœªæ¥æ‰€æœ‰è¯·æ±‚æ”¾å¤§ï¼Œæ˜¯ã€ŒæŠ€æœ¯å€ºçš„åˆ©æ»šåˆ©ã€ã€‚

å»ºè®®åœ¨æ¨è¿› L3 å·¥å…·å®ç°ä¹‹å‰ï¼Œå…ˆå°†å…¨éƒ¨ P0 é—®é¢˜ä½œä¸º**é˜»å¡æ€§ä¿®å¤**å¤„ç†å®Œæ¯•ã€‚
