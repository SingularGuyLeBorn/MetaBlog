# èåˆæ¶æ„è®¾è®¡ - VitePress Ã— AI-Native Agent ç»ˆæèåˆæ–¹æ¡ˆ

> **ã€ä¼ä¸šçº§åŒæ¶æ„èåˆå®Œæ•´è®¾è®¡æ–‡æ¡£ã€‘**
> 
> ç‰ˆæœ¬: 3.0 Enterprise Edition  
> æ–‡æ¡£å¤§å°: 300KB+  
> æœ€åæ›´æ–°: 2026-02-18  
> 
> æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°ä¼ ç»Ÿ VitePress åšå®¢ä¸ AI-Native Agent çš„æ— ç¼èåˆæ–¹æ¡ˆï¼ŒåŒ…å«å®Œæ•´ä»£ç å®ç°ã€æ¶æ„è®¾è®¡ã€æ•°æ®æµå‘ã€è¿ç§»ç­–ç•¥ã€æµ‹è¯•ç”¨ä¾‹å’Œè¾¹ç•Œè®¾è®¡ã€‚

---

## ç›®å½•

1. [èåˆæ¶æ„è®¾è®¡å“²å­¦](#1-èåˆæ¶æ„è®¾è®¡å“²å­¦)
2. [ModeManager å®Œæ•´å®ç°](#2-modemanager-å®Œæ•´å®ç°)
3. [HistoryUnifier å®Œæ•´å®ç°](#3-historyunifier-å®Œæ•´å®ç°)
4. [UnifiedSearch å®Œæ•´å®ç°](#4-unifiedsearch-å®Œæ•´å®ç°)
5. [æ•°æ®èåˆè¯¦ç»†è®¾è®¡](#5-æ•°æ®èåˆè¯¦ç»†è®¾è®¡)
6. [UI èåˆè¯¦ç»†è®¾è®¡](#6-ui-èåˆè¯¦ç»†è®¾è®¡)
7. [è¿ç§»è·¯å¾„è¯¦ç»†è§„åˆ’](#7-è¿ç§»è·¯å¾„è¯¦ç»†è§„åˆ’)
8. [å®Œæ•´æµ‹è¯•ç”¨ä¾‹](#8-å®Œæ•´æµ‹è¯•ç”¨ä¾‹)
9. [ASCII æ¶æ„å›¾é›†](#9-ascii-æ¶æ„å›¾é›†)

---

## 1. èåˆæ¶æ„è®¾è®¡å“²å­¦

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦èåˆæ¶æ„

åœ¨å½“ä»Šå¿«é€Ÿå‘å±•çš„æŠ€æœ¯ landscape ä¸­ï¼Œå†…å®¹ç®¡ç†ç³»ç»Ÿé¢ä¸´ç€å‰æ‰€æœªæœ‰çš„æŒ‘æˆ˜ã€‚ä¼ ç»Ÿé™æ€ç½‘ç«™ç”Ÿæˆå™¨ï¼ˆå¦‚ VitePressã€Jekyllã€Hugoï¼‰æä¾›äº†å‡ºè‰²çš„æ€§èƒ½ã€ç®€æ´çš„éƒ¨ç½²æµç¨‹å’Œæè‡´çš„è®¿é—®é€Ÿåº¦ï¼Œä½†å®ƒä»¬åœ¨åŠ¨æ€äº¤äº’ã€ä¸ªæ€§åŒ–ä½“éªŒå’Œæ™ºèƒ½è¾…åŠ©æ–¹é¢å­˜åœ¨å¤©ç„¶å±€é™ã€‚ä¸æ­¤åŒæ—¶ï¼ŒAI-Native åº”ç”¨è™½ç„¶å…·å¤‡å¼ºå¤§çš„æ™ºèƒ½å¤„ç†èƒ½åŠ›ï¼Œä½†å¾€å¾€ç¼ºä¹ç¨³å®šçš„å†…å®¹åŸºç¡€è®¾æ–½å’Œæˆç†Ÿçš„å‘å¸ƒæµç¨‹ã€‚

èåˆæ¶æ„çš„è¯ç”Ÿï¼Œæ­£æ˜¯ä¸ºäº†å¼¥åˆè¿™ä¸€é¸¿æ²Ÿã€‚

#### 1.1.1 ä¼ ç»Ÿæ¶æ„çš„å±€é™æ€§

**é™æ€ç½‘ç«™ç”Ÿæˆå™¨çš„å›ºæœ‰çº¦æŸ**

ä¼ ç»Ÿçš„ VitePress æ¶æ„éµå¾ª"æ„å»ºæ—¶ç”Ÿæˆ"ï¼ˆBuild-time Generationï¼‰èŒƒå¼ï¼Œå…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼š

1. **æè‡´æ€§èƒ½**: é¢„æ¸²æŸ“çš„ HTML æ–‡ä»¶å¯ç›´æ¥ç”± CDN åˆ†å‘ï¼Œé¦–å±åŠ è½½æ—¶é—´æçŸ­
2. **å®‰å…¨ç®€å•**: æ— æœåŠ¡ç«¯è¿è¡Œæ—¶ï¼Œæ”»å‡»é¢æå°ï¼Œç»´æŠ¤æˆæœ¬ä½å»‰
3. **ç‰ˆæœ¬æ§åˆ¶å‹å¥½**: Markdown æºç å¤©ç„¶é€‚åˆ Git ç®¡ç†ï¼Œå˜æ›´å¯è¿½æº¯
4. **éƒ¨ç½²ä¾¿æ·**: ä»»ä½•é™æ€æ‰˜ç®¡æœåŠ¡å‡å¯æ‰¿è½½ï¼Œä» GitHub Pages åˆ° Cloudflare Workers

ç„¶è€Œï¼Œè¿™ç§æ¨¡å¼ä¹Ÿå­˜åœ¨æ˜æ˜¾çš„å±€é™æ€§ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¼ ç»Ÿé™æ€æ¶æ„çš„å±€é™æ€§åˆ†æ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å†…å®¹å‘ç°å›°éš¾                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ ä¼ ç»Ÿæœç´¢ä¾èµ–å…³é”®è¯åŒ¹é…ï¼Œæ— æ³•ç†è§£è¯­ä¹‰                                       â”‚
â”‚  â€¢ å†…å®¹å…³è”ä¾èµ–äººå·¥ç»´æŠ¤çš„é“¾æ¥ï¼Œå®¹æ˜“è¿‡æ—¶                                       â”‚
â”‚  â€¢ ç”¨æˆ·éš¾ä»¥åœ¨æµ·é‡æ–‡æ¡£ä¸­å¿«é€Ÿå®šä½æ‰€éœ€ä¿¡æ¯                                       â”‚
â”‚  â€¢ ç¼ºä¹ä¸ªæ€§åŒ–æ¨èï¼Œæ¯ä¸ªç”¨æˆ·çœ‹åˆ°ç›¸åŒçš„å†…å®¹                                     â”‚
â”‚                                                                             â”‚
â”‚  2. ç¼–è¾‘ä½“éªŒå‰²è£‚                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ å†™ä½œä¸ç ”ç©¶åˆ†ç¦»ï¼šä½œè€…éœ€è¦åœ¨æµè§ˆå™¨å’Œç¼–è¾‘å™¨ä¹‹é—´åå¤åˆ‡æ¢                        â”‚
â”‚  â€¢ ç¼ºä¹å®æ—¶è¾…åŠ©ï¼šè¯­æ³•æ£€æŸ¥ã€é£æ ¼å»ºè®®ã€äº‹å®æ ¸æŸ¥éœ€è¦äººå·¥å®Œæˆ                      â”‚
â”‚  â€¢ ç‰ˆæœ¬æ§åˆ¶å¤æ‚ï¼šGit å†å²å¯¹éæŠ€æœ¯äººå‘˜ä¸å‹å¥½                                   â”‚
â”‚  â€¢ åä½œæµç¨‹ç¹çï¼šä»£ç å®¡æŸ¥æ¨¡å¼ä¸é€‚åˆå†…å®¹å®¡æŸ¥                                   â”‚
â”‚                                                                             â”‚
â”‚  3. çŸ¥è¯†æ²‰æ·€å›°éš¾                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ æ–‡æ¡£ä»¥æ–‡ä»¶å½¢å¼åˆ†æ•£å­˜å‚¨ï¼Œéš¾ä»¥å½¢æˆçŸ¥è¯†ç½‘ç»œ                                   â”‚
â”‚  â€¢ æ›´æ–°å†å²ä»¥æäº¤è®°å½•å½¢å¼å­˜åœ¨ï¼Œéš¾ä»¥è¿½æº¯å†³ç­–è¿‡ç¨‹                               â”‚
â”‚  â€¢ ä½œè€…çš„ä¸“ä¸šçŸ¥è¯†éšå«åœ¨æ–‡æ¡£ä¸­ï¼Œæ— æ³•è¢«ç³»ç»ŸåŒ–å¤ç”¨                               â”‚
â”‚  â€¢ è·¨æ–‡æ¡£çš„å…³è”å…³ç³»éœ€è¦äººå·¥ç»´æŠ¤ï¼Œç»´æŠ¤æˆæœ¬é«˜                                   â”‚
â”‚                                                                             â”‚
â”‚  4. æ‰©å±•æ€§å—é™                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ æ·»åŠ åŠ¨æ€åŠŸèƒ½éœ€è¦å¼•å…¥å¤æ‚çš„æœåŠ¡ç«¯æ¶æ„                                       â”‚
â”‚  â€¢ ç”¨æˆ·äº¤äº’é™äºå®¢æˆ·ç«¯ JavaScriptï¼Œèƒ½åŠ›æœ‰é™                                   â”‚
â”‚  â€¢ é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡éœ€è¦é¢å¤–çš„å¼€å‘å·¥ä½œ                                           â”‚
â”‚  â€¢ éš¾ä»¥å®ç°çœŸæ­£çš„ä¸ªæ€§åŒ–å’Œæ™ºèƒ½åŒ–ä½“éªŒ                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“åœºæ™¯åˆ†æ**

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“åœºæ™¯æ¥ç†è§£è¿™äº›å±€é™æ€§ï¼š

å‡è®¾ Alice æ˜¯ä¸€ä½æŠ€æœ¯æ–‡æ¡£å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£ç»´æŠ¤ä¸€ä¸ªå¤§å‹å¼€æºé¡¹ç›®çš„æ–‡æ¡£ç«™ç‚¹ã€‚å¥¹é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **æ—©æ™¨ 9:00**: Alice æ”¶åˆ°ç”¨æˆ·åé¦ˆï¼Œè¯´æŸä¸ª API çš„æ–‡æ¡£ç¤ºä¾‹å·²ç»è¿‡æ—¶ã€‚å¥¹éœ€è¦åœ¨æ•°ç™¾ä¸ª Markdown æ–‡ä»¶ä¸­å®šä½ç›¸å…³å†…å®¹ã€‚
   - é—®é¢˜ï¼šä¼ ç»Ÿæœç´¢åªèƒ½åŒ¹é…å…³é”®è¯ï¼Œæ— æ³•è¯†åˆ«è¯­ä¹‰ç›¸ä¼¼çš„æè¿°
   - ç»“æœï¼šAlice èŠ±äº† 30 åˆ†é’Ÿæ‰æ‰¾åˆ°æ‰€æœ‰ç›¸å…³æ–‡æ¡£

2. **ä¸Šåˆ 10:30**: Alice å¼€å§‹æ›´æ–°æ–‡æ¡£ã€‚å¥¹éœ€è¦éªŒè¯æ–°çš„ API è¡Œä¸ºï¼ŒæŸ¥é˜…æºä»£ç ï¼ŒåŒæ—¶ä¿æŒå†™ä½œ flowã€‚
   - é—®é¢˜ï¼šç ”ç©¶ï¼ˆæµè§ˆå™¨ï¼‰å’Œå†™ä½œï¼ˆç¼–è¾‘å™¨ï¼‰å®Œå…¨åˆ†ç¦»
   - ç»“æœï¼šé¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ•ˆç‡ä½ä¸‹

3. **ä¸‹åˆ 2:00**: Alice å®Œæˆä¿®æ”¹ï¼Œå‡†å¤‡æäº¤ã€‚å¥¹éœ€è¦å†™æäº¤ä¿¡æ¯ï¼Œç¡®ä¿æ ¼å¼ç¬¦åˆé¡¹ç›®è§„èŒƒã€‚
   - é—®é¢˜ï¼šGit å¯¹éæŠ€æœ¯äººå‘˜é—¨æ§›é«˜ï¼Œæäº¤ä¿¡æ¯è´¨é‡å‚å·®ä¸é½
   - ç»“æœï¼šå†å²è®°å½•éš¾ä»¥é˜…è¯»ï¼Œåç»­ç»´æŠ¤å›°éš¾

4. **ä¸‹åˆ 4:00**: å¦ä¸€ä½ä½œè€… Bob æ›´æ–°äº†ç›¸å…³ç« èŠ‚ï¼Œäº§ç”Ÿäº†å†²çªã€‚
   - é—®é¢˜ï¼šæ–‡æ¡£å†²çªè§£å†³ç¼ºä¹å¯è§†åŒ–å·¥å…·
   - ç»“æœï¼šéœ€è¦æ‰‹åŠ¨æ¯”å¯¹æ–‡æœ¬ï¼Œå®¹æ˜“å‡ºé”™

è¿™ä¸ªåœºæ™¯æ­ç¤ºäº†ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**ä¼ ç»Ÿå·¥å…·é“¾æ˜¯ä¸ºä»£ç è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯ä¸ºå†…å®¹è®¾è®¡çš„**ã€‚

#### 1.1.2 AI-Native æ¶æ„çš„æœºé‡ä¸æŒ‘æˆ˜

**å¤§æ¨¡å‹å¸¦æ¥çš„æ–°å¯èƒ½**

å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å‡ºç°ä¸ºå†…å®¹ç®¡ç†å¸¦æ¥äº†é©å‘½æ€§çš„å˜åŒ–ï¼š

1. **è¯­ä¹‰ç†è§£èƒ½åŠ›**: æ¨¡å‹å¯ä»¥ç†è§£å†…å®¹çš„å«ä¹‰ï¼Œè€Œä¸ä»…ä»…æ˜¯åŒ¹é…å…³é”®è¯
2. **ç”Ÿæˆèƒ½åŠ›**: å¯ä»¥è¾…åŠ©å†™ä½œã€è‡ªåŠ¨æ‘˜è¦ã€ç¿»è¯‘å’Œå¤šç‰ˆæœ¬ç”Ÿæˆ
3. **æ¨ç†èƒ½åŠ›**: å¯ä»¥åˆ†æå†…å®¹ç»“æ„ã€å‘ç°é€»è¾‘æ¼æ´ã€æä¾›æ”¹è¿›å»ºè®®
4. **ä¸Šä¸‹æ–‡å­¦ä¹ **: å¯ä»¥åŸºäºå·²æœ‰å†…å®¹å­¦ä¹ é£æ ¼ï¼Œä¿æŒä¸€è‡´æ€§

**çº¯ AI æ¶æ„çš„æŒ‘æˆ˜**

ç„¶è€Œï¼Œå®Œå…¨åŸºäº AI çš„æ¶æ„ä¹Ÿé¢ä¸´æŒ‘æˆ˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çº¯ AI æ¶æ„çš„æŒ‘æˆ˜åˆ†æ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. å¯é æ€§é—®é¢˜                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ å¤§æ¨¡å‹å¯èƒ½äº§ç”Ÿ"å¹»è§‰"ï¼ˆhallucinationï¼‰ï¼Œç”Ÿæˆçœ‹ä¼¼åˆç†ä½†å®é™…é”™è¯¯çš„å†…å®¹        â”‚
â”‚  â€¢ è¾“å‡ºç»“æœä¸ç¨³å®šï¼Œç›¸åŒçš„è¾“å…¥å¯èƒ½äº§ç”Ÿä¸åŒçš„è¾“å‡º                               â”‚
â”‚  â€¢ éš¾ä»¥ä¿è¯å†…å®¹çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§                                              â”‚
â”‚  â€¢ ç¼ºä¹æƒå¨çš„ç‰ˆæœ¬æ§åˆ¶å’Œå®¡è®¡è¿½è¸ª                                              â”‚
â”‚                                                                             â”‚
â”‚  2. æˆæœ¬é—®é¢˜                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ API è°ƒç”¨æˆæœ¬éšä½¿ç”¨é‡çº¿æ€§å¢é•¿ï¼Œéš¾ä»¥é¢„æµ‹                                    â”‚
â”‚  â€¢ æœ¬åœ°éƒ¨ç½²å¤§æ¨¡å‹éœ€è¦æ˜‚è´µçš„ç¡¬ä»¶èµ„æº                                          â”‚
â”‚  â€¢ å¤æ‚ä»»åŠ¡å¯èƒ½éœ€è¦å¤šè½®è°ƒç”¨ï¼Œæˆæœ¬å åŠ                                         â”‚
â”‚  â€¢ éš¾ä»¥å®ç°çœŸæ­£çš„"å…è´¹"å†…å®¹æ‰˜ç®¡                                             â”‚
â”‚                                                                             â”‚
â”‚  3. å»¶è¿Ÿé—®é¢˜                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ å¤§æ¨¡å‹æ¨ç†éœ€è¦æ—¶é—´ï¼Œä¸é€‚åˆå®æ—¶äº¤äº’åœºæ™¯                                     â”‚
â”‚  â€¢ é¦–æ¬¡ç”Ÿæˆå†…å®¹å¯èƒ½éœ€è¦æ•°ç§’ç”šè‡³æ›´ä¹…                                          â”‚
â”‚  â€¢ æµå¼è¾“å‡ºè™½ç„¶æ”¹å–„äº†ä½“éªŒï¼Œä½†åŸºç¡€å»¶è¿Ÿä»ç„¶å­˜åœ¨                                 â”‚
â”‚  â€¢ éš¾ä»¥è¾¾åˆ°é™æ€ç½‘ç«™çš„å³æ—¶å“åº”ä½“éªŒ                                            â”‚
â”‚                                                                             â”‚
â”‚  4. å¯æ§æ€§é—®é¢˜                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ AI çš„å†³ç­–è¿‡ç¨‹å¾€å¾€ä¸é€æ˜ï¼Œéš¾ä»¥è°ƒè¯•                                         â”‚
â”‚  â€¢ å†…å®¹é£æ ¼å¯èƒ½åç¦»é¢„æœŸï¼Œéœ€è¦åå¤è°ƒæ•´æç¤ºè¯                                   â”‚
â”‚  â€¢ éš¾ä»¥ä¿è¯ç¬¦åˆå“ç‰ŒæŒ‡å—å’Œæ³•å¾‹åˆè§„è¦æ±‚                                        â”‚
â”‚  â€¢ ç”¨æˆ·å¯¹ AI ç”Ÿæˆå†…å®¹çš„ä¿¡ä»»åº¦å­˜åœ¨å·®å¼‚                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.1.3 èåˆæ¶æ„çš„å¿…è¦æ€§

**æœ€ä½³ç»“åˆç‚¹çš„æ¢ç´¢**

èåˆæ¶æ„çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š**å–ä¸¤è€…ä¹‹é•¿ï¼Œè¡¥ä¸¤è€…ä¹‹çŸ­**ã€‚ä¸æ˜¯ç”¨ AI æ›¿ä»£ä¼ ç»Ÿå·¥å…·ï¼Œè€Œæ˜¯è®© AI å¢å¼ºä¼ ç»Ÿå·¥å…·ï¼›ä¸æ˜¯æ¨å€’é‡æ¥ï¼Œè€Œæ˜¯æ¸è¿›å‡çº§ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      èåˆæ¶æ„çš„ä»·å€¼ä¸»å¼                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚      ä¼ ç»Ÿé™æ€æ¶æ„            â”‚    â”‚      AI-Native æ¶æ„          â”‚        â”‚
â”‚  â”‚      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•        â”‚    â”‚      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•        â”‚        â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚        â”‚
â”‚  â”‚  âœ“ æè‡´æ€§èƒ½                  â”‚    â”‚  âœ“ æ™ºèƒ½ç†è§£                  â”‚        â”‚
â”‚  â”‚  âœ“ ç¨³å®šå¯é                   â”‚    â”‚  âœ“ ç”Ÿæˆèƒ½åŠ›                  â”‚        â”‚
â”‚  â”‚  âœ“ æˆæœ¬å¯æ§                  â”‚    â”‚  âœ“ ä¸ªæ€§åŒ–ä½“éªŒ                â”‚        â”‚
â”‚  â”‚  âœ“ ç‰ˆæœ¬å¯æ§                  â”‚    â”‚  âœ“ è‡ªåŠ¨åŒ–å¤„ç†                â”‚        â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚        â”‚
â”‚  â”‚  âœ— ç¼ºä¹æ™ºèƒ½                  â”‚    â”‚  âœ— å¯é æ€§å­˜ç–‘                â”‚        â”‚
â”‚  â”‚  âœ— ä½“éªŒå•ä¸€                  â”‚    â”‚  âœ— æˆæœ¬é«˜æ˜‚                  â”‚        â”‚
â”‚  â”‚  âœ— ç¼–è¾‘ä½æ•ˆ                  â”‚    â”‚  âœ— å»¶è¿Ÿè¾ƒé«˜                  â”‚        â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â”‚                                  â”‚                        â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                â–¼                                           â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                 â”‚      èåˆæ¶æ„ = æœ€ä½³ç»“åˆç‚¹      â”‚                           â”‚
â”‚                 â”‚      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       â”‚                           â”‚
â”‚                 â”‚                               â”‚                           â”‚
â”‚                 â”‚  é™æ€å†…å®¹ + AI å¢å¼º =           â”‚                           â”‚
â”‚                 â”‚                               â”‚                           â”‚
â”‚                 â”‚  â€¢ ä¿æŒé™æ€ç½‘ç«™çš„æè‡´æ€§èƒ½        â”‚                           â”‚
â”‚                 â”‚  â€¢ åœ¨å…³é”®èŠ‚ç‚¹å¼•å…¥ AI èƒ½åŠ›        â”‚                           â”‚
â”‚                 â”‚  â€¢ æ¸è¿›å¼å¢å¼ºï¼Œé£é™©å¯æ§          â”‚                           â”‚
â”‚                 â”‚  â€¢ å¯é€‰åŠŸèƒ½ï¼Œç”¨æˆ·è‡ªä¸»é€‰æ‹©        â”‚                           â”‚
â”‚                 â”‚  â€¢ äººæœºåä½œï¼Œäº’ä¸ºè¡¥å……            â”‚                           â”‚
â”‚                 â”‚                               â”‚                           â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“èåˆç­–ç•¥**

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | AI å¢å¼ºæ–¹å¼ | èåˆæ–¹æ¡ˆ |
|------|---------|------------|---------|
| å†…å®¹æœç´¢ | å…³é”®è¯åŒ¹é… | è¯­ä¹‰å‘é‡æœç´¢ | æ··åˆæœç´¢ï¼šå…³é”®è¯ + è¯­ä¹‰ |
| å†…å®¹ç¼–è¾‘ | çº¯æ‰‹åŠ¨ç¼–å†™ | AI å®Œå…¨ä»£å†™ | åä½œç¼–å†™ï¼šAI å»ºè®® + äººå·¥ç¡®è®¤ |
| å†…å®¹å‘å¸ƒ | Git æäº¤ | AI è‡ªåŠ¨å‘å¸ƒ | åŠè‡ªåŠ¨ï¼šAI è¾…åŠ©å‡†å¤‡ + äººå·¥å®¡æ ¸å‘å¸ƒ |
| å†å²æŸ¥çœ‹ | Git log | AI æ€»ç»“ | ç»Ÿä¸€è§†å›¾ï¼šå¯è§†åŒ–æ—¶é—´çº¿ + AI æ‘˜è¦ |
| çŸ¥è¯†å‘ç° | äººå·¥é“¾æ¥ | AI è‡ªåŠ¨å…³è” | æ··åˆå…³è”ï¼šWikiLinks + è¯­ä¹‰å›¾è°± |

### 1.2 èåˆæ¶æ„çš„æ ¸å¿ƒåŸåˆ™

èåˆæ¶æ„çš„è®¾è®¡éµå¾ªäº”é¡¹æ ¸å¿ƒåŸåˆ™ï¼Œç¡®ä¿åœ¨å¼•å…¥ AI èƒ½åŠ›çš„åŒæ—¶ï¼Œä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§ã€å¯æ§æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

#### 1.2.1 åŸåˆ™ä¸€ï¼šå…±ç”Ÿè€Œéæ›¿ä»£ï¼ˆSymbiosis over Replacementï¼‰

**æ ¸å¿ƒç†å¿µ**

AI ä¸æ˜¯æ¥å–ä»£ç°æœ‰å·¥å…·å’Œæµç¨‹çš„ï¼Œè€Œæ˜¯æ¥å¢å¼ºå®ƒä»¬ã€‚ä¼ ç»Ÿå·¥å…·ç»è¿‡é•¿æœŸéªŒè¯ï¼Œæœ‰å…¶ä¸å¯æ›¿ä»£çš„ä»·å€¼ï¼›AI æä¾›äº†æ–°çš„å¯èƒ½æ€§ï¼Œä½†ä¹Ÿæœ‰å…¶å±€é™æ€§ã€‚ä¸¤è€…çš„ç»“åˆåº”è¯¥åƒå…±ç”Ÿç”Ÿç‰©ä¸€æ ·ï¼Œäº’ç›¸è¡¥å……ï¼Œå…±åŒè¿›åŒ–ã€‚

**å…·ä½“å®è·µ**

```typescript
// agent/fusion/principles/SymbiosisPrinciple.ts

/**
 * å…±ç”ŸåŸåˆ™å®ç°
 * 
 * ç¡®ä¿ AI åŠŸèƒ½ä½œä¸ºå¯é€‰å¢å¼ºï¼Œè€Œéå¼ºåˆ¶æ›¿ä»£
 */
export class SymbiosisPrinciple {
  
  /**
   * åŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥
   * ä»»ä½• AI å¢å¼ºåŠŸèƒ½éƒ½åº”è¯¥èƒ½å¤Ÿåœ¨ AI ä¸å¯ç”¨æ—¶ä¼˜é›…é™çº§
   */
  static isFeatureAvailable(feature: AIFeature): boolean {
    // æ£€æŸ¥ AI æœåŠ¡æ˜¯å¦å¯ç”¨
    const aiAvailable = AIServiceManager.isHealthy()
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ç”¨äº†è¯¥åŠŸèƒ½
    const userEnabled = UserPreferences.get(`feature.${feature.id}`) !== false
    
    // æ£€æŸ¥è¯¥åŠŸèƒ½æ˜¯å¦æœ‰é™çº§æ–¹æ¡ˆ
    const hasFallback = feature.fallback !== undefined
    
    // AI åŠŸèƒ½å¯ç”¨ = AI æœåŠ¡æ­£å¸¸ && ç”¨æˆ·å¯ç”¨
    // åŸºç¡€åŠŸèƒ½å§‹ç»ˆå¯ç”¨ï¼ˆé€šè¿‡é™çº§æ–¹æ¡ˆï¼‰
    if (feature.requiresAI) {
      return aiAvailable && userEnabled
    }
    
    return true
  }
  
  /**
   * æ‰§è¡Œå¢å¼ºåŠŸèƒ½
   * ä¼˜å…ˆä½¿ç”¨ AI å¢å¼ºç‰ˆæœ¬ï¼Œä¸å¯ç”¨æ—¶ä½¿ç”¨ä¼ ç»Ÿæ–¹æ¡ˆ
   */
  static async executeWithEnhancement<T>(
    traditionalFn: () => Promise<T>,
    aiEnhancedFn: () => Promise<T>,
    feature: AIFeature
  ): Promise<T> {
    // é¦–å…ˆå°è¯• AI å¢å¼ºç‰ˆæœ¬
    if (this.isFeatureAvailable(feature)) {
      try {
        const result = await aiEnhancedFn()
        Analytics.track('ai_feature_success', { feature: feature.id })
        return result
      } catch (error) {
        Analytics.track('ai_feature_fallback', { 
          feature: feature.id, 
          error: error.message 
        })
        // AI å¤±è´¥æ—¶è®°å½•ä½†ç»§ç»­ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ¡ˆ
      }
    }
    
    // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ¡ˆ
    return traditionalFn()
  }
  
  /**
   * æœç´¢åŠŸèƒ½çš„å…±ç”Ÿå®ç°ç¤ºä¾‹
   */
  static async search(query: string, options: SearchOptions): Promise<SearchResult[]> {
    const feature: AIFeature = {
      id: 'semantic_search',
      requiresAI: false, // æœç´¢æœ¬èº«ä¸å¼ºåˆ¶éœ€è¦ AI
      fallback: 'keyword_search'
    }
    
    return this.executeWithEnhancement(
      // ä¼ ç»Ÿæ–¹æ¡ˆï¼šå…³é”®è¯æœç´¢
      () => KeywordSearch.search(query, options),
      // AI å¢å¼ºï¼šè¯­ä¹‰å‘é‡æœç´¢ + å…³é”®è¯æœç´¢æ··åˆ
      () => HybridSearch.search(query, options),
      feature
    )
  }
}

interface AIFeature {
  id: string
  requiresAI: boolean
  fallback?: string
}
```

**ç”¨æˆ·åœºæ™¯ç¤ºä¾‹**

**åœºæ™¯ 1ï¼šæœç´¢åŠŸèƒ½**

- **ä¼ ç»Ÿæ–¹å¼**: ç”¨æˆ·è¾“å…¥ "error handling"ï¼Œç³»ç»Ÿè¿”å›åŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡æ¡£
- **çº¯ AI æ–¹å¼**: ç”¨æˆ·æè¿°é—®é¢˜ "æˆ‘çš„ç¨‹åºé‡åˆ°é”™è¯¯æ—¶å´©æºƒäº†"ï¼ŒAI ç†è§£è¯­ä¹‰å¹¶è¿”å›ç›¸å…³æ–‡æ¡£
- **èåˆæ–¹å¼**: 
  - é»˜è®¤ä½¿ç”¨å…³é”®è¯æœç´¢ï¼ˆå¿«é€Ÿã€ç¡®å®šæ€§å¼ºï¼‰
  - å¦‚æœå…³é”®è¯æœç´¢ç»“æœä¸ä½³ï¼Œæç¤ºç”¨æˆ·å°è¯•è¯­ä¹‰æœç´¢
  - è¯­ä¹‰æœç´¢å¯ç”¨æ—¶ï¼Œç»“åˆä¸¤ç§ç»“æœç»™å‡ºæœ€ä½³ç­”æ¡ˆ
  - AI ä¸å¯ç”¨æ—¶ï¼Œå…³é”®è¯æœç´¢å®Œå…¨æ­£å¸¸å·¥ä½œ

**åœºæ™¯ 2ï¼šå†…å®¹ç¼–è¾‘**

- **ä¼ ç»Ÿæ–¹å¼**: ä½œè€…å®Œå…¨æ‰‹åŠ¨ç¼–å†™å†…å®¹
- **çº¯ AI æ–¹å¼**: AI å®Œå…¨è‡ªåŠ¨ç”Ÿæˆå†…å®¹
- **èåˆæ–¹å¼**:
  - ä½œè€…ç¼–å†™æ—¶ï¼ŒAI å®æ—¶æä¾›è¡¥å…¨å»ºè®®ï¼ˆç±»ä¼¼ Copilotï¼‰
  - ä½œè€…å¯ä»¥ä¸€é”®æ¥å—ã€æ‹’ç»æˆ–ä¿®æ”¹å»ºè®®
  - AI å¯ä»¥åˆ†æå·²æœ‰å†…å®¹ï¼Œå‘ç°ä¸ä¸€è‡´æˆ–ç¼ºå¤±
  - ä½œè€…å§‹ç»ˆæ‹¥æœ‰æœ€ç»ˆå†³å®šæƒ

#### 1.2.2 åŸåˆ™äºŒï¼šæ¸è¿›å¼å¢å¼ºï¼ˆProgressive Enhancementï¼‰

**æ ¸å¿ƒç†å¿µ**

ä»æœ€ç®€å•çš„åŠŸèƒ½å¼€å§‹ï¼Œé€æ­¥æ·»åŠ æ›´å¤æ‚çš„èƒ½åŠ›ã€‚æ¯ä¸ªé˜¶æ®µéƒ½åº”è¯¥æ˜¯ä¸€ä¸ªå¯ç”¨çš„äº§å“ï¼Œè€Œä¸æ˜¯åŠæˆå“ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å’Œèˆ’é€‚åº¦é€‰æ‹©ä½¿ç”¨å“ªäº›åŠŸèƒ½ã€‚

**æ¸è¿›å¼å±‚æ¬¡è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¸è¿›å¼å¢å¼ºå±‚æ¬¡ç»“æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Level 0: åŸºç¡€å±‚ (Foundation)                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ ¸å¿ƒåŠŸèƒ½ (æ— éœ€ AIï¼Œ100% å¯ç”¨)                                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â€¢ VitePress é™æ€ç½‘ç«™ç”Ÿæˆ                                           â”‚   â”‚
â”‚  â”‚  â€¢ Markdown ç¼–è¾‘ä¸é¢„è§ˆ                                              â”‚   â”‚
â”‚  â”‚  â€¢ Git ç‰ˆæœ¬æ§åˆ¶                                                     â”‚   â”‚
â”‚  â”‚  â€¢ åŸºç¡€æœç´¢ (FlexSearch)                                            â”‚   â”‚
â”‚  â”‚  â€¢ æ–‡ä»¶ç³»ç»Ÿç®¡ç†                                                     â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ä»·å€¼: ä¸€ä¸ªå®Œæ•´ã€å¯ç”¨çš„æŠ€æœ¯åšå®¢ç³»ç»Ÿ                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â–²                                        â”‚
â”‚                                    â”‚ åŸºç¡€å±‚æ°¸ä¸ä¾èµ–ä¸Šå±‚                      â”‚
â”‚  Level 1: å¢å¼ºå±‚ (Enhancement)     â”‚                                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AI è¾…åŠ©åŠŸèƒ½ (å¯é€‰å¢å¼º)                                               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â€¢ è¯­ä¹‰æœç´¢ (æœ¬åœ°å‘é‡ç´¢å¼•)                                            â”‚   â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½è¡¥å…¨ (åŸºäºæœ¬åœ°æ¨¡å‹æˆ–è½»é‡ API)                                   â”‚   â”‚
â”‚  â”‚  â€¢ å†…å®¹åˆ†æ (é“¾æ¥æ£€æŸ¥ã€é‡å¤æ£€æµ‹)                                       â”‚   â”‚
â”‚  â”‚  â€¢ åŸºç¡€ AI èŠå¤© (æ‚¬æµ®çƒ)                                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ä»·å€¼: æå‡æ•ˆç‡ï¼Œä½†éå¿…éœ€                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â–²                                        â”‚
â”‚                                    â”‚ å¢å¼ºå±‚ä¾èµ–åŸºç¡€å±‚                        â”‚
â”‚  Level 2: åä½œå±‚ (Collaboration)   â”‚                                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  äººæœºåä½œåŠŸèƒ½ (æ·±åº¦é›†æˆ)                                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â€¢ å®æ—¶ AI è¾…åŠ©ç¼–è¾‘                                                   â”‚   â”‚
â”‚  â”‚  â€¢ å†…è”å»ºè®®ä¸è¯„è®º                                                     â”‚   â”‚
â”‚  â”‚  â€¢ Web æœç´¢é›†æˆ                                                       â”‚   â”‚
â”‚  â”‚  â€¢ çŸ¥è¯†å›¾è°±æ„å»º                                                       â”‚   â”‚
â”‚  â”‚  â€¢ è®°å¿†ç³»ç»Ÿ                                                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ä»·å€¼: æ˜¾è‘—æ”¹å–„åˆ›ä½œä½“éªŒ                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â–²                                        â”‚
â”‚                                    â”‚ åä½œå±‚ä¾èµ–å¢å¼ºå±‚                        â”‚
â”‚  Level 3: è‡ªä¸»å±‚ (Autonomy)        â”‚                                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Agent è‡ªä¸»åŠŸèƒ½ (é«˜çº§è‡ªåŠ¨åŒ–)                                          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â€¢ æ„å›¾é©±åŠ¨çš„å†…å®¹ç”Ÿæˆ                                                 â”‚   â”‚
â”‚  â”‚  â€¢ å¤šæ­¥éª¤ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ                                                 â”‚   â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½ç ”ç©¶ä»£ç†                                                       â”‚   â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨å†…å®¹ç»´æŠ¤                                                       â”‚   â”‚
â”‚  â”‚  â€¢ å®¡æ‰¹å·¥ä½œæµ                                                         â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ä»·å€¼: è‡ªåŠ¨åŒ–å¤æ‚ä»»åŠ¡ï¼Œä½†ä»æœ‰äººå·¥ç›‘ç£                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å…³é”®è®¾è®¡ç‚¹:                                                                â”‚
â”‚  â€¢ æ¯å±‚éƒ½æ˜¯å®Œæ•´å¯ç”¨çš„äº§å“                                                   â”‚
â”‚  â€¢ ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚                                              â”‚
â”‚  â€¢ ç”¨æˆ·å¯ä»¥é€‰æ‹©åœåœ¨ä»»ä½•ä¸€å±‚                                                  â”‚
â”‚  â€¢ åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œéœ€è¦æ˜¾å¼å¼€å¯                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**

```typescript
// agent/fusion/principles/ProgressiveEnhancement.ts

/**
 * æ¸è¿›å¼å¢å¼ºç®¡ç†å™¨
 */
export class ProgressiveEnhancementManager {
  private static instance: ProgressiveEnhancementManager
  private currentLevel: EnhancementLevel = EnhancementLevel.FOUNDATION
  
  static getInstance(): ProgressiveEnhancementManager {
    if (!this.instance) {
      this.instance = new ProgressiveEnhancementManager()
    }
    return this.instance
  }
  
  /**
   * è·å–å½“å‰å¢å¼ºçº§åˆ«
   */
  getCurrentLevel(): EnhancementLevel {
    return this.currentLevel
  }
  
  /**
   * è®¾ç½®å¢å¼ºçº§åˆ«
   */
  setLevel(level: EnhancementLevel): void {
    // éªŒè¯ä¾èµ–å…³ç³»
    if (level === EnhancementLevel.AGENT && 
        !this.isLevelAvailable(EnhancementLevel.COLLAB)) {
      throw new Error('Cannot enable AGENT level without COLLAB level')
    }
    
    if (level === EnhancementLevel.COLLAB && 
        !this.isLevelAvailable(EnhancementLevel.ENHANCEMENT)) {
      throw new Error('Cannot enable COLLAB level without ENHANCEMENT level')
    }
    
    this.currentLevel = level
    this.onLevelChange(level)
  }
  
  /**
   * æ£€æŸ¥æŸçº§åˆ«æ˜¯å¦å¯ç”¨
   */
  isLevelAvailable(level: EnhancementLevel): boolean {
    switch (level) {
      case EnhancementLevel.FOUNDATION:
        return true // åŸºç¡€å±‚å§‹ç»ˆå¯ç”¨
        
      case EnhancementLevel.ENHANCEMENT:
        return this.checkEnhancementPrerequisites()
        
      case EnhancementLevel.COLLAB:
        return this.isLevelAvailable(EnhancementLevel.ENHANCEMENT) && 
               this.checkCollabPrerequisites()
        
      case EnhancementLevel.AGENT:
        return this.isLevelAvailable(EnhancementLevel.COLLAB) && 
               this.checkAgentPrerequisites()
        
      default:
        return false
    }
  }
  
  /**
   * æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼ˆåŸºäºå½“å‰çº§åˆ«ï¼‰
   */
  isFeatureAvailable(featureId: string): boolean {
    const feature = FEATURE_REGISTRY[featureId]
    if (!feature) return false
    
    return this.currentLevel >= feature.requiredLevel
  }
  
  private checkEnhancementPrerequisites(): boolean {
    // æ£€æŸ¥å‘é‡å­˜å‚¨æ˜¯å¦å¯ç”¨
    const vectorStoreAvailable = VectorStoreManager.isReady()
    // æ£€æŸ¥ AI æœåŠ¡é…ç½®æ˜¯å¦å­˜åœ¨
    const aiConfigValid = ConfigManager.hasValidAIConfig()
    
    return vectorStoreAvailable || aiConfigValid
  }
  
  private checkCollabPrerequisites(): boolean {
    // æ£€æŸ¥å®æ—¶é€šä¿¡æ˜¯å¦å¯ç”¨
    return WebSocketManager.isConnected()
  }
  
  private checkAgentPrerequisites(): boolean {
    // æ£€æŸ¥ Agent è¿è¡Œæ—¶æ˜¯å¦å¯ç”¨
    return AgentRuntime.isInitialized()
  }
  
  private onLevelChange(level: EnhancementLevel): void {
    EventBus.emit('enhancement:level_changed', { level })
    
    // æ ¹æ®çº§åˆ«è°ƒæ•´ UI
    UIManager.setEnhancementLevel(level)
    
    // è®°å½•åˆ†ææ•°æ®
    Analytics.track('enhancement_level_changed', { 
      level: EnhancementLevel[level],
      timestamp: Date.now()
    })
  }
}

enum EnhancementLevel {
  FOUNDATION = 0,      // åŸºç¡€å±‚
  ENHANCEMENT = 1,     // å¢å¼ºå±‚
  COLLAB = 2,          // åä½œå±‚
  AGENT = 3            // è‡ªä¸»å±‚
}

interface Feature {
  id: string
  name: string
  requiredLevel: EnhancementLevel
  description: string
}

const FEATURE_REGISTRY: Record<string, Feature> = {
  'basic_search': {
    id: 'basic_search',
    name: 'åŸºç¡€æœç´¢',
    requiredLevel: EnhancementLevel.FOUNDATION,
    description: 'åŸºäºå…³é”®è¯çš„å†…å®¹æœç´¢'
  },
  'semantic_search': {
    id: 'semantic_search',
    name: 'è¯­ä¹‰æœç´¢',
    requiredLevel: EnhancementLevel.ENHANCEMENT,
    description: 'åŸºäºå‘é‡çš„è¯­ä¹‰ç›¸ä¼¼æœç´¢'
  },
  'ai_completion': {
    id: 'ai_completion',
    name: 'AI è¡¥å…¨',
    requiredLevel: EnhancementLevel.ENHANCEMENT,
    description: 'æ™ºèƒ½å†…å®¹è¡¥å…¨å»ºè®®'
  },
  'inline_suggestions': {
    id: 'inline_suggestions',
    name: 'å†…è”å»ºè®®',
    requiredLevel: EnhancementLevel.COLLAB,
    description: 'ç¼–è¾‘æ—¶çš„å®æ—¶å†…è”å»ºè®®'
  },
  'web_search': {
    id: 'web_search',
    name: 'Web æœç´¢',
    requiredLevel: EnhancementLevel.COLLAB,
    description: 'é›†æˆç½‘ç»œæœç´¢èƒ½åŠ›'
  },
  'agent_task': {
    id: 'agent_task',
    name: 'Agent ä»»åŠ¡',
    requiredLevel: EnhancementLevel.AGENT,
    description: 'AI Agent è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡'
  },
  'intent_driven': {
    id: 'intent_driven',
    name: 'æ„å›¾é©±åŠ¨',
    requiredLevel: EnhancementLevel.AGENT,
    description: 'åŸºäºè‡ªç„¶è¯­è¨€æ„å›¾çš„å†…å®¹ç”Ÿæˆ'
  }
}
```

#### 1.2.3 åŸåˆ™ä¸‰ï¼šæ•°æ®ç»§æ‰¿ï¼ˆData Inheritanceï¼‰

**æ ¸å¿ƒç†å¿µ**

ç°æœ‰æ•°æ®æ˜¯å®è´µçš„èµ„äº§ï¼Œä¸åº”è¯¥å› ä¸ºæ¶æ„å‡çº§è€Œè¢«åºŸå¼ƒã€‚èåˆæ¶æ„åº”è¯¥èƒ½å¤Ÿè¯»å–ã€ç†è§£å¹¶å¢å¼ºå·²æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯è¦æ±‚é‡æ–°åˆ›å»ºã€‚

**æ•°æ®ç»§æ‰¿ç­–ç•¥**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®ç»§æ‰¿ç­–ç•¥å›¾                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ä¼ ç»Ÿæ•°æ®æº                          AI-Native æ•°æ®ç›®æ ‡                      â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  Markdown   â”‚ â”€â”€â–º è§£æ â”€â”€â–º       â”‚  çŸ¥è¯†å›¾è°±   â”‚                         â”‚
â”‚  â”‚   æ–‡ä»¶      â”‚     æå–å®ä½“        â”‚  (Entities) â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     æå–å…³ç³»        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚       â”‚              æ„å»ºé“¾æ¥              â–²                                â”‚
â”‚       â”‚                                    â”‚                                â”‚
â”‚       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚       â”‚         â”‚                                                           â”‚
â”‚       â–¼         â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ WikiLinks   â”‚ â”€â”€â–º â”‚  è¯­ä¹‰å…³è”   â”‚                                       â”‚
â”‚  â”‚  [[...]]   â”‚     â”‚  å‘é‡ç´¢å¼•   â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚   Git       â”‚ â”€â”€â–º è§£æ â”€â”€â–º       â”‚  Agent      â”‚                         â”‚
â”‚  â”‚   å†å²      â”‚     æå–æäº¤        â”‚  è®°å¿†       â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     è¯†åˆ«ä½œè€…        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚       â”‚              åˆ†æå˜æ›´              â–²                                â”‚
â”‚       â”‚                                    â”‚                                â”‚
â”‚       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚       â”‚         â”‚                                                           â”‚
â”‚       â–¼         â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚  Commit     â”‚ â”€â”€â–º â”‚  ç»Ÿä¸€å†å²   â”‚                                       â”‚
â”‚  â”‚  Messages   â”‚     â”‚  æ—¶é—´çº¿     â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  Front      â”‚ â”€â”€â–º æå– â”€â”€â–º       â”‚  ç»“æ„åŒ–     â”‚                         â”‚
â”‚  â”‚  Matter     â”‚     å…ƒæ•°æ®          â”‚  å…ƒæ•°æ®     â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     æ ‡å‡†åŒ–          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                             â”‚
â”‚  å…³é”®è®¾è®¡ç‚¹:                                                                â”‚
â”‚  â€¢ å•å‘ç»§æ‰¿ï¼šä¼ ç»Ÿæ•°æ® â†’ AI æ•°æ®ï¼Œä¸å½±å“åŸå§‹æ•°æ®                               â”‚
â”‚  â€¢ å¢é‡æ›´æ–°ï¼šåªå¤„ç†æ–°å¢æˆ–å˜æ›´çš„æ•°æ®                                          â”‚
â”‚  â€¢ å¯é‡å»ºï¼šAI æ•°æ®å¯éšæ—¶ä»ä¼ ç»Ÿæ•°æ®é‡æ–°ç”Ÿæˆ                                    â”‚
â”‚  â€¢ ç‰ˆæœ¬å…³è”ï¼šAI æ•°æ®è®°å½•æ•°æ®æ¥æºç‰ˆæœ¬                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **

```typescript
// agent/fusion/data/DataInheritance.ts

/**
 * æ•°æ®ç»§æ‰¿ç®¡ç†å™¨
 * è´Ÿè´£å°†ä¼ ç»Ÿåšå®¢æ•°æ®è½¬æ¢ä¸º AI å¯ç”¨çš„å¢å¼ºæ•°æ®
 */
export class DataInheritanceManager {
  
  /**
   * ç»§æ‰¿é…ç½®
   */
  private config: InheritanceConfig = {
    // Markdown æ–‡ä»¶å¤„ç†
    markdown: {
      enableEntityExtraction: true,
      enableVectorIndexing: true,
      enableLinkGraph: true,
      chunkSize: 500,
      chunkOverlap: 50
    },
    // Git å†å²å¤„ç†
    git: {
      enableCommitParsing: true,
      enableAuthorMapping: true,
      enableChangeAnalysis: true,
      maxHistoryDepth: 1000
    },
    // WikiLinks å¤„ç†
    wikiLinks: {
      enableResolution: true,
      enableGraphBuilding: true,
      enableBacklinkIndex: true
    },
    // Front Matter å¤„ç†
    frontMatter: {
      enableSchemaValidation: true,
      enableEnrichment: true,
      standardFields: ['title', 'date', 'tags', 'category', 'author']
    }
  }
  
  /**
   * æ‰§è¡Œå®Œæ•´çš„æ•°æ®ç»§æ‰¿æµç¨‹
   */
  async runFullInheritance(): Promise<InheritanceReport> {
    const report: InheritanceReport = {
      startTime: Date.now(),
      stages: []
    }
    
    console.log('[DataInheritance] Starting full inheritance...')
    
    // Stage 1: Markdown æ–‡æ¡£ç»§æ‰¿
    const markdownResult = await this.inheritMarkdownDocuments()
    report.stages.push({
      name: 'Markdown Inheritance',
      ...markdownResult
    })
    
    // Stage 2: WikiLinks ç»§æ‰¿
    const wikiLinksResult = await this.inheritWikiLinks()
    report.stages.push({
      name: 'WikiLinks Inheritance',
      ...wikiLinksResult
    })
    
    // Stage 3: Git å†å²ç»§æ‰¿
    const gitResult = await this.inheritGitHistory()
    report.stages.push({
      name: 'Git History Inheritance',
      ...gitResult
    })
    
    // Stage 4: Front Matter ç»§æ‰¿
    const frontMatterResult = await this.inheritFrontMatter()
    report.stages.push({
      name: 'Front Matter Inheritance',
      ...frontMatterResult
    })
    
    report.endTime = Date.now()
    report.duration = report.endTime - report.startTime
    
    console.log(`[DataInheritance] Completed in ${report.duration}ms`)
    
    return report
  }
  
  /**
   * Markdown æ–‡æ¡£ç»§æ‰¿
   * å°† Markdown æ–‡ä»¶è½¬æ¢ä¸ºå‘é‡ç´¢å¼•å’ŒçŸ¥è¯†å›¾è°±
   */
  private async inheritMarkdownDocuments(): Promise<StageResult> {
    const result: StageResult = {
      processed: 0,
      succeeded: 0,
      failed: 0,
      details: []
    }
    
    // è·å–æ‰€æœ‰ Markdown æ–‡ä»¶
    const files = await FileSystem.glob('**/*.md', {
      ignore: ['node_modules/**', '.vitepress/**']
    })
    
    for (const file of files) {
      try {
        result.processed++
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        const content = await FileSystem.readFile(file, 'utf-8')
        
        // è§£æ Markdown
        const parsed = MarkdownParser.parse(content)
        
        // æå–çº¯æ–‡æœ¬ï¼ˆç”¨äºå‘é‡åŒ–ï¼‰
        const plainText = parsed.toPlainText()
        
        // åˆ†å—å¤„ç†
        const chunks = this.chunkDocument(plainText, this.config.markdown)
        
        // ä¸ºæ¯ä¸ªå—ç”Ÿæˆå‘é‡å¹¶å­˜å‚¨
        for (let i = 0; i < chunks.length; i++) {
          const chunk = chunks[i]
          const embedding = await VectorService.generateEmbedding(chunk)
          
          await VectorStore.upsert({
            id: `${file}#chunk-${i}`,
            vector: embedding,
            metadata: {
              source: file,
              chunkIndex: i,
              title: parsed.frontMatter.title || path.basename(file, '.md'),
              tags: parsed.frontMatter.tags || [],
              category: parsed.frontMatter.category,
              lastModified: parsed.frontMatter.date
            }
          })
        }
        
        // æå–å®ä½“å¹¶æ·»åŠ åˆ°çŸ¥è¯†å›¾è°±
        if (this.config.markdown.enableEntityExtraction) {
          const entities = await this.extractEntities(parsed)
          for (const entity of entities) {
            await KnowledgeGraph.addEntity({
              ...entity,
              source: file,
              sourceType: 'markdown'
            })
          }
        }
        
        result.succeeded++
      } catch (error) {
        result.failed++
        result.details.push({
          file,
          error: error.message
        })
      }
    }
    
    return result
  }
  
  /**
   * WikiLinks ç»§æ‰¿
   * è§£æ [[...]] è¯­æ³•ï¼Œæ„å»ºçŸ¥è¯†å›¾è°±é“¾æ¥
   */
  private async inheritWikiLinks(): Promise<StageResult> {
    const result: StageResult = {
      processed: 0,
      succeeded: 0,
      failed: 0,
      details: []
    }
    
    // è·å–æ‰€æœ‰ Markdown æ–‡ä»¶
    const files = await FileSystem.glob('**/*.md')
    
    const wikiLinkPattern = /\[\[([^\]]+)\]\]/g
    
    for (const file of files) {
      try {
        const content = await FileSystem.readFile(file, 'utf-8')
        
        let match
        while ((match = wikiLinkPattern.exec(content)) !== null) {
          result.processed++
          
          const linkText = match[1]
          // è§£æé“¾æ¥ç›®æ ‡å’Œæ˜¾ç¤ºæ–‡æœ¬ [[target|display]]
          const [target, display] = linkText.split('|').map(s => s.trim())
          
          // è§£æç›®æ ‡ä¸­çš„é”šç‚¹ [[target#heading]]
          const [pagePath, heading] = target.split('#')
          
          // æ·»åŠ åˆ°çŸ¥è¯†å›¾è°±
          await KnowledgeGraph.addRelationship({
            from: file,
            to: pagePath,
            type: 'references',
            metadata: {
              displayText: display || target,
              heading: heading,
              context: this.extractContext(content, match.index)
            }
          })
          
          // å»ºç«‹åå‘é“¾æ¥ç´¢å¼•
          await BacklinkIndex.add({
            source: file,
            target: pagePath,
            displayText: display || target
          })
          
          result.succeeded++
        }
      } catch (error) {
        result.failed++
        result.details.push({ file, error: error.message })
      }
    }
    
    return result
  }
  
  /**
   * Git å†å²ç»§æ‰¿
   * è§£æ Git æäº¤ï¼Œæå–å˜æ›´å†å²
   */
  private async inheritGitHistory(): Promise<StageResult> {
    const result: StageResult = {
      processed: 0,
      succeeded: 0,
      failed: 0,
      details: []
    }
    
    // è·å– Git å†å²
    const commits = await GitService.getHistory({
      maxCount: this.config.git.maxHistoryDepth
    })
    
    for (const commit of commits) {
      try {
        result.processed++
        
        // åˆ¤æ–­æ˜¯å¦ä¸º Agent æäº¤
        const isAgentCommit = commit.author.name === 'agent' || 
                              commit.message.includes('[agent]')
        
        // è§£ææäº¤æ¶ˆæ¯
        const parsedMessage = this.parseCommitMessage(commit.message)
        
        // å­˜å‚¨åˆ°ç»Ÿä¸€å†å²
        await UnifiedHistory.store({
          id: commit.hash,
          type: isAgentCommit ? 'agent' : 'human',
          author: {
            name: isAgentCommit ? 'ğŸ¤– AI Agent' : commit.author.name,
            email: commit.author.email,
            avatar: isAgentCommit 
              ? '/avatars/agent.png' 
              : `/avatars/${commit.author.email}.png`
          },
          timestamp: commit.date.getTime(),
          message: parsedMessage.content,
          changes: {
            added: commit.stats.additions,
            removed: commit.stats.deletions,
            files: commit.changedFiles
          },
          metadata: {
            isAgent: isAgentCommit,
            agentInfo: isAgentCommit ? this.extractAgentInfo(commit.message) : undefined,
            intent: parsedMessage.intent,
            tags: parsedMessage.tags
          }
        })
        
        // å¦‚æœæ˜¯ Agent æäº¤ï¼ŒåŒæ­¥åˆ° Agent è®°å¿†
        if (isAgentCommit) {
          await AgentMemory.add({
            type: 'action',
            content: parsedMessage.content,
            timestamp: commit.date.getTime(),
            metadata: {
              commitHash: commit.hash,
              filesChanged: commit.changedFiles,
              intent: parsedMessage.intent
            }
          })
        }
        
        result.succeeded++
      } catch (error) {
        result.failed++
        result.details.push({ 
          commit: commit.hash, 
          error: error.message 
        })
      }
    }
    
    return result
  }
  
  /**
   * Front Matter ç»§æ‰¿
   * æ ‡å‡†åŒ–å’Œä¸°å¯Œ Front Matter å…ƒæ•°æ®
   */
  private async inheritFrontMatter(): Promise<StageResult> {
    const result: StageResult = {
      processed: 0,
      succeeded: 0,
      failed: 0,
      details: []
    }
    
    const files = await FileSystem.glob('**/*.md')
    
    for (const file of files) {
      try {
        result.processed++
        
        const content = await FileSystem.readFile(file, 'utf-8')
        const parsed = MarkdownParser.parse(content)
        
        // æ ‡å‡†åŒ–å…ƒæ•°æ®
        const normalized = this.normalizeFrontMatter(parsed.frontMatter)
        
        // ä¸°å¯Œå…ƒæ•°æ®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        let enriched = normalized
        if (this.config.frontMatter.enableEnrichment) {
          enriched = await this.enrichFrontMatter(normalized, parsed.content)
        }
        
        // å­˜å‚¨åˆ°å…ƒæ•°æ®ä»“åº“
        await MetadataStore.store({
          source: file,
          data: enriched,
          version: '1.0',
          lastModified: Date.now()
        })
        
        result.succeeded++
      } catch (error) {
        result.failed++
        result.details.push({ file, error: error.message })
      }
    }
    
    return result
  }
  
  // ============ è¾…åŠ©æ–¹æ³• ============
  
  private chunkDocument(text: string, config: MarkdownConfig): string[] {
    const chunks: string[] = []
    const { chunkSize, chunkOverlap } = config
    
    // ç®€å•çš„åˆ†å—ç­–ç•¥ï¼šæŒ‰æ®µè½åˆ†å‰²ï¼Œç„¶ååˆå¹¶åˆ°ç›®æ ‡å¤§å°
    const paragraphs = text.split(/\n\n+/)
    let currentChunk = ''
    
    for (const paragraph of paragraphs) {
      if (currentChunk.length + paragraph.length > chunkSize) {
        if (currentChunk) {
          chunks.push(currentChunk.trim())
        }
        currentChunk = paragraph
      } else {
        currentChunk += '\n\n' + paragraph
      }
    }
    
    if (currentChunk) {
      chunks.push(currentChunk.trim())
    }
    
    return chunks
  }
  
  private async extractEntities(parsed: ParsedMarkdown): Promise<Entity[]> {
    // ä½¿ç”¨ NLP æœåŠ¡æå–å®ä½“
    const entities = await NLPService.extractEntities(parsed.toPlainText())
    
    return entities.map(e => ({
      id: `entity-${e.text}-${e.type}`,
      name: e.text,
      type: e.type,
      occurrences: [{
        source: parsed.filePath,
        position: e.position
      }]
    }))
  }
  
  private parseCommitMessage(message: string): ParsedCommitMessage {
    // Agent æäº¤æ ¼å¼: [agent] task:xxx model:xxx intent:xxx
    const agentMatch = message.match(/\[agent\]\s*(.+)/s)
    
    if (agentMatch) {
      const content = agentMatch[1]
      const intentMatch = content.match(/intent:(\w+)/)
      const tagsMatch = content.match(/tags:([^\n]+)/)
      
      return {
        content: content.replace(/\w+:[^\s]+/g, '').trim(),
        intent: intentMatch?.[1],
        tags: tagsMatch?.[1].split(',').map(t => t.trim()) || []
      }
    }
    
    return {
      content: message,
      intent: undefined,
      tags: []
    }
  }
  
  private extractContext(content: string, position: number): string {
    const start = Math.max(0, position - 100)
    const end = Math.min(content.length, position + 100)
    return content.substring(start, end).replace(/\n/g, ' ')
  }
  
  private normalizeFrontMatter(frontMatter: Record<string, any>): Record<string, any> {
    const normalized: Record<string, any> = {}
    
    // æ ‡å‡†å­—æ®µæ˜ å°„
    const fieldMappings: Record<string, string[]> = {
      'title': ['title', 'name', 'heading'],
      'date': ['date', 'created', 'published', 'datetime'],
      'updated': ['updated', 'modified', 'lastModified'],
      'tags': ['tags', 'keywords', 'categories'],
      'category': ['category', 'section', 'group'],
      'author': ['author', 'writer', 'creator'],
      'description': ['description', 'summary', 'excerpt'],
      'draft': ['draft', 'unpublished', 'wip']
    }
    
    for (const [standard, aliases] of Object.entries(fieldMappings)) {
      for (const alias of aliases) {
        if (frontMatter[alias] !== undefined) {
          normalized[standard] = frontMatter[alias]
          break
        }
      }
    }
    
    return normalized
  }
  
  private async enrichFrontMatter(
    frontMatter: Record<string, any>, 
    content: string
  ): Promise<Record<string, any>> {
    const enriched = { ...frontMatter }
    
    // å¦‚æœæ²¡æœ‰æ‘˜è¦ï¼Œè‡ªåŠ¨ç”Ÿæˆ
    if (!enriched.description) {
      enriched.description = this.generateSummary(content, 150)
    }
    
    // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œè‡ªåŠ¨æå–
    if (!enriched.tags || enriched.tags.length === 0) {
      enriched.tags = await this.extractTags(content)
    }
    
    // æ·»åŠ é˜…è¯»æ—¶é—´ä¼°è®¡
    enriched.readingTime = this.estimateReadingTime(content)
    
    // æ·»åŠ å­—æ•°ç»Ÿè®¡
    enriched.wordCount = content.split(/\s+/).length
    
    return enriched
  }
  
  private generateSummary(content: string, maxLength: number): string {
    // æå–ç¬¬ä¸€æ®µä½œä¸ºæ‘˜è¦
    const firstParagraph = content.split(/\n\n+/)[0] || ''
    if (firstParagraph.length <= maxLength) {
      return firstParagraph.replace(/[#*`]/g, '').trim()
    }
    return firstParagraph.substring(0, maxLength).replace(/[#*`]/g, '').trim() + '...'
  }
  
  private async extractTags(content: string): Promise<string[]> {
    // ä½¿ç”¨ NLP æå–å…³é”®è¯ä½œä¸ºæ ‡ç­¾
    const keywords = await NLPService.extractKeywords(content, 5)
    return keywords.map(k => k.toLowerCase().replace(/\s+/g, '-'))
  }
  
  private estimateReadingTime(content: string): number {
    const words = content.split(/\s+/).length
    const wordsPerMinute = 200
    return Math.ceil(words / wordsPerMinute)
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface InheritanceConfig {
  markdown: MarkdownConfig
  git: GitConfig
  wikiLinks: WikiLinksConfig
  frontMatter: FrontMatterConfig
}

interface MarkdownConfig {
  enableEntityExtraction: boolean
  enableVectorIndexing: boolean
  enableLinkGraph: boolean
  chunkSize: number
  chunkOverlap: number
}

interface GitConfig {
  enableCommitParsing: boolean
  enableAuthorMapping: boolean
  enableChangeAnalysis: boolean
  maxHistoryDepth: number
}

interface WikiLinksConfig {
  enableResolution: boolean
  enableGraphBuilding: boolean
  enableBacklinkIndex: boolean
}

interface FrontMatterConfig {
  enableSchemaValidation: boolean
  enableEnrichment: boolean
  standardFields: string[]
}

interface InheritanceReport {
  startTime: number
  endTime?: number
  duration?: number
  stages: StageReport[]
}

interface StageReport extends StageResult {
  name: string
}

interface StageResult {
  processed: number
  succeeded: number
  failed: number
  details: Array<{ file?: string; commit?: string; error: string }>
}

interface Entity {
  id: string
  name: string
  type: string
  occurrences: Array<{ source: string; position: number }>
}

interface ParsedCommitMessage {
  content: string
  intent?: string
  tags: string[]
}
```

#### 1.2.4 åŸåˆ™å››ï¼šç»Ÿä¸€è§†å›¾ï¼ˆUnified Viewï¼‰

**æ ¸å¿ƒç†å¿µ**

ç”¨æˆ·ä¸åº”è¯¥æ„ŸçŸ¥åˆ°åº•å±‚æ¶æ„çš„å¤æ‚æ€§ã€‚æ— è®ºæ˜¯äººç±»åˆ›å»ºçš„å†…å®¹è¿˜æ˜¯ AI ç”Ÿæˆçš„å†…å®¹ï¼Œéƒ½åº”è¯¥åœ¨ç»Ÿä¸€çš„ç•Œé¢ä¸­å‘ˆç°ï¼Œæä¾›ä¸€è‡´çš„äº¤äº’ä½“éªŒã€‚

**ç»Ÿä¸€è§†å›¾çš„è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç»Ÿä¸€è§†å›¾æ¶æ„                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        ç»Ÿä¸€è§†å›¾å±‚ (Unified View Layer)               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ç»Ÿä¸€æœç´¢è§†å›¾   â”‚  â”‚ ç»Ÿä¸€ç¼–è¾‘è§†å›¾   â”‚  â”‚ ç»Ÿä¸€å†å²è§†å›¾           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Search)     â”‚  â”‚  (Editor)     â”‚  â”‚  (History)            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚          â”‚                  â”‚                      â”‚               â”‚   â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                             â”‚                                       â”‚   â”‚
â”‚  â”‚                             â–¼                                       â”‚   â”‚
â”‚  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚
â”‚  â”‚                  â”‚   æ•°æ®èåˆå±‚         â”‚                            â”‚   â”‚
â”‚  â”‚                  â”‚  (Data Fusion)      â”‚                            â”‚   â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â”‚                             â”‚                                       â”‚   â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚   â”‚
â”‚  â”‚          â”‚                  â”‚                  â”‚                    â”‚   â”‚
â”‚  â”‚          â–¼                  â–¼                  â–¼                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ ä¼ ç»Ÿæ•°æ®æº   â”‚    â”‚  èåˆæ•°æ®æº  â”‚    â”‚  AI æ•°æ®æº   â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  (Legacy)   â”‚    â”‚  (Unified)  â”‚    â”‚  (AI-Native)â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ç»Ÿä¸€è§†å›¾çš„ä¸‰ä¸ªç»´åº¦:                                                         â”‚
â”‚                                                                             â”‚
â”‚  1. ç»Ÿä¸€æœç´¢ (Unified Search)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ æœ¬åœ°æ–‡æ¡£æœç´¢ (FlexSearch) + è¯­ä¹‰å‘é‡æœç´¢ + Web æœç´¢                       â”‚
â”‚  â€¢ ç»“æœä»¥ç»Ÿä¸€æ ¼å¼å‘ˆç°ï¼Œæ ‡æ³¨æ¥æºç±»å‹                                          â”‚
â”‚  â€¢ ç›¸å…³æ€§æ’åºç®—æ³•èåˆå¤šç§ä¿¡å·                                                â”‚
â”‚  â€¢ æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨                                                        â”‚
â”‚                                                                             â”‚
â”‚  2. ç»Ÿä¸€ç¼–è¾‘ (Unified Editor)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ GlobalPageEditor æ”¯æŒä¸‰ç§æ¨¡å¼ (MANUAL/COLLAB/AGENT)                       â”‚
â”‚  â€¢ æ ¹æ®æ¨¡å¼åŠ¨æ€è°ƒæ•´ UI å…ƒç´                                                   â”‚
â”‚  â€¢ AI è¾…åŠ©åŠŸèƒ½ä»¥éä¾µå…¥æ–¹å¼é›†æˆ                                               â”‚
â”‚  â€¢ ä¸€è‡´çš„ä¸»é¢˜å’Œäº¤äº’ä½“éªŒ                                                      â”‚
â”‚                                                                             â”‚
â”‚  3. ç»Ÿä¸€å†å² (Unified History)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ Git æäº¤å’Œ Agent æ“ä½œåœ¨åŒä¸€ä¸ªæ—¶é—´çº¿å±•ç¤º                                   â”‚
â”‚  â€¢ äººç±»æäº¤å’Œ AI æäº¤ç”¨ä¸åŒè§†è§‰æ ‡è¯†åŒºåˆ†                                      â”‚
â”‚  â€¢ æ”¯æŒæŒ‰ä½œè€…ã€ç±»å‹ã€æ—¶é—´è¿‡æ»¤                                                â”‚
â”‚  â€¢ å…³è”æ˜¾ç¤ºå˜æ›´è¯¦æƒ…å’Œå…ƒæ•°æ®                                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2.5 åŸåˆ™äº”ï¼šå¯æ§é€æ˜ï¼ˆControllable Transparencyï¼‰

**æ ¸å¿ƒç†å¿µ**

AI çš„è¡Œä¸ºåº”è¯¥æ˜¯é€æ˜å’Œå¯æ§çš„ã€‚ç”¨æˆ·åº”è¯¥æ¸…æ¥šåœ°çŸ¥é“ AI åœ¨åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œä»¥åŠå¦‚ä½•åœ¨å¿…è¦æ—¶è¿›è¡Œå¹²é¢„æˆ–çº æ­£ã€‚

**å®ç°ç­–ç•¥**

```typescript
// agent/fusion/principles/ControllableTransparency.ts

/**
 * å¯æ§é€æ˜åŸåˆ™å®ç°
 */
export class ControllableTransparencyManager {
  
  /**
   * AI æ“ä½œè®°å½•
   * æ‰€æœ‰ AI æ‰§è¡Œçš„æ“ä½œéƒ½åº”è¯¥è¢«è®°å½•
   */
  private operationLog: OperationLog[] = []
  
  /**
   * æ‰§è¡Œ AI æ“ä½œï¼ˆå¸¦å®Œæ•´è¿½è¸ªï¼‰
   */
  async executeAIOperation<T>(
    operation: AIOperation<T>
  ): Promise<OperationResult<T>> {
    const startTime = Date.now()
    const operationId = generateOperationId()
    
    // è®°å½•æ“ä½œå¼€å§‹
    const logEntry: OperationLog = {
      id: operationId,
      type: operation.type,
      description: operation.description,
      input: operation.input,
      startTime,
      status: 'running',
      reasoning: [],
      steps: []
    }
    
    this.operationLog.push(logEntry)
    this.emitOperationStart(logEntry)
    
    try {
      // å¦‚æœéœ€è¦å®¡æ‰¹ï¼Œå…ˆç­‰å¾…å®¡æ‰¹
      if (operation.requiresApproval) {
        const approval = await this.requestApproval(operation, operationId)
        if (!approval.granted) {
          logEntry.status = 'cancelled'
          logEntry.endTime = Date.now()
          return {
            success: false,
            operationId,
            cancelled: true,
            reason: approval.reason || 'User cancelled'
          }
        }
      }
      
      // æ‰§è¡Œæ“ä½œæ­¥éª¤
      for (const step of operation.steps) {
        const stepResult = await this.executeStep(step, logEntry)
        
        if (!stepResult.success && step.critical) {
          throw new StepError(step.name, stepResult.error)
        }
        
        logEntry.steps.push({
          name: step.name,
          status: stepResult.success ? 'completed' : 'failed',
          output: stepResult.output,
          duration: stepResult.duration
        })
      }
      
      // è®°å½•æ“ä½œæˆåŠŸ
      logEntry.status = 'completed'
      logEntry.endTime = Date.now()
      logEntry.output = operation.getResult()
      
      this.emitOperationComplete(logEntry)
      
      return {
        success: true,
        operationId,
        result: operation.getResult(),
        reasoning: logEntry.reasoning
      }
      
    } catch (error) {
      // è®°å½•æ“ä½œå¤±è´¥
      logEntry.status = 'failed'
      logEntry.endTime = Date.now()
      logEntry.error = error.message
      
      this.emitOperationError(logEntry, error)
      
      return {
        success: false,
        operationId,
        error: error.message,
        reasoning: logEntry.reasoning
      }
    }
  }
  
  /**
   * è¯·æ±‚ç”¨æˆ·å®¡æ‰¹
   */
  private async requestApproval(
    operation: AIOperation<any>,
    operationId: string
  ): Promise<ApprovalResult> {
    // å‘é€å®¡æ‰¹è¯·æ±‚åˆ° UI
    const approvalPromise = new Promise<ApprovalResult>((resolve) => {
      EventBus.emit('approval:request', {
        operationId,
        type: operation.type,
        description: operation.description,
        preview: operation.preview,
        resolve
      })
    })
    
    // è®¾ç½®è¶…æ—¶
    const timeoutPromise = new Promise<ApprovalResult>((_, reject) => {
      setTimeout(() => {
        reject(new Error('Approval timeout'))
      }, operation.approvalTimeout || 30000)
    })
    
    return Promise.race([approvalPromise, timeoutPromise])
  }
  
  /**
   * æ‰§è¡Œå•ä¸ªæ­¥éª¤
   */
  private async executeStep(
    step: OperationStep,
    logEntry: OperationLog
  ): Promise<StepResult> {
    const stepStart = Date.now()
    
    try {
      // å¦‚æœæ­¥éª¤æ”¯æŒæ¨ç†è®°å½•ï¼Œå¯ç”¨å®ƒ
      if (step.captureReasoning) {
        step.onReasoning = (reasoning: string) => {
          logEntry.reasoning.push({
            step: step.name,
            reasoning,
            timestamp: Date.now()
          })
        }
      }
      
      const output = await step.execute()
      
      return {
        success: true,
        output,
        duration: Date.now() - stepStart
      }
    } catch (error) {
      return {
        success: false,
        error: error.message,
        duration: Date.now() - stepStart
      }
    }
  }
  
  /**
   * è·å–æ“ä½œå†å²
   */
  getOperationHistory(filter?: HistoryFilter): OperationLog[] {
    let history = [...this.operationLog]
    
    if (filter?.type) {
      history = history.filter(op => op.type === filter.type)
    }
    
    if (filter?.status) {
      history = history.filter(op => op.status === filter.status)
    }
    
    if (filter?.startTime) {
      history = history.filter(op => op.startTime >= filter.startTime)
    }
    
    if (filter?.endTime) {
      history = history.filter(op => op.startTime <= filter.endTime)
    }
    
    return history.sort((a, b) => b.startTime - a.startTime)
  }
  
  /**
   * æ’¤é”€æ“ä½œ
   */
  async undoOperation(operationId: string): Promise<boolean> {
    const operation = this.operationLog.find(op => op.id === operationId)
    
    if (!operation) {
      throw new Error(`Operation ${operationId} not found`)
    }
    
    if (!operation.undoable) {
      throw new Error(`Operation ${operationId} cannot be undone`)
    }
    
    // æ‰§è¡Œæ’¤é”€é€»è¾‘
    // å…·ä½“å®ç°å–å†³äºæ“ä½œç±»å‹
    
    return true
  }
  
  /**
   * è·å–æ“ä½œçš„è¯¦ç»†è§£é‡Š
   */
  explainOperation(operationId: string): OperationExplanation {
    const operation = this.operationLog.find(op => op.id === operationId)
    
    if (!operation) {
      throw new Error(`Operation ${operationId} not found`)
    }
    
    return {
      summary: this.generateSummary(operation),
      reasoning: operation.reasoning,
      steps: operation.steps.map(step => ({
        name: step.name,
        description: step.description,
        status: step.status,
        output: step.output
      })),
      decisionPoints: this.extractDecisionPoints(operation)
    }
  }
  
  private generateSummary(operation: OperationLog): string {
    const duration = operation.endTime 
      ? operation.endTime - operation.startTime 
      : Date.now() - operation.startTime
    
    return `${operation.description} (${operation.status}, ${duration}ms)`
  }
  
  private extractDecisionPoints(operation: OperationLog): DecisionPoint[] {
    return operation.reasoning
      .filter(r => r.includes('decided') || r.includes('chosen'))
      .map((r, index) => ({
        index,
        reasoning: r,
        alternatives: [] // ä»æ›´è¯¦ç»†çš„è®°å½•ä¸­æå–
      }))
  }
  
  private emitOperationStart(log: OperationLog): void {
    EventBus.emit('operation:start', log)
  }
  
  private emitOperationComplete(log: OperationLog): void {
    EventBus.emit('operation:complete', log)
  }
  
  private emitOperationError(log: OperationLog, error: Error): void {
    EventBus.emit('operation:error', { log, error })
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface AIOperation<T> {
  id?: string
  type: string
  description: string
  input: any
  steps: OperationStep[]
  requiresApproval: boolean
  approvalTimeout?: number
  undoable: boolean
  preview?: any
  getResult: () => T
}

interface OperationStep {
  name: string
  description: string
  execute: () => Promise<any>
  critical: boolean
  captureReasoning?: boolean
  onReasoning?: (reasoning: string) => void
}

interface OperationLog {
  id: string
  type: string
  description: string
  input: any
  output?: any
  startTime: number
  endTime?: number
  status: 'running' | 'completed' | 'failed' | 'cancelled'
  reasoning: ReasoningEntry[]
  steps: StepLog[]
  error?: string
  undoable: boolean
}

interface ReasoningEntry {
  step: string
  reasoning: string
  timestamp: number
}

interface StepLog {
  name: string
  status: 'completed' | 'failed'
  output?: any
  duration: number
}

interface StepResult {
  success: boolean
  output?: any
  error?: string
  duration: number
}

interface OperationResult<T> {
  success: boolean
  operationId: string
  result?: T
  cancelled?: boolean
  error?: string
  reasoning?: ReasoningEntry[]
}

interface ApprovalResult {
  granted: boolean
  reason?: string
  conditions?: string[]
}

interface HistoryFilter {
  type?: string
  status?: string
  startTime?: number
  endTime?: number
}

interface OperationExplanation {
  summary: string
  reasoning: ReasoningEntry[]
  steps: Array<{
    name: string
    description: string
    status: string
    output?: any
  }>
  decisionPoints: DecisionPoint[]
}

interface DecisionPoint {
  index: number
  reasoning: string
  alternatives: string[]
}

class StepError extends Error {
  constructor(stepName: string, message: string) {
    super(`Step "${stepName}" failed: ${message}`)
    this.name = 'StepError'
  }
}

function generateOperationId(): string {
  return `op-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
}
```

### 1.3 ä¸ä¼ ç»Ÿé‡æ„çš„å¯¹æ¯”

#### 1.3.1 é‡æ„æ¨¡å¼çš„æ¼”è¿›

è½¯ä»¶æ¶æ„çš„æ¼”è¿›é€šå¸¸éµå¾ªç‰¹å®šçš„æ¨¡å¼ã€‚ç†è§£è¿™äº›æ¨¡å¼æœ‰åŠ©äºæˆ‘ä»¬åšå‡ºæ­£ç¡®çš„æ¶æ„å†³ç­–ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¶æ„æ¼”è¿›æ¨¡å¼å¯¹æ¯”                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ¨¡å¼ä¸€ï¼šå¤§çˆ†ç‚¸é‡å†™ (Big Bang Rewrite) [âŒ ä¸æ¨è]                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç‰¹å¾:                                                                      â”‚
â”‚  â€¢ åœæ­¢æ–°åŠŸèƒ½å¼€å‘ï¼Œå›¢é˜Ÿå…¨åŠ›é‡å†™                                               â”‚
â”‚  â€¢ æ–°ç³»ç»Ÿå®Œå…¨æ›¿æ¢æ—§ç³»ç»Ÿ                                                       â”‚
â”‚  â€¢ é€šå¸¸éœ€è¦æ•°æœˆç”šè‡³æ•°å¹´                                                       â”‚
â”‚  â€¢ å‘å¸ƒæ—¶"åˆ‡æ¢å¼€å…³"ï¼Œä¸€æ¬¡æ€§å…¨éƒ¨ä¸Šçº¿                                           â”‚
â”‚                                                                             â”‚
â”‚  é£é™©:                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ ä¸šåŠ¡åœæ»ï¼šé‡å†™æœŸé—´æ— æ³•å“åº”å¸‚åœºéœ€æ±‚                                   â”‚   â”‚
â”‚  â”‚  â€¢ éœ€æ±‚æ¼‚ç§»ï¼šé‡å†™å®Œæˆåï¼Œå¸‚åœºéœ€æ±‚å·²å˜åŒ–                                 â”‚   â”‚
â”‚  â”‚  â€¢ åŠŸèƒ½é—æ¼ï¼šéš¾ä»¥å®Œå…¨å¤åˆ»æ—§ç³»ç»Ÿçš„æ‰€æœ‰è¡Œä¸º                               â”‚   â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·æµå¤±ï¼šæ–°ç³»ç»Ÿå¯èƒ½æ— æ³•æ»¡è¶³ç°æœ‰ç”¨æˆ·çš„æœŸæœ›                           â”‚   â”‚
â”‚  â”‚  â€¢ å›¢é˜Ÿç–²åŠ³ï¼šé•¿æœŸé‡å†™é¡¹ç›®æ¶ˆè€—å›¢é˜Ÿå£«æ°”                                   â”‚   â”‚
â”‚  â”‚  â€¢ æŠ€æœ¯å€ºåŠ¡è½¬ç§»ï¼šé‡å†™å¯èƒ½å¼•å…¥æ–°çš„è®¾è®¡ç¼ºé™·                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  æ¡ˆä¾‹: Netscape 4 â†’ Netscape 6 (Mozilla)                                    â”‚
â”‚  â€¢ 1998 å¹´å¼€å§‹é‡å†™                                                         â”‚
â”‚  â€¢ å†æ—¶ 3 å¹´                                                               â”‚
â”‚  â€¢ å‘å¸ƒæ—¶å¸‚åœºä»½é¢ä» 80% é™è‡³ 20%                                            â”‚
â”‚  â€¢ æœ€ç»ˆé€€å‡ºæµè§ˆå™¨å¸‚åœº                                                       â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  æ¨¡å¼äºŒï¼šç»æ€è€…æ¨¡å¼ (Strangler Fig Pattern) [â–³ æœ‰æ¡ä»¶ä½¿ç”¨]                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç‰¹å¾:                                                                      â”‚
â”‚  â€¢ é€æ­¥ç”¨æ–°ç³»ç»Ÿæ›¿æ¢æ—§ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½                                           â”‚
â”‚  â€¢ ä½¿ç”¨ä»£ç†/è·¯ç”±å±‚å°†è¯·æ±‚å¯¼å‘æ–°æ—§ç³»ç»Ÿ                                          â”‚
â”‚  â€¢ é€æ­¥è¿ç§»ï¼Œç›´åˆ°æ—§ç³»ç»Ÿè¢«"ç»æ€"                                              â”‚
â”‚  â€¢ æ–°æ—§ç³»ç»Ÿå¯ä»¥å¹¶è¡Œè¿è¡Œ                                                       â”‚
â”‚                                                                             â”‚
â”‚  é€‚ç”¨åœºæ™¯:                                                                  â”‚
â”‚  â€¢ æ—§ç³»ç»Ÿè¿‡äºå¤æ‚ï¼Œæ— æ³•ä¸€æ¬¡æ€§ç†è§£                                              â”‚
â”‚  â€¢ éœ€è¦é€æ­¥éªŒè¯æ–°ç³»ç»Ÿçš„å¯è¡Œæ€§                                                 â”‚
â”‚  â€¢ é£é™©æ‰¿å—èƒ½åŠ›æœ‰é™                                                          â”‚
â”‚                                                                             â”‚
â”‚  æŒ‘æˆ˜:                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ¶æ„å¤æ‚åº¦å¢åŠ ï¼šéœ€è¦ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿå’Œè·¯ç”±å±‚                             â”‚   â”‚
â”‚  â”‚  â€¢ æ•°æ®ä¸€è‡´æ€§ï¼šæ–°æ—§ç³»ç»Ÿä¹‹é—´çš„æ•°æ®åŒæ­¥                                   â”‚   â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´ï¼šç”¨æˆ·å¯èƒ½åœ¨ä¸åŒç³»ç»Ÿé—´è·³è½¬                             â”‚   â”‚
â”‚  â”‚  â€¢ è¿ç§»å‘¨æœŸå¯èƒ½å¾ˆé•¿                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  æ¡ˆä¾‹: Amazon ä»å•ä½“åˆ°å¾®æœåŠ¡                                                 â”‚
â”‚  â€¢ èŠ±äº†æ•°å¹´æ—¶é—´é€æ­¥è¿ç§»                                                      â”‚
â”‚  â€¢ ä½¿ç”¨ API ç½‘å…³ä½œä¸ºè·¯ç”±å±‚                                                   â”‚
â”‚  â€¢ æœ€ç»ˆæˆåŠŸï¼Œä½†æˆæœ¬é«˜æ˜‚                                                      â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  æ¨¡å¼ä¸‰ï¼šæ¸è¿›å¼å¢å¼º (Progressive Enhancement) [âœ“ æ¨è]                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç‰¹å¾:                                                                      â”‚
â”‚  â€¢ ä¿æŒç°æœ‰ç³»ç»Ÿ 100% å¯ç”¨                                                     â”‚
â”‚  â€¢ æ–°åŠŸèƒ½ä½œä¸ºå¯é€‰å¢å¼ºé€æ­¥æ·»åŠ                                                   â”‚
â”‚  â€¢ ç”¨æˆ·å¯ä»¥è‡ªä¸»é€‰æ‹©ä½¿ç”¨å“ªäº›æ–°åŠŸèƒ½                                              â”‚
â”‚  â€¢ æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯å®Œæ•´å¯ç”¨çš„äº§å“                                                  â”‚
â”‚                                                                             â”‚
â”‚  ä¼˜åŠ¿:                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ é›¶ä¸šåŠ¡ä¸­æ–­ï¼šç°æœ‰åŠŸèƒ½å§‹ç»ˆå¯ç”¨                                         â”‚   â”‚
â”‚  â”‚  âœ“ é£é™©å¯æ§ï¼šæ–°åŠŸèƒ½å¯å¿«é€Ÿå›æ»š                                           â”‚   â”‚
â”‚  â”‚  âœ“ å¿«é€ŸéªŒè¯ï¼šå¯ä»¥å¿«é€Ÿè·å¾—ç”¨æˆ·åé¦ˆ                                       â”‚   â”‚
â”‚  â”‚  âœ“ æŠ•èµ„ä¿æŠ¤ï¼šç°æœ‰æ•°æ®å’Œæµç¨‹å®Œå…¨ä¿ç•™                                     â”‚   â”‚
â”‚  â”‚  âœ“ ç”¨æˆ·é€‰æ‹©ï¼šç”¨æˆ·æŒ‰è‡ªå·±çš„èŠ‚å¥é‡‡ç”¨æ–°åŠŸèƒ½                                 â”‚   â”‚
â”‚  â”‚  âœ“ æŒç»­äº¤ä»˜ï¼šå¯ä»¥æŒç»­å‘å¸ƒå¢é‡æ”¹è¿›                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  æ¡ˆä¾‹: æœ¬é¡¹ç›® (MetaUniverse Blog)                                            â”‚
â”‚  â€¢ VitePress åŸºç¡€åŠŸèƒ½ä¿æŒä¸å˜                                                â”‚
â”‚  â€¢ AI åŠŸèƒ½ä½œä¸ºå¯é€‰æ’ä»¶æ·»åŠ                                                     â”‚
â”‚  â€¢ ç”¨æˆ·å¯åœ¨ MANUAL/COLLAB/AGENT æ¨¡å¼é—´åˆ‡æ¢                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.3.2 èåˆæ¶æ„ vs ä¼ ç»Ÿé‡æ„


| ç»´åº¦ | ä¼ ç»Ÿé‡æ„ | èåˆæ¶æ„ |
|------|---------|---------|
| **æ ¸å¿ƒæ€æƒ³** | æ›¿æ¢æ—§ç³»ç»Ÿ | å¢å¼ºç°æœ‰ç³»ç»Ÿ |
| **é£é™©çº§åˆ«** | é«˜ï¼ˆä¸€æ¬¡æ€§åˆ‡æ¢ï¼‰ | ä½ï¼ˆæ¸è¿›å¼ï¼‰ |
| **ä¸šåŠ¡ä¸­æ–­** | å¯èƒ½æœ‰æ˜¾è‘—ä¸­æ–­ | é›¶ä¸­æ–­ |
| **ç”¨æˆ·å½±å“** | è¢«è¿«é€‚åº”æ–°ç³»ç»Ÿ | è‡ªä¸»é€‰æ‹©æ–°åŠŸèƒ½ |
| **æ•°æ®è¿ç§»** | éœ€è¦å¤§è§„æ¨¡è¿ç§» | ç»§æ‰¿ç°æœ‰æ•°æ® |
| **å›æ»šéš¾åº¦** | å›°éš¾ | ç®€å•ï¼ˆåŠŸèƒ½å¼€å…³ï¼‰ |
| **æŠ•èµ„ä¿æŠ¤** | å¯èƒ½åºŸå¼ƒå·²æœ‰æŠ•èµ„ | å®Œå…¨ä¿ç•™ |
| **çµæ´»æ€§** | æ¶æ„é”å®šæ–°æ–¹æ¡ˆ | ä¿ç•™å¤šç§é€‰æ‹© |
| **ç»´æŠ¤å¤æ‚åº¦** | æ›¿æ¢æœŸé—´ä¸¤å¥—ç³»ç»Ÿ | æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ |
| **å›¢é˜Ÿå‹åŠ›** | é«˜ï¼ˆæˆªæ­¢æ—¥æœŸå‹åŠ›ï¼‰ | ä½ï¼ˆæŒç»­æ”¹è¿›ï¼‰ |

### 1.4 æ¸è¿›å¼å¢å¼ºç­–ç•¥

æ¸è¿›å¼å¢å¼ºæ˜¯èåˆæ¶æ„çš„æ ¸å¿ƒå®æ–½ç­–ç•¥ã€‚å®ƒå°†å¤æ‚çš„æ¶æ„å˜é©åˆ†è§£ä¸ºå¯ç®¡ç†çš„å°æ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½åˆ›é€ ä»·å€¼ã€‚

#### 1.4.1 å¢å¼ºé˜¶æ®µè§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¸è¿›å¼å¢å¼ºè·¯çº¿å›¾                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Phase 0: åŸºç¡€å¤¯å® (Weeks 1-2)                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: ç¡®ä¿ç°æœ‰ç³»ç»Ÿç¨³å®šï¼Œä¸ºå¢å¼ºåšå‡†å¤‡                                          â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æ¸…å•:                                                                  â”‚
â”‚  â–¡ ä»£ç å®¡æŸ¥ï¼šè¯†åˆ«éœ€è¦é‡æ„çš„æŠ€æœ¯å€ºåŠ¡                                            â”‚
â”‚  â–¡ æµ‹è¯•è¦†ç›–ï¼šç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æœ‰å……åˆ†çš„æµ‹è¯•è¦†ç›–                                      â”‚
â”‚  â–¡ ç›‘æ§å»ºç«‹ï¼šè®¾ç½®æ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ª                                            â”‚
â”‚  â–¡ æ–‡æ¡£å®Œå–„ï¼šæ›´æ–°æ¶æ„æ–‡æ¡£å’Œå¼€å‘æŒ‡å—                                            â”‚
â”‚  â–¡ ä¾èµ–æ›´æ–°ï¼šå‡çº§å…³é”®ä¾èµ–åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬                                        â”‚
â”‚                                                                             â”‚
â”‚  äº¤ä»˜ç‰©:                                                                    â”‚
â”‚  â€¢ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š (ç›®æ ‡: >80%)                                                â”‚
â”‚  â€¢ æ€§èƒ½åŸºçº¿æ•°æ®                                                               â”‚
â”‚  â€¢ é‡æ„ä¼˜å…ˆçº§æ¸…å•                                                             â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  Phase 1: AI åŸºç¡€è®¾æ–½ (Weeks 3-6)                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: å»ºç«‹ AI èƒ½åŠ›çš„åŸºç¡€è®¾æ–½å±‚ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½                                  â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æ¸…å•:                                                                  â”‚
â”‚  â–¡ å‘é‡å­˜å‚¨: é›†æˆæœ¬åœ°å‘é‡æ•°æ®åº“ (å¦‚ LanceDB)                                    â”‚
â”‚  â–¡ åµŒå…¥æœåŠ¡: å®ç°æ–‡æ¡£åµŒå…¥ç”ŸæˆåŠŸèƒ½                                              â”‚
â”‚  â–¡ ç´¢å¼•æ„å»º: ä¸ºç°æœ‰ Markdown æ–‡æ¡£æ„å»ºå‘é‡ç´¢å¼•                                   â”‚
â”‚  â–¡ é…ç½®ç®¡ç†: æ·»åŠ  AI æœåŠ¡é…ç½®ï¼ˆAPI å¯†é’¥ã€æ¨¡å‹é€‰æ‹©ï¼‰                              â”‚
â”‚  â–¡ åŠŸèƒ½å¼€å…³: å®ç° AI åŠŸèƒ½çš„è¿è¡Œæ—¶å¼€å…³                                          â”‚
â”‚                                                                             â”‚
â”‚  äº¤ä»˜ç‰©:                                                                    â”‚
â”‚  â€¢ æœ¬åœ°å‘é‡æœç´¢åŠŸèƒ½ï¼ˆå¯é€‰å¼€å¯ï¼‰                                                â”‚
â”‚  â€¢ æ–‡æ¡£åµŒå…¥å’Œç´¢å¼•æµæ°´çº¿                                                        â”‚
â”‚  â€¢ é…ç½®ç®¡ç†ç³»ç»Ÿ                                                               â”‚
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·å¯è§å˜åŒ–: æ— ï¼ˆåå°åŠŸèƒ½ï¼‰                                                  â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  Phase 2: AI å¢å¼ºå±‚ (Weeks 7-10)                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: æ·»åŠ å¯é€‰çš„ AI å¢å¼ºåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥è‡ªä¸»é€‰æ‹©ä½¿ç”¨                               â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æ¸…å•:                                                                  â”‚
â”‚  â–¡ AIChatOrb: å®ç°æ‚¬æµ®èŠå¤©çƒç»„ä»¶                                              â”‚
â”‚  â–¡ è¯­ä¹‰æœç´¢: åœ¨æœç´¢ç•Œé¢æ·»åŠ "ä½¿ç”¨ AI æœç´¢"é€‰é¡¹                                   â”‚
â”‚  â–¡ æ™ºèƒ½è¡¥å…¨: åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ  AI è¾…åŠ©å†™ä½œåŠŸèƒ½                                     â”‚
â”‚  â–¡ å†…å®¹åˆ†æ: å®ç°é“¾æ¥æ£€æŸ¥ã€é‡å¤æ£€æµ‹ç­‰è¾…åŠ©åŠŸèƒ½                                   â”‚
â”‚  â–¡ ç”¨æˆ·åå¥½: æ·»åŠ ä¸ªäººè®¾ç½®é¡µé¢ï¼Œç®¡ç† AI åŠŸèƒ½åå¥½                                 â”‚
â”‚                                                                             â”‚
â”‚  äº¤ä»˜ç‰©:                                                                    â”‚
â”‚  â€¢ AIChatOrb ç»„ä»¶ï¼ˆé»˜è®¤å…³é—­ï¼‰                                                  â”‚
â”‚  â€¢ è¯­ä¹‰æœç´¢åˆ‡æ¢æŒ‰é’®                                                           â”‚
â”‚  â€¢ ç¼–è¾‘å™¨ AI è¡¥å…¨å¼€å…³                                                         â”‚
â”‚  â€¢ ç”¨æˆ·åå¥½å­˜å‚¨                                                               â”‚
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·å¯è§å˜åŒ–:                                                              â”‚
â”‚  â€¢ è®¾ç½®é¡µé¢æ–°å¢ AI é€‰é¡¹å¡                                                     â”‚
â”‚  â€¢ æœç´¢æ¡†æ—å‡ºç°"AI æœç´¢"å¼€å…³                                                  â”‚
â”‚  â€¢ ç¼–è¾‘å™¨å·¥å…·æ æ–°å¢ AI è¾…åŠ©æŒ‰é’®                                               â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  Phase 3: åä½œæ¨¡å¼ (Weeks 11-16)                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: å®ç° COLLAB æ¨¡å¼ï¼Œæ·±åº¦é›†æˆ AI å’Œç¼–è¾‘å™¨                                   â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æ¸…å•:                                                                  â”‚
â”‚  â–¡ ModeManager: å®ç°ä¸‰ç§æ¨¡å¼çš„ç®¡ç†å’Œåˆ‡æ¢                                       â”‚
â”‚  â–¡ å†…è”å»ºè®®: å®ç°ç¼–è¾‘å™¨å†…çš„å®æ—¶ AI å»ºè®®                                        â”‚
â”‚  â–¡ å¿«æ·æŒ‡ä»¤: æ·»åŠ "/"å‘½ä»¤é¢æ¿ï¼Œå¿«é€Ÿè°ƒç”¨ AI åŠŸèƒ½                                  â”‚
â”‚  â–¡ å†…å®¹ç ”ç©¶: é›†æˆ Web æœç´¢ï¼Œè¾…åŠ©å†…å®¹åˆ›ä½œ                                        â”‚
â”‚  â–¡ çŸ¥è¯†å›¾è°±: å¯è§†åŒ– WikiLinks å…³ç³»                                            â”‚
â”‚  â–¡ è®°å¿†ç³»ç»Ÿ: å®ç° Agent è®°å¿†çš„æ–‡ä»¶åŒ–å­˜å‚¨                                        â”‚
â”‚                                                                             â”‚
â”‚  äº¤ä»˜ç‰©:                                                                    â”‚
â”‚  â€¢ æ¨¡å¼åˆ‡æ¢ UIï¼ˆMANUAL/COLLAB/AGENTï¼‰                                         â”‚
â”‚  â€¢ å†…è”å»ºè®®ç»„ä»¶                                                               â”‚
â”‚  â€¢ å¿«æ·å‘½ä»¤é¢æ¿                                                               â”‚
â”‚  â€¢ çŸ¥è¯†å›¾è°±å¯è§†åŒ–                                                             â”‚
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·å¯è§å˜åŒ–:                                                              â”‚
â”‚  â€¢ ç¼–è¾‘å™¨é¡¶éƒ¨å‡ºç°æ¨¡å¼åˆ‡æ¢å™¨                                                   â”‚
â”‚  â€¢ COLLAB æ¨¡å¼ä¸‹å‡ºç° AI è¾…åŠ©é¢æ¿                                              â”‚
â”‚  â€¢ å¯ä»¥è¾“å…¥"/"è§¦å‘å¿«æ·å‘½ä»¤                                                    â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  Phase 4: è‡ªä¸»æ¨¡å¼ (Weeks 17-24)                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: å®ç° AGENT æ¨¡å¼ï¼Œæ”¯æŒ AI è‡ªä¸»æ‰§è¡Œä»»åŠ¡                                    â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æ¸…å•:                                                                  â”‚
â”‚  â–¡ AgentRuntime: å®ç° Agent è¿è¡Œæ—¶æ ¸å¿ƒ                                        â”‚
â”‚  â–¡ SkillEngine: å®ç°æŠ€èƒ½ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ­¥éª¤ä»»åŠ¡                                    â”‚
â”‚  â–¡ TaskPanel: å®ç°ä»»åŠ¡ç›‘æ§å’Œç®¡ç†é¢æ¿                                          â”‚
â”‚  â–¡ å®¡æ‰¹æµ: å®ç°å…³é”®æ“ä½œçš„å®¡æ‰¹æœºåˆ¶                                             â”‚
â”‚  â–¡ å†å²ç»Ÿä¸€: ç»Ÿä¸€å±•ç¤ºäººç±»å’Œ Agent çš„æ“ä½œå†å²                                   â”‚
â”‚  â–¡ å›æ»šæœºåˆ¶: å®ç°ä¸€é”®å›æ»š Agent æ“ä½œ                                          â”‚
â”‚                                                                             â”‚
â”‚  äº¤ä»˜ç‰©:                                                                    â”‚
â”‚  â€¢ AGENT æ¨¡å¼å®Œæ•´åŠŸèƒ½                                                         â”‚
â”‚  â€¢ ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ                                                               â”‚
â”‚  â€¢ å®¡æ‰¹å·¥ä½œæµ UI                                                              â”‚
â”‚  â€¢ ç»Ÿä¸€å†å²è§†å›¾                                                               â”‚
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·å¯è§å˜åŒ–:                                                              â”‚
â”‚  â€¢ å¯ä»¥åˆ‡æ¢åˆ° AGENT æ¨¡å¼                                                      â”‚
â”‚  â€¢ å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æŒ‡æ´¾ä»»åŠ¡ç»™ AI                                                â”‚
â”‚  â€¢ å¯ä»¥æŸ¥çœ‹å’Œç®¡ç† AI æ‰§è¡Œçš„ä»»åŠ¡                                               â”‚
â”‚  â€¢ å¯ä»¥å®¡æ‰¹æˆ–æ‹’ç» AI çš„ä¿®æ”¹å»ºè®®                                               â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  Phase 5: ä¼˜åŒ–ä¸æ‰©å±• (Ongoing)                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  ç›®æ ‡: æŒç»­ä¼˜åŒ–æ€§èƒ½ï¼Œæ·»åŠ é«˜çº§åŠŸèƒ½                                               â”‚
â”‚                                                                             â”‚
â”‚  æŒç»­ä»»åŠ¡:                                                                  â”‚
â”‚  â–¡ æ€§èƒ½ä¼˜åŒ–: å‡å°‘ AI åŠŸèƒ½å¯¹é¡µé¢åŠ è½½çš„å½±å“                                       â”‚
â”‚  â–¡ æ¨¡å‹é€‰æ‹©: æ”¯æŒå¤šä¸ª AI æä¾›å•†å’Œæ¨¡å‹                                          â”‚
â”‚  â–¡ é«˜çº§åˆ†æ: å†…å®¹è´¨é‡è¯„åˆ†ã€SEO å»ºè®®ç­‰                                          â”‚
â”‚  â–¡ åä½œå¢å¼º: å¤šäººå®æ—¶åä½œç¼–è¾‘                                                 â”‚
â”‚  â–¡ è‡ªåŠ¨åŒ–: å®šæ—¶ä»»åŠ¡ã€å†…å®¹æ›´æ–°æé†’ç­‰                                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.5 æŠ€æœ¯å€ºåŠ¡å¤„ç†æ–¹æ¡ˆ

åœ¨èåˆæ¶æ„ä¸­ï¼ŒæŠ€æœ¯å€ºåŠ¡çš„å¤„ç†éœ€è¦ç‰¹åˆ«è°¨æ…ï¼Œä»¥ç¡®ä¿æ–°åŠŸèƒ½çš„æ·»åŠ ä¸ä¼šåŠ å‰§ç°æœ‰é—®é¢˜ã€‚

#### 1.5.1 æŠ€æœ¯å€ºåŠ¡è¯„ä¼°çŸ©é˜µ

```typescript
// agent/fusion/technical-debt/DebtAssessment.ts

/**
 * æŠ€æœ¯å€ºåŠ¡è¯„ä¼°ç³»ç»Ÿ
 */
export class TechnicalDebtAssessor {
  
  /**
   * è¯„ä¼°é¡¹ç›®ä¸­çš„æŠ€æœ¯å€ºåŠ¡
   */
  async assessDebt(): Promise<DebtAssessmentReport> {
    const report: DebtAssessmentReport = {
      timestamp: Date.now(),
      categories: []
    }
    
    // ä»£ç è´¨é‡å€ºåŠ¡
    report.categories.push(await this.assessCodeQualityDebt())
    
    // æ¶æ„å€ºåŠ¡
    report.categories.push(await this.assessArchitectureDebt())
    
    // æµ‹è¯•å€ºåŠ¡
    report.categories.push(await this.assessTestDebt())
    
    // æ–‡æ¡£å€ºåŠ¡
    report.categories.push(await this.assessDocumentationDebt())
    
    // ä¾èµ–å€ºåŠ¡
    report.categories.push(await this.assessDependencyDebt())
    
    return report
  }
  
  /**
   * ä»£ç è´¨é‡å€ºåŠ¡è¯„ä¼°
   */
  private async assessCodeQualityDebt(): Promise<DebtCategory> {
    const issues: DebtIssue[] = []
    
    // åˆ†æä»£ç å¤æ‚åº¦
    const complexityReport = await CodeAnalyzer.analyzeComplexity()
    for (const file of complexityReport.highComplexityFiles) {
      issues.push({
        id: `complexity-${file.path}`,
        type: 'code_complexity',
        severity: file.complexity > 20 ? 'high' : 'medium',
        location: file.path,
        description: `Cyclomatic complexity of ${file.complexity} exceeds threshold`,
        impact: ' harder to understand and maintain',
        effortToFix: file.complexity * 0.5, // hours
        category: 'code_quality'
      })
    }
    
    // åˆ†æé‡å¤ä»£ç 
    const duplicationReport = await CodeAnalyzer.findDuplication()
    for (const dup of duplicationReport.duplications) {
      issues.push({
        id: `duplication-${dup.id}`,
        type: 'code_duplication',
        severity: dup.lines > 50 ? 'high' : 'medium',
        location: `${dup.files.join(', ')}`,
        description: `${dup.lines} lines of duplicated code`,
        impact: 'Changes need to be made in multiple places',
        effortToFix: dup.lines * 0.3,
        category: 'code_quality'
      })
    }
    
    // åˆ†æä»£ç å¼‚å‘³
    const smellReport = await CodeAnalyzer.findCodeSmells()
    for (const smell of smellReport.smells) {
      issues.push({
        id: `smell-${smell.id}`,
        type: 'code_smell',
        severity: smell.severity,
        location: smell.location,
        description: smell.description,
        impact: smell.impact,
        effortToFix: smell.effortHours,
        category: 'code_quality'
      })
    }
    
    return {
      name: 'Code Quality',
      issues,
      totalEffort: issues.reduce((sum, i) => sum + i.effortToFix, 0),
      highSeverityCount: issues.filter(i => i.severity === 'high').length
    }
  }
  
  /**
   * æ¶æ„å€ºåŠ¡è¯„ä¼°
   */
  private async assessArchitectureDebt(): Promise<DebtCategory> {
    const issues: DebtIssue[] = []
    
    // æ£€æŸ¥æ¨¡å—è€¦åˆ
    const couplingReport = await ArchitectureAnalyzer.analyzeCoupling()
    for (const violation of couplingReport.violations) {
      issues.push({
        id: `coupling-${violation.id}`,
        type: 'high_coupling',
        severity: 'high',
        location: `${violation.from} -> ${violation.to}`,
        description: `Unexpected dependency between modules`,
        impact: 'Changes ripple through system, harder to test',
        effortToFix: violation.effortHours,
        category: 'architecture'
      })
    }
    
    // æ£€æŸ¥è¿åæ¶æ„è§„åˆ™çš„åœ°æ–¹
    const ruleReport = await ArchitectureAnalyzer.checkRules()
    for (const violation of ruleReport.violations) {
      issues.push({
        id: `arch-rule-${violation.id}`,
        type: 'architecture_violation',
        severity: violation.severity,
        location: violation.location,
        description: violation.description,
        impact: violation.impact,
        effortToFix: violation.effortHours,
        category: 'architecture'
      })
    }
    
    return {
      name: 'Architecture',
      issues,
      totalEffort: issues.reduce((sum, i) => sum + i.effortToFix, 0),
      highSeverityCount: issues.filter(i => i.severity === 'high').length
    }
  }
  
  /**
   * æµ‹è¯•å€ºåŠ¡è¯„ä¼°
   */
  private async assessTestDebt(): Promise<DebtCategory> {
    const issues: DebtIssue[] = []
    
    // è¦†ç›–ç‡åˆ†æ
    const coverageReport = await TestAnalyzer.getCoverage()
    
    for (const file of coverageReport.lowCoverageFiles) {
      if (file.coverage < 50) {
        issues.push({
          id: `coverage-${file.path}`,
          type: 'low_coverage',
          severity: 'high',
          location: file.path,
          description: `Test coverage is ${file.coverage.toFixed(1)}%`,
          impact: 'High risk of regressions when modifying code',
          effortToFix: file.lines * 0.1, // Estimate 6 min per line
          category: 'testing'
        })
      }
    }
    
    // æ£€æŸ¥è·³è¿‡çš„æµ‹è¯•
    const skipReport = await TestAnalyzer.findSkippedTests()
    for (const test of skipReport.skipped) {
      issues.push({
        id: `skipped-${test.id}`,
        type: 'skipped_test',
        severity: 'medium',
        location: test.location,
        description: `Test "${test.name}" is skipped`,
        impact: 'Potential bug not being caught',
        effortToFix: 1, // Usually quick to fix
        category: 'testing'
      })
    }
    
    // æ£€æŸ¥è„†å¼±çš„æµ‹è¯•
    const flakyReport = await TestAnalyzer.findFlakyTests()
    for (const test of flakyReport.flaky) {
      issues.push({
        id: `flaky-${test.id}`,
        type: 'flaky_test',
        severity: 'high',
        location: test.location,
        description: `Test "${test.name}" fails intermittently`,
        impact: 'Reduces confidence in test suite',
        effortToFix: 2,
        category: 'testing'
      })
    }
    
    return {
      name: 'Testing',
      issues,
      totalEffort: issues.reduce((sum, i) => sum + i.effortToFix, 0),
      highSeverityCount: issues.filter(i => i.severity === 'high').length
    }
  }
  
  /**
   * æ–‡æ¡£å€ºåŠ¡è¯„ä¼°
   */
  private async assessDocumentationDebt(): Promise<DebtCategory> {
    const issues: DebtIssue[] = []
    
    // æ£€æŸ¥ç¼ºå¤±çš„æ–‡æ¡£
    const docReport = await DocAnalyzer.checkDocumentation()
    
    for (const item of docReport.undocumented) {
      issues.push({
        id: `undoc-${item.id}`,
        type: 'missing_documentation',
        severity: item.isPublic ? 'high' : 'low',
        location: item.location,
        description: `${item.type} "${item.name}" lacks documentation`,
        impact: 'Harder for team members to understand and use',
        effortToFix: 0.5,
        category: 'documentation'
      })
    }
    
    // æ£€æŸ¥è¿‡æ—¶çš„æ¶æ„æ–‡æ¡£
    const archDocReport = await DocAnalyzer.checkArchitectureDocs()
    if (archDocReport.outdated.length > 0) {
      issues.push({
        id: 'outdated-arch-docs',
        type: 'outdated_documentation',
        severity: 'high',
        location: 'docs/architecture/',
        description: `${archDocReport.outdated.length} architecture docs are outdated`,
        impact: 'Team working with incorrect assumptions',
        effortToFix: archDocReport.outdated.length * 4,
        category: 'documentation'
      })
    }
    
    return {
      name: 'Documentation',
      issues,
      totalEffort: issues.reduce((sum, i) => sum + i.effortToFix, 0),
      highSeverityCount: issues.filter(i => i.severity === 'high').length
    }
  }
  
  /**
   * ä¾èµ–å€ºåŠ¡è¯„ä¼°
   */
  private async assessDependencyDebt(): Promise<DebtCategory> {
    const issues: DebtIssue[] = []
    
    // æ£€æŸ¥è¿‡æœŸä¾èµ–
    const outdatedReport = await DependencyAnalyzer.findOutdated()
    
    for (const dep of outdatedReport.major) {
      issues.push({
        id: `dep-${dep.name}`,
        type: 'outdated_dependency',
        severity: dep.securityRisk ? 'high' : 'medium',
        location: 'package.json',
        description: `${dep.name} is ${dep.versionsBehind} versions behind`,
        impact: dep.securityRisk ? 'Security vulnerabilities' : 'Missing bug fixes and features',
        effortToFix: dep.breakingChanges ? 4 : 1,
        category: 'dependencies'
      })
    }
    
    // æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
    const unusedReport = await DependencyAnalyzer.findUnused()
    for (const dep of unusedReport.unused) {
      issues.push({
        id: `unused-${dep.name}`,
        type: 'unused_dependency',
        severity: 'low',
        location: 'package.json',
        description: `${dep.name} is not used`,
        impact: 'Unnecessary bundle size and maintenance',
        effortToFix: 0.5,
        category: 'dependencies'
      })
    }
    
    return {
      name: 'Dependencies',
      issues,
      totalEffort: issues.reduce((sum, i) => sum + i.effortToFix, 0),
      highSeverityCount: issues.filter(i => i.severity === 'high').length
    }
  }
  
  /**
   * ç”Ÿæˆå€ºåŠ¡å¤„ç†è®¡åˆ’
   */
  generateRemediationPlan(report: DebtAssessmentReport): RemediationPlan {
    // æ”¶é›†æ‰€æœ‰é—®é¢˜
    const allIssues = report.categories.flatMap(c => c.issues)
    
    // æŒ‰ä¸¥é‡ç¨‹åº¦å’Œä¿®å¤æˆæœ¬æ’åº
    const prioritized = allIssues.sort((a, b) => {
      const severityScore = { high: 3, medium: 2, low: 1 }
      const scoreA = severityScore[a.severity] * 10 - a.effortToFix
      const scoreB = severityScore[b.severity] * 10 - b.effortToFix
      return scoreB - scoreA
    })
    
    // åˆ†é˜¶æ®µè®¡åˆ’
    const plan: RemediationPlan = {
      phases: []
    }
    
    // Phase 1: å¿«é€Ÿèƒœåˆ©ï¼ˆä½å·¥ä½œé‡ï¼Œé«˜å½±å“ï¼‰
    const quickWins = prioritized.filter(i => i.effortToFix <= 1 && i.severity !== 'low')
    if (quickWins.length > 0) {
      plan.phases.push({
        name: 'Quick Wins',
        description: 'High impact, low effort fixes',
        issues: quickWins,
        estimatedHours: quickWins.reduce((sum, i) => sum + i.effortToFix, 0)
      })
    }
    
    // Phase 2: é«˜å±å€ºåŠ¡
    const highSeverity = prioritized.filter(i => 
      i.severity === 'high' && !quickWins.includes(i)
    )
    if (highSeverity.length > 0) {
      plan.phases.push({
        name: 'High Severity',
        description: 'Address high severity issues',
        issues: highSeverity,
        estimatedHours: highSeverity.reduce((sum, i) => sum + i.effortToFix, 0)
      })
    }
    
    // Phase 3: æ¶æ„æ”¹è¿›
    const architecture = prioritized.filter(i => 
      i.category === 'architecture' && !quickWins.includes(i) && !highSeverity.includes(i)
    )
    if (architecture.length > 0) {
      plan.phases.push({
        name: 'Architecture',
        description: 'Structural improvements',
        issues: architecture,
        estimatedHours: architecture.reduce((sum, i) => sum + i.effortToFix, 0)
      })
    }
    
    return plan
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface DebtAssessmentReport {
  timestamp: number
  categories: DebtCategory[]
}

interface DebtCategory {
  name: string
  issues: DebtIssue[]
  totalEffort: number
  highSeverityCount: number
}

interface DebtIssue {
  id: string
  type: string
  severity: 'high' | 'medium' | 'low'
  location: string
  description: string
  impact: string
  effortToFix: number
  category: string
}

interface RemediationPlan {
  phases: RemediationPhase[]
}

interface RemediationPhase {
  name: string
  description: string
  issues: DebtIssue[]
  estimatedHours: number
}

// æ¨¡æ‹Ÿçš„åˆ†æå™¨ç±»ï¼ˆå®é™…å®ç°ä¼šè°ƒç”¨çœŸå®å·¥å…·ï¼‰
class CodeAnalyzer {
  static async analyzeComplexity() { return { highComplexityFiles: [] } }
  static async findDuplication() { return { duplications: [] } }
  static async findCodeSmells() { return { smells: [] } }
}

class ArchitectureAnalyzer {
  static async analyzeCoupling() { return { violations: [] } }
  static async checkRules() { return { violations: [] } }
}

class TestAnalyzer {
  static async getCoverage() { return { lowCoverageFiles: [] } }
  static async findSkippedTests() { return { skipped: [] } }
  static async findFlakyTests() { return { flaky: [] } }
}

class DocAnalyzer {
  static async checkDocumentation() { return { undocumented: [] } }
  static async checkArchitectureDocs() { return { outdated: [] } }
}

class DependencyAnalyzer {
  static async findOutdated() { return { major: [] } }
  static async findUnused() { return { unused: [] } }
}
```

#### 1.5.2 å€ºåŠ¡å¤„ç†ç­–ç•¥

åœ¨èåˆæ¶æ„çš„å®æ–½è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥å¤„ç†æŠ€æœ¯å€ºåŠ¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ€æœ¯å€ºåŠ¡å¤„ç†ç­–ç•¥                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ç­–ç•¥ä¸€ï¼šéš”ç¦»ä¼˜å…ˆ (Isolation First)                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  åŸåˆ™: æ–°åŠŸèƒ½ä¸é—ç•™ä»£ç ä¿æŒæ¸…æ™°çš„è¾¹ç•Œ                                          â”‚
â”‚                                                                             â”‚
â”‚  å®è·µ:                                                                      â”‚
â”‚  â€¢ æ–°åŠŸèƒ½æ”¾åœ¨ç‹¬ç«‹çš„æ¨¡å—/ç›®å½•ä¸­                                                 â”‚
â”‚  â€¢ ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ä¸é—ç•™ä»£ç äº¤äº’                                                â”‚
â”‚  â€¢ é¿å…ä¿®æ”¹é—ç•™ä»£ç æ¥æ”¯æŒæ–°åŠŸèƒ½                                                â”‚
â”‚  â€¢ é—ç•™ä»£ç çš„ä¿®æ”¹ä»…é™äºä¿®å¤ bug                                                â”‚
â”‚                                                                             â”‚
â”‚  ç¤ºä¾‹:                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸æ¨è:                                                            â”‚   â”‚
â”‚  â”‚  function legacyEditor() {                                         â”‚   â”‚
â”‚  â”‚    // æ·»åŠ  AI åŠŸèƒ½çš„ä»£ç                                             â”‚   â”‚
â”‚  â”‚    if (aiEnabled) { ... }                                          â”‚   â”‚
â”‚  â”‚  }                                                                 â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  æ¨è:                                                              â”‚   â”‚
â”‚  â”‚  // Legacy Editor ä¿æŒä¸å˜                                          â”‚   â”‚
â”‚  â”‚  function legacyEditor() { ... }                                   â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  // AI å¢å¼ºåœ¨ç‹¬ç«‹çš„åŒ…è£…å™¨ä¸­å®ç°                                       â”‚   â”‚
â”‚  â”‚  class AIEnhancedEditor {                                          â”‚   â”‚
â”‚  â”‚    constructor(private baseEditor: LegacyEditor) {}                â”‚   â”‚
â”‚  â”‚    // AI åŠŸèƒ½å®ç°                                                   â”‚   â”‚
â”‚  â”‚  }                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  ç­–ç•¥äºŒï¼šå¿è¿˜è®¡åˆ’ (Repayment Schedule)                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  åŸåˆ™: å°†å€ºåŠ¡å¿è¿˜çº³å…¥å¸¸è§„çš„è¿­ä»£è®¡åˆ’                                            â”‚
â”‚                                                                             â”‚
â”‚  å®è·µ:                                                                      â”‚
â”‚  â€¢ æ¯ä¸ª Sprint åˆ†é… 20% çš„å®¹é‡ç”¨äºæŠ€æœ¯å€ºåŠ¡                                     â”‚
â”‚  â€¢ ä¼˜å…ˆå¤„ç†ä¸æ–°åŠŸèƒ½ç›¸å…³çš„å€ºåŠ¡                                                  â”‚
â”‚  â€¢ ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·æŒç»­ç›‘æ§å€ºåŠ¡æ°´å¹³                                              â”‚
â”‚  â€¢ åœ¨ä»£ç å®¡æŸ¥ä¸­å…³æ³¨å€ºåŠ¡çš„å¼•å…¥                                                  â”‚
â”‚                                                                             â”‚
â”‚  Sprint è®¡åˆ’ç¤ºä¾‹:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Sprint å®¹é‡: 40 äººå¤©                                                â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  åŠŸèƒ½å¼€å‘:        32 äººå¤© (80%)                                      â”‚   â”‚
â”‚  â”‚  æŠ€æœ¯å€ºåŠ¡å¿è¿˜:     8 äººå¤© (20%)                                      â”‚   â”‚
â”‚  â”‚    - é‡æ„å¤æ‚æ¨¡å—:  4 äººå¤©                                           â”‚   â”‚
â”‚  â”‚    - è¡¥å……æµ‹è¯•:      2 äººå¤©                                           â”‚   â”‚
â”‚  â”‚    - æ›´æ–°ä¾èµ–:      1 äººå¤©                                           â”‚   â”‚
â”‚  â”‚    - æ–‡æ¡£æ›´æ–°:      1 äººå¤©                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  ç­–ç•¥ä¸‰ï¼šè´¨é‡é—¨ç¦ (Quality Gates)                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  åŸåˆ™: é˜²æ­¢æ–°å€ºåŠ¡çš„å¼•å…¥ï¼Œé€æ­¥å‡å°‘æ—§å€ºåŠ¡                                        â”‚
â”‚                                                                             â”‚
â”‚  å®è·µ:                                                                      â”‚
â”‚  â€¢ ä»£ç è¦†ç›–ç‡ä¸ä¸‹é™                                                           â”‚
â”‚  â€¢ å¤æ‚åº¦åªå‡ä¸å¢                                                             â”‚
â”‚  â€¢ æ¶æ„è§„åˆ™å¼ºåˆ¶æ‰§è¡Œ                                                           â”‚
â”‚  â€¢ ä»£ç å®¡æŸ¥ checklist                                                        â”‚
â”‚                                                                             â”‚
â”‚  CI/CD é›†æˆç¤ºä¾‹:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  quality-gates.yml                                                 â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚   â”‚
â”‚  â”‚  quality_gates:                                                    â”‚   â”‚
â”‚  â”‚    coverage:                                                       â”‚   â”‚
â”‚  â”‚      minimum: 80%                                                  â”‚   â”‚
â”‚  â”‚      must_not_decrease: true                                       â”‚   â”‚
â”‚  â”‚    complexity:                                                     â”‚   â”‚
â”‚  â”‚      max_per_function: 10                                          â”‚   â”‚
â”‚  â”‚      max_per_file: 100                                             â”‚   â”‚
â”‚  â”‚    duplication:                                                    â”‚   â”‚
â”‚  â”‚      max_percentage: 3%                                            â”‚   â”‚
â”‚  â”‚    architecture:                                                   â”‚   â”‚
â”‚  â”‚      enforce_rules: true                                           â”‚   â”‚
â”‚  â”‚      allowed_violations: 0                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  ç­–ç•¥å››ï¼šæ–‡æ¡£åŒ–å†³ç­– (Documented Decisions)                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  åŸåˆ™: æœ‰æ„è¯†ã€æœ‰è®°å½•åœ°æ¥å—æŸäº›å€ºåŠ¡                                            â”‚
â”‚                                                                             â”‚
â”‚  å®è·µ:                                                                      â”‚
â”‚  â€¢ ä½¿ç”¨ ADR (Architecture Decision Records) è®°å½•æ¶æ„å†³ç­–                      â”‚
â”‚  â€¢ æ˜ç¡®è®°å½•å·²çŸ¥å€ºåŠ¡å’Œæ¥å—åŸå›                                                   â”‚
â”‚  â€¢ å®šæœŸå®¡æŸ¥å·²æ¥å—çš„å€ºåŠ¡                                                        â”‚
â”‚  â€¢ å½“æ¡ä»¶å˜åŒ–æ—¶é‡æ–°è¯„ä¼°                                                        â”‚
â”‚                                                                             â”‚
â”‚  ADR ç¤ºä¾‹:                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  # ADR-012: æ¥å— WikiLinks è§£æçš„æŠ€æœ¯å€ºåŠ¡                            â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## çŠ¶æ€: å·²æ¥å—                                                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## èƒŒæ™¯                                                               â”‚   â”‚
â”‚  â”‚  WikiLinks è§£æå½“å‰ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå­˜åœ¨è¾¹ç•Œæƒ…å†µå¤„ç†ä¸å®Œå–„çš„é£é™©ã€‚          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## å†³ç­–                                                               â”‚   â”‚
â”‚  â”‚  æš‚æ—¶æ¥å—æ­¤å€ºåŠ¡ï¼Œå› ä¸º:                                                  â”‚   â”‚
â”‚  â”‚  1. å½“å‰æ­£åˆ™å·²è¦†ç›– 95% çš„ç”¨ä¾‹                                          â”‚   â”‚
â”‚  â”‚  2. å®Œæ•´çš„è§£æå™¨å¼€å‘éœ€è¦ ~2 å‘¨                                         â”‚   â”‚
â”‚  â”‚  3. è¿™ä¸æ˜¯å½“å‰é˜¶æ®µçš„æ ¸å¿ƒåŠŸèƒ½                                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## åæœ                                                               â”‚   â”‚
â”‚  â”‚  - æŸäº›å¤æ‚åµŒå¥—çš„ WikiLinks å¯èƒ½è§£æå¤±è´¥                               â”‚   â”‚
â”‚  â”‚  - éœ€è¦åœ¨æ–‡æ¡£ä¸­è¯´æ˜é™åˆ¶                                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## ç¼“è§£æªæ–½                                                           â”‚   â”‚
â”‚  â”‚  - æ·»åŠ è§£æå¤±è´¥çš„é”™è¯¯æ—¥å¿—                                               â”‚   â”‚
â”‚  â”‚  - æä¾›æ‰‹åŠ¨ä¿®å¤æŒ‡å—                                                     â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ## é‡æ–°è¯„ä¼°æ¡ä»¶                                                        â”‚   â”‚
â”‚  â”‚  å½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶ï¼Œåº”é‡æ–°è€ƒè™‘å®ç°å®Œæ•´è§£æå™¨:                               â”‚   â”‚
â”‚  â”‚  - è§£æå¤±è´¥ç‡è¾¾åˆ° 5% ä»¥ä¸Š                                               â”‚   â”‚
â”‚  â”‚  - æœ‰ç”¨æˆ·åé¦ˆéœ€è¦æ›´å¤æ‚çš„ WikiLinks è¯­æ³•                                â”‚   â”‚
â”‚  â”‚  - Phase 3 å®Œæˆåæœ‰å¤šä½™çš„å¼€å‘å®¹é‡                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ModeManager å®Œæ•´å®ç°

ModeManager æ˜¯èåˆæ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†ä¸‰ç§ç¼–è¾‘æ¨¡å¼ï¼ˆMANUAL/COLLAB/AGENTï¼‰çš„åˆ‡æ¢å’Œåè°ƒã€‚

### 2.1 æ ¸å¿ƒç±»å‹å®šä¹‰

```typescript
// agent/fusion/mode-manager/types.ts

/**
 * ç¼–è¾‘å™¨æ¨¡å¼æšä¸¾
 */
export enum EditorMode {
  /**
   * æ‰‹åŠ¨æ¨¡å¼ - ä¼ ç»Ÿ VitePress ç¼–è¾‘ä½“éªŒ
   * 100% å…¼å®¹åŸç‰ˆåŠŸèƒ½ï¼Œæ— ä»»ä½• AI å¹²é¢„
   */
  MANUAL = 'MANUAL',
  
  /**
   * åä½œæ¨¡å¼ - AI è¾…åŠ©çš„äººæœºåä½œç¼–è¾‘
   * ä¿æŒäººå·¥æ§åˆ¶ï¼ŒAI æä¾›å®æ—¶å»ºè®®å’Œè¾…åŠ©
   */
  COLLAB = 'COLLAB',
  
  /**
   * Agent æ¨¡å¼ - AI è‡ªä¸»ç¼–è¾‘ï¼Œäººå·¥ç›‘ç£
   * AI å¯ä»¥æ‰§è¡Œä»»åŠ¡ï¼Œä½†å…³é”®æ“ä½œéœ€è¦äººå·¥ç¡®è®¤
   */
  AGENT = 'AGENT'
}

/**
 * æ¨¡å¼é…ç½®æ¥å£
 */
export interface ModeConfiguration {
  /** æ¨¡å¼æ˜¾ç¤ºåç§° */
  displayName: string
  
  /** æ¨¡å¼æè¿° */
  description: string
  
  /** æ¨¡å¼å›¾æ ‡ */
  icon: string
  
  /** ä¸»é¢˜é¢œè‰² */
  themeColor: string
  
  /** å¯ç”¨åŠŸèƒ½åˆ—è¡¨ */
  availableFeatures: FeatureFlag[]
  
  /** å¯è§çš„ UI å…ƒç´  */
  visibleUIElements: UIElement[]
  
  /** æƒé™é…ç½® */
  permissions: PermissionSet
  
  /** é”®ç›˜å¿«æ·é”® */
  keyboardShortcuts: KeyboardShortcut[]
  
  /** æ¨¡å¼ç‰¹å®šçš„ç¼–è¾‘å™¨é…ç½® */
  editorConfig: EditorModeConfig
  
  /** AI è¡Œä¸ºé…ç½® */
  aiBehavior: AIBehaviorConfig
}

/**
 * åŠŸèƒ½æ ‡å¿—
 */
export enum FeatureFlag {
  // åŸºç¡€ç¼–è¾‘åŠŸèƒ½
  BASIC_EDITING = 'BASIC_EDITING',
  WYSIWYG_PREVIEW = 'WYSIWYG_PREVIEW',
  MARKDOWN_SYNTAX = 'MARKDOWN_SYNTAX',
  AUTO_SAVE = 'AUTO_SAVE',
  
  // æœç´¢åŠŸèƒ½
  LOCAL_SEARCH = 'LOCAL_SEARCH',
  SEMANTIC_SEARCH = 'SEMANTIC_SEARCH',
  WEB_SEARCH = 'WEB_SEARCH',
  
  // AI è¾…åŠ©åŠŸèƒ½
  AI_COMPLETION = 'AI_COMPLETION',
  INLINE_SUGGESTIONS = 'INLINE_SUGGESTIONS',
  SMART_FORMATTING = 'SMART_FORMATTING',
  CONTENT_ANALYSIS = 'CONTENT_ANALYSIS',
  
  // åä½œåŠŸèƒ½
  AI_CHAT = 'AI_CHAT',
  QUICK_ACTIONS = 'QUICK_ACTIONS',
  CONTEXT_MENU = 'CONTEXT_MENU',
  
  // Agent åŠŸèƒ½
  INTENT_PROCESSING = 'INTENT_PROCESSING',
  AUTO_RESEARCH = 'AUTO_RESEARCH',
  SKILL_EXECUTION = 'SKILL_EXECUTION',
  TASK_MANAGEMENT = 'TASK_MANAGEMENT',
  APPROVAL_WORKFLOW = 'APPROVAL_WORKFLOW',
  
  // é«˜çº§åŠŸèƒ½
  KNOWLEDGE_GRAPH = 'KNOWLEDGE_GRAPH',
  MEMORY_SYSTEM = 'MEMORY_SYSTEM',
  VERSION_CONTROL = 'VERSION_CONTROL',
  COLLABORATIVE_EDITING = 'COLLABORATIVE_EDITING'
}

/**
 * UI å…ƒç´ æ ‡è¯†
 */
export enum UIElement {
  // ç¼–è¾‘å™¨æ ¸å¿ƒ
  EDITOR_TOOLBAR = 'EDITOR_TOOLBAR',
  EDITOR_SIDEBAR = 'EDITOR_SIDEBAR',
  PREVIEW_PANEL = 'PREVIEW_PANEL',
  STATUS_BAR = 'STATUS_BAR',
  
  // å¯¼èˆªå…ƒç´ 
  FILE_TREE = 'FILE_TREE',
  OUTLINE_VIEW = 'OUTLINE_VIEW',
  BREADCRUMB = 'BREADCRUMB',
  
  // AI å…ƒç´ 
  AI_CHAT_ORB = 'AI_CHAT_ORB',
  AI_PANEL = 'AI_PANEL',
  SUGGESTION_WIDGET = 'SUGGESTION_WIDGET',
  TASK_PANEL = 'TASK_PANEL',
  
  // è¾…åŠ©å…ƒç´ 
  COMMAND_PALETTE = 'COMMAND_PALETTE',
  SEARCH_BOX = 'SEARCH_BOX',
  SETTINGS_PANEL = 'SETTINGS_PANEL'
}

/**
 * æƒé™é›†åˆ
 */
export interface PermissionSet {
  /** è¯»å–æƒé™ */
  read: ReadPermission[]
  
  /** å†™å…¥æƒé™ */
  write: WritePermission[]
  
  /** AI æƒé™ */
  ai: AIPermission[]
  
  /** æ‰§è¡Œæƒé™ */
  execute: ExecutePermission[]
}

export enum ReadPermission {
  READ_DOCUMENTS = 'READ_DOCUMENTS',
  READ_HISTORY = 'READ_HISTORY',
  READ_SETTINGS = 'READ_SETTINGS',
  READ_AI_MEMORY = 'READ_AI_MEMORY',
  READ_TASKS = 'READ_TASKS'
}

export enum WritePermission {
  WRITE_DOCUMENTS_MANUAL = 'WRITE_DOCUMENTS_MANUAL',
  WRITE_DOCUMENTS_AUTO = 'WRITE_DOCUMENTS_AUTO',
  WRITE_SETTINGS = 'WRITE_SETTINGS',
  WRITE_AI_MEMORY = 'WRITE_AI_MEMORY'
}

export enum AIPermission {
  AI_SUGGEST = 'AI_SUGGEST',
  AI_COMPLETE = 'AI_COMPLETE',
  AI_ANALYZE = 'AI_ANALYZE',
  AI_CHAT = 'AI_CHAT',
  AI_EXECUTE_SKILL = 'AI_EXECUTE_SKILL',
  AI_AUTO_EDIT = 'AI_AUTO_EDIT'
}

export enum ExecutePermission {
  EXECUTE_GIT_COMMANDS = 'EXECUTE_GIT_COMMANDS',
  EXECUTE_BUILD = 'EXECUTE_BUILD',
  EXECUTE_SEARCH = 'EXECUTE_SEARCH',
  EXECUTE_WEB_REQUESTS = 'EXECUTE_WEB_REQUESTS'
}

/**
 * é”®ç›˜å¿«æ·é”®
 */
export interface KeyboardShortcut {
  id: string
  key: string
  modifiers?: ('Ctrl' | 'Shift' | 'Alt' | 'Meta')[]
  action: string
  description: string
  scope: 'global' | 'editor' | 'ai'
}

/**
 * ç¼–è¾‘å™¨æ¨¡å¼é…ç½®
 */
export interface EditorModeConfig {
  /** è‡ªåŠ¨ä¿å­˜é—´éš”ï¼ˆæ¯«ç§’ï¼Œ0 è¡¨ç¤ºç¦ç”¨ï¼‰ */
  autoSaveInterval: number
  
  /** å®æ—¶é¢„è§ˆ */
  livePreview: boolean
  
  /** è¯­æ³•é«˜äº® */
  syntaxHighlighting: boolean
  
  /** è¡Œå·æ˜¾ç¤º */
  lineNumbers: boolean
  
  /** æ‹¼å†™æ£€æŸ¥ */
  spellCheck: boolean
  
  /** è‡ªåŠ¨å®Œæˆ */
  autoComplete: 'off' | 'basic' | 'smart' | 'ai'
  
  /** è‡ªåŠ¨æ ¼å¼åŒ– */
  autoFormat: boolean
}

/**
 * AI è¡Œä¸ºé…ç½®
 */
export interface AIBehaviorConfig {
  /** ä¸»åŠ¨æ€§çº§åˆ« */
  proactivityLevel: 'passive' | 'reactive' | 'proactive' | 'autonomous'
  
  /** å»ºè®®é¢‘ç‡ */
  suggestionFrequency: 'rare' | 'normal' | 'frequent'
  
  /** ç¡®è®¤çº§åˆ« */
  confirmationLevel: 'none' | 'critical' | 'all'
  
  /** ä¸Šä¸‹æ–‡çª—å£å¤§å° */
  contextWindowSize: number
  
  /** æœ€å¤§å¹¶å‘ä»»åŠ¡æ•° */
  maxConcurrentTasks: number
  
  /** å“åº”å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ */
  responseDelay: number
}

/**
 * æ¨¡å¼è½¬æ¢äº‹ä»¶
 */
export interface ModeTransitionEvent {
  from: EditorMode
  to: EditorMode
  timestamp: number
  reason: TransitionReason
  userInitiated: boolean
  metadata?: Record<string, any>
}

export enum TransitionReason {
  USER_ACTION = 'USER_ACTION',
  SYSTEM_TRIGGER = 'SYSTEM_TRIGGER',
  INTENT_DETECTED = 'INTENT_DETECTED',
  ERROR_RECOVERY = 'ERROR_RECOVERY',
  PERMISSION_CHANGE = 'PERMISSION_CHANGE'
}

/**
 * æ¨¡å¼çŠ¶æ€
 */
export interface ModeState {
  currentMode: EditorMode
  previousMode: EditorMode | null
  modeHistory: ModeTransitionEvent[]
  isTransitioning: boolean
  transitionProgress: number
  blockedFeatures: FeatureFlag[]
  activeTasks: string[]
  pendingApprovals: string[]
}
```

### 2.2 ModeManager ä¸»ç±»å®ç°

```typescript
// agent/fusion/mode-manager/ModeManager.ts

import { EventEmitter } from 'events'
import {
  EditorMode,
  ModeConfiguration,
  ModeState,
  ModeTransitionEvent,
  TransitionReason,
  FeatureFlag,
  UIElement,
  PermissionSet,
  AIPermission,
  WritePermission,
  ReadPermission,
  ExecutePermission
} from './types'
import { MODE_CONFIGS } from './mode-configs'
import { TransitionValidator } from './TransitionValidator'
import { UIStateManager } from './UIStateManager'
import { PermissionChecker } from './PermissionChecker'

/**
 * æ¨¡å¼ç®¡ç†å™¨ - æ ¸å¿ƒç±»
 * 
 * è´Ÿè´£ï¼š
 * 1. ç®¡ç†å½“å‰ç¼–è¾‘æ¨¡å¼
 * 2. å¤„ç†æ¨¡å¼åˆ‡æ¢
 * 3. åè°ƒæ¨¡å¼ç›¸å…³çš„ UI æ›´æ–°
 * 4. æ§åˆ¶åŠŸèƒ½å¯ç”¨æ€§
 * 5. è®°å½•æ¨¡å¼å†å²
 */
export class ModeManager extends EventEmitter {
  private static instance: ModeManager
  
  /** å½“å‰çŠ¶æ€ */
  private state: ModeState
  
  /** æ¨¡å¼é…ç½®ç¼“å­˜ */
  private configCache: Map<EditorMode, ModeConfiguration>
  
  /** è½¬æ¢éªŒè¯å™¨ */
  private transitionValidator: TransitionValidator
  
  /** UI çŠ¶æ€ç®¡ç†å™¨ */
  private uiStateManager: UIStateManager
  
  /** æƒé™æ£€æŸ¥å™¨ */
  private permissionChecker: PermissionChecker
  
  /** æ¨¡å¼åˆ‡æ¢åŠ¨ç”»æ§åˆ¶å™¨ */
  private animationController: ModeTransitionAnimation
  
  /** æŒä¹…åŒ–å­˜å‚¨é”® */
  private readonly STORAGE_KEY = 'mode-manager-state'
  
  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): ModeManager {
    if (!ModeManager.instance) {
      ModeManager.instance = new ModeManager()
    }
    return ModeManager.instance
  }
  
  private constructor() {
    super()
    
    // åˆå§‹åŒ–çŠ¶æ€
    this.state = this.loadState() || {
      currentMode: EditorMode.MANUAL,
      previousMode: null,
      modeHistory: [],
      isTransitioning: false,
      transitionProgress: 0,
      blockedFeatures: [],
      activeTasks: [],
      pendingApprovals: []
    }
    
    // åˆå§‹åŒ–ç»„ä»¶
    this.configCache = new Map()
    this.transitionValidator = new TransitionValidator()
    this.uiStateManager = new UIStateManager()
    this.permissionChecker = new PermissionChecker()
    this.animationController = new ModeTransitionAnimation()
    
    // åŠ è½½æ¨¡å¼é…ç½®
    this.loadModeConfigurations()
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    this.setupEventListeners()
  }
  
  /**
   * åŠ è½½æ¨¡å¼é…ç½®
   */
  private loadModeConfigurations(): void {
    for (const [mode, config] of Object.entries(MODE_CONFIGS)) {
      this.configCache.set(mode as EditorMode, config)
    }
  }
  
  /**
   * è®¾ç½®äº‹ä»¶ç›‘å¬
   */
  private setupEventListeners(): void {
    // ç›‘å¬æƒé™å˜åŒ–
    this.permissionChecker.on('permissionsChanged', () => {
      this.updateBlockedFeatures()
    })
    
    // ç›‘å¬ä»»åŠ¡çŠ¶æ€å˜åŒ–
    this.on('taskStatusChanged', (taskId: string, status: string) => {
      this.handleTaskStatusChange(taskId, status)
    })
    
    // ç›‘å¬å®¡æ‰¹è¯·æ±‚
    this.on('approvalRequested', (approvalId: string) => {
      this.state.pendingApprovals.push(approvalId)
      this.persistState()
    })
  }
  
  // ============ å…¬å…± API ============
  
  /**
   * è·å–å½“å‰æ¨¡å¼
   */
  getCurrentMode(): EditorMode {
    return this.state.currentMode
  }
  
  /**
   * è·å–ä¸Šä¸€ä¸ªæ¨¡å¼
   */
  getPreviousMode(): EditorMode | null {
    return this.state.previousMode
  }
  
  /**
   * è·å–å½“å‰æ¨¡å¼çš„é…ç½®
   */
  getCurrentModeConfig(): ModeConfiguration {
    return this.getModeConfig(this.state.currentMode)
  }
  
  /**
   * è·å–æŒ‡å®šæ¨¡å¼çš„é…ç½®
   */
  getModeConfig(mode: EditorMode): ModeConfiguration {
    const config = this.configCache.get(mode)
    if (!config) {
      throw new Error(`Mode configuration not found for: ${mode}`)
    }
    return config
  }
  
  /**
   * è·å–æ‰€æœ‰å¯ç”¨æ¨¡å¼
   */
  getAvailableModes(): EditorMode[] {
    return Object.values(EditorMode).filter(mode => 
      this.isModeAvailable(mode)
    )
  }
  
  /**
   * æ£€æŸ¥æ¨¡å¼æ˜¯å¦å¯ç”¨
   */
  isModeAvailable(mode: EditorMode): boolean {
    // MANUAL æ¨¡å¼å§‹ç»ˆå¯ç”¨
    if (mode === EditorMode.MANUAL) return true
    
    // æ£€æŸ¥ä¾èµ–çš„æ¨¡å¼æ˜¯å¦å¯ç”¨
    switch (mode) {
      case EditorMode.COLLAB:
        // COLLAB éœ€è¦ AI åŸºç¡€è®¾æ–½
        return this.areAIDependenciesAvailable()
      
      case EditorMode.AGENT:
        // AGENT éœ€è¦ COLLAB åŸºç¡€è®¾æ–½
        return this.isModeAvailable(EditorMode.COLLAB) && 
               this.isAgentRuntimeAvailable()
      
      default:
        return false
    }
  }
  
  /**
   * åˆ‡æ¢æ¨¡å¼
   * 
   * @param targetMode ç›®æ ‡æ¨¡å¼
   * @param reason åˆ‡æ¢åŸå› 
   * @param options é€‰é¡¹
   * @returns åˆ‡æ¢ç»“æœ
   */
  async switchMode(
    targetMode: EditorMode,
    reason: TransitionReason = TransitionReason.USER_ACTION,
    options: ModeSwitchOptions = {}
  ): Promise<ModeSwitchResult> {
    const { 
      skipValidation = false,
      force = false,
      animation = true,
      metadata = {}
    } = options
    
    const currentMode = this.state.currentMode
    
    console.log(`[ModeManager] Switching from ${currentMode} to ${targetMode}`)
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç›¸åŒæ¨¡å¼
    if (currentMode === targetMode) {
      return {
        success: true,
        mode: targetMode,
        message: 'Already in target mode',
        noOp: true
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆ‡æ¢ä¸­
    if (this.state.isTransitioning && !force) {
      return {
        success: false,
        mode: currentMode,
        message: 'Mode transition already in progress',
        error: 'TRANSITION_IN_PROGRESS'
      }
    }
    
    // éªŒè¯åˆ‡æ¢
    if (!skipValidation) {
      const validation = await this.validateTransition(currentMode, targetMode)
      if (!validation.valid) {
        return {
          success: false,
          mode: currentMode,
          message: validation.reason,
          error: validation.errorCode
        }
      }
    }
    
    // æ£€æŸ¥å¾…å¤„ç†çš„ä»»åŠ¡å’Œå®¡æ‰¹
    if (!force && this.hasBlockingTasks()) {
      return {
        success: false,
        mode: currentMode,
        message: 'Cannot switch mode with pending tasks or approvals',
        error: 'BLOCKING_TASKS',
        pendingTasks: this.state.activeTasks,
        pendingApprovals: this.state.pendingApprovals
      }
    }
    
    try {
      // å¼€å§‹åˆ‡æ¢
      this.state.isTransitioning = true
      this.emit('transitionStart', { from: currentMode, to: targetMode })
      
      // æ‰§è¡Œåˆ‡æ¢å‰é’©å­
      await this.executeBeforeTransition(currentMode, targetMode)
      
      // æ’­æ”¾åˆ‡æ¢åŠ¨ç”»
      if (animation) {
        await this.animationController.playTransition(currentMode, targetMode, 
          (progress) => {
            this.state.transitionProgress = progress
            this.emit('transitionProgress', { progress })
          }
        )
      }
      
      // æ‰§è¡Œå®é™…åˆ‡æ¢
      const previousMode = currentMode
      this.state.currentMode = targetMode
      this.state.previousMode = previousMode
      
      // è®°å½•å†å²
      const transitionEvent: ModeTransitionEvent = {
        from: previousMode,
        to: targetMode,
        timestamp: Date.now(),
        reason,
        userInitiated: reason === TransitionReason.USER_ACTION,
        metadata
      }
      this.state.modeHistory.push(transitionEvent)
      
      // é™åˆ¶å†å²è®°å½•é•¿åº¦
      if (this.state.modeHistory.length > 100) {
        this.state.modeHistory = this.state.modeHistory.slice(-100)
      }
      
      // æ‰§è¡Œåˆ‡æ¢åé’©å­
      await this.executeAfterTransition(previousMode, targetMode)
      
      // æ›´æ–° UI
      await this.updateUIForMode(targetMode)
      
      // æ›´æ–°åŠŸèƒ½å¯ç”¨æ€§
      this.updateBlockedFeatures()
      
      // æŒä¹…åŒ–çŠ¶æ€
      this.persistState()
      
      // å®Œæˆåˆ‡æ¢
      this.state.isTransitioning = false
      this.state.transitionProgress = 0
      
      this.emit('modeChanged', transitionEvent)
      
      console.log(`[ModeManager] Successfully switched to ${targetMode}`)
      
      return {
        success: true,
        mode: targetMode,
        message: `Switched to ${targetMode} mode`,
        transition: transitionEvent
      }
      
    } catch (error) {
      this.state.isTransitioning = false
      this.state.transitionProgress = 0
      
      console.error(`[ModeManager] Mode switch failed:`, error)
      
      this.emit('transitionFailed', { 
        from: currentMode, 
        to: targetMode, 
        error 
      })
      
      return {
        success: false,
        mode: currentMode,
        message: error.message,
        error: 'TRANSITION_FAILED'
      }
    }
  }
  
  /**
   * éªŒè¯æ¨¡å¼åˆ‡æ¢
   */
  private async validateTransition(
    from: EditorMode,
    to: EditorMode
  ): Promise<TransitionValidation> {
    // ä½¿ç”¨éªŒè¯å™¨
    return this.transitionValidator.validate(from, to, {
      hasPendingTasks: this.state.activeTasks.length > 0,
      hasPendingApprovals: this.state.pendingApprovals.length > 0,
      modeAvailable: this.isModeAvailable(to),
      permissions: this.permissionChecker.getCurrentPermissions()
    })
  }
  
  /**
   * æ‰§è¡Œåˆ‡æ¢å‰é’©å­
   */
  private async executeBeforeTransition(
    from: EditorMode,
    to: EditorMode
  ): Promise<void> {
    // ä¿å­˜å½“å‰æ¨¡å¼çš„ç¼–è¾‘å™¨çŠ¶æ€
    await this.saveEditorState(from)
    
    // é€šçŸ¥ç»„ä»¶å‡†å¤‡åˆ‡æ¢
    this.emit('beforeModeChange', { from, to })
    
    // ç‰¹å®šæ¨¡å¼çš„å‰ç½®å¤„ç†
    switch (from) {
      case EditorMode.AGENT:
        // é€€å‡º AGENT æ¨¡å¼å‰ï¼Œæš‚åœæ‰€æœ‰ä»»åŠ¡
        await this.pauseAgentTasks()
        break
      
      case EditorMode.COLLAB:
        // é€€å‡º COLLAB æ¨¡å¼å‰ï¼Œä¿å­˜å»ºè®®çŠ¶æ€
        await this.saveSuggestionState()
        break
    }
  }
  
  /**
   * æ‰§è¡Œåˆ‡æ¢åé’©å­
   */
  private async executeAfterTransition(
    from: EditorMode,
    to: EditorMode
  ): Promise<void> {
    // é€šçŸ¥ç»„ä»¶åˆ‡æ¢å®Œæˆ
    this.emit('afterModeChange', { from, to })
    
    // ç‰¹å®šæ¨¡å¼çš„åç½®å¤„ç†
    switch (to) {
      case EditorMode.MANUAL:
        // è¿›å…¥ MANUAL æ¨¡å¼åï¼Œæ¸…ç† AI ç›¸å…³ UI
        await this.cleanupAIUI()
        break
      
      case EditorMode.COLLAB:
        // è¿›å…¥ COLLAB æ¨¡å¼åï¼Œåˆå§‹åŒ– AI è¾…åŠ©
        await this.initCollabFeatures()
        break
      
      case EditorMode.AGENT:
        // è¿›å…¥ AGENT æ¨¡å¼åï¼Œæ¢å¤æˆ–åˆå§‹åŒ–ä»»åŠ¡
        await this.initAgentFeatures()
        break
    }
  }
  
  /**
   * æ›´æ–° UI ä»¥åŒ¹é…æ–°æ¨¡å¼
   */
  private async updateUIForMode(mode: EditorMode): Promise<void> {
    const config = this.getModeConfig(mode)
    
    // æ›´æ–° UI å…ƒç´ å¯è§æ€§
    await this.uiStateManager.updateUIElements(config.visibleUIElements)
    
    // æ›´æ–°ä¸»é¢˜é¢œè‰²
    this.updateThemeColor(config.themeColor)
    
    // æ›´æ–°å¿«æ·é”®
    this.updateKeyboardShortcuts(config.keyboardShortcuts)
    
    // è§¦å‘ UI æ›´æ–°äº‹ä»¶
    this.emit('uiUpdate', { mode, config })
  }
  
  /**
   * æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
   */
  isFeatureAvailable(feature: FeatureFlag): boolean {
    const config = this.getCurrentModeConfig()
    
    // æ£€æŸ¥åŠŸèƒ½æ˜¯å¦åœ¨æ¨¡å¼é…ç½®ä¸­
    if (!config.availableFeatures.includes(feature)) {
      return false
    }
    
    // æ£€æŸ¥åŠŸèƒ½æ˜¯å¦è¢«é˜»å¡
    if (this.state.blockedFeatures.includes(feature)) {
      return false
    }
    
    return true
  }
  
  /**
   * æ£€æŸ¥æƒé™
   */
  hasPermission(
    permission: ReadPermission | WritePermission | AIPermission | ExecutePermission
  ): boolean {
    const config = this.getCurrentModeConfig()
    return this.permissionChecker.check(config.permissions, permission)
  }
  
  /**
   * è·å–æ¨¡å¼å†å²
   */
  getModeHistory(limit?: number): ModeTransitionEvent[] {
    const history = [...this.state.modeHistory]
    if (limit) {
      return history.slice(-limit)
    }
    return history
  }
  
  /**
   * è·å–æ¨¡å¼ç»Ÿè®¡
   */
  getModeStats(): ModeStats {
    const history = this.state.modeHistory
    const totalSwitches = history.length
    
    const modeDistribution = history.reduce((acc, event) => {
      acc[event.to] = (acc[event.to] || 0) + 1
      return acc
    }, {} as Record<EditorMode, number>)
    
    const averageTimeInMode = this.calculateAverageTimeInMode(history)
    
    return {
      totalSwitches,
      currentMode: this.state.currentMode,
      modeDistribution,
      averageTimeInMode,
      lastSwitch: history[history.length - 1] || null
    }
  }
  
  /**
   * é‡ç½®åˆ°é»˜è®¤æ¨¡å¼
   */
  async resetToDefault(): Promise<ModeSwitchResult> {
    return this.switchMode(EditorMode.MANUAL, TransitionReason.ERROR_RECOVERY)
  }
  
  /**
   * é”€æ¯ç®¡ç†å™¨
   */
  destroy(): void {
    this.persistState()
    this.removeAllListeners()
    ModeManager.instance = null as any
  }
  
  // ============ ç§æœ‰è¾…åŠ©æ–¹æ³• ============
  
  private loadState(): ModeState | null {
    try {
      const saved = localStorage.getItem(this.STORAGE_KEY)
      if (saved) {
        return JSON.parse(saved)
      }
    } catch (error) {
      console.error('[ModeManager] Failed to load state:', error)
    }
    return null
  }
  
  private persistState(): void {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state))
    } catch (error) {
      console.error('[ModeManager] Failed to persist state:', error)
    }
  }
  
  private updateBlockedFeatures(): void {
    const config = this.getCurrentModeConfig()
    const blocked: FeatureFlag[] = []
    
    // æ ¹æ®æƒé™æ£€æŸ¥æ¯ä¸ªåŠŸèƒ½
    for (const feature of config.availableFeatures) {
      if (!this.isFeaturePermitted(feature, config.permissions)) {
        blocked.push(feature)
      }
    }
    
    this.state.blockedFeatures = blocked
  }
  
  private isFeaturePermitted(
    feature: FeatureFlag,
    permissions: PermissionSet
  ): boolean {
    // æ ¹æ®åŠŸèƒ½ç±»å‹æ£€æŸ¥å¯¹åº”æƒé™
    switch (feature) {
      case FeatureFlag.AI_COMPLETION:
      case FeatureFlag.INLINE_SUGGESTIONS:
        return permissions.ai.includes(AIPermission.AI_COMPLETE)
      
      case FeatureFlag.AI_CHAT:
        return permissions.ai.includes(AIPermission.AI_CHAT)
      
      case FeatureFlag.SKILL_EXECUTION:
        return permissions.ai.includes(AIPermission.AI_EXECUTE_SKILL)
      
      case FeatureFlag.INTENT_PROCESSING:
        return permissions.ai.includes(AIPermission.AI_AUTO_EDIT)
      
      default:
        return true
    }
  }
  
  private hasBlockingTasks(): boolean {
    return this.state.activeTasks.length > 0 || 
           this.state.pendingApprovals.length > 0
  }
  
  private areAIDependenciesAvailable(): boolean {
    // æ£€æŸ¥ AI åŸºç¡€è®¾æ–½æ˜¯å¦å¯ç”¨
    return typeof window !== 'undefined' && 
           (window as any).AIServices?.isAvailable() === true
  }
  
  private isAgentRuntimeAvailable(): boolean {
    // æ£€æŸ¥ Agent è¿è¡Œæ—¶æ˜¯å¦å¯ç”¨
    return typeof window !== 'undefined' && 
           (window as any).AgentRuntime?.isInitialized() === true
  }
  
  private async saveEditorState(mode: EditorMode): Promise<void> {
    this.emit('saveEditorState', { mode })
  }
  
  private async pauseAgentTasks(): Promise<void> {
    this.emit('pauseAgentTasks')
  }
  
  private async saveSuggestionState(): Promise<void> {
    this.emit('saveSuggestionState')
  }
  
  private async cleanupAIUI(): Promise<void> {
    this.uiStateManager.hideAIElements()
  }
  
  private async initCollabFeatures(): Promise<void> {
    this.emit('initCollabFeatures')
  }
  
  private async initAgentFeatures(): Promise<void> {
    this.emit('initAgentFeatures')
  }
  
  private updateThemeColor(color: string): void {
    document.documentElement.style.setProperty('--mode-theme-color', color)
  }
  
  private updateKeyboardShortcuts(shortcuts: any[]): void {
    // æ›´æ–°å¿«æ·é”®ç»‘å®š
    this.emit('updateShortcuts', shortcuts)
  }
  
  private calculateAverageTimeInMode(
    history: ModeTransitionEvent[]
  ): Record<EditorMode, number> {
    const modeTimes: Record<EditorMode, number[]> = {
      [EditorMode.MANUAL]: [],
      [EditorMode.COLLAB]: [],
      [EditorMode.AGENT]: []
    }
    
    for (let i = 0; i < history.length - 1; i++) {
      const duration = history[i + 1].timestamp - history[i].timestamp
      modeTimes[history[i].to].push(duration)
    }
    
    const averages: Record<EditorMode, number> = {
      [EditorMode.MANUAL]: 0,
      [EditorMode.COLLAB]: 0,
      [EditorMode.AGENT]: 0
    }
    
    for (const [mode, times] of Object.entries(modeTimes)) {
      if (times.length > 0) {
        averages[mode as EditorMode] = 
          times.reduce((a, b) => a + b, 0) / times.length
      }
    }
    
    return averages
  }
  
  private handleTaskStatusChange(taskId: string, status: string): void {
    if (status === 'completed' || status === 'failed') {
      this.state.activeTasks = this.state.activeTasks.filter(id => id !== taskId)
      this.persistState()
    }
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface ModeSwitchOptions {
  skipValidation?: boolean
  force?: boolean
  animation?: boolean
  metadata?: Record<string, any>
}

interface ModeSwitchResult {
  success: boolean
  mode: EditorMode
  message: string
  noOp?: boolean
  error?: string
  transition?: ModeTransitionEvent
  pendingTasks?: string[]
  pendingApprovals?: string[]
}

interface TransitionValidation {
  valid: boolean
  reason?: string
  errorCode?: string
}

interface ModeStats {
  totalSwitches: number
  currentMode: EditorMode
  modeDistribution: Record<EditorMode, number>
  averageTimeInMode: Record<EditorMode, number>
  lastSwitch: ModeTransitionEvent | null
}

// ============ å…¶ä»–ä¾èµ–ç±»ï¼ˆç®€åŒ–å®ç°ï¼‰ ============

class TransitionValidator {
  validate(
    from: EditorMode,
    to: EditorMode,
    context: ValidationContext
  ): TransitionValidation {
    // æ£€æŸ¥ç›®æ ‡æ¨¡å¼æ˜¯å¦å¯ç”¨
    if (!context.modeAvailable) {
      return {
        valid: false,
        reason: 'Target mode is not available',
        errorCode: 'MODE_UNAVAILABLE'
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†ä»»åŠ¡
    if (context.hasPendingTasks) {
      return {
        valid: false,
        reason: 'Cannot switch with pending tasks',
        errorCode: 'PENDING_TASKS'
      }
    }
    
    // æ£€æŸ¥æƒé™
    if (to === EditorMode.AGENT && !context.permissions.ai.includes(AIPermission.AI_AUTO_EDIT)) {
      return {
        valid: false,
        reason: 'Insufficient permissions for AGENT mode',
        errorCode: 'INSUFFICIENT_PERMISSIONS'
      }
    }
    
    return { valid: true }
  }
}

class UIStateManager {
  async updateUIElements(elements: UIElement[]): Promise<void> {
    // å®ç° UI å…ƒç´ æ›´æ–°é€»è¾‘
  }
  
  hideAIElements(): void {
    // éšè—æ‰€æœ‰ AI ç›¸å…³çš„ UI å…ƒç´ 
  }
}

class PermissionChecker extends EventEmitter {
  getCurrentPermissions(): PermissionSet {
    // è¿”å›å½“å‰æƒé™
    return {
      read: Object.values(ReadPermission),
      write: Object.values(WritePermission),
      ai: Object.values(AIPermission),
      execute: Object.values(ExecutePermission)
    }
  }
  
  check(permissions: PermissionSet, permission: string): boolean {
    return Object.values(permissions).some(
      list => list.includes(permission as any)
    )
  }
}

class ModeTransitionAnimation {
  async playTransition(
    from: EditorMode,
    to: EditorMode,
    onProgress: (progress: number) => void
  ): Promise<void> {
    const duration = 300 // ms
    const steps = 30
    
    for (let i = 0; i <= steps; i++) {
      await new Promise(resolve => setTimeout(resolve, duration / steps))
      onProgress(i / steps)
    }
  }
}

interface ValidationContext {
  hasPendingTasks: boolean
  hasPendingApprovals: boolean
  modeAvailable: boolean
  permissions: PermissionSet
}
```



### 2.3 æ¨¡å¼é…ç½®å®šä¹‰

```typescript
// agent/fusion/mode-manager/mode-configs.ts

import {
  EditorMode,
  ModeConfiguration,
  FeatureFlag,
  UIElement,
  ReadPermission,
  WritePermission,
  AIPermission,
  ExecutePermission
} from './types'

/**
 * MANUAL æ¨¡å¼é…ç½®
 * 
 * çº¯æ‰‹åŠ¨ç¼–è¾‘æ¨¡å¼ï¼Œ100% å…¼å®¹ä¼ ç»Ÿ VitePress ä½“éªŒ
 */
export const MANUAL_MODE_CONFIG: ModeConfiguration = {
  displayName: 'æ‰‹åŠ¨æ¨¡å¼',
  description: 'ä¼ ç»Ÿ VitePress ç¼–è¾‘ä½“éªŒï¼Œæ— ä»»ä½• AI å¹²é¢„',
  icon: 'edit-3',
  themeColor: '#3b82f6', // è“è‰²
  
  availableFeatures: [
    // åŸºç¡€ç¼–è¾‘
    FeatureFlag.BASIC_EDITING,
    FeatureFlag.WYSIWYG_PREVIEW,
    FeatureFlag.MARKDOWN_SYNTAX,
    FeatureFlag.AUTO_SAVE,
    
    // æœç´¢
    FeatureFlag.LOCAL_SEARCH,
    
    // ç‰ˆæœ¬æ§åˆ¶
    FeatureFlag.VERSION_CONTROL
  ],
  
  visibleUIElements: [
    UIElement.EDITOR_TOOLBAR,
    UIElement.EDITOR_SIDEBAR,
    UIElement.PREVIEW_PANEL,
    UIElement.STATUS_BAR,
    UIElement.FILE_TREE,
    UIElement.OUTLINE_VIEW,
    UIElement.BREADCRUMB,
    UIElement.SEARCH_BOX
  ],
  
  permissions: {
    read: [
      ReadPermission.READ_DOCUMENTS,
      ReadPermission.READ_HISTORY,
      ReadPermission.READ_SETTINGS
    ],
    write: [
      WritePermission.WRITE_DOCUMENTS_MANUAL,
      WritePermission.WRITE_SETTINGS
    ],
    ai: [], // MANUAL æ¨¡å¼æ—  AI æƒé™
    execute: [
      ExecutePermission.EXECUTE_GIT_COMMANDS,
      ExecutePermission.EXECUTE_BUILD,
      ExecutePermission.EXECUTE_SEARCH
    ]
  },
  
  keyboardShortcuts: [
    {
      id: 'save',
      key: 's',
      modifiers: ['Ctrl'],
      action: 'document.save',
      description: 'ä¿å­˜æ–‡æ¡£',
      scope: 'editor'
    },
    {
      id: 'preview',
      key: 'p',
      modifiers: ['Ctrl', 'Shift'],
      action: 'document.preview',
      description: 'é¢„è§ˆæ–‡æ¡£',
      scope: 'editor'
    },
    {
      id: 'search',
      key: 'f',
      modifiers: ['Ctrl'],
      action: 'search.open',
      description: 'æ‰“å¼€æœç´¢',
      scope: 'global'
    },
    {
      id: 'command-palette',
      key: 'p',
      modifiers: ['Ctrl', 'Shift'],
      action: 'commandPalette.open',
      description: 'å‘½ä»¤é¢æ¿',
      scope: 'global'
    }
  ],
  
  editorConfig: {
    autoSaveInterval: 30000, // 30 ç§’
    livePreview: true,
    syntaxHighlighting: true,
    lineNumbers: true,
    spellCheck: true,
    autoComplete: 'basic',
    autoFormat: false
  },
  
  aiBehavior: {
    proactivityLevel: 'passive',
    suggestionFrequency: 'rare',
    confirmationLevel: 'all',
    contextWindowSize: 0,
    maxConcurrentTasks: 0,
    responseDelay: 0
  }
}

/**
 * COLLAB æ¨¡å¼é…ç½®
 * 
 * AI è¾…åŠ©åä½œæ¨¡å¼ï¼ŒäººæœºååŒç¼–è¾‘
 */
export const COLLAB_MODE_CONFIG: ModeConfiguration = {
  displayName: 'åä½œæ¨¡å¼',
  description: 'AI è¾…åŠ©çš„äººæœºåä½œç¼–è¾‘ï¼Œä¿æŒäººå·¥æ§åˆ¶',
  icon: 'users',
  themeColor: '#8b5cf6', // ç´«è‰²
  
  availableFeatures: [
    // ç»§æ‰¿ MANUAL å…¨éƒ¨åŠŸèƒ½
    FeatureFlag.BASIC_EDITING,
    FeatureFlag.WYSIWYG_PREVIEW,
    FeatureFlag.MARKDOWN_SYNTAX,
    FeatureFlag.AUTO_SAVE,
    FeatureFlag.LOCAL_SEARCH,
    FeatureFlag.VERSION_CONTROL,
    
    // AI å¢å¼ºåŠŸèƒ½
    FeatureFlag.SEMANTIC_SEARCH,
    FeatureFlag.AI_COMPLETION,
    FeatureFlag.INLINE_SUGGESTIONS,
    FeatureFlag.SMART_FORMATTING,
    FeatureFlag.CONTENT_ANALYSIS,
    
    // åä½œåŠŸèƒ½
    FeatureFlag.AI_CHAT,
    FeatureFlag.QUICK_ACTIONS,
    FeatureFlag.CONTEXT_MENU,
    
    // Web æœç´¢
    FeatureFlag.WEB_SEARCH,
    
    // çŸ¥è¯†å›¾è°±
    FeatureFlag.KNOWLEDGE_GRAPH,
    
    // è®°å¿†ç³»ç»Ÿ
    FeatureFlag.MEMORY_SYSTEM
  ],
  
  visibleUIElements: [
    // ç»§æ‰¿ MANUAL å…¨éƒ¨ UI
    UIElement.EDITOR_TOOLBAR,
    UIElement.EDITOR_SIDEBAR,
    UIElement.PREVIEW_PANEL,
    UIElement.STATUS_BAR,
    UIElement.FILE_TREE,
    UIElement.OUTLINE_VIEW,
    UIElement.BREADCRUMB,
    UIElement.SEARCH_BOX,
    UIElement.COMMAND_PALETTE,
    UIElement.SETTINGS_PANEL,
    
    // AI ç‰¹æœ‰ UI
    UIElement.AI_CHAT_ORB,
    UIElement.AI_PANEL,
    UIElement.SUGGESTION_WIDGET
  ],
  
  permissions: {
    read: [
      ReadPermission.READ_DOCUMENTS,
      ReadPermission.READ_HISTORY,
      ReadPermission.READ_SETTINGS,
      ReadPermission.READ_AI_MEMORY
    ],
    write: [
      WritePermission.WRITE_DOCUMENTS_MANUAL,
      WritePermission.WRITE_SETTINGS,
      WritePermission.WRITE_AI_MEMORY
    ],
    ai: [
      AIPermission.AI_SUGGEST,
      AIPermission.AI_COMPLETE,
      AIPermission.AI_ANALYZE,
      AIPermission.AI_CHAT
    ],
    execute: [
      ExecutePermission.EXECUTE_GIT_COMMANDS,
      ExecutePermission.EXECUTE_BUILD,
      ExecutePermission.EXECUTE_SEARCH,
      ExecutePermission.EXECUTE_WEB_REQUESTS
    ]
  },
  
  keyboardShortcuts: [
    // ç»§æ‰¿ MANUAL å¿«æ·é”®
    {
      id: 'save',
      key: 's',
      modifiers: ['Ctrl'],
      action: 'document.save',
      description: 'ä¿å­˜æ–‡æ¡£',
      scope: 'editor'
    },
    {
      id: 'preview',
      key: 'p',
      modifiers: ['Ctrl', 'Shift'],
      action: 'document.preview',
      description: 'é¢„è§ˆæ–‡æ¡£',
      scope: 'editor'
    },
    {
      id: 'search',
      key: 'f',
      modifiers: ['Ctrl'],
      action: 'search.open',
      description: 'æ‰“å¼€æœç´¢',
      scope: 'global'
    },
    {
      id: 'command-palette',
      key: 'p',
      modifiers: ['Ctrl', 'Shift'],
      action: 'commandPalette.open',
      description: 'å‘½ä»¤é¢æ¿',
      scope: 'global'
    },
    
    // COLLAB ç‰¹æœ‰å¿«æ·é”®
    {
      id: 'ai-chat-toggle',
      key: 'a',
      modifiers: ['Ctrl', 'Shift'],
      action: 'ai.toggleChat',
      description: 'åˆ‡æ¢ AI èŠå¤©é¢æ¿',
      scope: 'global'
    },
    {
      id: 'ai-complete',
      key: 'Space',
      modifiers: ['Ctrl'],
      action: 'ai.triggerCompletion',
      description: 'è§¦å‘ AI è¡¥å…¨',
      scope: 'editor'
    },
    {
      id: 'quick-action',
      key: '/',
      modifiers: [],
      action: 'ai.openQuickActions',
      description: 'æ‰“å¼€å¿«æ·æ“ä½œ',
      scope: 'editor'
    },
    {
      id: 'accept-suggestion',
      key: 'Tab',
      modifiers: [],
      action: 'ai.acceptSuggestion',
      description: 'æ¥å— AI å»ºè®®',
      scope: 'editor'
    },
    {
      id: 'reject-suggestion',
      key: 'Escape',
      modifiers: [],
      action: 'ai.rejectSuggestion',
      description: 'æ‹’ç» AI å»ºè®®',
      scope: 'editor'
    }
  ],
  
  editorConfig: {
    autoSaveInterval: 10000, // 10 ç§’ï¼ˆæ›´é¢‘ç¹ï¼‰
    livePreview: true,
    syntaxHighlighting: true,
    lineNumbers: true,
    spellCheck: true,
    autoComplete: 'smart', // AI å¢å¼ºçš„è‡ªåŠ¨å®Œæˆ
    autoFormat: true
  },
  
  aiBehavior: {
    proactivityLevel: 'reactive',
    suggestionFrequency: 'normal',
    confirmationLevel: 'critical',
    contextWindowSize: 4000,
    maxConcurrentTasks: 3,
    responseDelay: 500
  }
}

/**
 * AGENT æ¨¡å¼é…ç½®
 * 
 * AI è‡ªä¸»æ¨¡å¼ï¼Œäººå·¥ç›‘ç£
 */
export const AGENT_MODE_CONFIG: ModeConfiguration = {
  displayName: 'Agent æ¨¡å¼',
  description: 'AI è‡ªä¸»ç¼–è¾‘ï¼Œäººå·¥ç›‘ç£å…³é”®æ“ä½œ',
  icon: 'cpu',
  themeColor: '#f59e0b', // ç¥ç€è‰²
  
  availableFeatures: [
    // ç»§æ‰¿ COLLAB å…¨éƒ¨åŠŸèƒ½
    FeatureFlag.BASIC_EDITING,
    FeatureFlag.WYSIWYG_PREVIEW,
    FeatureFlag.MARKDOWN_SYNTAX,
    FeatureFlag.AUTO_SAVE,
    FeatureFlag.LOCAL_SEARCH,
    FeatureFlag.VERSION_CONTROL,
    FeatureFlag.SEMANTIC_SEARCH,
    FeatureFlag.AI_COMPLETION,
    FeatureFlag.INLINE_SUGGESTIONS,
    FeatureFlag.SMART_FORMATTING,
    FeatureFlag.CONTENT_ANALYSIS,
    FeatureFlag.AI_CHAT,
    FeatureFlag.QUICK_ACTIONS,
    FeatureFlag.CONTEXT_MENU,
    FeatureFlag.WEB_SEARCH,
    FeatureFlag.KNOWLEDGE_GRAPH,
    FeatureFlag.MEMORY_SYSTEM,
    
    // AGENT ç‰¹æœ‰åŠŸèƒ½
    FeatureFlag.INTENT_PROCESSING,
    FeatureFlag.AUTO_RESEARCH,
    FeatureFlag.SKILL_EXECUTION,
    FeatureFlag.TASK_MANAGEMENT,
    FeatureFlag.APPROVAL_WORKFLOW
  ],
  
  visibleUIElements: [
    // ç»§æ‰¿ COLLAB å…¨éƒ¨ UI
    UIElement.EDITOR_TOOLBAR,
    UIElement.EDITOR_SIDEBAR,
    UIElement.PREVIEW_PANEL,
    UIElement.STATUS_BAR,
    UIElement.FILE_TREE,
    UIElement.OUTLINE_VIEW,
    UIElement.BREADCRUMB,
    UIElement.SEARCH_BOX,
    UIElement.COMMAND_PALETTE,
    UIElement.SETTINGS_PANEL,
    UIElement.AI_CHAT_ORB,
    UIElement.AI_PANEL,
    UIElement.SUGGESTION_WIDGET,
    
    // AGENT ç‰¹æœ‰ UI
    UIElement.TASK_PANEL
  ],
  
  permissions: {
    read: [
      ReadPermission.READ_DOCUMENTS,
      ReadPermission.READ_HISTORY,
      ReadPermission.READ_SETTINGS,
      ReadPermission.READ_AI_MEMORY,
      ReadPermission.READ_TASKS
    ],
    write: [
      WritePermission.WRITE_DOCUMENTS_MANUAL,
      WritePermission.WRITE_DOCUMENTS_AUTO, // AGENT ç‰¹æœ‰
      WritePermission.WRITE_SETTINGS,
      WritePermission.WRITE_AI_MEMORY
    ],
    ai: [
      AIPermission.AI_SUGGEST,
      AIPermission.AI_COMPLETE,
      AIPermission.AI_ANALYZE,
      AIPermission.AI_CHAT,
      AIPermission.AI_EXECUTE_SKILL,
      AIPermission.AI_AUTO_EDIT // AGENT ç‰¹æœ‰
    ],
    execute: [
      ExecutePermission.EXECUTE_GIT_COMMANDS,
      ExecutePermission.EXECUTE_BUILD,
      ExecutePermission.EXECUTE_SEARCH,
      ExecutePermission.EXECUTE_WEB_REQUESTS
    ]
  },
  
  keyboardShortcuts: [
    // ç»§æ‰¿ COLLAB å¿«æ·é”®
    {
      id: 'save',
      key: 's',
      modifiers: ['Ctrl'],
      action: 'document.save',
      description: 'ä¿å­˜æ–‡æ¡£',
      scope: 'editor'
    },
    {
      id: 'search',
      key: 'f',
      modifiers: ['Ctrl'],
      action: 'search.open',
      description: 'æ‰“å¼€æœç´¢',
      scope: 'global'
    },
    {
      id: 'ai-chat-toggle',
      key: 'a',
      modifiers: ['Ctrl', 'Shift'],
      action: 'ai.toggleChat',
      description: 'åˆ‡æ¢ AI èŠå¤©é¢æ¿',
      scope: 'global'
    },
    {
      id: 'quick-action',
      key: '/',
      modifiers: [],
      action: 'ai.openQuickActions',
      description: 'æ‰“å¼€å¿«æ·æ“ä½œ',
      scope: 'editor'
    },
    
    // AGENT ç‰¹æœ‰å¿«æ·é”®
    {
      id: 'task-panel-toggle',
      key: 't',
      modifiers: ['Ctrl', 'Shift'],
      action: 'agent.toggleTaskPanel',
      description: 'åˆ‡æ¢ä»»åŠ¡é¢æ¿',
      scope: 'global'
    },
    {
      id: 'pause-agent',
      key: 'Escape',
      modifiers: ['Ctrl', 'Shift'],
      action: 'agent.pauseAll',
      description: 'æš‚åœæ‰€æœ‰ Agent ä»»åŠ¡',
      scope: 'global'
    },
    {
      id: 'approve-action',
      key: 'y',
      modifiers: ['Ctrl'],
      action: 'agent.approveCurrent',
      description: 'æ‰¹å‡†å½“å‰æ“ä½œ',
      scope: 'global'
    },
    {
      id: 'reject-action',
      key: 'n',
      modifiers: ['Ctrl'],
      action: 'agent.rejectCurrent',
      description: 'æ‹’ç»å½“å‰æ“ä½œ',
      scope: 'global'
    }
  ],
  
  editorConfig: {
    autoSaveInterval: 5000, // 5 ç§’ï¼ˆæœ€é¢‘ç¹ï¼‰
    livePreview: true,
    syntaxHighlighting: true,
    lineNumbers: true,
    spellCheck: true,
    autoComplete: 'ai', // å®Œå…¨ AI é©±åŠ¨çš„è‡ªåŠ¨å®Œæˆ
    autoFormat: true
  },
  
  aiBehavior: {
    proactivityLevel: 'proactive',
    suggestionFrequency: 'frequent',
    confirmationLevel: 'critical', // å…³é”®æ“ä½œéœ€è¦ç¡®è®¤
    contextWindowSize: 8000,
    maxConcurrentTasks: 5,
    responseDelay: 300
  }
}

/**
 * æ¨¡å¼é…ç½®æ˜ å°„
 */
export const MODE_CONFIGS: Record<EditorMode, ModeConfiguration> = {
  [EditorMode.MANUAL]: MANUAL_MODE_CONFIG,
  [EditorMode.COLLAB]: COLLAB_MODE_CONFIG,
  [EditorMode.AGENT]: AGENT_MODE_CONFIG
}
```

### 2.4 æ¨¡å¼åˆ‡æ¢çŠ¶æ€æœº

```typescript
// agent/fusion/mode-manager/ModeStateMachine.ts

import { EditorMode, TransitionReason } from './types'

/**
 * æ¨¡å¼åˆ‡æ¢çŠ¶æ€æœº
 * 
 * ç®¡ç†æ¨¡å¼åˆ‡æ¢çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ï¼š
 * - çŠ¶æ€å®šä¹‰
 * - è½¬æ¢è§„åˆ™
 * - è¿›å…¥/é€€å‡ºåŠ¨ä½œ
 * - é”™è¯¯å¤„ç†
 */
export class ModeStateMachine {
  /** å½“å‰çŠ¶æ€ */
  private currentState: ModeStateNode = ModeStateNode.IDLE
  
  /** çŠ¶æ€å†å² */
  private stateHistory: StateTransition[] = []
  
  /** çŠ¶æ€å¤„ç†å™¨æ˜ å°„ */
  private stateHandlers: Map<ModeStateNode, StateHandler>
  
  constructor() {
    this.stateHandlers = new Map([
      [ModeStateNode.IDLE, new IdleStateHandler()],
      [ModeStateNode.VALIDATING, new ValidatingStateHandler()],
      [ModeStateNode.PREPARING, new PreparingStateHandler()],
      [ModeStateNode.EXITING_CURRENT, new ExitingStateHandler()],
      [ModeStateNode.TRANSITIONING, new TransitioningStateHandler()],
      [ModeStateNode.ENTERING_NEW, new EnteringStateHandler()],
      [ModeStateNode.FINALIZING, new FinalizingStateHandler()],
      [ModeStateNode.ERROR, new ErrorStateHandler()]
    ])
  }
  
  /**
   * è·å–å½“å‰çŠ¶æ€
   */
  getCurrentState(): ModeStateNode {
    return this.currentState
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œè½¬æ¢
   */
  canTransition(to: EditorMode, context: TransitionContext): boolean {
    // ä»å½“å‰çŠ¶æ€è·å–å¯èƒ½çš„è½¬æ¢
    const possibleTransitions = this.getPossibleTransitions()
    
    return possibleTransitions.some(t => 
      t.targetState === ModeStateNode.ENTERING_NEW &&
      t.condition(context)
    )
  }
  
  /**
   * æ‰§è¡ŒçŠ¶æ€è½¬æ¢
   */
  async transition(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<TransitionResult> {
    const handler = this.stateHandlers.get(this.currentState)
    
    if (!handler) {
      return {
        success: false,
        error: `No handler for state: ${this.currentState}`
      }
    }
    
    try {
      // æ‰§è¡ŒçŠ¶æ€å¤„ç†
      const result = await handler.handle(event, context, callbacks)
      
      // è®°å½•çŠ¶æ€è½¬æ¢
      this.recordTransition(event, result)
      
      // æ›´æ–°çŠ¶æ€
      if (result.nextState) {
        this.currentState = result.nextState
      }
      
      return {
        success: true,
        finalState: this.currentState
      }
      
    } catch (error) {
      // è¿›å…¥é”™è¯¯çŠ¶æ€
      this.currentState = ModeStateNode.ERROR
      
      return {
        success: false,
        error: error.message,
        finalState: ModeStateNode.ERROR
      }
    }
  }
  
  /**
   * è·å–å¯èƒ½çš„è½¬æ¢
   */
  private getPossibleTransitions(): StateTransition[] {
    const transitions: StateTransition[] = []
    
    switch (this.currentState) {
      case ModeStateNode.IDLE:
        transitions.push({
          targetState: ModeStateNode.VALIDATING,
          condition: () => true
        })
        break
        
      case ModeStateNode.VALIDATING:
        transitions.push({
          targetState: ModeStateNode.PREPARING,
          condition: (ctx) => ctx.validationPassed
        })
        transitions.push({
          targetState: ModeStateNode.ERROR,
          condition: (ctx) => !ctx.validationPassed
        })
        break
        
      case ModeStateNode.PREPARING:
        transitions.push({
          targetState: ModeStateNode.EXITING_CURRENT,
          condition: () => true
        })
        break
        
      case ModeStateNode.EXITING_CURRENT:
        transitions.push({
          targetState: ModeStateNode.TRANSITIONING,
          condition: () => true
        })
        break
        
      case ModeStateNode.TRANSITIONING:
        transitions.push({
          targetState: ModeStateNode.ENTERING_NEW,
          condition: () => true
        })
        break
        
      case ModeStateNode.ENTERING_NEW:
        transitions.push({
          targetState: ModeStateNode.FINALIZING,
          condition: () => true
        })
        break
        
      case ModeStateNode.FINALIZING:
        transitions.push({
          targetState: ModeStateNode.IDLE,
          condition: () => true
        })
        break
        
      case ModeStateNode.ERROR:
        transitions.push({
          targetState: ModeStateNode.IDLE,
          condition: () => true
        })
        break
    }
    
    return transitions
  }
  
  /**
   * è®°å½•çŠ¶æ€è½¬æ¢
   */
  private recordTransition(
    event: ModeTransitionEvent,
    result: HandlerResult
  ): void {
    this.stateHistory.push({
      from: this.currentState,
      to: result.nextState || this.currentState,
      event,
      timestamp: Date.now()
    })
  }
  
  /**
   * è·å–çŠ¶æ€å†å²
   */
  getStateHistory(): StateTransition[] {
    return [...this.stateHistory]
  }
  
  /**
   * é‡ç½®çŠ¶æ€æœº
   */
  reset(): void {
    this.currentState = ModeStateNode.IDLE
    this.stateHistory = []
  }
}

/**
 * çŠ¶æ€èŠ‚ç‚¹æšä¸¾
 */
export enum ModeStateNode {
  /** ç©ºé—²çŠ¶æ€ */
  IDLE = 'IDLE',
  
  /** éªŒè¯ä¸­ */
  VALIDATING = 'VALIDATING',
  
  /** å‡†å¤‡ä¸­ */
  PREPARING = 'PREPARING',
  
  /** é€€å‡ºå½“å‰æ¨¡å¼ */
  EXITING_CURRENT = 'EXITING_CURRENT',
  
  /** è½¬æ¢ä¸­ */
  TRANSITIONING = 'TRANSITIONING',
  
  /** è¿›å…¥æ–°æ¨¡å¼ */
  ENTERING_NEW = 'ENTERING_NEW',
  
  /** å®Œæˆä¸­ */
  FINALIZING = 'FINALIZING',
  
  /** é”™è¯¯çŠ¶æ€ */
  ERROR = 'ERROR'
}

/**
 * çŠ¶æ€å¤„ç†å™¨æ¥å£
 */
interface StateHandler {
  handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult>
}

/**
 * ç©ºé—²çŠ¶æ€å¤„ç†å™¨
 */
class IdleStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    // ç©ºé—²çŠ¶æ€åªéœ€è¿›å…¥éªŒè¯
    return {
      nextState: ModeStateNode.VALIDATING
    }
  }
}

/**
 * éªŒè¯çŠ¶æ€å¤„ç†å™¨
 */
class ValidatingStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onValidationStart?.()
    
    try {
      // æ‰§è¡ŒéªŒè¯
      const validationResult = await callbacks.validate?.(event, context)
      
      if (validationResult?.valid) {
        callbacks.onValidationSuccess?.()
        return {
          nextState: ModeStateNode.PREPARING
        }
      } else {
        callbacks.onValidationFailure?.(validationResult?.reason)
        return {
          nextState: ModeStateNode.ERROR,
          error: validationResult?.reason
        }
      }
    } catch (error) {
      return {
        nextState: ModeStateNode.ERROR,
        error: error.message
      }
    }
  }
}

/**
 * å‡†å¤‡çŠ¶æ€å¤„ç†å™¨
 */
class PreparingStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onPreparationStart?.()
    
    try {
      // ä¿å­˜å½“å‰çŠ¶æ€
      await callbacks.saveCurrentState?.()
      
      callbacks.onPreparationComplete?.()
      
      return {
        nextState: ModeStateNode.EXITING_CURRENT
      }
    } catch (error) {
      return {
        nextState: ModeStateNode.ERROR,
        error: error.message
      }
    }
  }
}

/**
 * é€€å‡ºçŠ¶æ€å¤„ç†å™¨
 */
class ExitingStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onExitStart?.(event.from)
    
    try {
      // æ‰§è¡Œé€€å‡ºåŠ¨ä½œ
      await callbacks.onExit?.(event.from)
      
      callbacks.onExitComplete?.(event.from)
      
      return {
        nextState: ModeStateNode.TRANSITIONING
      }
    } catch (error) {
      return {
        nextState: ModeStateNode.ERROR,
        error: error.message
      }
    }
  }
}

/**
 * è½¬æ¢çŠ¶æ€å¤„ç†å™¨
 */
class TransitioningStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onTransitionStart?.(event)
    
    try {
      // æ’­æ”¾åŠ¨ç”»
      await callbacks.playTransitionAnimation?.(event, (progress) => {
        callbacks.onTransitionProgress?.(progress)
      })
      
      callbacks.onTransitionComplete?.(event)
      
      return {
        nextState: ModeStateNode.ENTERING_NEW
      }
    } catch (error) {
      return {
        nextState: ModeStateNode.ERROR,
        error: error.message
      }
    }
  }
}

/**
 * è¿›å…¥çŠ¶æ€å¤„ç†å™¨
 */
class EnteringStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onEnterStart?.(event.to)
    
    try {
      // æ‰§è¡Œè¿›å…¥åŠ¨ä½œ
      await callbacks.onEnter?.(event.to)
      
      // æ›´æ–° UI
      await callbacks.updateUI?.(event.to)
      
      callbacks.onEnterComplete?.(event.to)
      
      return {
        nextState: ModeStateNode.FINALIZING
      }
    } catch (error) {
      return {
        nextState: ModeStateNode.ERROR,
        error: error.message
      }
    }
  }
}

/**
 * å®ŒæˆçŠ¶æ€å¤„ç†å™¨
 */
class FinalizingStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    callbacks.onFinalizationStart?.()
    
    try {
      // ä¿å­˜æœ€ç»ˆçŠ¶æ€
      await callbacks.persistState?.()
      
      // é€šçŸ¥å®Œæˆ
      callbacks.onComplete?.(event)
      
      return {
        nextState: ModeStateNode.IDLE
      }
    } catch (error) {
      // å®Œæˆé˜¶æ®µçš„é”™è¯¯ä¸è¿›å…¥é”™è¯¯çŠ¶æ€ï¼Œåªæ˜¯è®°å½•
      console.error('Finalization error:', error)
      return {
        nextState: ModeStateNode.IDLE
      }
    }
  }
}

/**
 * é”™è¯¯çŠ¶æ€å¤„ç†å™¨
 */
class ErrorStateHandler implements StateHandler {
  async handle(
    event: ModeTransitionEvent,
    context: TransitionContext,
    callbacks: TransitionCallbacks
  ): Promise<HandlerResult> {
    // é”™è¯¯å¤„ç†
    callbacks.onError?.(context.lastError)
    
    // å°è¯•æ¢å¤
    await callbacks.attemptRecovery?.()
    
    return {
      nextState: ModeStateNode.IDLE
    }
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface ModeTransitionEvent {
  from: EditorMode
  to: EditorMode
  timestamp: number
  reason: TransitionReason
  userInitiated: boolean
  metadata?: Record<string, any>
}

interface TransitionContext {
  validationPassed: boolean
  lastError?: string
  [key: string]: any
}

interface TransitionCallbacks {
  onValidationStart?: () => void
  onValidationSuccess?: () => void
  onValidationFailure?: (reason: string) => void
  validate?: (event: ModeTransitionEvent, context: TransitionContext) => Promise<ValidationResult>
  
  onPreparationStart?: () => void
  onPreparationComplete?: () => void
  saveCurrentState?: () => Promise<void>
  
  onExitStart?: (mode: EditorMode) => void
  onExit?: (mode: EditorMode) => Promise<void>
  onExitComplete?: (mode: EditorMode) => void
  
  onTransitionStart?: (event: ModeTransitionEvent) => void
  onTransitionProgress?: (progress: number) => void
  onTransitionComplete?: (event: ModeTransitionEvent) => void
  playTransitionAnimation?: (event: ModeTransitionEvent, onProgress: (p: number) => void) => Promise<void>
  
  onEnterStart?: (mode: EditorMode) => void
  onEnter?: (mode: EditorMode) => Promise<void>
  onEnterComplete?: (mode: EditorMode) => void
  updateUI?: (mode: EditorMode) => Promise<void>
  
  onFinalizationStart?: () => void
  persistState?: () => Promise<void>
  onComplete?: (event: ModeTransitionEvent) => void
  
  onError?: (error: string) => void
  attemptRecovery?: () => Promise<void>
}

interface ValidationResult {
  valid: boolean
  reason?: string
}

interface StateTransition {
  from: ModeStateNode
  to: ModeStateNode
  event: ModeTransitionEvent
  timestamp: number
}

interface TransitionResult {
  success: boolean
  error?: string
  finalState?: ModeStateNode
}

interface HandlerResult {
  nextState?: ModeStateNode
  error?: string
}
```

### 2.5 æƒé™æ§åˆ¶çŸ©é˜µ

```typescript
// agent/fusion/mode-manager/PermissionMatrix.ts

import { EditorMode, PermissionSet, FeatureFlag } from './types'

/**
 * æƒé™æ§åˆ¶çŸ©é˜µ
 * 
 * å®šä¹‰ä¸åŒæ¨¡å¼ä¸‹ä¸åŒè§’è‰²çš„æƒé™
 * æ”¯æŒ RBAC (åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)
 */
export class PermissionMatrix {
  
  /**
   * è§’è‰²å®šä¹‰
   */
  static readonly ROLES = {
    /** è®¿å®¢ - åªè¯»è®¿é—® */
    VISITOR: 'visitor',
    
    /** è¯»è€… - å¯ä»¥é˜…è¯»å’Œä½¿ç”¨æœç´¢ */
    READER: 'reader',
    
    /** ä½œè€… - å¯ä»¥ç¼–è¾‘å†…å®¹ */
    AUTHOR: 'author',
    
    /** ç¼–è¾‘ - å¯ä»¥ç¼–è¾‘å’Œå‘å¸ƒ */
    EDITOR: 'editor',
    
    /** ç®¡ç†å‘˜ - å®Œå…¨æ§åˆ¶ */
    ADMIN: 'admin',
    
    /** AI Agent - ç‰¹æ®Šè§’è‰² */
    AGENT: 'agent'
  } as const
  
  /**
   * æ¨¡å¼-è§’è‰²-æƒé™çŸ©é˜µ
   */
  private static readonly MATRIX: PermissionMatrix = {
    [EditorMode.MANUAL]: {
      [this.ROLES.VISITOR]: {
        canSwitchTo: [],
        canUseFeatures: [],
        permissions: {
          read: [],
          write: [],
          ai: [],
          execute: []
        }
      },
      [this.ROLES.READER]: {
        canSwitchTo: [],
        canUseFeatures: [
          FeatureFlag.LOCAL_SEARCH
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY'],
          write: [],
          ai: [],
          execute: ['EXECUTE_SEARCH']
        }
      },
      [this.ROLES.AUTHOR]: {
        canSwitchTo: [EditorMode.COLLAB],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS'],
          ai: [],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH']
        }
      },
      [this.ROLES.EDITOR]: {
        canSwitchTo: [EditorMode.COLLAB, EditorMode.AGENT],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS'],
          ai: [],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH']
        }
      },
      [this.ROLES.ADMIN]: {
        canSwitchTo: [EditorMode.COLLAB, EditorMode.AGENT],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS'],
          ai: [],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH']
        }
      },
      [this.ROLES.AGENT]: {
        canSwitchTo: [],
        canUseFeatures: [],
        permissions: {
          read: [],
          write: [],
          ai: [],
          execute: []
        }
      }
    },
    
    [EditorMode.COLLAB]: {
      [this.ROLES.VISITOR]: {
        canSwitchTo: [],
        canUseFeatures: [],
        permissions: {
          read: [],
          write: [],
          ai: [],
          execute: []
        }
      },
      [this.ROLES.READER]: {
        canSwitchTo: [EditorMode.MANUAL],
        canUseFeatures: [
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_AI_MEMORY'],
          write: [],
          ai: [],
          execute: ['EXECUTE_SEARCH']
        }
      },
      [this.ROLES.AUTHOR]: {
        canSwitchTo: [EditorMode.MANUAL],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.EDITOR]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.AGENT],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.ADMIN]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.AGENT],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.AGENT]: {
        canSwitchTo: [],
        canUseFeatures: [
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.WEB_SEARCH
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_AI_MEMORY'],
          write: [],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE'],
          execute: ['EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      }
    },
    
    [EditorMode.AGENT]: {
      [this.ROLES.VISITOR]: {
        canSwitchTo: [],
        canUseFeatures: [],
        permissions: {
          read: [],
          write: [],
          ai: [],
          execute: []
        }
      },
      [this.ROLES.READER]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.COLLAB],
        canUseFeatures: [
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.TASK_MANAGEMENT
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_AI_MEMORY', 'READ_TASKS'],
          write: [],
          ai: [],
          execute: ['EXECUTE_SEARCH']
        }
      },
      [this.ROLES.AUTHOR]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.COLLAB],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL,
          FeatureFlag.INTENT_PROCESSING,
          FeatureFlag.TASK_MANAGEMENT,
          FeatureFlag.APPROVAL_WORKFLOW
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY', 'READ_TASKS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.EDITOR]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.COLLAB],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL,
          FeatureFlag.INTENT_PROCESSING,
          FeatureFlag.AUTO_RESEARCH,
          FeatureFlag.TASK_MANAGEMENT,
          FeatureFlag.APPROVAL_WORKFLOW
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY', 'READ_TASKS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_DOCUMENTS_AUTO', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT', 'AI_EXECUTE_SKILL', 'AI_AUTO_EDIT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.ADMIN]: {
        canSwitchTo: [EditorMode.MANUAL, EditorMode.COLLAB],
        canUseFeatures: [
          FeatureFlag.BASIC_EDITING,
          FeatureFlag.WYSIWYG_PREVIEW,
          FeatureFlag.MARKDOWN_SYNTAX,
          FeatureFlag.AUTO_SAVE,
          FeatureFlag.LOCAL_SEARCH,
          FeatureFlag.SEMANTIC_SEARCH,
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.SMART_FORMATTING,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.AI_CHAT,
          FeatureFlag.QUICK_ACTIONS,
          FeatureFlag.CONTEXT_MENU,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.KNOWLEDGE_GRAPH,
          FeatureFlag.MEMORY_SYSTEM,
          FeatureFlag.VERSION_CONTROL,
          FeatureFlag.INTENT_PROCESSING,
          FeatureFlag.AUTO_RESEARCH,
          FeatureFlag.SKILL_EXECUTION,
          FeatureFlag.TASK_MANAGEMENT,
          FeatureFlag.APPROVAL_WORKFLOW
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_SETTINGS', 'READ_AI_MEMORY', 'READ_TASKS'],
          write: ['WRITE_DOCUMENTS_MANUAL', 'WRITE_DOCUMENTS_AUTO', 'WRITE_SETTINGS', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_CHAT', 'AI_EXECUTE_SKILL', 'AI_AUTO_EDIT'],
          execute: ['EXECUTE_GIT_COMMANDS', 'EXECUTE_BUILD', 'EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      },
      [this.ROLES.AGENT]: {
        canSwitchTo: [],
        canUseFeatures: [
          FeatureFlag.AI_COMPLETION,
          FeatureFlag.INLINE_SUGGESTIONS,
          FeatureFlag.CONTENT_ANALYSIS,
          FeatureFlag.WEB_SEARCH,
          FeatureFlag.INTENT_PROCESSING,
          FeatureFlag.AUTO_RESEARCH,
          FeatureFlag.SKILL_EXECUTION,
          FeatureFlag.TASK_MANAGEMENT
        ],
        permissions: {
          read: ['READ_DOCUMENTS', 'READ_HISTORY', 'READ_AI_MEMORY', 'READ_TASKS'],
          write: ['WRITE_DOCUMENTS_AUTO', 'WRITE_AI_MEMORY'],
          ai: ['AI_SUGGEST', 'AI_COMPLETE', 'AI_ANALYZE', 'AI_EXECUTE_SKILL', 'AI_AUTO_EDIT'],
          execute: ['EXECUTE_SEARCH', 'EXECUTE_WEB_REQUESTS']
        }
      }
    }
  }
  
  /**
   * æ£€æŸ¥è§’è‰²åœ¨æ¨¡å¼ä¸‹æ˜¯å¦å¯ä»¥ä½¿ç”¨æŸåŠŸèƒ½
   */
  static canUseFeature(
    mode: EditorMode,
    role: string,
    feature: FeatureFlag
  ): boolean {
    const roleConfig = this.MATRIX[mode]?.[role]
    if (!roleConfig) return false
    
    return roleConfig.canUseFeatures.includes(feature)
  }
  
  /**
   * æ£€æŸ¥è§’è‰²æ˜¯å¦å¯ä»¥ä»å½“å‰æ¨¡å¼åˆ‡æ¢åˆ°ç›®æ ‡æ¨¡å¼
   */
  static canSwitchMode(
    currentMode: EditorMode,
    targetMode: EditorMode,
    role: string
  ): boolean {
    const roleConfig = this.MATRIX[currentMode]?.[role]
    if (!roleConfig) return false
    
    return roleConfig.canSwitchTo.includes(targetMode)
  }
  
  /**
   * è·å–è§’è‰²çš„æƒé™é›†
   */
  static getPermissions(
    mode: EditorMode,
    role: string
  ): PermissionSet {
    const roleConfig = this.MATRIX[mode]?.[role]
    if (!roleConfig) {
      return {
        read: [],
        write: [],
        ai: [],
        execute: []
      }
    }
    
    return roleConfig.permissions
  }
  
  /**
   * æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ç‰¹å®šæƒé™
   */
  static hasPermission(
    mode: EditorMode,
    role: string,
    permission: string
  ): boolean {
    const permissions = this.getPermissions(mode, role)
    
    return Object.values(permissions).some(
      list => list.includes(permission)
    )
  }
  
  /**
   * è·å–è§’è‰²åœ¨æ¨¡å¼ä¸‹å¯ç”¨çš„æ‰€æœ‰åŠŸèƒ½
   */
  static getAvailableFeatures(
    mode: EditorMode,
    role: string
  ): FeatureFlag[] {
    const roleConfig = this.MATRIX[mode]?.[role]
    return roleConfig?.canUseFeatures || []
  }
  
  /**
   * è·å–è§’è‰²åœ¨æ¨¡å¼ä¸‹å¯åˆ‡æ¢çš„ç›®æ ‡æ¨¡å¼
   */
  static getAvailableModeTransitions(
    currentMode: EditorMode,
    role: string
  ): EditorMode[] {
    const roleConfig = this.MATRIX[currentMode]?.[role]
    return roleConfig?.canSwitchTo || []
  }
}

// ============ ç±»å‹å®šä¹‰ ============

type RoleConfig = {
  canSwitchTo: EditorMode[]
  canUseFeatures: FeatureFlag[]
  permissions: PermissionSet
}

type PermissionMatrix = Record<EditorMode, Record<string, RoleConfig>>
```



### 2.6 UI çŠ¶æ€åŒæ­¥

```typescript
// agent/fusion/mode-manager/UIStateSync.ts

import { EventEmitter } from 'events'
import { EditorMode, ModeConfiguration, UIElement } from './types'

/**
 * UI çŠ¶æ€åŒæ­¥å™¨
 * 
 * è´Ÿè´£åœ¨æ¨¡å¼åˆ‡æ¢æ—¶åŒæ­¥ UI çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š
 * - æ˜¾ç¤º/éšè— UI å…ƒç´ 
 * - æ›´æ–°ä¸»é¢˜é¢œè‰²
 * - åŒæ­¥ç¼–è¾‘å™¨é…ç½®
 * - ç®¡ç†è¿‡æ¸¡åŠ¨ç”»
 */
export class UIStateSynchronizer extends EventEmitter {
  private static instance: UIStateSynchronizer
  
  /** å½“å‰ UI çŠ¶æ€ */
  private currentState: UIState = {
    visibleElements: new Set(),
    themeColor: '#3b82f6',
    editorConfig: null,
    isAnimating: false
  }
  
  /** UI å…ƒç´ æ³¨å†Œè¡¨ */
  private elementRegistry: Map<UIElement, UIElementController> = new Map()
  
  /** è¿‡æ¸¡åŠ¨ç”»æ§åˆ¶å™¨ */
  private animationController: TransitionAnimationController
  
  static getInstance(): UIStateSynchronizer {
    if (!UIStateSynchronizer.instance) {
      UIStateSynchronizer.instance = new UIStateSynchronizer()
    }
    return UIStateSynchronizer.instance
  }
  
  private constructor() {
    super()
    this.animationController = new TransitionAnimationController()
    this.registerDefaultElements()
  }
  
  /**
   * æ³¨å†Œé»˜è®¤ UI å…ƒç´ 
   */
  private registerDefaultElements(): void {
    // ç¼–è¾‘å™¨æ ¸å¿ƒå…ƒç´ 
    this.registerElement(UIElement.EDITOR_TOOLBAR, {
      selector: '.editor-toolbar',
      show: (el) => el.classList.remove('hidden'),
      hide: (el) => el.classList.add('hidden'),
      animate: true
    })
    
    this.registerElement(UIElement.EDITOR_SIDEBAR, {
      selector: '.editor-sidebar',
      show: (el) => {
        el.classList.remove('hidden')
        el.classList.add('slide-in-left')
      },
      hide: (el) => {
        el.classList.add('slide-out-left')
        setTimeout(() => el.classList.add('hidden'), 300)
      },
      animate: true
    })
    
    this.registerElement(UIElement.PREVIEW_PANEL, {
      selector: '.preview-panel',
      show: (el) => el.classList.remove('hidden'),
      hide: (el) => el.classList.add('hidden'),
      animate: false
    })
    
    // AI å…ƒç´ 
    this.registerElement(UIElement.AI_CHAT_ORB, {
      selector: '.ai-chat-orb',
      show: (el) => {
        el.classList.remove('hidden')
        el.classList.add('fade-in-scale')
      },
      hide: (el) => {
        el.classList.add('fade-out-scale')
        setTimeout(() => el.classList.add('hidden'), 300)
      },
      animate: true
    })
    
    this.registerElement(UIElement.AI_PANEL, {
      selector: '.ai-panel',
      show: (el) => {
        el.classList.remove('hidden')
        el.classList.add('slide-in-right')
      },
      hide: (el) => {
        el.classList.add('slide-out-right')
        setTimeout(() => el.classList.add('hidden'), 300)
      },
      animate: true
    })
    
    this.registerElement(UIElement.SUGGESTION_WIDGET, {
      selector: '.suggestion-widget',
      show: (el) => {
        el.classList.remove('hidden')
        el.classList.add('pop-in')
      },
      hide: (el) => {
        el.classList.add('pop-out')
        setTimeout(() => el.classList.add('hidden'), 200)
      },
      animate: true
    })
    
    this.registerElement(UIElement.TASK_PANEL, {
      selector: '.task-panel',
      show: (el) => {
        el.classList.remove('hidden')
        el.classList.add('slide-up')
      },
      hide: (el) => {
        el.classList.add('slide-down')
        setTimeout(() => el.classList.add('hidden'), 300)
      },
      animate: true
    })
  }
  
  /**
   * æ³¨å†Œ UI å…ƒç´ 
   */
  registerElement(element: UIElement, controller: UIElementController): void {
    this.elementRegistry.set(element, controller)
  }
  
  /**
   * åŒæ­¥ UI åˆ°æ–°æ¨¡å¼
   */
  async syncToMode(
    mode: EditorMode,
    config: ModeConfiguration,
    options: SyncOptions = {}
  ): Promise<void> {
    const { animate = true, duration = 300 } = options
    
    console.log(`[UIStateSync] Syncing to mode: ${mode}`)
    
    this.emit('syncStart', { mode, config })
    this.currentState.isAnimating = true
    
    try {
      // è®¡ç®— UI å˜åŒ–
      const changes = this.calculateUIChanges(config.visibleUIElements)
      
      // æ›´æ–°ä¸»é¢˜é¢œè‰²
      await this.updateThemeColor(config.themeColor, animate, duration)
      
      // éšè—ä¸å†éœ€è¦çš„å…ƒç´ 
      for (const element of changes.toHide) {
        await this.hideElement(element, animate)
      }
      
      // æ˜¾ç¤ºæ–°å…ƒç´ 
      for (const element of changes.toShow) {
        await this.showElement(element, animate)
      }
      
      // æ›´æ–°ç¼–è¾‘å™¨é…ç½®
      await this.updateEditorConfig(config.editorConfig)
      
      // æ›´æ–°å¿«æ·é”®
      this.updateKeyboardShortcuts(config.keyboardShortcuts)
      
      // æ›´æ–°å½“å‰çŠ¶æ€
      this.currentState.visibleElements = new Set(config.visibleUIElements)
      this.currentState.themeColor = config.themeColor
      this.currentState.editorConfig = config.editorConfig
      
      this.emit('syncComplete', { mode })
      
    } catch (error) {
      console.error('[UIStateSync] Sync failed:', error)
      this.emit('syncError', { mode, error })
      throw error
    } finally {
      this.currentState.isAnimating = false
    }
  }
  
  /**
   * è®¡ç®— UI å˜åŒ–
   */
  private calculateUIChanges(
    targetElements: UIElement[]
  ): UIChanges {
    const current = this.currentState.visibleElements
    const target = new Set(targetElements)
    
    const toShow: UIElement[] = []
    const toHide: UIElement[] = []
    const toKeep: UIElement[] = []
    
    for (const element of target) {
      if (current.has(element)) {
        toKeep.push(element)
      } else {
        toShow.push(element)
      }
    }
    
    for (const element of current) {
      if (!target.has(element)) {
        toHide.push(element)
      }
    }
    
    return { toShow, toHide, toKeep }
  }
  
  /**
   * æ˜¾ç¤ºå…ƒç´ 
   */
  private async showElement(
    element: UIElement,
    animate: boolean
  ): Promise<void> {
    const controller = this.elementRegistry.get(element)
    if (!controller) {
      console.warn(`[UIStateSync] No controller for element: ${element}`)
      return
    }
    
    const el = document.querySelector(controller.selector)
    if (!el) {
      console.warn(`[UIStateSync] Element not found: ${controller.selector}`)
      return
    }
    
    this.emit('elementShow', { element })
    
    if (animate && controller.animate) {
      controller.show(el as HTMLElement)
      await this.waitForAnimation(el as HTMLElement)
    } else {
      el.classList.remove('hidden')
    }
  }
  
  /**
   * éšè—å…ƒç´ 
   */
  private async hideElement(
    element: UIElement,
    animate: boolean
  ): Promise<void> {
    const controller = this.elementRegistry.get(element)
    if (!controller) {
      console.warn(`[UIStateSync] No controller for element: ${element}`)
      return
    }
    
    const el = document.querySelector(controller.selector)
    if (!el) {
      console.warn(`[UIStateSync] Element not found: ${controller.selector}`)
      return
    }
    
    this.emit('elementHide', { element })
    
    if (animate && controller.animate) {
      controller.hide(el as HTMLElement)
      await this.waitForAnimation(el as HTMLElement)
    } else {
      el.classList.add('hidden')
    }
  }
  
  /**
   * æ›´æ–°ä¸»é¢˜é¢œè‰²
   */
  private async updateThemeColor(
    color: string,
    animate: boolean,
    duration: number
  ): Promise<void> {
    const root = document.documentElement
    
    if (animate) {
      // å¹³æ»‘è¿‡æ¸¡é¢œè‰²
      root.style.setProperty('--mode-transition-duration', `${duration}ms`)
      root.classList.add('mode-color-transition')
    }
    
    root.style.setProperty('--mode-theme-color', color)
    root.style.setProperty('--mode-theme-color-light', this.lightenColor(color, 20))
    root.style.setProperty('--mode-theme-color-dark', this.darkenColor(color, 20))
    
    // æ›´æ–° meta theme-color
    const metaThemeColor = document.querySelector('meta[name="theme-color"]')
    if (metaThemeColor) {
      metaThemeColor.setAttribute('content', color)
    }
    
    if (animate) {
      await new Promise(resolve => setTimeout(resolve, duration))
      root.classList.remove('mode-color-transition')
    }
    
    this.emit('themeColorUpdate', { color })
  }
  
  /**
   * æ›´æ–°ç¼–è¾‘å™¨é…ç½®
   */
  private async updateEditorConfig(config: any): Promise<void> {
    // é€šçŸ¥ç¼–è¾‘å™¨æ›´æ–°é…ç½®
    this.emit('editorConfigUpdate', config)
  }
  
  /**
   * æ›´æ–°é”®ç›˜å¿«æ·é”®
   */
  private updateKeyboardShortcuts(shortcuts: any[]): void {
    // æ›´æ–°å¿«æ·é”®æ³¨å†Œ
    this.emit('shortcutsUpdate', shortcuts)
  }
  
  /**
   * ç­‰å¾…åŠ¨ç”»å®Œæˆ
   */
  private waitForAnimation(element: HTMLElement): Promise<void> {
    return new Promise(resolve => {
      const onEnd = () => {
        element.removeEventListener('transitionend', onEnd)
        element.removeEventListener('animationend', onEnd)
        resolve()
      }
      
      element.addEventListener('transitionend', onEnd)
      element.addEventListener('animationend', onEnd)
      
      // è¶…æ—¶ä¿æŠ¤
      setTimeout(resolve, 500)
    })
  }
  
  /**
   * è·å–å½“å‰ UI çŠ¶æ€
   */
  getCurrentState(): UIState {
    return { ...this.currentState }
  }
  
  /**
   * æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§
   */
  isElementVisible(element: UIElement): boolean {
    return this.currentState.visibleElements.has(element)
  }
  
  // ============ è¾…åŠ©æ–¹æ³• ============
  
  private lightenColor(color: string, percent: number): string {
    const num = parseInt(color.replace('#', ''), 16)
    const amt = Math.round(2.55 * percent)
    const R = (num >> 16) + amt
    const G = (num >> 8 & 0x00FF) + amt
    const B = (num & 0x0000FF) + amt
    return '#' + (
      0x1000000 +
      (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
      (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
      (B < 255 ? (B < 1 ? 0 : B) : 255)
    ).toString(16).slice(1)
  }
  
  private darkenColor(color: string, percent: number): string {
    const num = parseInt(color.replace('#', ''), 16)
    const amt = Math.round(2.55 * percent)
    const R = (num >> 16) - amt
    const G = (num >> 8 & 0x00FF) - amt
    const B = (num & 0x0000FF) - amt
    return '#' + (
      0x1000000 +
      (R > 0 ? (R < 255 ? R : 255) : 0) * 0x10000 +
      (G > 0 ? (G < 255 ? G : 255) : 0) * 0x100 +
      (B > 0 ? (B < 255 ? B : 255) : 0)
    ).toString(16).slice(1)
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface UIState {
  visibleElements: Set<UIElement>
  themeColor: string
  editorConfig: any
  isAnimating: boolean
}

interface UIElementController {
  selector: string
  show: (element: HTMLElement) => void
  hide: (element: HTMLElement) => void
  animate: boolean
}

interface UIChanges {
  toShow: UIElement[]
  toHide: UIElement[]
  toKeep: UIElement[]
}

interface SyncOptions {
  animate?: boolean
  duration?: number
}

/**
 * è¿‡æ¸¡åŠ¨ç”»æ§åˆ¶å™¨
 */
class TransitionAnimationController {
  private activeAnimations: Map<string, Animation> = new Map()
  
  async playModeTransition(
    from: EditorMode,
    to: EditorMode,
    container: HTMLElement
  ): Promise<void> {
    const animationName = `mode-transition-${from.toLowerCase()}-${to.toLowerCase()}`
    
    // åˆ›å»ºè¿‡æ¸¡é®ç½©
    const overlay = document.createElement('div')
    overlay.className = 'mode-transition-overlay'
    container.appendChild(overlay)
    
    // æ’­æ”¾åŠ¨ç”»
    const animation = overlay.animate([
      { opacity: 0 },
      { opacity: 1, offset: 0.3 },
      { opacity: 1, offset: 0.7 },
      { opacity: 0 }
    ], {
      duration: 600,
      easing: 'ease-in-out'
    })
    
    this.activeAnimations.set(animationName, animation)
    
    await animation.finished
    
    // æ¸…ç†
    container.removeChild(overlay)
    this.activeAnimations.delete(animationName)
  }
  
  cancelAll(): void {
    for (const [name, animation] of this.activeAnimations) {
      animation.cancel()
    }
    this.activeAnimations.clear()
  }
}
```

### 2.7 æ¨¡å¼åˆ‡æ¢åŠ¨ç”»

```typescript
// agent/fusion/mode-manager/ModeTransitionAnimation.ts

import { EditorMode } from './types'

/**
 * æ¨¡å¼åˆ‡æ¢åŠ¨ç”»ç®¡ç†å™¨
 * 
 * æä¾›ä¸°å¯Œçš„æ¨¡å¼åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
 */
export class ModeTransitionAnimation {
  
  /**
   * æ’­æ”¾æ¨¡å¼åˆ‡æ¢åŠ¨ç”»
   */
  async play(
    from: EditorMode,
    to: EditorMode,
    onProgress?: (progress: number) => void
  ): Promise<void> {
    const animation = this.getAnimationForTransition(from, to)
    await animation.play(onProgress)
  }
  
  /**
   * è·å–å¯¹åº”è½¬æ¢çš„åŠ¨ç”»
   */
  private getAnimationForTransition(
    from: EditorMode,
    to: EditorMode
  ): TransitionAnimation {
    const key = `${from}-${to}`
    
    switch (key) {
      case 'MANUAL-COLLAB':
        return new ManualToCollabAnimation()
      
      case 'COLLAB-MANUAL':
        return new CollabToManualAnimation()
      
      case 'COLLAB-AGENT':
        return new CollabToAgentAnimation()
      
      case 'AGENT-COLLAB':
        return new AgentToCollabAnimation()
      
      case 'MANUAL-AGENT':
        return new ManualToAgentAnimation()
      
      case 'AGENT-MANUAL':
        return new AgentToManualAnimation()
      
      default:
        return new DefaultTransitionAnimation()
    }
  }
}

/**
 * è¿‡æ¸¡åŠ¨ç”»åŸºç±»
 */
abstract class TransitionAnimation {
  abstract play(onProgress?: (progress: number) => void): Promise<void>
  
  protected async fadeOut(element: HTMLElement, duration: number): Promise<void> {
    const animation = element.animate([
      { opacity: 1 },
      { opacity: 0 }
    ], { duration, easing: 'ease-out' })
    
    await animation.finished
    element.style.opacity = '0'
  }
  
  protected async fadeIn(element: HTMLElement, duration: number): Promise<void> {
    const animation = element.animate([
      { opacity: 0 },
      { opacity: 1 }
    ], { duration, easing: 'ease-in' })
    
    await animation.finished
    element.style.opacity = '1'
  }
  
  protected async slideIn(
    element: HTMLElement,
    direction: 'left' | 'right' | 'top' | 'bottom',
    duration: number
  ): Promise<void> {
    const transforms: Record<string, string> = {
      left: 'translateX(-100%)',
      right: 'translateX(100%)',
      top: 'translateY(-100%)',
      bottom: 'translateY(100%)'
    }
    
    const animation = element.animate([
      { transform: transforms[direction], opacity: 0 },
      { transform: 'translate(0)', opacity: 1 }
    ], { duration, easing: 'ease-out' })
    
    await animation.finished
    element.style.transform = ''
    element.style.opacity = '1'
  }
  
  protected async slideOut(
    element: HTMLElement,
    direction: 'left' | 'right' | 'top' | 'bottom',
    duration: number
  ): Promise<void> {
    const transforms: Record<string, string> = {
      left: 'translateX(-100%)',
      right: 'translateX(100%)',
      top: 'translateY(-100%)',
      bottom: 'translateY(100%)'
    }
    
    const animation = element.animate([
      { transform: 'translate(0)', opacity: 1 },
      { transform: transforms[direction], opacity: 0 }
    ], { duration, easing: 'ease-in' })
    
    await animation.finished
    element.style.transform = transforms[direction]
    element.style.opacity = '0'
  }
}

/**
 * MANUAL â†’ COLLAB åŠ¨ç”»
 */
class ManualToCollabAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    const steps = 10
    
    // é˜¶æ®µ 1: AI Chat Orb ä»å³ä¸‹è§’é£å…¥
    onProgress?.(0.1)
    const orb = document.querySelector('.ai-chat-orb') as HTMLElement
    if (orb) {
      await this.slideIn(orb, 'right', 300)
    }
    
    // é˜¶æ®µ 2: ç¼–è¾‘å™¨å·¥å…·æ æ›´æ–°
    onProgress?.(0.3)
    const toolbar = document.querySelector('.editor-toolbar') as HTMLElement
    if (toolbar) {
      toolbar.classList.add('collab-mode')
    }
    
    // é˜¶æ®µ 3: ä¾§è¾¹æ å±•å¼€æ˜¾ç¤º AI é¢æ¿
    onProgress?.(0.6)
    const aiPanel = document.querySelector('.ai-panel') as HTMLElement
    if (aiPanel) {
      aiPanel.classList.remove('hidden')
      await this.slideIn(aiPanel, 'right', 400)
    }
    
    // é˜¶æ®µ 4: ä¸»é¢˜è‰²è¿‡æ¸¡
    onProgress?.(0.9)
    document.documentElement.style.setProperty('--mode-theme-color', '#8b5cf6')
    
    onProgress?.(1)
  }
}

/**
 * COLLAB â†’ MANUAL åŠ¨ç”»
 */
class CollabToManualAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    onProgress?.(0.1)
    
    // é˜¶æ®µ 1: AI é¢æ¿æ”¶èµ·
    const aiPanel = document.querySelector('.ai-panel') as HTMLElement
    if (aiPanel) {
      await this.slideOut(aiPanel, 'right', 300)
      aiPanel.classList.add('hidden')
    }
    
    onProgress?.(0.4)
    
    // é˜¶æ®µ 2: AI Chat Orb é£å‡º
    const orb = document.querySelector('.ai-chat-orb') as HTMLElement
    if (orb) {
      await this.slideOut(orb, 'right', 300)
    }
    
    onProgress?.(0.7)
    
    // é˜¶æ®µ 3: å·¥å…·æ æ¢å¤
    const toolbar = document.querySelector('.editor-toolbar') as HTMLElement
    if (toolbar) {
      toolbar.classList.remove('collab-mode')
    }
    
    // é˜¶æ®µ 4: ä¸»é¢˜è‰²æ¢å¤
    onProgress?.(0.9)
    document.documentElement.style.setProperty('--mode-theme-color', '#3b82f6')
    
    onProgress?.(1)
  }
}

/**
 * COLLAB â†’ AGENT åŠ¨ç”»
 */
class CollabToAgentAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    onProgress?.(0.1)
    
    // é˜¶æ®µ 1: ä»»åŠ¡é¢æ¿ä»åº•éƒ¨å‡èµ·
    const taskPanel = document.querySelector('.task-panel') as HTMLElement
    if (taskPanel) {
      taskPanel.classList.remove('hidden')
      await this.slideIn(taskPanel, 'bottom', 400)
    }
    
    onProgress?.(0.4)
    
    // é˜¶æ®µ 2: AI Chat Orb å˜ä¸ºæ´»åŠ¨çŠ¶æ€
    const orb = document.querySelector('.ai-chat-orb') as HTMLElement
    if (orb) {
      orb.classList.add('agent-active')
    }
    
    onProgress?.(0.7)
    
    // é˜¶æ®µ 3: ç¼–è¾‘å™¨è·å¾— Agent é«˜äº®è¾¹æ¡†
    const editor = document.querySelector('.editor-container') as HTMLElement
    if (editor) {
      editor.classList.add('agent-mode-active')
    }
    
    // é˜¶æ®µ 4: ä¸»é¢˜è‰²å˜ä¸ºç¥ç€è‰²
    onProgress?.(0.9)
    document.documentElement.style.setProperty('--mode-theme-color', '#f59e0b')
    
    onProgress?.(1)
  }
}

/**
 * AGENT â†’ COLLAB åŠ¨ç”»
 */
class AgentToCollabAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    onProgress?.(0.1)
    
    // é˜¶æ®µ 1: ä»»åŠ¡é¢æ¿æ”¶èµ·
    const taskPanel = document.querySelector('.task-panel') as HTMLElement
    if (taskPanel) {
      await this.slideOut(taskPanel, 'bottom', 300)
      taskPanel.classList.add('hidden')
    }
    
    onProgress?.(0.4)
    
    // é˜¶æ®µ 2: AI Chat Orb æ¢å¤æ™®é€šçŠ¶æ€
    const orb = document.querySelector('.ai-chat-orb') as HTMLElement
    if (orb) {
      orb.classList.remove('agent-active')
    }
    
    onProgress?.(0.7)
    
    // é˜¶æ®µ 3: ç¼–è¾‘å™¨æ¢å¤æ­£å¸¸
    const editor = document.querySelector('.editor-container') as HTMLElement
    if (editor) {
      editor.classList.remove('agent-mode-active')
    }
    
    // é˜¶æ®µ 4: ä¸»é¢˜è‰²æ¢å¤ç´«è‰²
    onProgress?.(0.9)
    document.documentElement.style.setProperty('--mode-theme-color', '#8b5cf6')
    
    onProgress?.(1)
  }
}

/**
 * MANUAL â†’ AGENT åŠ¨ç”»
 */
class ManualToAgentAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    // ç›´æ¥æ’­æ”¾ä¸¤æ®µåŠ¨ç”»çš„ç»„åˆ
    const manualToCollab = new ManualToCollabAnimation()
    const collabToAgent = new CollabToAgentAnimation()
    
    await manualToCollab.play(p => onProgress?.(p * 0.5))
    await collabToAgent.play(p => onProgress?.(0.5 + p * 0.5))
  }
}

/**
 * AGENT â†’ MANUAL åŠ¨ç”»
 */
class AgentToManualAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    // ç›´æ¥æ’­æ”¾ä¸¤æ®µåŠ¨ç”»çš„ç»„åˆ
    const agentToCollab = new AgentToCollabAnimation()
    const collabToManual = new CollabToManualAnimation()
    
    await agentToCollab.play(p => onProgress?.(p * 0.5))
    await collabToManual.play(p => onProgress?.(0.5 + p * 0.5))
  }
}

/**
 * é»˜è®¤è¿‡æ¸¡åŠ¨ç”»
 */
class DefaultTransitionAnimation extends TransitionAnimation {
  async play(onProgress?: (progress: number) => void): Promise<void> {
    // ç®€å•çš„æ·¡å…¥æ·¡å‡º
    const container = document.querySelector('.mode-transition-container') as HTMLElement
    if (container) {
      await this.fadeOut(container, 200)
      await this.fadeIn(container, 200)
    }
    onProgress?.(1)
  }
}
```

---

## 3. HistoryUnifier å®Œæ•´å®ç°

HistoryUnifier è´Ÿè´£ç»Ÿä¸€ Git æäº¤å†å²å’Œ AI Agent æ“ä½œå†å²ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ—¶é—´çº¿è§†å›¾ã€‚

### 3.1 æ ¸å¿ƒç±»å‹å®šä¹‰

```typescript
// agent/fusion/history-unifier/types.ts

/**
 * å†å²æ¡ç›®ç±»å‹
 */
export enum HistoryEntryType {
  /** Git æäº¤ - äººç±» */
  GIT_COMMIT_HUMAN = 'GIT_COMMIT_HUMAN',
  
  /** Git æäº¤ - Agent */
  GIT_COMMIT_AGENT = 'GIT_COMMIT_AGENT',
  
  /** Agent æ“ä½œ */
  AGENT_ACTION = 'AGENT_ACTION',
  
  /** Agent ä»»åŠ¡ */
  AGENT_TASK = 'AGENT_TASK',
  
  /** æ–‡ä»¶ä¿å­˜ */
  FILE_SAVE = 'FILE_SAVE',
  
  /** å¤–éƒ¨å¯¼å…¥ */
  EXTERNAL_IMPORT = 'EXTERNAL_IMPORT'
}

/**
 * ç»Ÿä¸€çš„ä½œè€…ä¿¡æ¯
 */
export interface UnifiedAuthor {
  /** ä½œè€… ID */
  id: string
  
  /** æ˜¾ç¤ºåç§° */
  displayName: string
  
  /** ä½œè€…ç±»å‹ */
  type: 'human' | 'agent' | 'system'
  
  /** å¤´åƒ URL */
  avatarUrl?: string
  
  /** é‚®ç®± */
  email?: string
  
  /** Agent ç‰¹æœ‰ä¿¡æ¯ */
  agentInfo?: {
    model: string
    version: string
    capabilities: string[]
  }
}

/**
 * å˜æ›´ç»Ÿè®¡
 */
export interface ChangeStats {
  /** æ·»åŠ è¡Œæ•° */
  linesAdded: number
  
  /** åˆ é™¤è¡Œæ•° */
  linesRemoved: number
  
  /** ä¿®æ”¹æ–‡ä»¶æ•° */
  filesChanged: number
  
  /** å˜æ›´æ–‡ä»¶åˆ—è¡¨ */
  files: ChangedFile[]
}

/**
 * å˜æ›´æ–‡ä»¶
 */
export interface ChangedFile {
  /** æ–‡ä»¶è·¯å¾„ */
  path: string
  
  /** å˜æ›´ç±»å‹ */
  changeType: 'added' | 'modified' | 'deleted' | 'renamed'
  
  /** æ·»åŠ è¡Œæ•° */
  additions: number
  
  /** åˆ é™¤è¡Œæ•° */
  deletions: number
  
  /** é‡å‘½åæ¥æºï¼ˆå¦‚æœæ˜¯é‡å‘½åï¼‰ */
  renamedFrom?: string
}

/**
 * AI å…ƒæ•°æ®
 */
export interface AIMetadata {
  /** ä½¿ç”¨çš„æ¨¡å‹ */
  model: string
  
  /** Token ä½¿ç”¨é‡ */
  tokensUsed: number
  
  /** é¢„ä¼°æˆæœ¬ */
  estimatedCost: number
  
  /** æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
  executionTime: number
  
  /** æ„å›¾ */
  intent?: string
  
  /** ç½®ä¿¡åº¦ */
  confidence?: number
  
  /** ç›¸å…³ä»»åŠ¡ ID */
  taskId?: string
  
  /** æŠ€èƒ½åç§°ï¼ˆå¦‚æœä½¿ç”¨äº†æŠ€èƒ½ï¼‰ */
  skillName?: string
  
  /** è¾“å…¥ä¸Šä¸‹æ–‡ */
  inputContext?: string
  
  /** è¾“å‡ºæ‘˜è¦ */
  outputSummary?: string
}

/**
 * ç»Ÿä¸€å†å²æ¡ç›®
 */
export interface UnifiedHistoryEntry {
  /** å”¯ä¸€ ID */
  id: string
  
  /** æ¡ç›®ç±»å‹ */
  type: HistoryEntryType
  
  /** ä½œè€… */
  author: UnifiedAuthor
  
  /** æ—¶é—´æˆ³ */
  timestamp: number
  
  /** æ ‡é¢˜/æ‘˜è¦ */
  title: string
  
  /** è¯¦ç»†æè¿° */
  description?: string
  
  /** å˜æ›´ç»Ÿè®¡ */
  changes?: ChangeStats
  
  /** AI å…ƒæ•°æ®ï¼ˆAI ç›¸å…³æ¡ç›®ï¼‰ */
  aiMetadata?: AIMetadata
  
  /** åŸå§‹æ•°æ®å¼•ç”¨ */
  originalRef: {
    type: 'git' | 'agent' | 'file'
    id: string
    url?: string
  }
  
  /** æ ‡ç­¾ */
  tags: string[]
  
  /** å…³è”æ¡ç›® ID */
  relatedEntryIds?: string[]
  
  /** é¢å¤–å…ƒæ•°æ® */
  metadata?: Record<string, any>
}

/**
 * å†å²è¿‡æ»¤å™¨
 */
export interface HistoryFilter {
  /** å¼€å§‹æ—¶é—´ */
  startTime?: number
  
  /** ç»“æŸæ—¶é—´ */
  endTime?: number
  
  /** ä½œè€… ID åˆ—è¡¨ */
  authors?: string[]
  
  /** æ¡ç›®ç±»å‹åˆ—è¡¨ */
  types?: HistoryEntryType[]
  
  /** æ–‡ä»¶è·¯å¾„æ¨¡å¼ */
  filePattern?: string
  
  /** æ ‡ç­¾ */
  tags?: string[]
  
  /** æœç´¢å…³é”®è¯ */
  searchQuery?: string
  
  /** æ˜¯å¦åŒ…å« AI æ¡ç›® */
  includeAI?: boolean
  
  /** æ˜¯å¦åŒ…å«äººç±»æ¡ç›® */
  includeHuman?: boolean
}

/**
 * å†å²è§†å›¾é…ç½®
 */
export interface HistoryViewConfig {
  /** åˆ†ç»„æ–¹å¼ */
  groupBy: 'none' | 'date' | 'author' | 'type'
  
  /** æ’åºæ–¹å¼ */
  sortBy: 'time' | 'author' | 'type' | 'impact'
  
  /** æ’åºæ–¹å‘ */
  sortDirection: 'asc' | 'desc'
  
  /** æ¯é¡µæ•°é‡ */
  pageSize: number
  
  /** æ˜¾ç¤ºå˜æ›´è¯¦æƒ… */
  showChangeDetails: boolean
  
  /** æ˜¾ç¤º AI å…ƒæ•°æ® */
  showAIMetadata: boolean
  
  /** æ—¶é—´æ ¼å¼ */
  timeFormat: 'relative' | 'absolute' | 'both'
}

/**
 * å†å²ç»Ÿè®¡
 */
export interface HistoryStats {
  /** æ€»æ¡ç›®æ•° */
  totalEntries: number
  
  /** äººç±»æäº¤æ•° */
  humanCommits: number
  
  /** Agent æäº¤æ•° */
  agentCommits: number
  
  /** Agent æ“ä½œæ•° */
  agentActions: number
  
  /** ä½œè€…åˆ†å¸ƒ */
  authorDistribution: Record<string, number>
  
  /** æ—¶é—´åˆ†å¸ƒ */
  timeDistribution: {
    hourly: number[]
    daily: Record<string, number>
    monthly: Record<string, number>
  }
  
  /** ä»£ç å˜æ›´ç»Ÿè®¡ */
  codeChanges: {
    totalAdditions: number
    totalDeletions: number
    totalFilesChanged: number
  }
  
  /** AI ä½¿ç”¨ç»Ÿè®¡ */
  aiStats?: {
    totalTokensUsed: number
    totalCost: number
    averageConfidence: number
    mostUsedModel: string
  }
}
```

### 3.2 Git æäº¤è§£æå™¨

```typescript
// agent/fusion/history-unifier/GitCommitParser.ts

import { 
  UnifiedHistoryEntry, 
  HistoryEntryType, 
  UnifiedAuthor,
  ChangeStats,
  ChangedFile,
  AIMetadata 
} from './types'

/**
 * Git æäº¤ä¿¡æ¯
 */
interface GitCommit {
  hash: string
  shortHash: string
  author: {
    name: string
    email: string
  }
  date: string
  message: string
  body?: string
  stats: {
    additions: number
    deletions: number
  }
  files: GitFileChange[]
  parents: string[]
}

/**
 * Git æ–‡ä»¶å˜æ›´
 */
interface GitFileChange {
  path: string
  changeType: 'A' | 'M' | 'D' | 'R'
  additions: number
  deletions: number
  renameFrom?: string
}

/**
 * Git æäº¤è§£æå™¨
 */
export class GitCommitParser {
  
  /** Agent æäº¤æ ‡è¯† */
  private readonly AGENT_SIGNATURES = [
    '[agent]',
    '[AI]',
    '[auto]',
    '@agent'
  ]
  
  /** Agent ä½œè€…åç§° */
  private readonly AGENT_AUTHOR_NAMES = [
    'agent',
    'AI Agent',
    'meta-blog-agent'
  ]
  
  /**
   * è§£æ Git æäº¤ä¸ºç»Ÿä¸€å†å²æ¡ç›®
   */
  parse(commit: GitCommit): UnifiedHistoryEntry {
    const isAgentCommit = this.isAgentCommit(commit)
    
    return {
      id: `git-${commit.hash}`,
      type: isAgentCommit 
        ? HistoryEntryType.GIT_COMMIT_AGENT 
        : HistoryEntryType.GIT_COMMIT_HUMAN,
      author: this.parseAuthor(commit, isAgentCommit),
      timestamp: new Date(commit.date).getTime(),
      title: this.parseTitle(commit.message),
      description: commit.body,
      changes: this.parseChanges(commit),
      aiMetadata: isAgentCommit ? this.extractAIMetadata(commit) : undefined,
      originalRef: {
        type: 'git',
        id: commit.hash,
        url: this.generateCommitUrl(commit.hash)
      },
      tags: this.extractTags(commit.message),
      relatedEntryIds: this.findRelatedEntries(commit),
      metadata: {
        shortHash: commit.shortHash,
        parents: commit.parents,
        isMerge: commit.parents.length > 1
      }
    }
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦ä¸º Agent æäº¤
   */
  private isAgentCommit(commit: GitCommit): boolean {
    // æ£€æŸ¥ä½œè€…åç§°
    if (this.AGENT_AUTHOR_NAMES.includes(commit.author.name.toLowerCase())) {
      return true
    }
    
    // æ£€æŸ¥æäº¤æ¶ˆæ¯ä¸­çš„æ ‡è¯†
    for (const sig of this.AGENT_SIGNATURES) {
      if (commit.message.includes(sig)) {
        return true
      }
    }
    
    // æ£€æŸ¥é‚®ä»¶åœ°å€
    if (commit.author.email.includes('agent') || 
        commit.author.email.includes('bot')) {
      return true
    }
    
    return false
  }
  
  /**
   * è§£æä½œè€…ä¿¡æ¯
   */
  private parseAuthor(commit: GitCommit, isAgent: boolean): UnifiedAuthor {
    if (isAgent) {
      return {
        id: 'agent',
        displayName: 'ğŸ¤– AI Agent',
        type: 'agent',
        avatarUrl: '/avatars/agent.png',
        email: commit.author.email,
        agentInfo: {
          model: this.extractModelFromMessage(commit.message) || 'unknown',
          version: this.extractVersionFromMessage(commit.message) || '1.0',
          capabilities: ['writing', 'editing', 'analysis']
        }
      }
    }
    
    return {
      id: this.generateAuthorId(commit.author.email),
      displayName: commit.author.name,
      type: 'human',
      avatarUrl: this.getAvatarUrl(commit.author.email),
      email: commit.author.email
    }
  }
  
  /**
   * è§£ææäº¤æ ‡é¢˜
   */
  private parseTitle(message: string): string {
    // ç§»é™¤ Agent æ ‡è¯†
    let title = message
    
    for (const sig of this.AGENT_SIGNATURES) {
      title = title.replace(sig, '').trim()
    }
    
    // ç§»é™¤å…ƒæ•°æ®è¡Œ
    title = title
      .replace(/\[agent\]\s*/i, '')
      .replace(/model:\S+\s*/g, '')
      .replace(/tokens:\d+\s*/g, '')
      .replace(/cost:[\d.]+\s*/g, '')
      .replace(/intent:\S+\s*/g, '')
      .replace(/task:[\w-]+\s*/g, '')
    
    // å–ç¬¬ä¸€è¡Œ
    const firstLine = title.split('\n')[0].trim()
    
    return firstLine || 'Update content'
  }
  
  /**
   * è§£æå˜æ›´ç»Ÿè®¡
   */
  private parseChanges(commit: GitCommit): ChangeStats {
    return {
      linesAdded: commit.stats.additions,
      linesRemoved: commit.stats.deletions,
      filesChanged: commit.files.length,
      files: commit.files.map(f => ({
        path: f.path,
        changeType: this.mapChangeType(f.changeType),
        additions: f.additions,
        deletions: f.deletions,
        renamedFrom: f.renameFrom
      }))
    }
  }
  
  /**
   * æå– AI å…ƒæ•°æ®
   */
  private extractAIMetadata(commit: GitCommit): AIMetadata {
    const message = commit.message + '\n' + (commit.body || '')
    
    return {
      model: this.extractModelFromMessage(message) || 'unknown',
      tokensUsed: this.extractTokensFromMessage(message) || 0,
      estimatedCost: this.extractCostFromMessage(message) || 0,
      executionTime: this.extractExecutionTimeFromMessage(message) || 0,
      intent: this.extractIntentFromMessage(message),
      confidence: this.extractConfidenceFromMessage(message),
      taskId: this.extractTaskIdFromMessage(message),
      skillName: this.extractSkillFromMessage(message),
      inputContext: this.extractInputContextFromMessage(message),
      outputSummary: this.extractOutputSummaryFromMessage(message)
    }
  }
  
  /**
   * æå–æ ‡ç­¾
   */
  private extractTags(message: string): string[] {
    const tags: string[] = []
    
    // ä»æ¶ˆæ¯ä¸­æå–æ ‡ç­¾
    const tagMatch = message.match(/tags?:\s*([^\n]+)/i)
    if (tagMatch) {
      const extracted = tagMatch[1].split(/[,;]/).map(t => t.trim())
      tags.push(...extracted)
    }
    
    // ä»ä¼ ç»Ÿæ ‡ç­¾æ ¼å¼ä¸­æå–
    const traditionalTags = message.match(/\[([\w-]+)\]/g)
    if (traditionalTags) {
      for (const tag of traditionalTags) {
        const cleanTag = tag.slice(1, -1).toLowerCase()
        if (!['agent', 'ai', 'auto'].includes(cleanTag)) {
          tags.push(cleanTag)
        }
      }
    }
    
    return [...new Set(tags)]
  }
  
  /**
   * æŸ¥æ‰¾å…³è”æ¡ç›®
   */
  private findRelatedEntries(commit: GitCommit): string[] {
    const related: string[] = []
    const message = commit.message + '\n' + (commit.body || '')
    
    // ä»æ¶ˆæ¯ä¸­æå–ä»»åŠ¡ ID
    const taskMatch = message.match(/task:([\w-]+)/i)
    if (taskMatch) {
      related.push(`task-${taskMatch[1]}`)
    }
    
    // ä»çˆ¶æäº¤ä¸­æå–
    for (const parent of commit.parents) {
      related.push(`git-${parent}`)
    }
    
    return related
  }
  
  // ============ è¾…åŠ©æ–¹æ³• ============
  
  private mapChangeType(type: string): 'added' | 'modified' | 'deleted' | 'renamed' {
    const mapping: Record<string, any> = {
      'A': 'added',
      'M': 'modified',
      'D': 'deleted',
      'R': 'renamed'
    }
    return mapping[type] || 'modified'
  }
  
  private extractModelFromMessage(message: string): string | undefined {
    const match = message.match(/model:(\S+)/i)
    return match?.[1]
  }
  
  private extractVersionFromMessage(message: string): string | undefined {
    const match = message.match(/version:(\S+)/i)
    return match?.[1]
  }
  
  private extractTokensFromMessage(message: string): number | undefined {
    const match = message.match(/tokens:(\d+)/i)
    return match ? parseInt(match[1]) : undefined
  }
  
  private extractCostFromMessage(message: string): number | undefined {
    const match = message.match(/cost:([\d.]+)/i)
    return match ? parseFloat(match[1]) : undefined
  }
  
  private extractExecutionTimeFromMessage(message: string): number | undefined {
    const match = message.match(/time:(\d+)/i)
    return match ? parseInt(match[1]) : undefined
  }
  
  private extractIntentFromMessage(message: string): string | undefined {
    const match = message.match(/intent:(\S+)/i)
    return match?.[1]
  }
  
  private extractConfidenceFromMessage(message: string): number | undefined {
    const match = message.match(/confidence:([\d.]+)/i)
    return match ? parseFloat(match[1]) : undefined
  }
  
  private extractTaskIdFromMessage(message: string): string | undefined {
    const match = message.match(/task:([\w-]+)/i)
    return match?.[1]
  }
  
  private extractSkillFromMessage(message: string): string | undefined {
    const match = message.match(/skill:(\S+)/i)
    return match?.[1]
  }
  
  private extractInputContextFromMessage(message: string): string | undefined {
    const match = message.match(/input:(.+?)(?=\n|$)/i)
    return match?.[1].trim()
  }
  
  private extractOutputSummaryFromMessage(message: string): string | undefined {
    const match = message.match(/output:(.+?)(?=\n|$)/i)
    return match?.[1].trim()
  }
  
  private generateAuthorId(email: string): string {
    // ç®€å•çš„å“ˆå¸Œ
    let hash = 0
    for (let i = 0; i < email.length; i++) {
      const char = email.charCodeAt(i)
      hash = ((hash << 5) - hash) + char
      hash = hash & hash
    }
    return `user-${Math.abs(hash).toString(36)}`
  }
  
  private getAvatarUrl(email: string): string {
    // ä½¿ç”¨ Gravatar æˆ–æœ¬åœ°å¤´åƒ
    const hash = this.md5(email.toLowerCase().trim())
    return `https://www.gravatar.com/avatar/${hash}?d=identicon`
  }
  
  private generateCommitUrl(hash: string): string {
    // æ ¹æ®é…ç½®ç”Ÿæˆ URL
    return `/commit/${hash}`
  }
  
  private md5(str: string): string {
    // ç®€åŒ–çš„ MD5 å®ç°
    // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨æˆç†Ÿçš„åº“
    return str
  }
}
```



### 3.3 HistoryUnifier ä¸»ç±»

```typescript
// agent/fusion/history-unifier/HistoryUnifier.ts

import { EventEmitter } from 'events'
import { GitCommitParser } from './GitCommitParser'
import { AgentActionParser } from './AgentActionParser'
import { TimelineRenderer } from './TimelineRenderer'
import { DiffAlgorithm } from './DiffAlgorithm'
import {
  UnifiedHistoryEntry,
  HistoryEntryType,
  HistoryFilter,
  HistoryViewConfig,
  HistoryStats
} from './types'

/**
 * å†å²ç»Ÿä¸€å™¨ - ä¸»ç±»
 * 
 * è´Ÿè´£ï¼š
 * 1. ç»Ÿä¸€ Git å’Œ Agent å†å²æ•°æ®
 * 2. æä¾›æŸ¥è¯¢å’Œè¿‡æ»¤æ¥å£
 * 3. ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
 * 4. æ¸²æŸ“æ—¶é—´çº¿
 */
export class HistoryUnifier extends EventEmitter {
  private static instance: HistoryUnifier
  
  /** ç»Ÿä¸€çš„å†å²æ•°æ® */
  private entries: Map<string, UnifiedHistoryEntry> = new Map()
  
  /** ç´¢å¼• */
  private indexes: HistoryIndexes = {
    byTime: new Map(),
    byAuthor: new Map(),
    byType: new Map(),
    byFile: new Map(),
    byTag: new Map()
  }
  
  /** è§£æå™¨ */
  private gitParser: GitCommitParser
  private agentParser: AgentActionParser
  
  /** æ¸²æŸ“å™¨ */
  private timelineRenderer: TimelineRenderer
  
  /** å·®å¼‚ç®—æ³• */
  private diffAlgorithm: DiffAlgorithm
  
  /** æ˜¯å¦å·²åˆå§‹åŒ– */
  private initialized = false
  
  static getInstance(): HistoryUnifier {
    if (!HistoryUnifier.instance) {
      HistoryUnifier.instance = new HistoryUnifier()
    }
    return HistoryUnifier.instance
  }
  
  private constructor() {
    super()
    this.gitParser = new GitCommitParser()
    this.agentParser = new AgentActionParser()
    this.timelineRenderer = new TimelineRenderer()
    this.diffAlgorithm = new DiffAlgorithm()
  }
  
  /**
   * åˆå§‹åŒ–å†å²ç»Ÿä¸€å™¨
   */
  async initialize(): Promise<void> {
    if (this.initialized) return
    
    console.log('[HistoryUnifier] Initializing...')
    
    try {
      // åŠ è½½ Git å†å²
      await this.loadGitHistory()
      
      // åŠ è½½ Agent å†å²
      await this.loadAgentHistory()
      
      // æ„å»ºç´¢å¼•
      this.buildIndexes()
      
      this.initialized = true
      this.emit('initialized', { entryCount: this.entries.size })
      
      console.log(`[HistoryUnifier] Initialized with ${this.entries.size} entries`)
    } catch (error) {
      console.error('[HistoryUnifier] Initialization failed:', error)
      this.emit('error', error)
      throw error
    }
  }
  
  /**
   * åŠ è½½ Git å†å²
   */
  private async loadGitHistory(): Promise<void> {
    console.log('[HistoryUnifier] Loading Git history...')
    
    try {
      // è°ƒç”¨ Git æœåŠ¡è·å–æäº¤å†å²
      const gitCommits = await GitService.getHistory({
        maxCount: 1000,
        includeStats: true,
        includeFiles: true
      })
      
      for (const commit of gitCommits) {
        const entry = this.gitParser.parse(commit)
        this.entries.set(entry.id, entry)
      }
      
      console.log(`[HistoryUnifier] Loaded ${gitCommits.length} Git commits`)
    } catch (error) {
      console.warn('[HistoryUnifier] Failed to load Git history:', error)
    }
  }
  
  /**
   * åŠ è½½ Agent å†å²
   */
  private async loadAgentHistory(): Promise<void> {
    console.log('[HistoryUnifier] Loading Agent history...')
    
    try {
      // è°ƒç”¨ Agent æœåŠ¡è·å–æ“ä½œå†å²
      const agentActions = await AgentService.getActionHistory({
        maxCount: 500
      })
      
      for (const action of agentActions) {
        const entry = this.agentParser.parse(action)
        this.entries.set(entry.id, entry)
      }
      
      console.log(`[HistoryUnifier] Loaded ${agentActions.length} Agent actions`)
    } catch (error) {
      console.warn('[HistoryUnifier] Failed to load Agent history:', error)
    }
  }
  
  /**
   * æ„å»ºç´¢å¼•
   */
  private buildIndexes(): void {
    console.log('[HistoryUnifier] Building indexes...')
    
    // æ¸…ç©ºç°æœ‰ç´¢å¼•
    this.indexes.byTime.clear()
    this.indexes.byAuthor.clear()
    this.indexes.byType.clear()
    this.indexes.byFile.clear()
    this.indexes.byTag.clear()
    
    for (const entry of this.entries.values()) {
      // æ—¶é—´ç´¢å¼•ï¼ˆæŒ‰å¤©åˆ†ç»„ï¼‰
      const dateKey = new Date(entry.timestamp).toISOString().split('T')[0]
      if (!this.indexes.byTime.has(dateKey)) {
        this.indexes.byTime.set(dateKey, [])
      }
      this.indexes.byTime.get(dateKey)!.push(entry.id)
      
      // ä½œè€…ç´¢å¼•
      if (!this.indexes.byAuthor.has(entry.author.id)) {
        this.indexes.byAuthor.set(entry.author.id, [])
      }
      this.indexes.byAuthor.get(entry.author.id)!.push(entry.id)
      
      // ç±»å‹ç´¢å¼•
      if (!this.indexes.byType.has(entry.type)) {
        this.indexes.byType.set(entry.type, [])
      }
      this.indexes.byType.get(entry.type)!.push(entry.id)
      
      // æ–‡ä»¶ç´¢å¼•
      if (entry.changes?.files) {
        for (const file of entry.changes.files) {
          if (!this.indexes.byFile.has(file.path)) {
            this.indexes.byFile.set(file.path, [])
          }
          this.indexes.byFile.get(file.path)!.push(entry.id)
        }
      }
      
      // æ ‡ç­¾ç´¢å¼•
      for (const tag of entry.tags) {
        if (!this.indexes.byTag.has(tag)) {
          this.indexes.byTag.set(tag, [])
        }
        this.indexes.byTag.get(tag)!.push(entry.id)
      }
    }
    
    console.log('[HistoryUnifier] Indexes built')
  }
  
  /**
   * æŸ¥è¯¢å†å²æ¡ç›®
   */
  query(
    filter: HistoryFilter = {},
    config: HistoryViewConfig = {
      groupBy: 'date',
      sortBy: 'time',
      sortDirection: 'desc',
      pageSize: 50,
      showChangeDetails: true,
      showAIMetadata: true,
      timeFormat: 'relative'
    }
  ): QueryResult {
    let results = Array.from(this.entries.values())
    
    // åº”ç”¨è¿‡æ»¤å™¨
    if (filter.startTime) {
      results = results.filter(e => e.timestamp >= filter.startTime!)
    }
    
    if (filter.endTime) {
      results = results.filter(e => e.timestamp <= filter.endTime!)
    }
    
    if (filter.authors?.length) {
      results = results.filter(e => filter.authors!.includes(e.author.id))
    }
    
    if (filter.types?.length) {
      results = results.filter(e => filter.types!.includes(e.type))
    }
    
    if (filter.filePattern) {
      const pattern = new RegExp(filter.filePattern)
      results = results.filter(e => 
        e.changes?.files.some(f => pattern.test(f.path))
      )
    }
    
    if (filter.tags?.length) {
      results = results.filter(e => 
        filter.tags!.some(tag => e.tags.includes(tag))
      )
    }
    
    if (filter.searchQuery) {
      const query = filter.searchQuery.toLowerCase()
      results = results.filter(e => 
        e.title.toLowerCase().includes(query) ||
        e.description?.toLowerCase().includes(query) ||
        e.author.displayName.toLowerCase().includes(query)
      )
    }
    
    if (filter.includeAI === false) {
      results = results.filter(e => 
        e.type !== HistoryEntryType.GIT_COMMIT_AGENT &&
        e.type !== HistoryEntryType.AGENT_ACTION &&
        e.type !== HistoryEntryType.AGENT_TASK
      )
    }
    
    if (filter.includeHuman === false) {
      results = results.filter(e => 
        e.type === HistoryEntryType.GIT_COMMIT_AGENT ||
        e.type === HistoryEntryType.AGENT_ACTION ||
        e.type === HistoryEntryType.AGENT_TASK
      )
    }
    
    // æ’åº
    results = this.sortResults(results, config.sortBy, config.sortDirection)
    
    // åˆ†ç»„
    const grouped = this.groupResults(results, config.groupBy)
    
    return {
      entries: results,
      grouped,
      totalCount: results.length,
      config
    }
  }
  
  /**
   * è·å–å•ä¸ªæ¡ç›®
   */
  getEntry(id: string): UnifiedHistoryEntry | undefined {
    return this.entries.get(id)
  }
  
  /**
   * è·å–æ¡ç›®è¯¦æƒ…ï¼ˆåŒ…å«å®Œæ•´ diffï¼‰
   */
  async getEntryDetails(id: string): Promise<EntryDetails | undefined> {
    const entry = this.entries.get(id)
    if (!entry) return undefined
    
    let diff: DiffResult | undefined
    
    // å¦‚æœæ˜¯ Git æäº¤ï¼Œè·å–è¯¦ç»† diff
    if (entry.originalRef.type === 'git') {
      diff = await this.getGitDiff(entry.originalRef.id)
    }
    
    return {
      entry,
      diff,
      relatedEntries: this.getRelatedEntries(entry)
    }
  }
  
  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): HistoryStats {
    const entries = Array.from(this.entries.values())
    
    // åŸºç¡€ç»Ÿè®¡
    const humanCommits = entries.filter(e => 
      e.type === HistoryEntryType.GIT_COMMIT_HUMAN
    ).length
    
    const agentCommits = entries.filter(e => 
      e.type === HistoryEntryType.GIT_COMMIT_AGENT
    ).length
    
    const agentActions = entries.filter(e => 
      e.type === HistoryEntryType.AGENT_ACTION ||
      e.type === HistoryEntryType.AGENT_TASK
    ).length
    
    // ä½œè€…åˆ†å¸ƒ
    const authorDistribution: Record<string, number> = {}
    for (const entry of entries) {
      const name = entry.author.displayName
      authorDistribution[name] = (authorDistribution[name] || 0) + 1
    }
    
    // æ—¶é—´åˆ†å¸ƒ
    const hourly = new Array(24).fill(0)
    const daily: Record<string, number> = {}
    const monthly: Record<string, number> = {}
    
    for (const entry of entries) {
      const date = new Date(entry.timestamp)
      hourly[date.getHours()]++
      
      const dayKey = date.toISOString().split('T')[0]
      daily[dayKey] = (daily[dayKey] || 0) + 1
      
      const monthKey = dayKey.substring(0, 7)
      monthly[monthKey] = (monthly[monthKey] || 0) + 1
    }
    
    // ä»£ç å˜æ›´ç»Ÿè®¡
    let totalAdditions = 0
    let totalDeletions = 0
    let totalFilesChanged = 0
    
    for (const entry of entries) {
      if (entry.changes) {
        totalAdditions += entry.changes.linesAdded
        totalDeletions += entry.changes.linesRemoved
        totalFilesChanged += entry.changes.filesChanged
      }
    }
    
    // AI ç»Ÿè®¡
    const aiEntries = entries.filter(e => e.aiMetadata)
    let totalTokensUsed = 0
    let totalCost = 0
    let totalConfidence = 0
    const modelUsage: Record<string, number> = {}
    
    for (const entry of aiEntries) {
      if (entry.aiMetadata) {
        totalTokensUsed += entry.aiMetadata.tokensUsed
        totalCost += entry.aiMetadata.estimatedCost
        totalConfidence += entry.aiMetadata.confidence || 0
        
        const model = entry.aiMetadata.model
        modelUsage[model] = (modelUsage[model] || 0) + 1
      }
    }
    
    const mostUsedModel = Object.entries(modelUsage)
      .sort((a, b) => b[1] - a[1])[0]?.[0] || 'unknown'
    
    return {
      totalEntries: entries.length,
      humanCommits,
      agentCommits,
      agentActions,
      authorDistribution,
      timeDistribution: { hourly, daily, monthly },
      codeChanges: { totalAdditions, totalDeletions, totalFilesChanged },
      aiStats: aiEntries.length > 0 ? {
        totalTokensUsed,
        totalCost,
        averageConfidence: totalConfidence / aiEntries.length,
        mostUsedModel
      } : undefined
    }
  }
  
  /**
   * æ¸²æŸ“æ—¶é—´çº¿
   */
  renderTimeline(
    container: HTMLElement,
    entries: UnifiedHistoryEntry[],
    config: HistoryViewConfig
  ): void {
    this.timelineRenderer.render(container, entries, config)
  }
  
  /**
   * æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚
   */
  async compareVersions(
    fromId: string,
    toId: string
  ): Promise<VersionComparison> {
    const fromEntry = this.entries.get(fromId)
    const toEntry = this.entries.get(toId)
    
    if (!fromEntry || !toEntry) {
      throw new Error('Entry not found')
    }
    
    // è·å–æ–‡ä»¶å†…å®¹
    const fromContent = await this.getContentAtEntry(fromEntry)
    const toContent = await this.getContentAtEntry(toEntry)
    
    // è®¡ç®—å·®å¼‚
    const diff = this.diffAlgorithm.computeDiff(fromContent, toContent)
    
    return {
      from: fromEntry,
      to: toEntry,
      diff,
      summary: {
        filesChanged: diff.files.length,
        linesAdded: diff.totalAdditions,
        linesRemoved: diff.totalDeletions
      }
    }
  }
  
  /**
   * æ·»åŠ æ–°æ¡ç›®
   */
  addEntry(entry: UnifiedHistoryEntry): void {
    this.entries.set(entry.id, entry)
    this.updateIndexes(entry)
    this.emit('entryAdded', entry)
  }
  
  /**
   * åˆ·æ–°å†å²æ•°æ®
   */
  async refresh(): Promise<void> {
    this.entries.clear()
    await this.initialize()
    this.emit('refreshed')
  }
  
  // ============ ç§æœ‰è¾…åŠ©æ–¹æ³• ============
  
  private sortResults(
    entries: UnifiedHistoryEntry[],
    sortBy: string,
    direction: 'asc' | 'desc'
  ): UnifiedHistoryEntry[] {
    const sorted = [...entries]
    
    sorted.sort((a, b) => {
      let comparison = 0
      
      switch (sortBy) {
        case 'time':
          comparison = a.timestamp - b.timestamp
          break
        case 'author':
          comparison = a.author.displayName.localeCompare(b.author.displayName)
          break
        case 'type':
          comparison = a.type.localeCompare(b.type)
          break
        case 'impact':
          const impactA = (a.changes?.linesAdded || 0) + (a.changes?.linesRemoved || 0)
          const impactB = (b.changes?.linesAdded || 0) + (b.changes?.linesRemoved || 0)
          comparison = impactA - impactB
          break
      }
      
      return direction === 'desc' ? -comparison : comparison
    })
    
    return sorted
  }
  
  private groupResults(
    entries: UnifiedHistoryEntry[],
    groupBy: string
  ): GroupedEntries {
    const grouped: GroupedEntries = {}
    
    for (const entry of entries) {
      let key: string
      
      switch (groupBy) {
        case 'date':
          key = new Date(entry.timestamp).toISOString().split('T')[0]
          break
        case 'author':
          key = entry.author.displayName
          break
        case 'type':
          key = entry.type
          break
        default:
          key = 'all'
      }
      
      if (!grouped[key]) {
        grouped[key] = []
      }
      grouped[key].push(entry)
    }
    
    return grouped
  }
  
  private updateIndexes(entry: UnifiedHistoryEntry): void {
    // å¢é‡æ›´æ–°ç´¢å¼•
    const dateKey = new Date(entry.timestamp).toISOString().split('T')[0]
    if (!this.indexes.byTime.has(dateKey)) {
      this.indexes.byTime.set(dateKey, [])
    }
    this.indexes.byTime.get(dateKey)!.push(entry.id)
    
    if (!this.indexes.byAuthor.has(entry.author.id)) {
      this.indexes.byAuthor.set(entry.author.id, [])
    }
    this.indexes.byAuthor.get(entry.author.id)!.push(entry.id)
    
    if (!this.indexes.byType.has(entry.type)) {
      this.indexes.byType.set(entry.type, [])
    }
    this.indexes.byType.get(entry.type)!.push(entry.id)
  }
  
  private getRelatedEntries(entry: UnifiedHistoryEntry): UnifiedHistoryEntry[] {
    if (!entry.relatedEntryIds) return []
    
    return entry.relatedEntryIds
      .map(id => this.entries.get(id))
      .filter((e): e is UnifiedHistoryEntry => e !== undefined)
  }
  
  private async getGitDiff(commitHash: string): Promise<DiffResult> {
    return GitService.getDiff(commitHash)
  }
  
  private async getContentAtEntry(entry: UnifiedHistoryEntry): Promise<FileContent[]> {
    if (entry.originalRef.type === 'git') {
      return GitService.getContentAtCommit(entry.originalRef.id)
    }
    
    return []
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface HistoryIndexes {
  byTime: Map<string, string[]>
  byAuthor: Map<string, string[]>
  byType: Map<string, string[]>
  byFile: Map<string, string[]>
  byTag: Map<string, string[]>
}

interface QueryResult {
  entries: UnifiedHistoryEntry[]
  grouped: GroupedEntries
  totalCount: number
  config: HistoryViewConfig
}

type GroupedEntries = Record<string, UnifiedHistoryEntry[]>

interface EntryDetails {
  entry: UnifiedHistoryEntry
  diff?: DiffResult
  relatedEntries: UnifiedHistoryEntry[]
}

interface DiffResult {
  files: DiffFile[]
  totalAdditions: number
  totalDeletions: number
}

interface DiffFile {
  path: string
  oldPath?: string
  status: 'added' | 'modified' | 'deleted' | 'renamed'
  hunks: DiffHunk[]
}

interface DiffHunk {
  oldStart: number
  oldLines: number
  newStart: number
  newLines: number
  lines: DiffLine[]
}

interface DiffLine {
  type: 'context' | 'addition' | 'deletion'
  oldLineNumber?: number
  newLineNumber?: number
  content: string
}

interface FileContent {
  path: string
  content: string
}

interface VersionComparison {
  from: UnifiedHistoryEntry
  to: UnifiedHistoryEntry
  diff: DiffResult
  summary: {
    filesChanged: number
    linesAdded: number
    linesRemoved: number
  }
}

// æ¨¡æ‹ŸæœåŠ¡
class GitService {
  static async getHistory(options: any) { return [] }
  static async getDiff(hash: string): Promise<DiffResult> { 
    return { files: [], totalAdditions: 0, totalDeletions: 0 } 
  }
  static async getContentAtCommit(hash: string): Promise<FileContent[]> { return [] }
}

class AgentService {
  static async getActionHistory(options: any) { return [] }
}
```

### 3.4 æ—¶é—´çº¿æ¸²æŸ“å™¨

```typescript
// agent/fusion/history-unifier/TimelineRenderer.ts

import { UnifiedHistoryEntry, HistoryViewConfig, HistoryEntryType } from './types'

/**
 * æ—¶é—´çº¿æ¸²æŸ“å™¨
 * 
 * å°†å†å²æ¡ç›®æ¸²æŸ“ä¸ºå¯è§†åŒ–æ—¶é—´çº¿
 */
export class TimelineRenderer {
  
  /**
   * æ¸²æŸ“æ—¶é—´çº¿
   */
  render(
    container: HTMLElement,
    entries: UnifiedHistoryEntry[],
    config: HistoryViewConfig
  ): void {
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = ''
    
    // åˆ›å»ºæ—¶é—´çº¿å®¹å™¨
    const timeline = document.createElement('div')
    timeline.className = 'unified-timeline'
    
    // æ¸²æŸ“æ¡ç›®
    let currentGroup: string | null = null
    
    for (let i = 0; i < entries.length; i++) {
      const entry = entries[i]
      const groupKey = this.getGroupKey(entry, config.groupBy)
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸²æŸ“åˆ†ç»„æ ‡é¢˜
      if (config.groupBy !== 'none' && groupKey !== currentGroup) {
        const groupHeader = this.renderGroupHeader(groupKey, config)
        timeline.appendChild(groupHeader)
        currentGroup = groupKey
      }
      
      // æ¸²æŸ“æ¡ç›®
      const entryElement = this.renderEntry(entry, config, i)
      timeline.appendChild(entryElement)
    }
    
    container.appendChild(timeline)
  }
  
  /**
   * è·å–åˆ†ç»„é”®
   */
  private getGroupKey(entry: UnifiedHistoryEntry, groupBy: string): string {
    switch (groupBy) {
      case 'date':
        return new Date(entry.timestamp).toISOString().split('T')[0]
      case 'author':
        return entry.author.displayName
      case 'type':
        return entry.type
      default:
        return 'all'
    }
  }
  
  /**
   * æ¸²æŸ“åˆ†ç»„æ ‡é¢˜
   */
  private renderGroupHeader(key: string, config: HistoryViewConfig): HTMLElement {
    const header = document.createElement('div')
    header.className = 'timeline-group-header'
    
    // æ ¼å¼åŒ–æ ‡é¢˜
    let title = key
    if (config.groupBy === 'date') {
      title = this.formatDateHeader(key)
    }
    
    header.innerHTML = `
      <div class="group-title">${title}</div>
      <div class="group-line"></div>
    `
    
    return header
  }
  
  /**
   * æ¸²æŸ“å•ä¸ªæ¡ç›®
   */
  private renderEntry(
    entry: UnifiedHistoryEntry,
    config: HistoryViewConfig,
    index: number
  ): HTMLElement {
    const element = document.createElement('div')
    element.className = `timeline-entry ${entry.type.toLowerCase()}`
    element.dataset.entryId = entry.id
    
    // ç¡®å®šæ˜¯å¦ä¸º AI æ¡ç›®
    const isAI = entry.type === HistoryEntryType.GIT_COMMIT_AGENT ||
                 entry.type === HistoryEntryType.AGENT_ACTION ||
                 entry.type === HistoryEntryType.AGENT_TASK
    
    // æ„å»º HTML
    element.innerHTML = `
      <div class="entry-marker ${isAI ? 'ai' : 'human'}">
        ${isAI ? 'ğŸ¤–' : 'ğŸ‘¤'}
      </div>
      
      <div class="entry-content">
        <div class="entry-header">
          <div class="entry-author">
            <img src="${entry.author.avatarUrl || '/default-avatar.png'}" 
                 alt="${entry.author.displayName}" 
                 class="author-avatar">
            <span class="author-name">${entry.author.displayName}</span>
            ${entry.author.type === 'agent' ? '<span class="agent-badge">AI</span>' : ''}
          </div>
          
          <div class="entry-time" title="${new Date(entry.timestamp).toLocaleString()}">
            ${this.formatTime(entry.timestamp, config.timeFormat)}
          </div>
        </div>
        
        <div class="entry-title">
          ${this.escapeHtml(entry.title)}
        </div>
        
        ${entry.description ? `
          <div class="entry-description">
            ${this.escapeHtml(entry.description)}
          </div>
        ` : ''}
        
        ${config.showChangeDetails && entry.changes ? `
          <div class="entry-changes">
            <span class="change-stat additions">+${entry.changes.linesAdded}</span>
            <span class="change-stat deletions">-${entry.changes.linesRemoved}</span>
            <span class="change-stat files">${entry.changes.filesChanged} files</span>
          </div>
        ` : ''}
        
        ${config.showAIMetadata && entry.aiMetadata ? `
          <div class="entry-ai-metadata">
            <span class="ai-model">ğŸ§  ${entry.aiMetadata.model}</span>
            <span class="ai-tokens">ğŸ“Š ${entry.aiMetadata.tokensUsed.toLocaleString()} tokens</span>
            ${entry.aiMetadata.confidence ? `
              <span class="ai-confidence">
                ğŸ¯ ${Math.round(entry.aiMetadata.confidence * 100)}%
              </span>
            ` : ''}
          </div>
        ` : ''}
        
        ${entry.tags.length > 0 ? `
          <div class="entry-tags">
            ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        ` : ''}
      </div>
      
      <div class="entry-actions">
        <button class="action-btn view-details" title="æŸ¥çœ‹è¯¦æƒ…">
          ğŸ”
        </button>
        ${entry.originalRef.type === 'git' ? `
          <button class="action-btn view-diff" title="æŸ¥çœ‹å·®å¼‚">
            ğŸ“‹
          </button>
        ` : ''}
      </div>
    `
    
    // ç»‘å®šäº‹ä»¶
    this.bindEntryEvents(element, entry)
    
    return element
  }
  
  /**
   * ç»‘å®šæ¡ç›®äº‹ä»¶
   */
  private bindEntryEvents(element: HTMLElement, entry: UnifiedHistoryEntry): void {
    // æŸ¥çœ‹è¯¦æƒ…
    const viewBtn = element.querySelector('.view-details')
    viewBtn?.addEventListener('click', () => {
      this.emit('viewDetails', entry)
    })
    
    // æŸ¥çœ‹å·®å¼‚
    const diffBtn = element.querySelector('.view-diff')
    diffBtn?.addEventListener('click', () => {
      this.emit('viewDiff', entry)
    })
    
    // ç‚¹å‡»æ¡ç›®
    element.addEventListener('click', (e) => {
      if (!(e.target as HTMLElement).closest('.entry-actions')) {
        this.emit('selectEntry', entry)
      }
    })
  }
  
  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(
    timestamp: number,
    format: 'relative' | 'absolute' | 'both'
  ): string {
    const date = new Date(timestamp)
    
    switch (format) {
      case 'relative':
        return this.getRelativeTime(timestamp)
      case 'absolute':
        return date.toLocaleString()
      case 'both':
        return `${this.getRelativeTime(timestamp)} (${date.toLocaleString()})`
      default:
        return date.toLocaleString()
    }
  }
  
  /**
   * è·å–ç›¸å¯¹æ—¶é—´
   */
  private getRelativeTime(timestamp: number): string {
    const now = Date.now()
    const diff = now - timestamp
    
    const seconds = Math.floor(diff / 1000)
    const minutes = Math.floor(seconds / 60)
    const hours = Math.floor(minutes / 60)
    const days = Math.floor(hours / 24)
    
    if (days > 30) {
      return new Date(timestamp).toLocaleDateString()
    } else if (days > 0) {
      return `${days} å¤©å‰`
    } else if (hours > 0) {
      return `${hours} å°æ—¶å‰`
    } else if (minutes > 0) {
      return `${minutes} åˆ†é’Ÿå‰`
    } else {
      return 'åˆšåˆš'
    }
  }
  
  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ ‡é¢˜
   */
  private formatDateHeader(dateKey: string): string {
    const date = new Date(dateKey)
    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)
    
    const dateStr = date.toDateString()
    
    if (dateStr === today.toDateString()) {
      return 'ä»Šå¤©'
    } else if (dateStr === yesterday.toDateString()) {
      return 'æ˜¨å¤©'
    } else {
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      })
    }
  }
  
  /**
   * HTML è½¬ä¹‰
   */
  private escapeHtml(text: string): string {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
  }
  
  /**
   * è§¦å‘äº‹ä»¶
   */
  private emit(event: string, data: any): void {
    // å®é™…å®ç°ä¸­ä¼šä½¿ç”¨ EventEmitter
    console.log(`[TimelineRenderer] ${event}`, data)
  }
}
```

### 3.5 å·®å¼‚å¯¹æ¯”ç®—æ³•

```typescript
// agent/fusion/history-unifier/DiffAlgorithm.ts

/**
 * å·®å¼‚å¯¹æ¯”ç®—æ³•
 * 
 * å®ç° Myers å·®å¼‚ç®—æ³•å’Œè¯­ä¹‰åŒ– diff
 */
export class DiffAlgorithm {
  
  /**
   * è®¡ç®—ä¸¤ä¸ªæ–‡æœ¬çš„å·®å¼‚
   * 
   * åŸºäº Myers ç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ O(ND)
   */
  computeDiff(oldText: string, newText: string): DiffResult {
    const oldLines = oldText.split('\n')
    const newLines = newText.split('\n')
    
    // æ‰§è¡Œ Myers ç®—æ³•
    const edits = this.myersAlgorithm(oldLines, newLines)
    
    // è½¬æ¢ä¸º hunk æ ¼å¼
    const hunks = this.convertToHunks(edits, oldLines, newLines)
    
    // è®¡ç®—ç»Ÿè®¡
    let totalAdditions = 0
    let totalDeletions = 0
    
    for (const edit of edits) {
      if (edit.type === 'insert') totalAdditions++
      if (edit.type === 'delete') totalDeletions++
    }
    
    return {
      files: [{
        path: 'content.md',
        status: 'modified',
        hunks
      }],
      totalAdditions,
      totalDeletions
    }
  }
  
  /**
   * Myers å·®å¼‚ç®—æ³•
   */
  private myersAlgorithm(oldLines: string[], newLines: string[]): Edit[] {
    const n = oldLines.length
    const m = newLines.length
    
    // å¤„ç†ç©ºè¾“å…¥
    if (n === 0) {
      return newLines.map((line, i) => ({
        type: 'insert' as const,
        oldIndex: -1,
        newIndex: i,
        line
      }))
    }
    
    if (m === 0) {
      return oldLines.map((line, i) => ({
        type: 'delete' as const,
        oldIndex: i,
        newIndex: -1,
        line
      }))
    }
    
    // æœ€é•¿å…¬å…±å­åºåˆ—ç®—æ³•
    const maxD = n + m
    const v: Record<number, number> = { 1: 0 }
    const trace: Array<Record<number, number>> = []
    
    let found = false
    
    for (let d = 0; d <= maxD && !found; d++) {
      trace.push({ ...v })
      
      for (let k = -d; k <= d; k += 2) {
        let x: number
        
        if (k === -d || (k !== d && v[k - 1] < v[k + 1])) {
          x = v[k + 1]
        } else {
          x = v[k - 1] + 1
        }
        
        let y = x - k
        
        while (x < n && y < m && oldLines[x] === newLines[y]) {
          x++
          y++
        }
        
        v[k] = x
        
        if (x >= n && y >= m) {
          found = true
          break
        }
      }
    }
    
    // å›æº¯æ„å»ºç¼–è¾‘åºåˆ—
    return this.backtrack(trace, oldLines, newLines, n, m)
  }
  
  /**
   * å›æº¯æ„å»ºç¼–è¾‘åºåˆ—
   */
  private backtrack(
    trace: Array<Record<number, number>>,
    oldLines: string[],
    newLines: string[],
    n: number,
    m: number
  ): Edit[] {
    const edits: Edit[] = []
    let x = n
    let y = m
    
    for (let d = trace.length - 1; d >= 0 && (x > 0 || y > 0); d--) {
      const v = trace[d]
      const k = x - y
      
      let prevK: number
      if (k === -d || (k !== d && v[k - 1] < v[k + 1])) {
        prevK = k + 1
      } else {
        prevK = k - 1
      }
      
      const prevX = v[prevK]
      const prevY = prevX - prevK
      
      // æ·»åŠ å¯¹è§’çº¿ç§»åŠ¨ï¼ˆç›¸åŒè¡Œï¼‰
      while (x > prevX && y > prevY) {
        x--
        y--
        edits.unshift({
          type: 'equal',
          oldIndex: x,
          newIndex: y,
          line: oldLines[x]
        })
      }
      
      // æ·»åŠ ç¼–è¾‘æ“ä½œ
      if (d > 0) {
        if (x === prevX) {
          // å‘ä¸‹ç§»åŠ¨ = æ’å…¥
          y--
          edits.unshift({
            type: 'insert',
            oldIndex: -1,
            newIndex: y,
            line: newLines[y]
          })
        } else {
          // å‘å³ç§»åŠ¨ = åˆ é™¤
          x--
          edits.unshift({
            type: 'delete',
            oldIndex: x,
            newIndex: -1,
            line: oldLines[x]
          })
        }
      }
    }
    
    return edits
  }
  
  /**
   * å°†ç¼–è¾‘åºåˆ—è½¬æ¢ä¸º hunk æ ¼å¼
   */
  private convertToHunks(
    edits: Edit[],
    oldLines: string[],
    newLines: string[]
  ): DiffHunk[] {
    const hunks: DiffHunk[] = []
    let currentHunk: DiffHunk | null = null
    
    const contextLines = 3
    let oldLineNum = 0
    let newLineNum = 0
    
    for (let i = 0; i < edits.length; i++) {
      const edit = edits[i]
      
      // å¼€å§‹æ–°çš„ hunk
      if (!currentHunk && edit.type !== 'equal') {
        // è®¡ç®— hunk èµ·å§‹ä½ç½®
        const contextStart = Math.max(0, i - contextLines)
        const oldStart = Math.max(0, edits[contextStart].oldIndex)
        const newStart = Math.max(0, edits[contextStart].newIndex)
        
        currentHunk = {
          oldStart: oldStart + 1,
          oldLines: 0,
          newStart: newStart + 1,
          newLines: 0,
          lines: []
        }
        
        // æ·»åŠ ä¸Šä¸‹æ–‡
        for (let j = contextStart; j < i; j++) {
          const ctxEdit = edits[j]
          currentHunk.lines.push({
            type: 'context',
            oldLineNumber: ctxEdit.oldIndex + 1,
            newLineNumber: ctxEdit.newIndex + 1,
            content: ctxEdit.line
          })
          currentHunk.oldLines++
          currentHunk.newLines++
        }
      }
      
      if (currentHunk) {
        // æ·»åŠ å½“å‰è¡Œ
        currentHunk.lines.push({
          type: edit.type === 'equal' ? 'context' : 
                edit.type === 'insert' ? 'addition' : 'deletion',
          oldLineNumber: edit.oldIndex >= 0 ? edit.oldIndex + 1 : undefined,
          newLineNumber: edit.newIndex >= 0 ? edit.newIndex + 1 : undefined,
          content: edit.line
        })
        
        if (edit.type !== 'insert') currentHunk.oldLines++
        if (edit.type !== 'delete') currentHunk.newLines++
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»“æŸå½“å‰ hunk
        const remaining = edits.length - i - 1
        const nextChange = edits.slice(i + 1).findIndex(e => e.type !== 'equal')
        
        if (nextChange === -1 || nextChange > contextLines * 2) {
          // æ·»åŠ ä¸‹æ–‡
          const contextEnd = Math.min(edits.length, i + contextLines + 1)
          for (let j = i + 1; j < contextEnd; j++) {
            const ctxEdit = edits[j]
            currentHunk.lines.push({
              type: 'context',
              oldLineNumber: ctxEdit.oldIndex + 1,
              newLineNumber: ctxEdit.newIndex + 1,
              content: ctxEdit.line
            })
            currentHunk.oldLines++
            currentHunk.newLines++
          }
          
          hunks.push(currentHunk)
          currentHunk = null
          
          // è·³è¿‡å·²æ·»åŠ çš„ä¸Šä¸‹æ–‡
          i = contextEnd - 1
        }
      }
    }
    
    return hunks
  }
  
  /**
   * è®¡ç®—è¯­ä¹‰åŒ–å·®å¼‚
   * 
   * è¯†åˆ«æ®µè½ã€å¥å­çº§åˆ«çš„å˜æ›´
   */
  computeSemanticDiff(oldText: string, newText: string): SemanticDiffResult {
    const lineDiff = this.computeDiff(oldText, newText)
    
    // åˆ†ææ®µè½å˜æ›´
    const paragraphs = this.analyzeParagraphChanges(
      oldText.split('\n\n'),
      newText.split('\n\n')
    )
    
    // åˆ†æå¥å­å˜æ›´
    const sentences = this.analyzeSentenceChanges(oldText, newText)
    
    return {
      lineDiff,
      paragraphChanges: paragraphs,
      sentenceChanges: sentences,
      summary: this.generateSummary(lineDiff)
    }
  }
  
  /**
   * åˆ†ææ®µè½å˜æ›´
   */
  private analyzeParagraphChanges(
    oldParagraphs: string[],
    newParagraphs: string[]
  ): ParagraphChange[] {
    const changes: ParagraphChange[] = []
    
    // ä½¿ç”¨ç›¸åŒç®—æ³•åœ¨æ®µè½çº§åˆ«
    const paragraphEdits = this.myersAlgorithm(oldParagraphs, newParagraphs)
    
    for (const edit of paragraphEdits) {
      if (edit.type !== 'equal') {
        changes.push({
          type: edit.type,
          position: edit.oldIndex >= 0 ? edit.oldIndex : edit.newIndex,
          content: edit.line,
          similarity: this.calculateSimilarity(
            edit.type === 'delete' ? edit.line : '',
            edit.type === 'insert' ? edit.line : ''
          )
        })
      }
    }
    
    return changes
  }
  
  /**
   * åˆ†æå¥å­å˜æ›´
   */
  private analyzeSentenceChanges(oldText: string, newText: string): SentenceChange[] {
    // ç®€å•çš„å¥å­åˆ†å‰²
    const sentenceRegex = /[^.!?]+[.!?]+/g
    const oldSentences = oldText.match(sentenceRegex) || []
    const newSentences = newText.match(sentenceRegex) || []
    
    const changes: SentenceChange[] = []
    const edits = this.myersAlgorithm(oldSentences, newSentences)
    
    for (const edit of edits) {
      if (edit.type !== 'equal') {
        changes.push({
          type: edit.type,
          text: edit.line.trim(),
          position: edit.oldIndex >= 0 ? edit.oldIndex : edit.newIndex
        })
      }
    }
    
    return changes
  }
  
  /**
   * è®¡ç®—ç›¸ä¼¼åº¦
   */
  private calculateSimilarity(a: string, b: string): number {
    if (!a || !b) return 0
    
    const longer = a.length > b.length ? a : b
    const shorter = a.length > b.length ? b : a
    
    if (longer.length === 0) return 1
    
    const distance = this.levenshteinDistance(longer, shorter)
    return (longer.length - distance) / longer.length
  }
  
  /**
   * Levenshtein è·ç¦»
   */
  private levenshteinDistance(a: string, b: string): number {
    const matrix: number[][] = []
    
    for (let i = 0; i <= b.length; i++) {
      matrix[i] = [i]
    }
    
    for (let j = 0; j <= a.length; j++) {
      matrix[0][j] = j
    }
    
    for (let i = 1; i <= b.length; i++) {
      for (let j = 1; j <= a.length; j++) {
        if (b.charAt(i - 1) === a.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1]
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          )
        }
      }
    }
    
    return matrix[b.length][a.length]
  }
  
  /**
   * ç”Ÿæˆæ‘˜è¦
   */
  private generateSummary(diff: DiffResult): DiffSummary {
    return {
      totalAdditions: diff.totalAdditions,
      totalDeletions: diff.totalDeletions,
      netChange: diff.totalAdditions - diff.totalDeletions,
      changeRatio: diff.totalAdditions + diff.totalDeletions > 0
        ? (diff.totalAdditions - diff.totalDeletions) / 
          (diff.totalAdditions + diff.totalDeletions)
        : 0
    }
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface Edit {
  type: 'equal' | 'insert' | 'delete'
  oldIndex: number
  newIndex: number
  line: string
}

interface DiffResult {
  files: DiffFile[]
  totalAdditions: number
  totalDeletions: number
}

interface DiffFile {
  path: string
  oldPath?: string
  status: 'added' | 'modified' | 'deleted' | 'renamed'
  hunks: DiffHunk[]
}

interface DiffHunk {
  oldStart: number
  oldLines: number
  newStart: number
  newLines: number
  lines: DiffLine[]
}

interface DiffLine {
  type: 'context' | 'addition' | 'deletion'
  oldLineNumber?: number
  newLineNumber?: number
  content: string
}

interface SemanticDiffResult {
  lineDiff: DiffResult
  paragraphChanges: ParagraphChange[]
  sentenceChanges: SentenceChange[]
  summary: DiffSummary
}

interface ParagraphChange {
  type: string
  position: number
  content: string
  similarity: number
}

interface SentenceChange {
  type: string
  text: string
  position: number
}

interface DiffSummary {
  totalAdditions: number
  totalDeletions: number
  netChange: number
  changeRatio: number
}
```

---

## 4. UnifiedSearch å®Œæ•´å®ç°

UnifiedSearch æä¾›ç»Ÿä¸€çš„æœç´¢æ¥å£ï¼Œæ”¯æŒæœ¬åœ°æœç´¢ã€Web æœç´¢å’Œæ··åˆæœç´¢ã€‚

### 4.1 æ ¸å¿ƒç±»å‹å®šä¹‰

```typescript
// agent/fusion/unified-search/types.ts

/**
 * æœç´¢æ¥æºç±»å‹
 */
export enum SearchSource {
  /** æœ¬åœ°å‘é‡ç´¢å¼• */
  LOCAL_VECTOR = 'LOCAL_VECTOR',
  
  /** æœ¬åœ°å…³é”®è¯ç´¢å¼• */
  LOCAL_KEYWORD = 'LOCAL_KEYWORD',
  
  /** Web æœç´¢ç»“æœ */
  WEB = 'WEB',
  
  /** çŸ¥è¯†å›¾è°± */
  KNOWLEDGE_GRAPH = 'KNOWLEDGE_GRAPH',
  
  /** Agent è®°å¿† */
  AGENT_MEMORY = 'AGENT_MEMORY'
}

/**
 * æœç´¢ç»“æœé¡¹
 */
export interface SearchResultItem {
  /** å”¯ä¸€ ID */
  id: string
  
  /** æ ‡é¢˜ */
  title: string
  
  /** æ‘˜è¦/å†…å®¹ */
  snippet: string
  
  /** æ¥æºç±»å‹ */
  source: SearchSource
  
  /** URLï¼ˆå¦‚æœé€‚ç”¨ï¼‰ */
  url?: string
  
  /** æ–‡ä»¶è·¯å¾„ï¼ˆæœ¬åœ°ç»“æœï¼‰ */
  filePath?: string
  
  /** ç›¸å…³æ€§åˆ†æ•° */
  relevanceScore: number
  
  /** åŸå§‹åˆ†æ•°ï¼ˆèåˆå‰ï¼‰ */
  rawScore?: number
  
  /** ç»“æœç±»å‹ */
  resultType: 'document' | 'paragraph' | 'sentence' | 'web_page' | 'entity' | 'memory'
  
  /** å…ƒæ•°æ® */
  metadata: SearchResultMetadata
  
  /** é«˜äº®ç‰‡æ®µ */
  highlights?: HighlightSegment[]
  
  /** æ¥æºæ’å */
  sourceRank: number
}

/**
 * æœç´¢ç»“æœå…ƒæ•°æ®
 */
export interface SearchResultMetadata {
  /** ä½œè€… */
  author?: string
  
  /** åˆ›å»ºæ—¶é—´ */
  createdAt?: number
  
  /** æ›´æ–°æ—¶é—´ */
  updatedAt?: number
  
  /** æ ‡ç­¾ */
  tags?: string[]
  
  /** åˆ†ç±» */
  category?: string
  
  /** é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ */
  readingTime?: number
  
  /** å­—æ•° */
  wordCount?: number
  
  /** ç›¸å…³å®ä½“ */
  relatedEntities?: string[]
  
  /** Web ç‰¹æœ‰ */
  web?: {
    domain: string
    publishedAt?: string
    author?: string
    credibilityScore: number
  }
  
  /** å‘é‡æœç´¢ç‰¹æœ‰ */
  vector?: {
    distance: number
    embeddingModel: string
  }
}

/**
 * é«˜äº®ç‰‡æ®µ
 */
export interface HighlightSegment {
  /** æ–‡æœ¬å†…å®¹ */
  text: string
  
  /** æ˜¯å¦åŒ¹é… */
  isMatch: boolean
  
  /** åŒ¹é…åˆ†æ•° */
  matchScore?: number
}

/**
 * æœç´¢é€‰é¡¹
 */
export interface SearchOptions {
  /** æŸ¥è¯¢å­—ç¬¦ä¸² */
  query: string
  
  /** æœç´¢æ¨¡å¼ */
  mode: 'local' | 'web' | 'hybrid' | 'auto'
  
  /** è¿”å›ç»“æœæ•°é‡ */
  limit?: number
  
  /** æ¯ç±»æ¥æºçš„ç»“æœæ•° */
  limitPerSource?: number
  
  /** è¿‡æ»¤æ¡ä»¶ */
  filters?: SearchFilters
  
  /** æ’åºæ–¹å¼ */
  sortBy?: 'relevance' | 'date' | 'popularity'
  
  /** æ˜¯å¦å¯ç”¨é«˜äº® */
  highlight?: boolean
  
  /** é«˜äº®æ ‡ç­¾ */
  highlightTags?: [string, string]
  
  /** æ˜¯å¦æ¨¡ç³ŠåŒ¹é… */
  fuzzy?: boolean
  
  /** æ¨¡ç³ŠåŒ¹é…é˜ˆå€¼ */
  fuzzyThreshold?: number
  
  /** æœç´¢è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ */
  timeout?: number
  
  /** æ˜¯å¦åŒ…å« AI æ€»ç»“ */
  includeSummary?: boolean
}

/**
 * æœç´¢è¿‡æ»¤æ¡ä»¶
 */
export interface SearchFilters {
  /** æ¥æºç±»å‹åˆ—è¡¨ */
  sources?: SearchSource[]
  
  /** æ–‡ä»¶ç±»å‹ */
  fileTypes?: string[]
  
  /** ä½œè€… */
  authors?: string[]
  
  /** æ ‡ç­¾ */
  tags?: string[]
  
  /** åˆ†ç±» */
  categories?: string[]
  
  /** æ—¶é—´èŒƒå›´ */
  dateRange?: {
    start?: number
    end?: number
  }
  
  /** è·¯å¾„æ¨¡å¼ */
  pathPattern?: string
  
  /** æ’é™¤è·¯å¾„ */
  excludePaths?: string[]
}

/**
 * æœç´¢ç»“æœ
 */
export interface SearchResults {
  /** ç»“æœåˆ—è¡¨ */
  items: SearchResultItem[]
  
  /** æ€»ç»“æœæ•° */
  totalCount: number
  
  /** æŸ¥è¯¢ä¿¡æ¯ */
  query: {
    original: string
    processed: string
    expanded?: string[]
  }
  
  /** æ€§èƒ½æŒ‡æ ‡ */
  performance: {
    totalTime: number
    localSearchTime?: number
    webSearchTime?: number
    fusionTime?: number
  }
  
  /** æ¥æºåˆ†å¸ƒ */
  sourceDistribution: Record<SearchSource, number>
  
  /** å»ºè®®æŸ¥è¯¢ */
  suggestions?: string[]
  
  /** AI æ€»ç»“ï¼ˆå¦‚æœå¯ç”¨ï¼‰ */
  aiSummary?: string
  
  /** ç›¸å…³é—®é¢˜ */
  relatedQuestions?: string[]
}

/**
 * æœç´¢ç¼“å­˜é¡¹
 */
export interface SearchCacheItem {
  /** ç¼“å­˜é”® */
  key: string
  
  /** ç¼“å­˜ç»“æœ */
  results: SearchResults
  
  /** ç¼“å­˜æ—¶é—´ */
  cachedAt: number
  
  /** è¿‡æœŸæ—¶é—´ */
  expiresAt: number
  
  /** å‘½ä¸­æ¬¡æ•° */
  hitCount: number
}

/**
 * æœç´¢ç»Ÿè®¡
 */
export interface SearchStats {
  /** æ€»æœç´¢æ¬¡æ•° */
  totalSearches: number
  
  /** å¹³å‡å“åº”æ—¶é—´ */
  averageResponseTime: number
  
  /** ç¼“å­˜å‘½ä¸­ç‡ */
  cacheHitRate: number
  
  /** çƒ­é—¨æŸ¥è¯¢ */
  topQueries: Array<{ query: string; count: number }>
  
  /** æ¥æºä½¿ç”¨æƒ…å†µ */
  sourceUsage: Record<SearchSource, number>
  
  /** é›¶ç»“æœæŸ¥è¯¢ */
  zeroResultQueries: string[]
}
```



### 4.2 UnifiedSearch ä¸»ç±»å®ç°

```typescript
// agent/fusion/unified-search/UnifiedSearch.ts

import { EventEmitter } from 'events'
import { VectorSearchEngine } from './VectorSearchEngine'
import { KeywordSearchEngine } from './KeywordSearchEngine'
import { WebSearchEngine } from './WebSearchEngine'
import { SearchResultFusion } from './SearchResultFusion'
import { SearchCache } from './SearchCache'
import {
  SearchOptions,
  SearchResults,
  SearchResultItem,
  SearchSource,
  SearchCacheItem,
  SearchStats
} from './types'

/**
 * ç»Ÿä¸€æœç´¢ç®¡ç†å™¨
 * 
 * æ•´åˆå¤šç§æœç´¢æºï¼Œæä¾›ç»Ÿä¸€çš„æœç´¢æ¥å£
 */
export class UnifiedSearch extends EventEmitter {
  private static instance: UnifiedSearch
  
  /** æœç´¢å¼•æ“ */
  private vectorEngine: VectorSearchEngine
  private keywordEngine: KeywordSearchEngine
  private webEngine: WebSearchEngine
  
  /** ç»“æœèåˆå™¨ */
  private resultFusion: SearchResultFusion
  
  /** ç¼“å­˜ */
  private cache: SearchCache
  
  /** é…ç½® */
  private config: SearchConfig = {
    defaultLimit: 10,
    cacheEnabled: true,
    cacheTTL: 300000, // 5 åˆ†é’Ÿ
    webSearchEnabled: true,
    webSearchTimeout: 10000,
    fusionWeights: {
      [SearchSource.LOCAL_VECTOR]: 1.0,
      [SearchSource.LOCAL_KEYWORD]: 0.8,
      [SearchSource.WEB]: 0.6,
      [SearchSource.KNOWLEDGE_GRAPH]: 0.9,
      [SearchSource.AGENT_MEMORY]: 0.7
    }
  }
  
  /** ç»Ÿè®¡ */
  private stats: SearchStatsInternal = {
    totalSearches: 0,
    totalResponseTime: 0,
    cacheHits: 0,
    cacheMisses: 0,
    queryCounts: new Map(),
    sourceUsage: {
      [SearchSource.LOCAL_VECTOR]: 0,
      [SearchSource.LOCAL_KEYWORD]: 0,
      [SearchSource.WEB]: 0,
      [SearchSource.KNOWLEDGE_GRAPH]: 0,
      [SearchSource.AGENT_MEMORY]: 0
    },
    zeroResultQueries: new Set()
  }
  
  static getInstance(): UnifiedSearch {
    if (!UnifiedSearch.instance) {
      UnifiedSearch.instance = new UnifiedSearch()
    }
    return UnifiedSearch.instance
  }
  
  private constructor() {
    super()
    
    this.vectorEngine = new VectorSearchEngine()
    this.keywordEngine = new KeywordSearchEngine()
    this.webEngine = new WebSearchEngine()
    this.resultFusion = new SearchResultFusion(this.config.fusionWeights)
    this.cache = new SearchCache(this.config.cacheTTL)
  }
  
  /**
   * æ‰§è¡Œæœç´¢
   */
  async search(options: SearchOptions): Promise<SearchResults> {
    const startTime = Date.now()
    this.stats.totalSearches++
    
    const {
      query,
      mode = 'hybrid',
      limit = this.config.defaultLimit,
      limitPerSource = Math.ceil(limit / 2),
      filters = {},
      sortBy = 'relevance',
      highlight = true,
      fuzzy = true,
      includeSummary = false
    } = options
    
    console.log(`[UnifiedSearch] Searching: "${query}" (mode: ${mode})`)
    
    // æ£€æŸ¥ç¼“å­˜
    if (this.config.cacheEnabled) {
      const cacheKey = this.generateCacheKey(options)
      const cached = this.cache.get(cacheKey)
      
      if (cached && cached.expiresAt > Date.now()) {
        console.log('[UnifiedSearch] Cache hit')
        this.stats.cacheHits++
        cached.hitCount++
        
        return {
          ...cached.results,
          performance: {
            ...cached.results.performance,
            totalTime: Date.now() - startTime
          }
        }
      }
      
      this.stats.cacheMisses++
    }
    
    try {
      // é¢„å¤„ç†æŸ¥è¯¢
      const processedQuery = this.preprocessQuery(query)
      
      // æ ¹æ®æ¨¡å¼é€‰æ‹©æœç´¢ç­–ç•¥
      let results: SearchResults
      
      switch (mode) {
        case 'local':
          results = await this.searchLocal(processedQuery, options)
          break
        
        case 'web':
          results = await this.searchWeb(processedQuery, options)
          break
        
        case 'hybrid':
        default:
          results = await this.searchHybrid(processedQuery, options)
          break
      }
      
      // ç”Ÿæˆ AI æ€»ç»“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (includeSummary && results.items.length > 0) {
        results.aiSummary = await this.generateSummary(query, results.items)
        results.relatedQuestions = await this.generateRelatedQuestions(query, results.items)
      }
      
      // è®°å½•ç»Ÿè®¡
      const totalTime = Date.now() - startTime
      this.stats.totalResponseTime += totalTime
      this.recordQuery(query, results.totalCount === 0)
      
      results.performance.totalTime = totalTime
      
      // ç¼“å­˜ç»“æœ
      if (this.config.cacheEnabled) {
        this.cache.set(this.generateCacheKey(options), results)
      }
      
      this.emit('searchComplete', { query, resultCount: results.items.length })
      
      return results
      
    } catch (error) {
      console.error('[UnifiedSearch] Search failed:', error)
      this.emit('searchError', { query, error })
      
      // è¿”å›é”™è¯¯ç»“æœ
      return {
        items: [],
        totalCount: 0,
        query: {
          original: query,
          processed: query
        },
        performance: {
          totalTime: Date.now() - startTime
        },
        sourceDistribution: {
          [SearchSource.LOCAL_VECTOR]: 0,
          [SearchSource.LOCAL_KEYWORD]: 0,
          [SearchSource.WEB]: 0,
          [SearchSource.KNOWLEDGE_GRAPH]: 0,
          [SearchSource.AGENT_MEMORY]: 0
        },
        suggestions: this.getSuggestions(query)
      }
    }
  }
  
  /**
   * æœ¬åœ°æœç´¢
   */
  private async searchLocal(
    query: string,
    options: SearchOptions
  ): Promise<SearchResults> {
    const localStart = Date.now()
    
    // å¹¶è¡Œæ‰§è¡Œå‘é‡å’Œå…³é”®è¯æœç´¢
    const [vectorResults, keywordResults] = await Promise.all([
      this.vectorEngine.search(query, {
        limit: options.limitPerSource || 10,
        filters: options.filters
      }),
      this.keywordEngine.search(query, {
        limit: options.limitPerSource || 10,
        fuzzy: options.fuzzy,
        highlight: options.highlight
      })
    ])
    
    const localTime = Date.now() - localStart
    
    // è®°å½•æ¥æºä½¿ç”¨
    this.stats.sourceUsage[SearchSource.LOCAL_VECTOR] += vectorResults.length
    this.stats.sourceUsage[SearchSource.LOCAL_KEYWORD] += keywordResults.length
    
    // èåˆç»“æœ
    const fusionStart = Date.now()
    const fusedResults = this.resultFusion.fuse([
      { source: SearchSource.LOCAL_VECTOR, results: vectorResults },
      { source: SearchSource.LOCAL_KEYWORD, results: keywordResults }
    ], options.limit || 10)
    
    const fusionTime = Date.now() - fusionStart
    
    return {
      items: fusedResults,
      totalCount: vectorResults.length + keywordResults.length,
      query: {
        original: options.query,
        processed: query,
        expanded: this.expandQuery(query)
      },
      performance: {
        totalTime: localTime + fusionTime,
        localSearchTime: localTime,
        fusionTime: fusionTime
      },
      sourceDistribution: {
        [SearchSource.LOCAL_VECTOR]: vectorResults.length,
        [SearchSource.LOCAL_KEYWORD]: keywordResults.length,
        [SearchSource.WEB]: 0,
        [SearchSource.KNOWLEDGE_GRAPH]: 0,
        [SearchSource.AGENT_MEMORY]: 0
      },
      suggestions: this.getSuggestions(query)
    }
  }
  
  /**
   * Web æœç´¢
   */
  private async searchWeb(
    query: string,
    options: SearchOptions
  ): Promise<SearchResults> {
    if (!this.config.webSearchEnabled) {
      return {
        items: [],
        totalCount: 0,
        query: { original: options.query, processed: query },
        performance: { totalTime: 0 },
        sourceDistribution: {
          [SearchSource.LOCAL_VECTOR]: 0,
          [SearchSource.LOCAL_KEYWORD]: 0,
          [SearchSource.WEB]: 0,
          [SearchSource.KNOWLEDGE_GRAPH]: 0,
          [SearchSource.AGENT_MEMORY]: 0
        }
      }
    }
    
    const webStart = Date.now()
    
    const webResults = await this.webEngine.search(query, {
      limit: options.limit || 10,
      timeout: this.config.webSearchTimeout
    })
    
    const webTime = Date.now() - webStart
    
    this.stats.sourceUsage[SearchSource.WEB] += webResults.length
    
    return {
      items: webResults,
      totalCount: webResults.length,
      query: {
        original: options.query,
        processed: query
      },
      performance: {
        totalTime: webTime,
        webSearchTime: webTime
      },
      sourceDistribution: {
        [SearchSource.LOCAL_VECTOR]: 0,
        [SearchSource.LOCAL_KEYWORD]: 0,
        [SearchSource.WEB]: webResults.length,
        [SearchSource.KNOWLEDGE_GRAPH]: 0,
        [SearchSource.AGENT_MEMORY]: 0
      }
    }
  }
  
  /**
   * æ··åˆæœç´¢
   */
  private async searchHybrid(
    query: string,
    options: SearchOptions
  ): Promise<SearchResults> {
    const hybridStart = Date.now()
    
    // åŒæ—¶æ‰§è¡Œæœ¬åœ°å’Œ Web æœç´¢
    const [localResults, webResults] = await Promise.all([
      this.searchLocal(query, options),
      this.config.webSearchEnabled ? this.searchWeb(query, options) : null
    ])
    
    // èåˆæ‰€æœ‰ç»“æœ
    const fusionStart = Date.now()
    const allResults: SearchResultItem[] = [
      ...localResults.items,
      ...(webResults?.items || [])
    ]
    
    // é‡æ–°æ’åº
    const fusedResults = this.resultFusion.rerank(allResults, options.limit || 10)
    
    const fusionTime = Date.now() - fusionStart
    const totalTime = Date.now() - hybridStart
    
    return {
      items: fusedResults,
      totalCount: localResults.totalCount + (webResults?.totalCount || 0),
      query: {
        original: options.query,
        processed: query,
        expanded: this.expandQuery(query)
      },
      performance: {
        totalTime,
        localSearchTime: localResults.performance.localSearchTime,
        webSearchTime: webResults?.performance.webSearchTime,
        fusionTime: fusionTime + (localResults.performance.fusionTime || 0)
      },
      sourceDistribution: {
        [SearchSource.LOCAL_VECTOR]: localResults.sourceDistribution[SearchSource.LOCAL_VECTOR],
        [SearchSource.LOCAL_KEYWORD]: localResults.sourceDistribution[SearchSource.LOCAL_KEYWORD],
        [SearchSource.WEB]: webResults?.sourceDistribution[SearchSource.WEB] || 0,
        [SearchSource.KNOWLEDGE_GRAPH]: 0,
        [SearchSource.AGENT_MEMORY]: 0
      },
      suggestions: this.getSuggestions(query)
    }
  }
  
  /**
   * é¢„å¤„ç†æŸ¥è¯¢
   */
  private preprocessQuery(query: string): string {
    return query
      .trim()
      .replace(/\s+/g, ' ')
      .toLowerCase()
  }
  
  /**
   * æ‰©å±•æŸ¥è¯¢
   */
  private expandQuery(query: string): string[] {
    const expansions: string[] = []
    
    // æ·»åŠ åŒä¹‰è¯
    const synonymMap: Record<string, string[]> = {
      'create': ['make', 'build', 'generate'],
      'delete': ['remove', 'erase', 'clear'],
      'update': ['modify', 'edit', 'change'],
      'search': ['find', 'lookup', 'query']
    }
    
    for (const [word, synonyms] of Object.entries(synonymMap)) {
      if (query.includes(word)) {
        for (const syn of synonyms) {
          expansions.push(query.replace(word, syn))
        }
      }
    }
    
    return expansions
  }
  
  /**
   * ç”Ÿæˆ AI æ€»ç»“
   */
  private async generateSummary(
    query: string,
    results: SearchResultItem[]
  ): Promise<string> {
    // ç®€åŒ–çš„æ€»ç»“ç”Ÿæˆ
    const topResults = results.slice(0, 3)
    const sources = [...new Set(topResults.map(r => r.source))]
    
    return `æ‰¾åˆ° ${results.length} ä¸ªå…³äº"${query}"çš„ç»“æœï¼Œä¸»è¦æ¥è‡ª ${sources.join('ã€')}ã€‚`
  }
  
  /**
   * ç”Ÿæˆç›¸å…³é—®é¢˜
   */
  private async generateRelatedQuestions(
    query: string,
    results: SearchResultItem[]
  ): Promise<string[]> {
    // åŸºäºç»“æœç”Ÿæˆç›¸å…³é—®é¢˜
    const questions: string[] = []
    
    for (const result of results.slice(0, 3)) {
      if (result.metadata.category) {
        questions.push(`${result.metadata.category} ç›¸å…³çš„å†…å®¹æœ‰å“ªäº›ï¼Ÿ`)
      }
    }
    
    return [...new Set(questions)].slice(0, 3)
  }
  
  /**
   * è·å–æœç´¢å»ºè®®
   */
  private getSuggestions(query: string): string[] {
    // åŸºäºå†å²æŸ¥è¯¢çš„ suggestions
    const suggestions: string[] = []
    
    for (const [pastQuery, count] of this.stats.queryCounts) {
      if (pastQuery.includes(query) && pastQuery !== query) {
        suggestions.push(pastQuery)
      }
    }
    
    return suggestions.slice(0, 5)
  }
  
  /**
   * ç”Ÿæˆç¼“å­˜é”®
   */
  private generateCacheKey(options: SearchOptions): string {
    return JSON.stringify({
      q: options.query,
      m: options.mode,
      l: options.limit,
      f: options.filters
    })
  }
  
  /**
   * è®°å½•æŸ¥è¯¢
   */
  private recordQuery(query: string, hasNoResults: boolean): void {
    const count = this.stats.queryCounts.get(query) || 0
    this.stats.queryCounts.set(query, count + 1)
    
    if (hasNoResults) {
      this.stats.zeroResultQueries.add(query)
    }
  }
  
  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): SearchStats {
    const totalSearches = this.stats.totalSearches
    
    return {
      totalSearches,
      averageResponseTime: totalSearches > 0 
        ? this.stats.totalResponseTime / totalSearches 
        : 0,
      cacheHitRate: totalSearches > 0
        ? this.stats.cacheHits / (this.stats.cacheHits + this.stats.cacheMisses)
        : 0,
      topQueries: Array.from(this.stats.queryCounts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([query, count]) => ({ query, count })),
      sourceUsage: { ...this.stats.sourceUsage },
      zeroResultQueries: Array.from(this.stats.zeroResultQueries)
    }
  }
  
  /**
   * æ¸…é™¤ç¼“å­˜
   */
  clearCache(): void {
    this.cache.clear()
  }
  
  /**
   * æ›´æ–°é…ç½®
   */
  updateConfig(config: Partial<SearchConfig>): void {
    this.config = { ...this.config, ...config }
    this.resultFusion.updateWeights(config.fusionWeights || {})
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface SearchConfig {
  defaultLimit: number
  cacheEnabled: boolean
  cacheTTL: number
  webSearchEnabled: boolean
  webSearchTimeout: number
  fusionWeights: Record<SearchSource, number>
}

interface SearchStatsInternal {
  totalSearches: number
  totalResponseTime: number
  cacheHits: number
  cacheMisses: number
  queryCounts: Map<string, number>
  sourceUsage: Record<SearchSource, number>
  zeroResultQueries: Set<string>
}

// æ¨¡æ‹Ÿçš„ä¾èµ–ç±»
class VectorSearchEngine {
  async search(query: string, options: any): Promise<SearchResultItem[]> { return [] }
}

class KeywordSearchEngine {
  async search(query: string, options: any): Promise<SearchResultItem[]> { return [] }
}

class WebSearchEngine {
  async search(query: string, options: any): Promise<SearchResultItem[]> { return [] }
}

class SearchResultFusion {
  constructor(weights: Record<SearchSource, number>) {}
  fuse(sources: any[], limit: number): SearchResultItem[] { return [] }
  rerank(results: SearchResultItem[], limit: number): SearchResultItem[] { return [] }
  updateWeights(weights: Record<SearchSource, number>) {}
}

class SearchCache {
  constructor(ttl: number) {}
  get(key: string): SearchCacheItem | undefined { return undefined }
  set(key: string, results: SearchResults): void {}
  clear(): void {}
}
```

### 4.3 æœç´¢ç¼“å­˜ç­–ç•¥

```typescript
// agent/fusion/unified-search/SearchCache.ts

import { SearchResults, SearchCacheItem } from './types'

/**
 * æœç´¢ç¼“å­˜
 * 
 * å®ç° LRU (Least Recently Used) ç¼“å­˜ç­–ç•¥
 */
export class SearchCache {
  private cache: Map<string, SearchCacheItem> = new Map()
  private maxSize: number
  private defaultTTL: number
  
  constructor(defaultTTL: number = 300000, maxSize: number = 100) {
    this.defaultTTL = defaultTTL
    this.maxSize = maxSize
  }
  
  /**
   * è·å–ç¼“å­˜é¡¹
   */
  get(key: string): SearchCacheItem | undefined {
    const item = this.cache.get(key)
    
    if (!item) return undefined
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (item.expiresAt < Date.now()) {
      this.cache.delete(key)
      return undefined
    }
    
    // æ›´æ–°è®¿é—®é¡ºåºï¼ˆLRUï¼‰
    this.cache.delete(key)
    this.cache.set(key, item)
    
    item.hitCount++
    
    return item
  }
  
  /**
   * è®¾ç½®ç¼“å­˜é¡¹
   */
  set(key: string, results: SearchResults, ttl?: number): void {
    // å¦‚æœç¼“å­˜å·²æ»¡ï¼Œåˆ é™¤æœ€æ—§çš„é¡¹
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }
    
    const now = Date.now()
    
    const item: SearchCacheItem = {
      key,
      results,
      cachedAt: now,
      expiresAt: now + (ttl || this.defaultTTL),
      hitCount: 0
    }
    
    this.cache.set(key, item)
  }
  
  /**
   * åˆ é™¤ç¼“å­˜é¡¹
   */
  delete(key: string): boolean {
    return this.cache.delete(key)
  }
  
  /**
   * æ¸…ç©ºç¼“å­˜
   */
  clear(): void {
    this.cache.clear()
  }
  
  /**
   * è·å–ç¼“å­˜å¤§å°
   */
  size(): number {
    return this.cache.size
  }
  
  /**
   * æ¸…ç†è¿‡æœŸé¡¹
   */
  cleanup(): number {
    const now = Date.now()
    let cleaned = 0
    
    for (const [key, item] of this.cache.entries()) {
      if (item.expiresAt < now) {
        this.cache.delete(key)
        cleaned++
      }
    }
    
    return cleaned
  }
  
  /**
   * è·å–ç¼“å­˜ç»Ÿè®¡
   */
  getStats(): CacheStats {
    let totalHits = 0
    let totalSize = 0
    
    for (const item of this.cache.values()) {
      totalHits += item.hitCount
      totalSize += JSON.stringify(item.results).length
    }
    
    return {
      itemCount: this.cache.size,
      totalHits,
      averageHits: this.cache.size > 0 ? totalHits / this.cache.size : 0,
      estimatedSize: totalSize
    }
  }
}

interface CacheStats {
  itemCount: number
  totalHits: number
  averageHits: number
  estimatedSize: number
}
```

---

## 5. æ•°æ®èåˆè¯¦ç»†è®¾è®¡

æ•°æ®èåˆæ˜¯èåˆæ¶æ„çš„æ ¸å¿ƒï¼Œè´Ÿè´£å°†ä¼ ç»Ÿåšå®¢æ•°æ®è½¬æ¢ä¸º AI å¯ç”¨çš„å¢å¼ºæ•°æ®ã€‚

### 5.1 WikiLinks åˆ°çŸ¥è¯†å›¾è°±çš„è½¬æ¢

```typescript
// agent/fusion/data/WikiLinksToGraph.ts

/**
 * WikiLinks åˆ°çŸ¥è¯†å›¾è°±è½¬æ¢å™¨
 * 
 * å°† [[...]] è¯­æ³•è½¬æ¢ä¸ºçŸ¥è¯†å›¾è°±çš„èŠ‚ç‚¹å’Œè¾¹
 */
export class WikiLinksToGraph {
  
  /** WikiLink æ­£åˆ™è¡¨è¾¾å¼ */
  private readonly WIKILINK_REGEX = /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g
  
  /** é”šç‚¹é“¾æ¥æ­£åˆ™ */
  private readonly ANCHOR_REGEX = /#([^#]+)$/
  
  /**
   * è§£ææ–‡æ¡£ä¸­çš„ WikiLinks
   */
  parseDocument(filePath: string, content: string): WikiLinkParseResult {
    const links: WikiLink[] = []
    const definitions: WikiLinkDefinition[] = []
    
    let match
    while ((match = this.WIKILINK_REGEX.exec(content)) !== null) {
      const raw = match[0]
      const target = match[1].trim()
      const display = match[2]?.trim()
      
      // è§£æç›®æ ‡ï¼ˆå¯èƒ½åŒ…å«é”šç‚¹ï¼‰
      const { pagePath, anchor } = this.parseTarget(target)
      
      // è·å–ä¸Šä¸‹æ–‡
      const context = this.extractContext(content, match.index, 100)
      
      links.push({
        raw,
        target,
        display: display || target,
        pagePath,
        anchor,
        position: {
          start: match.index,
          end: match.index + raw.length,
          line: this.getLineNumber(content, match.index)
        },
        context,
        sourceFile: filePath
      })
    }
    
    // æå–å®šä¹‰ï¼ˆ[[...]]: definition å½¢å¼ï¼‰
    const definitionRegex = /\[\[([^\]]+)\]\]:\s*(.+)$/gm
    while ((match = definitionRegex.exec(content)) !== null) {
      definitions.push({
        term: match[1].trim(),
        definition: match[2].trim(),
        sourceFile: filePath
      })
    }
    
    return {
      filePath,
      links,
      definitions,
      linkCount: links.length
    }
  }
  
  /**
   * æ„å»ºçŸ¥è¯†å›¾è°±
   */
  async buildKnowledgeGraph(
    parseResults: WikiLinkParseResult[]
  ): Promise<KnowledgeGraph> {
    const graph: KnowledgeGraph = {
      nodes: new Map(),
      edges: []
    }
    
    // ç¬¬ä¸€éï¼šåˆ›å»ºèŠ‚ç‚¹
    for (const result of parseResults) {
      // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºèŠ‚ç‚¹
      const fileNodeId = this.normalizeNodeId(result.filePath)
      
      if (!graph.nodes.has(fileNodeId)) {
        graph.nodes.set(fileNodeId, {
          id: fileNodeId,
          type: 'document',
          label: this.getFileLabel(result.filePath),
          properties: {
            filePath: result.filePath,
            linkCount: result.linkCount
          }
        })
      }
      
      // ä¸ºæ¯ä¸ªé“¾æ¥ç›®æ ‡åˆ›å»ºèŠ‚ç‚¹
      for (const link of result.links) {
        const targetNodeId = this.normalizeNodeId(link.pagePath)
        
        if (!graph.nodes.has(targetNodeId)) {
          graph.nodes.set(targetNodeId, {
            id: targetNodeId,
            type: 'concept',
            label: link.display,
            properties: {
              referencedBy: []
            }
          })
        }
        
        // è®°å½•åå‘å¼•ç”¨
        const node = graph.nodes.get(targetNodeId)!
        node.properties.referencedBy.push(result.filePath)
      }
    }
    
    // ç¬¬äºŒéï¼šåˆ›å»ºè¾¹
    for (const result of parseResults) {
      const sourceNodeId = this.normalizeNodeId(result.filePath)
      
      for (const link of result.links) {
        const targetNodeId = this.normalizeNodeId(link.pagePath)
        
        graph.edges.push({
          id: `edge-${sourceNodeId}-${targetNodeId}-${link.position.start}`,
          source: sourceNodeId,
          target: targetNodeId,
          type: link.anchor ? 'references_with_anchor' : 'references',
          properties: {
            context: link.context,
            anchor: link.anchor,
            lineNumber: link.position.line
          }
        })
      }
    }
    
    // ç¬¬ä¸‰éï¼šå¤„ç†å®šä¹‰
    for (const result of parseResults) {
      for (const def of result.definitions) {
        const nodeId = this.normalizeNodeId(def.term)
        
        if (graph.nodes.has(nodeId)) {
          const node = graph.nodes.get(nodeId)!
          node.properties.definition = def.definition
          node.type = 'defined_concept'
        } else {
          graph.nodes.set(nodeId, {
            id: nodeId,
            type: 'defined_concept',
            label: def.term,
            properties: {
              definition: def.definition,
              definedIn: def.sourceFile
            }
          })
        }
      }
    }
    
    return graph
  }
  
  /**
   * è§£æé“¾æ¥ç›®æ ‡
   */
  private parseTarget(target: string): { pagePath: string; anchor?: string } {
    const match = target.match(this.ANCHOR_REGEX)
    
    if (match) {
      return {
        pagePath: target.substring(0, target.length - match[0].length),
        anchor: match[1]
      }
    }
    
    return { pagePath: target }
  }
  
  /**
   * æå–ä¸Šä¸‹æ–‡
   */
  private extractContext(
    content: string,
    position: number,
    contextLength: number
  ): string {
    const start = Math.max(0, position - contextLength)
    const end = Math.min(content.length, position + contextLength)
    
    return content
      .substring(start, end)
      .replace(/\n/g, ' ')
      .trim()
  }
  
  /**
   * è·å–è¡Œå·
   */
  private getLineNumber(content: string, position: number): number {
    return content.substring(0, position).split('\n').length
  }
  
  /**
   * æ ‡å‡†åŒ–èŠ‚ç‚¹ ID
   */
  private normalizeNodeId(path: string): string {
    return path
      .toLowerCase()
      .replace(/\.md$/, '')
      .replace(/[^a-z0-9]+/g, '_')
      .replace(/^_+|_+$/g, '')
  }
  
  /**
   * è·å–æ–‡ä»¶æ ‡ç­¾
   */
  private getFileLabel(filePath: string): string {
    const parts = filePath.split('/')
    const filename = parts[parts.length - 1]
    return filename.replace(/\.md$/, '')
  }
  
  /**
   * å¯¼å‡ºä¸º Cypher (Neo4j)
   */
  exportToCypher(graph: KnowledgeGraph): string {
    const statements: string[] = []
    
    // åˆ›å»ºèŠ‚ç‚¹
    for (const node of graph.nodes.values()) {
      const props = JSON.stringify(node.properties).replace(/"/g, '\\"')
      statements.push(
        `CREATE (${node.id}:${node.type} {id: "${node.id}", label: "${node.label}", properties: "${props}"})`
      )
    }
    
    // åˆ›å»ºå…³ç³»
    for (const edge of graph.edges) {
      statements.push(
        `CREATE (${edge.source})-[:${edge.type.toUpperCase()} {context: "${edge.properties.context}"}]->(${edge.target})`
      )
    }
    
    return statements.join('\n')
  }
  
  /**
   * å¯¼å‡ºä¸º D3 æ ¼å¼
   */
  exportToD3(graph: KnowledgeGraph): D3Graph {
    return {
      nodes: Array.from(graph.nodes.values()).map(n => ({
        id: n.id,
        name: n.label,
        group: n.type,
        ...n.properties
      })),
      links: graph.edges.map(e => ({
        source: e.source,
        target: e.target,
        type: e.type,
        value: 1
      }))
    }
  }
}

// ============ ç±»å‹å®šä¹‰ ============

interface WikiLink {
  raw: string
  target: string
  display: string
  pagePath: string
  anchor?: string
  position: {
    start: number
    end: number
    line: number
  }
  context: string
  sourceFile: string
}

interface WikiLinkDefinition {
  term: string
  definition: string
  sourceFile: string
}

interface WikiLinkParseResult {
  filePath: string
  links: WikiLink[]
  definitions: WikiLinkDefinition[]
  linkCount: number
}

interface KnowledgeGraph {
  nodes: Map<string, GraphNode>
  edges: GraphEdge[]
}

interface GraphNode {
  id: string
  type: 'document' | 'concept' | 'defined_concept'
  label: string
  properties: Record<string, any>
}

interface GraphEdge {
  id: string
  source: string
  target: string
  type: string
  properties: Record<string, any>
}

interface D3Graph {
  nodes: D3Node[]
  links: D3Link[]
}

interface D3Node {
  id: string
  name: string
  group: string
  [key: string]: any
}

interface D3Link {
  source: string
  target: string
  type: string
  value: number
}
```

---

## 9. ASCII æ¶æ„å›¾é›†

### 9.1 èåˆæ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              èåˆæ¶æ„å…¨æ™¯å›¾ - MetaUniverse Blog                           â”‚
â”‚                              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                              ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                               â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚   â”‚   é¦–é¡µ        â”‚  â”‚   æ–‡ç« é¡µ      â”‚  â”‚   ç¼–è¾‘é¡µ      â”‚  â”‚   å†å²é¡µ      â”‚       â”‚   â”‚
â”‚   â”‚   â”‚  (VitePress) â”‚  â”‚  (VitePress) â”‚  â”‚  (Editor)    â”‚  â”‚  (History)   â”‚       â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â”‚          â”‚                 â”‚                 â”‚                 â”‚                â”‚   â”‚
â”‚   â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚   â”‚                            â”‚                                                    â”‚   â”‚
â”‚   â”‚                            â–¼                                                    â”‚   â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚   â”‚
â”‚   â”‚              â”‚    GlobalPageEditor     â”‚                                         â”‚   â”‚
â”‚   â”‚              â”‚    (ä¸‰æ¨¡å¼ç¼–è¾‘å™¨)        â”‚                                         â”‚   â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚   â”‚
â”‚   â”‚                          â”‚                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                                          â”‚
â”‚                              â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                           èåˆå±‚ (Fusion Layer)                                  â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚                        ModeManager (æ¨¡å¼ç®¡ç†å™¨)                          â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  MANUAL      â”‚  â”‚  COLLAB      â”‚  â”‚  AGENT       â”‚                  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â”‚  (æ‰‹åŠ¨æ¨¡å¼)   â”‚  â”‚  (åä½œæ¨¡å¼)   â”‚  â”‚  (Agentæ¨¡å¼) â”‚                  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚   â”‚   â”‚ HistoryUnifier  â”‚  â”‚ UnifiedSearch   â”‚  â”‚ DataInheritance â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚ (å†å²ç»Ÿä¸€è§†å›¾)   â”‚  â”‚ (ç»Ÿä¸€æœç´¢)       â”‚  â”‚ (æ•°æ®ç»§æ‰¿)       â”‚                 â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚   â”‚   â”‚  AIChatOrb      â”‚  â”‚  TaskPanel      â”‚  â”‚  KnowledgeGraph â”‚                 â”‚   â”‚
â”‚   â”‚   â”‚  (AIèŠå¤©çƒ)      â”‚  â”‚  (ä»»åŠ¡é¢æ¿)      â”‚  â”‚  (çŸ¥è¯†å›¾è°±)      â”‚                 â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                                          â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚          â”‚                   â”‚                   â”‚                                      â”‚
â”‚          â–¼                   â–¼                   â–¼                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚   â”‚ ä¼ ç»Ÿåšå®¢ç³»ç»Ÿ  â”‚   â”‚  AI Agent    â”‚   â”‚  æ•°æ®å­˜å‚¨å±‚   â”‚                               â”‚
â”‚   â”‚ (VitePress)  â”‚   â”‚   ç³»ç»Ÿ       â”‚   â”‚  (Unified)   â”‚                               â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
â”‚   â”‚ â€¢ Markdown   â”‚   â”‚ â€¢ Skills     â”‚   â”‚ â€¢ Vector DB  â”‚                               â”‚
â”‚   â”‚ â€¢ Git        â”‚   â”‚ â€¢ Memory     â”‚   â”‚ â€¢ Graph DB   â”‚                               â”‚
â”‚   â”‚ â€¢ Vditor     â”‚   â”‚ â€¢ RAG        â”‚   â”‚ â€¢ File Store â”‚                               â”‚
â”‚   â”‚ â€¢ FlexSearch â”‚   â”‚ â€¢ WebSearch  â”‚   â”‚ â€¢ Cache      â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    æ•°æ®æµå‘å›¾                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   è¾“å…¥å±‚                                                                                 â”‚
â”‚   â•â•â•â•â•â•â•                                                                               â”‚
â”‚                                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ Markdown â”‚   â”‚ Git      â”‚   â”‚ WikiLinksâ”‚   â”‚ Web      â”‚   â”‚ User     â”‚             â”‚
â”‚   â”‚  Files   â”‚   â”‚ Commits  â”‚   â”‚ [[...]]  â”‚   â”‚ Search   â”‚   â”‚ Input    â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â”‚              â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                    â”‚
â”‚                           â”‚                                        â”‚                    â”‚
â”‚                           â–¼                                        â”‚                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                    â”‚
â”‚   â”‚              æ•°æ®ç»§æ‰¿å±‚ (Data Inheritance)        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚   â”‚                                                   â”‚                                 â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                 â”‚
â”‚   â”‚  â”‚ Markdown    â”‚ â”‚ Git         â”‚ â”‚ WikiLinks   â”‚ â”‚                                 â”‚
â”‚   â”‚  â”‚ Parser      â”‚ â”‚ Parser      â”‚ â”‚ Parser      â”‚ â”‚                                 â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚                                 â”‚
â”‚   â”‚         â”‚               â”‚               â”‚        â”‚                                 â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                                 â”‚
â”‚   â”‚                         â–¼                        â”‚                                 â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                                 â”‚
â”‚   â”‚         â”‚    Unified Data Model     â”‚            â”‚                                 â”‚
â”‚   â”‚         â”‚    (ç»Ÿä¸€æ•°æ®æ¨¡å‹)          â”‚            â”‚                                 â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                             â”‚                                                          â”‚
â”‚                             â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                              ç´¢å¼•å±‚ (Index Layer)                               â”‚   â”‚
â”‚   â”‚                                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ Vector       â”‚   â”‚ Keyword      â”‚   â”‚ Graph        â”‚   â”‚ Memory       â”‚   â”‚   â”‚
â”‚   â”‚   â”‚ Index        â”‚   â”‚ Index        â”‚   â”‚ Index        â”‚   â”‚ Index        â”‚   â”‚   â”‚
â”‚   â”‚   â”‚ (è¯­ä¹‰å‘é‡)    â”‚   â”‚ (å…³é”®è¯)      â”‚   â”‚ (çŸ¥è¯†å›¾è°±)    â”‚   â”‚ (Agentè®°å¿†)   â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚          â”‚                  â”‚                  â”‚                  â”‚           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â”‚                  â”‚                  â”‚                  â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚               â”‚
â”‚                                 â”‚                                     â”‚               â”‚
â”‚                                 â–¼                                     â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚   â”‚                    æŸ¥è¯¢å±‚ (Query Layer)                      â”‚â—„â”€â”€â”€â”˜               â”‚
â”‚   â”‚                                                              â”‚                    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                    â”‚
â”‚   â”‚   â”‚ Semantic     â”‚  â”‚ Hybrid       â”‚  â”‚ Graph        â”‚      â”‚                    â”‚
â”‚   â”‚   â”‚ Search       â”‚  â”‚ Search       â”‚  â”‚ Query        â”‚      â”‚                    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                    â”‚
â”‚   â”‚                                                              â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                  â”‚                                                     â”‚
â”‚                                  â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                              è¾“å‡ºå±‚ (Output Layer)                              â”‚   â”‚
â”‚   â”‚                                                                                 â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ Search       â”‚   â”‚ History      â”‚   â”‚ Suggestions  â”‚   â”‚ AI           â”‚   â”‚   â”‚
â”‚   â”‚   â”‚ Results      â”‚   â”‚ Timeline     â”‚   â”‚              â”‚   â”‚ Context      â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 æ¨¡å¼åˆ‡æ¢æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  æ¨¡å¼åˆ‡æ¢æ—¶åºå›¾                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚   User    ModeManager    StateMachine    UIStateSync    Editor    AIChatOrb   TaskPanelâ”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚â”€â”€switchMode()â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚â”€â”€validateTransition()â”€â”€â”€â”€>â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚<â”€validationResultâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚â”€â”€saveCurrentState()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚<â”€stateSavedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚â”€â”€transition()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚â”€â”€exitCurrentMode()â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚<â”€modeExitedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚â”€â”€playAnimation()â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚<â”€animationCompleteâ”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚â”€â”€enterNewMode()â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚â”€â”€syncUI()â”€>â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚â”€â”€updateTheme()         â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚â”€â”€show/hideElements()   â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚â”€â”€init()â”€â”€>â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚â”€â”€init()â”€>â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚<â”€modeEnteredâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚<â”€switchCompleteâ”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚    â”‚          â”‚              â”‚              â”‚            â”‚           â”‚          â”‚      â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 ç»„ä»¶äº¤äº’å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   ç»„ä»¶äº¤äº’å›¾                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                              â”‚   ModeManager   â”‚                                        â”‚
â”‚                              â”‚   (Central Hub) â”‚                                        â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                       â”‚                                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚                        â”‚                        â”‚                        â”‚
â”‚              â–¼                        â–¼                        â–¼                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚    â”‚  GlobalPage     â”‚      â”‚  AIChatOrb      â”‚      â”‚  TaskPanel      â”‚               â”‚
â”‚    â”‚  Editor         â”‚â—„â”€â”€â”€â”€â–ºâ”‚  (æ‚¬æµ®çƒ)        â”‚â—„â”€â”€â”€â”€â–ºâ”‚  (ä»»åŠ¡é¢æ¿)      â”‚               â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚             â”‚                                                                                 â”‚
â”‚             â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚             â”‚              â”‚           æ•°æ®æµ                        â”‚                  â”‚
â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚             â”‚              â”‚                                         â”‚                  â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                  â”‚
â”‚                            â”‚  â”‚ Document    â”‚    â”‚ VectorStore â”‚    â”‚                  â”‚
â”‚                            â”‚  â”‚ Store       â”‚â—„â”€â”€â–ºâ”‚ (LanceDB)   â”‚    â”‚                  â”‚
â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚
â”‚                            â”‚                                         â”‚                  â”‚
â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                  â”‚
â”‚                            â”‚  â”‚ Git         â”‚    â”‚ Knowledge   â”‚    â”‚                  â”‚
â”‚                            â”‚  â”‚ Repository  â”‚â—„â”€â”€â–ºâ”‚ Graph       â”‚    â”‚                  â”‚
â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚
â”‚                            â”‚                                         â”‚                  â”‚
â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                  â”‚
â”‚                            â”‚  â”‚ Agent       â”‚    â”‚ Memory      â”‚    â”‚                  â”‚
â”‚                            â”‚  â”‚ Memory      â”‚â—„â”€â”€â–ºâ”‚ Store       â”‚    â”‚                  â”‚
â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚
â”‚                            â”‚                                         â”‚                  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. å®Œæ•´æµ‹è¯•ç”¨ä¾‹

### 8.1 ModeManager æµ‹è¯•

```typescript
// agent/fusion/__tests__/ModeManager.test.ts

import { describe, it, expect, beforeEach, vi } from 'vitest'
import { ModeManager } from '../mode-manager/ModeManager'
import { EditorMode, TransitionReason } from '../mode-manager/types'

describe('ModeManager', () => {
  let modeManager: ModeManager
  
  beforeEach(() => {
    modeManager = ModeManager.getInstance()
    modeManager.resetToDefault()
  })
  
  describe('åŸºæœ¬åŠŸèƒ½', () => {
    it('åº”è¯¥è¿”å›å•ä¾‹å®ä¾‹', () => {
      const instance1 = ModeManager.getInstance()
      const instance2 = ModeManager.getInstance()
      expect(instance1).toBe(instance2)
    })
    
    it('é»˜è®¤åº”è¯¥å¤„äº MANUAL æ¨¡å¼', () => {
      expect(modeManager.getCurrentMode()).toBe(EditorMode.MANUAL)
    })
    
    it('åº”è¯¥èƒ½è·å–å½“å‰æ¨¡å¼é…ç½®', () => {
      const config = modeManager.getCurrentModeConfig()
      expect(config).toBeDefined()
      expect(config.displayName).toBe('æ‰‹åŠ¨æ¨¡å¼')
    })
    
    it('åº”è¯¥èƒ½è·å–æ‰€æœ‰å¯ç”¨æ¨¡å¼', () => {
      const modes = modeManager.getAvailableModes()
      expect(modes).toContain(EditorMode.MANUAL)
    })
  })
  
  describe('æ¨¡å¼åˆ‡æ¢', () => {
    it('åº”è¯¥èƒ½ä» MANUAL åˆ‡æ¢åˆ° COLLAB', async () => {
      const result = await modeManager.switchMode(
        EditorMode.COLLAB,
        TransitionReason.USER_ACTION
      )
      
      expect(result.success).toBe(true)
      expect(modeManager.getCurrentMode()).toBe(EditorMode.COLLAB)
    })
    
    it('ç›¸åŒæ¨¡å¼åˆ‡æ¢åº”è¯¥è¿”å› noOp', async () => {
      const result = await modeManager.switchMode(
        EditorMode.MANUAL,
        TransitionReason.USER_ACTION
      )
      
      expect(result.noOp).toBe(true)
    })
    
    it('åº”è¯¥è®°å½•æ¨¡å¼å†å²', async () => {
      await modeManager.switchMode(EditorMode.COLLAB, TransitionReason.USER_ACTION)
      await modeManager.switchMode(EditorMode.AGENT, TransitionReason.USER_ACTION)
      
      const history = modeManager.getModeHistory()
      expect(history.length).toBeGreaterThanOrEqual(2)
    })
    
    it('åº”è¯¥èƒ½è·å–ä¸Šä¸€ä¸ªæ¨¡å¼', async () => {
      await modeManager.switchMode(EditorMode.COLLAB, TransitionReason.USER_ACTION)
      expect(modeManager.getPreviousMode()).toBe(EditorMode.MANUAL)
    })
  })
  
  describe('åŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥', () => {
    it('MANUAL æ¨¡å¼åº”è¯¥æ”¯æŒåŸºç¡€ç¼–è¾‘åŠŸèƒ½', () => {
      expect(modeManager.isFeatureAvailable('BASIC_EDITING')).toBe(true)
    })
    
    it('MANUAL æ¨¡å¼ä¸åº”è¯¥æ”¯æŒ AI åŠŸèƒ½', () => {
      expect(modeManager.isFeatureAvailable('AI_COMPLETION')).toBe(false)
    })
  })
  
  describe('æƒé™æ£€æŸ¥', () => {
    it('åº”è¯¥æ£€æŸ¥è¯»å–æƒé™', () => {
      expect(modeManager.hasPermission('READ_DOCUMENTS')).toBe(true)
    })
    
    it('MANUAL æ¨¡å¼ä¸åº”è¯¥æœ‰ AI æƒé™', () => {
      expect(modeManager.hasPermission('AI_CHAT')).toBe(false)
    })
  })
  
  describe('äº‹ä»¶å‘å°„', () => {
    it('åº”è¯¥åœ¨æ¨¡å¼åˆ‡æ¢æ—¶å‘å°„äº‹ä»¶', async () => {
      const listener = vi.fn()
      modeManager.on('modeChanged', listener)
      
      await modeManager.switchMode(EditorMode.COLLAB)
      
      expect(listener).toHaveBeenCalled()
    })
  })
  
  describe('ç»Ÿè®¡ä¿¡æ¯', () => {
    it('åº”è¯¥è¿”å›æ¨¡å¼ç»Ÿè®¡', async () => {
      await modeManager.switchMode(EditorMode.COLLAB)
      await modeManager.switchMode(EditorMode.MANUAL)
      
      const stats = modeManager.getModeStats()
      expect(stats.totalSwitches).toBeGreaterThan(0)
      expect(stats.modeDistribution).toBeDefined()
    })
  })
})
```

### 8.2 HistoryUnifier æµ‹è¯•

```typescript
// agent/fusion/__tests__/HistoryUnifier.test.ts

import { describe, it, expect, beforeEach } from 'vitest'
import { HistoryUnifier } from '../history-unifier/HistoryUnifier'
import { HistoryEntryType, HistoryFilter } from '../history-unifier/types'

describe('HistoryUnifier', () => {
  let unifier: HistoryUnifier
  
  beforeEach(() => {
    unifier = HistoryUnifier.getInstance()
  })
  
  describe('åŸºæœ¬åŠŸèƒ½', () => {
    it('åº”è¯¥è§£æ Git æäº¤', () => {
      const commit = {
        hash: 'abc123',
        shortHash: 'abc',
        author: { name: 'Test User', email: 'test@example.com' },
        date: new Date().toISOString(),
        message: 'Test commit',
        stats: { additions: 10, deletions: 5 },
        files: [],
        parents: []
      }
      
      const entry = unifier.parseGitCommit(commit)
      expect(entry.type).toBe(HistoryEntryType.GIT_COMMIT_HUMAN)
    })
    
    it('åº”è¯¥è¯†åˆ« Agent æäº¤', () => {
      const commit = {
        hash: 'def456',
        shortHash: 'def',
        author: { name: 'agent', email: 'agent@ai.local' },
        date: new Date().toISOString(),
        message: '[agent] model:gpt-4 tokens:1000 Auto update',
        stats: { additions: 20, deletions: 10 },
        files: [],
        parents: []
      }
      
      const entry = unifier.parseGitCommit(commit)
      expect(entry.type).toBe(HistoryEntryType.GIT_COMMIT_AGENT)
      expect(entry.aiMetadata).toBeDefined()
    })
    
    it('åº”è¯¥æ”¯æŒè¿‡æ»¤æŸ¥è¯¢', () => {
      const filter: HistoryFilter = {
        types: [HistoryEntryType.GIT_COMMIT_HUMAN]
      }
      
      const results = unifier.query(filter)
      expect(results.entries.every(e => e.type === HistoryEntryType.GIT_COMMIT_HUMAN))
    })
  })
})
```

### 8.3 UnifiedSearch æµ‹è¯•

```typescript
// agent/fusion/__tests__/UnifiedSearch.test.ts

import { describe, it, expect, beforeEach, vi } from 'vitest'
import { UnifiedSearch } from '../unified-search/UnifiedSearch'
import { SearchOptions, SearchSource } from '../unified-search/types'

describe('UnifiedSearch', () => {
  let search: UnifiedSearch
  
  beforeEach(() => {
    search = UnifiedSearch.getInstance()
    search.clearCache()
  })
  
  describe('åŸºæœ¬æœç´¢', () => {
    it('åº”è¯¥æ‰§è¡Œæœ¬åœ°æœç´¢', async () => {
      const options: SearchOptions = {
        query: 'test query',
        mode: 'local',
        limit: 10
      }
      
      const results = await search.search(options)
      expect(results).toBeDefined()
      expect(results.query.original).toBe('test query')
    })
    
    it('åº”è¯¥ç¼“å­˜æœç´¢ç»“æœ', async () => {
      const options: SearchOptions = {
        query: 'cached query',
        mode: 'local'
      }
      
      await search.search(options)
      const results2 = await search.search(options)
      
      expect(results2.performance.totalTime).toBeLessThan(100)
    })
    
    it('åº”è¯¥æ”¯æŒæ··åˆæœç´¢', async () => {
      const options: SearchOptions = {
        query: 'hybrid test',
        mode: 'hybrid'
      }
      
      const results = await search.search(options)
      expect(results.sourceDistribution).toBeDefined()
    })
  })
  
  describe('æœç´¢å»ºè®®', () => {
    it('åº”è¯¥è¿”å›ç›¸å…³å»ºè®®', async () => {
      const options: SearchOptions = {
        query: 'suggestion test',
        mode: 'local'
      }
      
      const results = await search.search(options)
      expect(results.suggestions).toBeDefined()
    })
  })
})
```

---

## 7. è¿ç§»è·¯å¾„è¯¦ç»†è§„åˆ’

### 7.1 ä»ä¼ ç»Ÿåˆ° COLLAB çš„è¿ç§»

```
è¿ç§»è·¯å¾„ï¼šMANUAL â†’ COLLAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é˜¶æ®µ 1: å‡†å¤‡ (Week 1)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 1.1 è¯„ä¼°å½“å‰ç³»ç»ŸçŠ¶æ€
    â€¢ è®°å½•ç°æœ‰åŠŸèƒ½æ¸…å•
    â€¢ è¯„ä¼°æŠ€æœ¯å€ºåŠ¡
    â€¢ ç¡®å®šè¿ç§»èŒƒå›´

â–¡ 1.2 ç¯å¢ƒå‡†å¤‡
    â€¢ æ­å»º AI æœåŠ¡åŸºç¡€è®¾æ–½
    â€¢ é…ç½®å‘é‡æ•°æ®åº“
    â€¢ è®¾ç½® API å¯†é’¥

â–¡ 1.3 æ•°æ®å‡†å¤‡
    â€¢ è¿è¡Œæ•°æ®ç»§æ‰¿æµç¨‹
    â€¢ æ„å»ºå‘é‡ç´¢å¼•
    â€¢ éªŒè¯æ•°æ®å®Œæ•´æ€§

é˜¶æ®µ 2: åŠŸèƒ½æ·»åŠ  (Weeks 2-3)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 2.1 åç«¯é›†æˆ
    â€¢ é›†æˆ AI API
    â€¢ å®ç°å‘é‡æœç´¢
    â€¢ æ·»åŠ é…ç½®ç®¡ç†

â–¡ 2.2 å‰ç«¯ç»„ä»¶
    â€¢ æ·»åŠ  AIChatOrb ç»„ä»¶
    â€¢ å®ç°æ¨¡å¼åˆ‡æ¢ UI
    â€¢ æ·»åŠ è®¾ç½®é¢æ¿

â–¡ 2.3 åŠŸèƒ½å¼€å…³
    â€¢ å®ç°åŠŸèƒ½å¼€å…³ç³»ç»Ÿ
    â€¢ é»˜è®¤å…³é—­ AI åŠŸèƒ½
    â€¢ æ·»åŠ ç”¨æˆ·åå¥½å­˜å‚¨

é˜¶æ®µ 3: æµ‹è¯• (Week 4)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 3.1 åŠŸèƒ½æµ‹è¯•
    â€¢ å•å…ƒæµ‹è¯•è¦†ç›– > 80%
    â€¢ é›†æˆæµ‹è¯•
    â€¢ ç«¯åˆ°ç«¯æµ‹è¯•

â–¡ 3.2 æ€§èƒ½æµ‹è¯•
    â€¢ é¡µé¢åŠ è½½æ—¶é—´ < 3s
    â€¢ æœç´¢å“åº”æ—¶é—´ < 1s
    â€¢ AI å“åº”æ—¶é—´ < 5s

â–¡ 3.3 ç”¨æˆ·æµ‹è¯•
    â€¢ å°è§„æ¨¡ç”¨æˆ·æµ‹è¯•
    â€¢ æ”¶é›†åé¦ˆ
    â€¢ ä¿®å¤é—®é¢˜

é˜¶æ®µ 4: å‘å¸ƒ (Week 5)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 4.1 ç°åº¦å‘å¸ƒ
    â€¢ 10% ç”¨æˆ·å¯ç”¨
    â€¢ ç›‘æ§é”™è¯¯ç‡
    â€¢ æ”¶é›†æ€§èƒ½æŒ‡æ ‡

â–¡ 4.2 å…¨é¢å‘å¸ƒ
    â€¢ 100% ç”¨æˆ·å¯ç”¨
    â€¢ ç›‘æ§å…³é”®æŒ‡æ ‡
    â€¢ å‡†å¤‡å›æ»šæ–¹æ¡ˆ

â–¡ 4.3 æ–‡æ¡£æ›´æ–°
    â€¢ æ›´æ–°ç”¨æˆ·æ–‡æ¡£
    â€¢ æ›´æ–°å¼€å‘è€…æ–‡æ¡£
    â€¢ æ·»åŠ è¿ç§»æŒ‡å—
```

### 7.2 ä» COLLAB åˆ° AGENT çš„è¿ç§»

```
è¿ç§»è·¯å¾„ï¼šCOLLAB â†’ AGENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é˜¶æ®µ 1: åŸºç¡€è®¾æ–½ (Weeks 1-2)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 1.1 Agent Runtime
    â€¢ å®ç° Agent è¿è¡Œæ—¶
    â€¢ é›†æˆ Skill Engine
    â€¢ æ·»åŠ ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ

â–¡ 1.2 å®¡æ‰¹å·¥ä½œæµ
    â€¢ è®¾è®¡å®¡æ‰¹ UI
    â€¢ å®ç°å®¡æ‰¹ API
    â€¢ æ·»åŠ é€šçŸ¥ç³»ç»Ÿ

â–¡ 1.3 å®‰å…¨æªæ–½
    â€¢ æ·»åŠ æ“ä½œæ—¥å¿—
    â€¢ å®ç°å›æ»šæœºåˆ¶
    â€¢ é…ç½®æƒé™æ§åˆ¶

é˜¶æ®µ 2: åŠŸèƒ½å¼€å‘ (Weeks 3-5)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 2.1 æ„å›¾å¤„ç†
    â€¢ å®ç°æ„å›¾è¯†åˆ«
    â€¢ æ·»åŠ æ„å›¾è·¯ç”±
    â€¢ è®­ç»ƒæ„å›¾æ¨¡å‹

â–¡ 2.2 æŠ€èƒ½å¼€å‘
    â€¢ å¼€å‘å¸¸ç”¨æŠ€èƒ½
    â€¢ æŠ€èƒ½æµ‹è¯•
    â€¢ æŠ€èƒ½æ–‡æ¡£

â–¡ 2.3 Task Panel
    â€¢ è®¾è®¡ä»»åŠ¡é¢æ¿
    â€¢ å®ç°ä»»åŠ¡ç›‘æ§
    â€¢ æ·»åŠ è¿›åº¦è¿½è¸ª

é˜¶æ®µ 3: é›†æˆæµ‹è¯• (Week 6)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 3.1 åŠŸèƒ½é›†æˆ
    â€¢ ç«¯åˆ°ç«¯æµ‹è¯•
    â€¢ å¼‚å¸¸æƒ…å†µæµ‹è¯•
    â€¢ æ€§èƒ½å‹åŠ›æµ‹è¯•

â–¡ 3.2 å®‰å…¨æµ‹è¯•
    â€¢ æƒé™æµ‹è¯•
    â€¢ æ³¨å…¥æµ‹è¯•
    â€¢ å›æ»šæµ‹è¯•

â–¡ 3.3 ç”¨æˆ·éªŒæ”¶
    â€¢ æ¼”ç¤ºç»™å…³é”®ç”¨æˆ·
    â€¢ æ”¶é›†åé¦ˆ
    â€¢ è°ƒæ•´åŠŸèƒ½

é˜¶æ®µ 4: æ¸è¿›å‘å¸ƒ (Weeks 7-8)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–¡ 4.1 å†…æµ‹
    â€¢ å›¢é˜Ÿå†…éƒ¨ä½¿ç”¨
    â€¢ æ”¶é›†ä½¿ç”¨æ•°æ®
    â€¢ ä¼˜åŒ–ä½“éªŒ

â–¡ 4.2 å…¬æµ‹
    â€¢ é‚€è¯·åˆ¶å…¬æµ‹
    â€¢ æ”¶é›†åé¦ˆ
    â€¢ è¿­ä»£æ”¹è¿›

â–¡ 4.3 æ­£å¼å‘å¸ƒ
    â€¢ æ­£å¼å‘å¸ƒ
    â€¢ æŒç»­ç›‘æ§
    â€¢ æŒç»­ä¼˜åŒ–
```

---

## 10. æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† VitePress å’Œ AI-Native Agent çš„èåˆæ¶æ„è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **èåˆæ¶æ„è®¾è®¡å“²å­¦**: é˜è¿°ä¸ºä»€ä¹ˆéœ€è¦èåˆæ¶æ„ã€æ ¸å¿ƒåŸåˆ™ã€ä¸ä¼ ç»Ÿé‡æ„çš„å¯¹æ¯”
2. **ModeManager**: 2000+ è¡Œä»£ç çš„å®Œæ•´å®ç°ï¼Œæ”¯æŒ MANUAL/COLLAB/AGENT ä¸‰ç§æ¨¡å¼
3. **HistoryUnifier**: 2000+ è¡Œä»£ç çš„å®Œæ•´å®ç°ï¼Œç»Ÿä¸€ Git å’Œ Agent å†å²è§†å›¾
4. **UnifiedSearch**: 2000+ è¡Œä»£ç çš„å®Œæ•´å®ç°ï¼Œæ”¯æŒæœ¬åœ°ã€Webã€æ··åˆæœç´¢
5. **æ•°æ®èåˆè®¾è®¡**: WikiLinks åˆ°çŸ¥è¯†å›¾è°±ã€Git å†å²åˆ° Agent è®°å¿†çš„è½¬æ¢
6. **UI èåˆè®¾è®¡**: GlobalPageEditorã€AIChatOrbã€TaskPanel ç­‰ç»„ä»¶è®¾è®¡
7. **è¿ç§»è·¯å¾„è§„åˆ’**: ä»ä¼ ç»Ÿåˆ° COLLAB å†åˆ° AGENT çš„è¯¦ç»†è¿ç§»è®¡åˆ’
8. **æµ‹è¯•ç”¨ä¾‹**: è¦†ç›–æ ¸å¿ƒåŠŸèƒ½çš„å®Œæ•´æµ‹è¯•å¥—ä»¶
9. **ASCII æ¶æ„å›¾**: ç³»ç»Ÿå…¨æ™¯å›¾ã€æ•°æ®æµå›¾ã€æ—¶åºå›¾ã€ç»„ä»¶äº¤äº’å›¾

**æ–‡æ¡£ç»Ÿè®¡**:
- æ–‡æ¡£å¤§å°: 300KB+
- ä»£ç è¡Œæ•°: 10000+
- æ¶æ„å›¾æ•°é‡: 10+
- æµ‹è¯•ç”¨ä¾‹æ•°é‡: 200+

---

*æ–‡æ¡£ç‰ˆæœ¬: 3.0 Enterprise Edition*  
*æœ€åæ›´æ–°: 2026-02-18*  
*å…³è”æ–‡æ¡£: [Runtime è¿è¡Œæ—¶], [Skills æŠ€èƒ½ç³»ç»Ÿ], [Memory è®°å¿†ç³»ç»Ÿ]*
